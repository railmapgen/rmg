!function(){const e=["nextName"],t=["stnName","oneLine","directionPolarity"],n=["groups","direction"],r=["stnName","nameDirection"];function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach(function(t){i(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function i(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){if(null==e)return{};var n,r,s=function(e,t){if(null==e)return{};var n={};for(var r in e)if({}.hasOwnProperty.call(e,r)){if(-1!==t.indexOf(r))continue;n[r]=e[r]}return n}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(r=0;r<l.length;r++)n=l[r],-1===t.indexOf(n)&&{}.propertyIsEnumerable.call(e,n)&&(s[n]=e[n])}return s}System.register(["./chakra-legacy-az1WooHM.js","./react-legacy-CADlrHyp.js","./index-legacy-lOS8AgOj.js","./app-router-legacy-BcLme56O.js","./svg-wrapper-legacy-BRobEOLy.js","./share-legacy-CUIiY36V.js","./mtr-legacy-bXI2h-Zi.js","./param-selector-legacy-D5nTOI7b.js"],function(s,i){"use strict";var o,d,c,h,m,u,g,x,f,p,v,j,_,$;return{setters:[e=>{o=e.j},e=>{d=e.a,c=e.d},e=>{h=e.u,m=e.aW,u=e.n},e=>{g=e.i},e=>{x=e.S},e=>{f=e.d,p=e.a,v=e.c,j=e.g,_=e.b},e=>{$=e.a},null],execute:function(){const i=(e,t,n,r)=>{const s=e.length-2*r-n,l=[...e,...e,...e],i=e.length+e.findIndex(e=>e===t),a=l[i+s-1],o=e.length+e.findIndex(e=>e===a)+(i+s>2*e.length?e.length:0);return{top:l.slice(i,o+1),left:l.slice(i-r,i),right:l.slice(o+1,o+1+r),bottom:l.slice(o+1+r,o+1+r+n)}},y=m.Destination;function b(){const{canvasScale:e}=h(e=>e.app),{svgWidth:t,svg_height:n,theme:r}=h(e=>e.param),s=t[y];return o.jsxs(x,{type:y,svgWidth:s,svgHeight:n,canvasScale:e,theme:r,children:[o.jsx(k,{}),o.jsx(w,{})]})}const k=d.memo(function(){return o.jsx("defs",{children:o.jsx("marker",{id:"slope",viewBox:"-1.5 0 3 1.5",refY:.5,children:o.jsx("path",{d:"M0,0L1,1H-1z",fill:"var(--rmg-theme-colour)"})})})}),w=()=>{const{routes:e,branches:t}=h(e=>e.helper),{line_name:n,theme:r,current_stn_idx:s,direction:l,stn_list:i,info_panel_type:a,loop:d,coline:c}=h(e=>e.param),m=(e,t,n)=>[...new Set(e.filter(e=>e.includes(n)).map(e=>{const n=e.filter(e=>!["linestart","lineend"].includes(e));return"l"===t?n[0]:n.reverse()[0]}))],u=(e,t)=>t?[[e.map(e=>i[e].localisedName.zh).join("，"),e.map(e=>i[e].localisedName.en).join(", ")].map(e=>e.replace("\\",""))]:e.map(e=>{const{zh:t="",en:n=""}=i[e].localisedName;return[t.replace("\\",""),n.replace("\\","")]}),x=d?((e,t,n,r)=>{const s=e[0].filter(e=>!["linestart","lineend"].includes(e)),l=[...s,...s,...s],i="r"===t?l:l.reverse(),a=i.findIndex(e=>r===e)+s.length;return i.slice(a+1).filter(e=>n[e].loop_pivot).slice(void 0,2)})(t,l,i,s):m(e,l,s),f=(d?m(e,l,s):x).filter(e=>t.slice(1).filter(e=>g(e,i)).some(t=>t.includes(e))),p=u(x.filter(e=>!f.includes(e)),!(d||"sh2020"===a)),v=u(f,!0),j=Object.fromEntries(f.map(e=>[e,Object.values(c).filter(t=>t.from===e||t.to===e).at(0)]).filter(([,e])=>e));return o.jsxs(o.Fragment,{children:[o.jsx(S,{dest_names:p,line_name:n,line_color:[r[2],r[3]],coline:!!f.length,upper:!!f.length}),f.length&&f.filter(e=>Object.values(c).some(t=>t.from===e||t.to===e)).map(e=>{var t,n,r;return o.jsx("g",{transform:"translate(0,-250)",children:o.jsx(S,{dest_names:[v.at(0)],line_name:null===(t=j[e])||void 0===t?void 0:t.colors.at(0).slice(4),line_color:[null===(n=j[e])||void 0===n?void 0:n.colors.at(0)[2],null===(r=j[e])||void 0===r?void 0:r.colors.at(0)[3]],coline:!0,upper:!1})},`coline_${e}`)})]})},S=e=>{const{dest_names:t,line_name:n,line_color:r,coline:s,upper:l}=e,{current_stn_idx:i,direction:a,platform_num:c,svgWidth:m,svg_height:u}=h(e=>e.param),g=d.useRef(null),[x,f]=d.useState({width:0});d.useEffect(()=>{g.current&&f(g.current.getBBox())},[JSON.stringify(t),JSON.stringify(i)]);const[p,v,j,_,$]=[m.destination/2,10,36,264,325],y=p-v-j-x.width>=$/2&&p-v-j-_>=$/2?p:"l"===a?(m.destination+x.width-_)/2:(m.destination-x.width+_)/2;return o.jsxs("g",{transform:`translate(0,${u-300})`,children:[o.jsx("path",{stroke:r[0],strokeWidth:12,d:"l"===a?`M${m.destination-24},16 H 36`:"M24,16 H "+(m.destination-36),transform:`translate(0,${l?-20:220})`,markerEnd:s?void 0:"url(#slope)"}),o.jsx(O,{ref:g,dest_names:t}),""!==c&&o.jsx("g",{transform:`translate(${y},0)`,children:o.jsx(M,{})}),n[0].match(/^[\w\d]+(号)?线/)?o.jsx(N,{line_name:n,line_color:r}):o.jsx(z,{line_name:n,line_color:r})]})},O=d.forwardRef(function(e,t){const{dest_names:n}=e,{direction:r,svgWidth:s}=h(e=>e.param);return o.jsxs("g",{ref:t,transform:`translate(${"l"===r?36:s.destination-36},145)`,children:[o.jsx("g",{transform:`translate(0,${2===n.length?-20:20})`,children:o.jsx("path",{d:"M60,60L0,0L60-60H100L55-15H160V15H55L100,60z",fill:"black",transform:`rotate(${"l"===r?0:180})scale(0.8)`})}),o.jsx("g",{textAnchor:"l"===r?"start":"end",transform:`translate(${"l"===r?148:-148},25)`,children:n.map((e,t)=>o.jsxs(d.Fragment,{children:[o.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:70,dy:-100*t+7,children:"往"+e[0]},`zh${t}`),o.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:25,dy:-100*t+40,children:"To "+e[1]},`en${t}`)]},t))})]})}),M=()=>{const{platform_num:e}=h(e=>e.param);return d.useMemo(()=>o.jsxs("g",{transform:"translate(-102.5,150)",children:[o.jsx("circle",{r:60,fill:"none",stroke:"black",strokeWidth:2}),o.jsx("text",{className:"rmg-name__en rmg-outline",dominantBaseline:"central",fontSize:120,textAnchor:"middle",children:e}),o.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:100,dominantBaseline:"central",x:65,children:"站台"})]}),[e])},z=e=>{const{line_name:t,line_color:n}=e,{direction:r,svgWidth:s}=h(e=>e.param),l="l"===r?s.destination-42:42,i=d.useRef(null),[a,c]=d.useState({width:0});d.useEffect(()=>{i.current&&c(i.current.getBBox())},[...t]);const m=("l"===r?-a.width:0)-6,u=("l"===r?-1:1)*a.width/2;return d.useMemo(()=>o.jsxs("g",{transform:`translate(${l},92)`,children:[o.jsx("rect",{fill:n[0],x:m,width:a.width+10,height:120}),o.jsxs("g",{textAnchor:"r"===r?"start":"end",transform:"translate(0,68)",fill:n[1],children:[o.jsx("g",{ref:i,children:o.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:68,children:t[0]})}),o.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:30,textAnchor:"middle",x:u,dy:42,children:t[1]})]})]}),[a,...t,...n,r,s.destination])},N=e=>{const{line_name:t,line_color:n}=e,{direction:r,svgWidth:s}=h(e=>e.param),[l,i]=t[0].match(/^[\w\d]+|.+/g),a="l"===r?s.destination-36-210:90;return d.useMemo(()=>o.jsxs("g",{transform:`translate(${a},92)`,children:[o.jsx("rect",{fill:n[0],x:-54,width:108,height:120}),o.jsx("text",{className:"rmg-name__zh rmg-outline",fill:n[1],fontSize:96,textAnchor:"middle",dominantBaseline:"central",transform:"translate(0,60)",letterSpacing:-5,children:l}),o.jsxs("g",{textAnchor:"start",transform:"translate(74,68)",children:[o.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:68,children:i}),o.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:30,dy:42,children:t[1]})]})]}),[a,...t,...n,r,s.destination])},I=(e,t)=>e.map(e=>{const n=t.filter(t=>t.includes(e.from)&&t.includes(e.to));if(1!==n.length)return{linePath:[],colors:e.colors};const r=n.flat(),s=r.indexOf(e.from),l=r.indexOf(e.to);return{linePath:s<l?r.slice(s,l+1):r.slice(l,s+1),colors:e.colors}}).filter(e=>0!==e.linePath.length),H=()=>c.useMemo(()=>o.jsxs("filter",{id:"pujiang_outline",colorInterpolationFilters:"sRGB",filterUnits:"userSpaceOnUse",x:"0",y:"-1000",width:"5000",height:"2000",children:[o.jsxs("feComponentTransfer",{in:"SourceGraphic",children:[o.jsx("feFuncR",{type:"discrete",tableValues:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0"}),o.jsx("feFuncG",{type:"discrete",tableValues:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0"}),o.jsx("feFuncB",{type:"discrete",tableValues:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0"})]}),o.jsx("feColorMatrix",{type:"matrix",values:"1 0 0 0 0\n                            0 1 0 0 0\n                            0 0 1 0 0\n                            1 1 1 1 -3",result:"selectedColor"}),o.jsx("feMorphology",{operator:"erode",in:"selectedColor",radius:"0",result:"e1"}),o.jsx("feMorphology",{operator:"erode",in:"selectedColor",radius:"1",result:"e2"}),o.jsx("feComposite",{in:"e1",in2:"e2",operator:"xor",result:"uncoloredOutline"}),o.jsx("feFlood",{floodColor:"rgb(0,0,0)"}),o.jsx("feComposite",{operator:"in",in2:"uncoloredOutline",result:"outline"}),o.jsx("feComposite",{in:"outline",in2:"selectedColor",operator:"over",result:"result"}),o.jsx("feComposite",{in:"result",in2:"SourceGraphic",operator:"over"})]}),[]);H.displayName="PujiangLineDefs";const W=m.RunIn,L=()=>{const{canvasScale:e}=h(e=>e.app),{branches:t,routes:n,depsStr:r}=h(e=>e.helper),{svgWidth:s,svg_height:l,current_stn_idx:i,direction:a,loop:c,theme:m}=h(e=>e.param),u=s[W],g=l-300,f=d.useMemo(()=>{let e=n.filter(e=>e.includes(i)).map(e=>e[e.indexOf(i)+("l"===a?1:-1)]).filter(e=>void 0!==e).reduce((e,t)=>e.includes(t)?e:e.concat(t),[]);return c&&t[0].includes(i)&&1===e.length&&["linestart","lineend"].includes(e[0])&&(e="l"===a?[t[0][1]]:[t[0][t[0].length-2]]),e},[r,i,a,c]),p=d.useMemo(()=>{let e=n.filter(e=>e.includes(i)).map(e=>e[e.indexOf(i)+("l"===a?-1:1)]).filter(e=>void 0!==e).reduce((e,t)=>e.includes(t)?e:e.concat(t),[]);return c&&t[0].includes(i)&&1===e.length&&["linestart","lineend"].includes(e[0])&&(e="l"===a?[t[0][t[0].length-2]]:[t[0][1]]),e},[r,i,a,c]);return o.jsxs(x,{type:W,svgWidth:u,svgHeight:l,canvasScale:e,theme:m,children:[o.jsx(P,{}),o.jsx("g",{transform:`translate(0,${g})`,children:o.jsx(F,{prevStnIds:f,nextStnIds:p})})]})},P=d.memo(function(){return o.jsxs("defs",{children:[o.jsx("marker",{id:"slope",viewBox:"-1.5 0 3 1.5",refY:.5,children:o.jsx("path",{d:"M0,0L1,1H-1z",fill:"var(--rmg-theme-colour)"})}),o.jsx(H,{})]})}),F=e=>{const{prevStnIds:t,nextStnIds:n}=e,{info_panel_type:r,svgWidth:s,stn_list:l}=h(e=>e.param),i=s.runin/2,a=1===n.length&&["linestart","lineend"].includes(n[0]),d=1===t.length&&["linestart","lineend"].includes(t[0]),c=n.map(e=>l[e].localisedName),m=t.map(e=>l[e].localisedName),[{zh:u="",en:g=""}]=c,[{zh:x="",en:f=""}]=m,p=10+(n.length>1?-50*(u.split("\\").length-1)+-30*(g.split("\\").length-1):0),v=10+(t.length>1?-50*(x.split("\\").length-1)+-30*(f.split("\\").length-1):0);return o.jsxs(o.Fragment,{children:[o.jsx(R,{prevStnIds:t,nextStnIds:n,nextBranchLineDy:p,prevBranchLineDy:v}),a&&"sh2020"!==r?o.jsx(B,{mode:"terminal",prevStnIds:t,nextStnIds:n}):d&&"sh2020"!==r?o.jsx(B,{mode:"original",prevStnIds:t,nextStnIds:n}):o.jsxs(o.Fragment,{children:[o.jsx(E,{prevStnIds:t,nextStnIds:n}),o.jsx("g",{transform:`translate(${i},160)`,textAnchor:"middle",children:o.jsx(D,{})})]}),(d||!a)&&o.jsx(V,{stnIds:e.nextStnIds}),(a||!d)&&o.jsx(C,{stnIds:e.prevStnIds})]})},B=e=>{var t;const{mode:n,prevStnIds:r,nextStnIds:s}=e,{current_stn_idx:l,theme:i,svgWidth:a,direction:d,coline:c}=h(e=>e.param),{branches:m}=h(e=>e.helper),u={l:{original:{x:a.runin-36,anchor:"end"},terminal:{x:36,anchor:"start"}},r:{original:{x:36,anchor:"start"},terminal:{x:a.runin-36,anchor:"end"}}},g=I(Object.values(c),m),x="terminal"===n?r:s,f=s.length>1?"var(--rmg-theme-colour)":null!==(t=g.filter(e=>e.linePath.includes(l)&&e.linePath.includes(x[0])).map(e=>e.colors[0][2])[0])&&void 0!==t?t:"var(--rmg-theme-colour)";return o.jsxs(o.Fragment,{children:["original"===n&&o.jsx("path",{transform:`translate(0,${c.length?"198":"220"})${c.length?"scale(1,2)":""}`,stroke:f,strokeWidth:12,d:"l"===d?`M ${a.runin-24},16 H 36`:"M24,16 H "+(a.runin-36),markerEnd:"url(#slope)"}),"terminal"===n&&o.jsx("g",{filter:"#B5B5B6"===i[2]?"url(#pujiang_outline)":void 0,children:o.jsx("path",{transform:`translate(0,${c.length?"198":"220"})${c.length?"scale(1,2)":""}`,stroke:"var(--rmg-grey)",strokeWidth:12,d:"M24,16 H "+(a.runin-24)})}),o.jsx("g",{transform:`translate(${u[d][n].x},160)`,textAnchor:u[d][n].anchor,children:o.jsx(D,{})})]})},E=e=>{var t;const{prevStnIds:n,nextStnIds:r}=e,{direction:s,svgWidth:l,theme:i,coline:a,current_stn_idx:d,stn_list:c}=h(e=>e.param),{branches:m}=h(e=>e.helper),u=l.runin/2,x=e=>e.includes("linestart")||e.includes("lineend"),f=I(Object.values(a),m),p=r.length>1?"single":x(r)?f.filter(e=>[d,n[0]].every(t=>e.linePath.includes(t))).length>0?"multiple":"single":[d,r[0]].every(e=>m[0].includes(e))&&f.filter(e=>[d,r[0]].every(t=>e.linePath.includes(t))).length>0?"multiple":"single",v=x(r)?n:r,j=r.length>1?"var(--rmg-theme-colour)":null!==(t=f.filter(e=>e.linePath.includes(d)&&e.linePath.includes(v[0])).map(e=>e.colors[0][2])[0])&&void 0!==t?t:"var(--rmg-theme-colour)",_=Object.keys(a).length>0&&($=d,y=r,b=c,m.slice(1).filter(e=>[$,y[0]].every(t=>e.includes(t))).filter(e=>g(e,b)).length>0)?j:"var(--rmg-theme-colour)";var $,y,b;const k=Object.keys(a).length>0&&1===r.length&&(!(!x(n)&&!x(r))||!([d,r[0]].every(e=>m[0].includes(e))&&0!==f.filter(e=>e.linePath.includes(d)&&e.linePath.includes(r[0])).length)),w=Object.keys(a).length>0&&1===n.length;return o.jsxs("g",{transform:"translate(0,220)",strokeWidth:12,children:[o.jsxs(o.Fragment,{children:["var(--rmg-theme-colour)"!==_&&o.jsx("marker",{id:`slope_${_}`,viewBox:"-1.5 0 3 1.5",refY:.5,children:o.jsx("path",{d:"M0,0L1,1H-1z",fill:_})}),o.jsx("path",{stroke:_,d:`M ${u},16 H ${"l"===s?36:l.runin-36}`,markerEnd:"var(--rmg-theme-colour)"===_?"url(#slope)":`url(#slope_${_})`,transform:k?"translate(0,-22)scale(1,2)":void 0})]}),"multiple"===p&&o.jsxs(o.Fragment,{children:[o.jsx("marker",{id:`slope_${j}`,viewBox:"-1.5 0 3 1.5",refY:.5,children:o.jsx("path",{d:"M0,0L1,1H-1z",fill:j})}),o.jsx("path",{stroke:j,d:`M ${u},16 H ${"l"===s?48:l.runin-48}`,markerEnd:`url(#slope_${j})`,transform:"translate(0,-12)"})]}),o.jsx("g",{filter:"#B5B5B6"===i[2]?"url(#pujiang_outline)":void 0,transform:`translate(0,${w?-22:0})scale(1,${w?2:1})`,children:o.jsx("path",{stroke:"var(--rmg-grey)",d:`M ${u},16 H ${"l"===s?l.runin-24:24} `})})]})},R=e=>{const{prevStnIds:t,nextStnIds:n,nextBranchLineDy:r,prevBranchLineDy:s}=e,{direction:l,svgWidth:i,current_stn_idx:a,coline:d,theme:c}=h(e=>e.param),{branches:m}=h(e=>e.helper),u=i.runin/2,g=125,x=e=>`${e[0]},${e[1]}`,f=e=>`M${x(e.at(0))} `+e.slice(1).map(e=>`L${x(e)}`).join(" "),p="l"===l?[[i.runin/3,g],[i.runin/6,r],[36,r]]:[[i.runin/3*2,g],[i.runin/6*5,r],[i.runin-36,r]],v="l"===l?[[i.runin/3*2,g],[i.runin/6*5,s],[i.runin-24,s]]:[[i.runin/3,g],[i.runin/6,s],[24,s]];let j="var(--rmg-theme-colour)";if(Object.keys(d).length>0){const e=I(Object.values(d),m);n.length>1&&e.filter(e=>e.linePath.includes(a)&&n.some(t=>e.linePath.includes(t)))&&(p[0][1]-=11,p.unshift([u,114]),j=e.filter(e=>e.linePath.includes(a)&&n.some(t=>e.linePath.includes(t))).at(0).colors.at(0)[2]),t.length>1&&e.filter(e=>e.linePath.includes(a)&&t.some(t=>e.linePath.includes(t)))&&(v[0][1]-=11,v.unshift([u,114]))}return o.jsxs("g",{transform:"translate(0,110)",strokeWidth:12,fill:"none",filter:"#B5B5B6"===c[2]?"url(#pujiang_outline)":void 0,children:[o.jsx("marker",{id:"slope_branch",viewBox:"-1.5 0 3 1.5",refY:.5,children:o.jsx("path",{d:"M0,0L1,1H-1z",fill:j})}),n.length>1&&o.jsx("path",{stroke:j,d:f(p),markerEnd:"url(#slope_branch)"}),t.length>1&&o.jsx("path",{stroke:"var(--rmg-grey)",d:f(v)})]})},D=()=>{const e=h(e=>e.param),{localisedName:t}=e.stn_list[e.current_stn_idx],{zh:n="",en:r=""}=t;return d.useMemo(()=>o.jsxs(o.Fragment,{children:[o.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:112,children:n.replace("\\","")}),o.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:36,dy:50,children:r.replace("\\","")})]}),[n,r])},A=t=>{const{nextName:n}=t,r=a(t,e),{zh:s="",en:i=""}=n;return o.jsx("g",l(l({},r),{},{children:d.useMemo(()=>o.jsxs(o.Fragment,{children:[s.split("\\").map((e,t,n)=>o.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:48,dy:-50*(n.length-1-t)-30*(i.split("\\").length-1),children:e},e)),i.split("\\").map((e,t,n)=>o.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:24,dy:28+-30*(n.length-1-t),children:e},e))]}),[s,i])}))},C=e=>{const t=h(e=>e.param),n=e.stnIds.map(e=>t.stn_list[e].localisedName),r=(e.stnIds.length>1?15:125)+-50*n.map(e=>{var t,n;return null!==(t=null===(n=e.zh)||void 0===n||null===(n=n.split("\\"))||void 0===n?void 0:n.length)&&void 0!==t?t:1}).reduce((e,t)=>e+t,-n.length)+-30*n.map(e=>{var t,n;return null!==(t=null===(n=e.en)||void 0===n||null===(n=n.split("\\"))||void 0===n?void 0:n.length)&&void 0!==t?t:1}).reduce((e,t)=>e+t,-n.length),[{zh:s="",en:l=""}]=n,i=70+(e.stnIds.length>1?-50*(s.split("\\").length-1)+-30*(l.split("\\").length-1):0);return o.jsxs("g",{fill:"gray",textAnchor:"l"===t.direction?"end":"start",transform:`translate(${"l"===t.direction?t.svgWidth.runin-36:36},0)`,children:[o.jsx(A,{nextName:n[0],transform:"translate(0,183)"}),e.stnIds.length>1&&o.jsx(A,{nextName:n[1],transform:`translate(0,${i})`}),o.jsxs("g",{transform:`translate(0, ${r})`,children:[o.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:22,children:"上一站"}),o.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:12,dx:"l"===t.direction?-70:70,children:"Past Stop"})]})]})},V=e=>{const t=h(e=>e.param),n=e.stnIds.map(e=>t.stn_list[e].localisedName),r=(e.stnIds.length>1?15:125)+-50*n.map(e=>{var t,n;return null!==(t=null===(n=e.zh)||void 0===n||null===(n=n.split("\\"))||void 0===n?void 0:n.length)&&void 0!==t?t:1}).reduce((e,t)=>e+t,-n.length)+-30*n.map(e=>{var t,n;return null!==(t=null===(n=e.en)||void 0===n||null===(n=n.split("\\"))||void 0===n?void 0:n.length)&&void 0!==t?t:1}).reduce((e,t)=>e+t,-n.length),[{zh:s="",en:l=""}]=n,i=70+(e.stnIds.length>1?-50*(s.split("\\").length-1)+-30*(l.split("\\").length-1):0);return o.jsxs("g",{textAnchor:"l"===t.direction?"start":"end",transform:`translate(${"l"===t.direction?36:t.svgWidth.runin-36},0)`,children:[o.jsx(A,{nextName:t.stn_list[e.stnIds[0]].localisedName,transform:"translate(0,183)"}),e.stnIds.length>1&&o.jsx(A,{nextName:t.stn_list[e.stnIds[1]].localisedName,transform:`translate(0,${i})`}),o.jsxs("g",{transform:`translate(0, ${r})`,children:[o.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:22,children:"下一站"}),o.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:12,dx:"l"===t.direction?70:-70,children:"Next Stop"})]})]})},J=e=>{var t,n;const{stnId:r,stnState:s,color:i,bank:a,direction:d}=e,{direction:c,info_panel_type:m,stn_list:u,loop:g}=h(e=>e.param),x=u[r],f=null!=d?d:c,p=g?0:(x.parents.length>1||x.children.length>1?8+12*(null!==(t=null===(n=x.localisedName.en)||void 0===n||null===(n=n.split("\\"))||void 0===n?void 0:n.length)&&void 0!==t?t:1):0)*("r"===f?-1:1);let v;const j={};var _;"sh2020"===m?(v=3===x.services.length?"stn_sh_2020_direct":2===x.services.length?"stn_sh_2020_express":"stn_sh_2020",j.fill=-1===s?"gray":i||"var(--rmg-theme-colour)"):(v=3===x.services.length?"direct_sh":2===x.services.length?"express_sh":[...x.transfer.groups[0].lines||[],...(null===(_=x.transfer.groups[1])||void 0===_?void 0:_.lines)||[]].length>0?"int2_sh":"stn_sh",j.stroke=-1===s?"gray":i||"var(--rmg-theme-colour)");const $=null!=a?a:0,y=("l"===f?6:-6)+p+30*$,b=("sh2020"===m?-20:-6)+Math.abs($)*("sh2020"===m?25:11),k=$?0:"l"===f?-45:45;return o.jsxs(o.Fragment,{children:[o.jsx("use",l(l({xlinkHref:`#${v}`},j),{},{transform:`translate(${$*("sh2020"===m?5:0)},0)rotate(${90*$*("sh2020"===m?1:-1)})`})),o.jsx("g",{transform:`translate(${y},${b})rotate(${k})`,children:o.jsx(Y,{name:x.localisedName,groups:x.transfer.groups,stnState:s,direction:f,facility:x.facility,bank:$,oneLine:x.one_line,intPadding:x.int_padding})}),0===s?o.jsx(G,{}):void 0]})},Y=e=>{var t,n;const{name:r,groups:s,stnState:l,direction:i,facility:a,bank:c,oneLine:h,intPadding:m}=e,u=d.useRef(null),g="l"===i?1:-1,x=a?30:0,f=c?-12:0,p=d.useRef(null),[v,j]=d.useState(0);d.useEffect(()=>{var e,t;return j(null!==(e=null===(t=p.current)||void 0===t?void 0:t.getBBox().width)&&void 0!==e?e:0)},[JSON.stringify(s)]);const _=m-v;return o.jsxs(o.Fragment,{children:[s.map(e=>{var t;return null!==(t=e.lines)&&void 0!==t?t:[]}).flat().length>0&&o.jsxs(o.Fragment,{children:[o.jsx("line",{x1:(f+x)*g,x2:_*g,stroke:-1===l?"gray":"black",strokeWidth:.5}),o.jsx(U,{ref:p,groups:s,direction:i,transform:`translate(${_*g},-10.75)`})]}),a&&o.jsx("use",{xlinkHref:"#"+a,x:10*g,y:-30}),o.jsxs("g",{textAnchor:"l"===i?"start":"end",transform:`translate(${x*g},-14)`,children:[o.jsx(T,{ref:u,stnName:r,oneLine:h,directionPolarity:g,fill:-1===l?"gray":0===l?"red":"black"}),(null===(t=s[1])||void 0===t||null===(t=t.lines)||void 0===t?void 0:t.length)&&o.jsx("g",{transform:`translate(${(_+v/2)*g},-30)`,children:o.jsx(K,{osiInfos:s[1].lines})}),(null===(n=s[2])||void 0===n||null===(n=n.lines)||void 0===n?void 0:n.length)&&o.jsx("g",{transform:`translate(${(m+5)*g},0)`,children:o.jsx(Q,{osysiInfos:s[2].lines,direction:e.direction})})]})]})},T=d.forwardRef(function(e,n){const{stnName:r,oneLine:s,directionPolarity:i}=e,c=a(e,t),{zh:h="",en:m=""}=r,u=d.useRef(null),[g,x]=d.useState(0);d.useEffect(()=>{s&&u.current?x(u.current.getBBox().width+5):x(0)},[r.zh,r.en,s]);const[f,p]=[20,8];return o.jsx("g",l(l({ref:n},c),{},{children:d.useMemo(()=>o.jsxs(o.Fragment,{children:[o.jsx("g",{ref:u,children:h.split("\\").map((e,t,n)=>o.jsx("text",{className:"rmg-name__zh rmg-outline",dy:(n.length-1-t)*-f+(s?p:(m.split("\\").length-1)*-p),children:e},t))}),o.jsx("g",{fontSize:8,transform:`translate(${g*i},0)`,children:m.split("\\").map((e,t,n)=>o.jsx("text",{className:"rmg-name__en rmg-outline",dy:(n.length-2-t)*-p+2,children:e},t))})]}),[h,m,s,g,i])}))}),G=()=>{const{stn_list:e}=h(e=>e.param),t=[-1,35,50,75][new Set(Object.values(e).map(e=>e.services).flat()).size];return o.jsx("g",{transform:`translate(0, ${t})`,children:o.jsx("text",{className:"rmg-name__zh",fill:"red",textAnchor:"middle",children:"本站"})})},U=d.forwardRef(function(e,t){var r,s;const{groups:i,direction:d}=e,c=a(e,n),h=[...i[0].lines||[],...(null===(r=i[1])||void 0===r?void 0:r.lines)||[],...(null===(s=i[2])||void 0===s||null===(s=s.lines)||void 0===s?void 0:s.filter(e=>Boolean(e.name[0].match(/^磁(悬)*浮/))))||[]];let m=0;return o.jsx("g",l(l({ref:t,fontSize:14,textAnchor:"middle"},c),{},{children:h.map((e,t)=>{const n=Boolean(e.name[0].match(/^\w+(号)?线/)),r=Boolean(e.name[0].match(/^磁(悬)*浮/));let s;return"r"===d&&(m-=(n||r?20:14*e.name[0].length+12)+(0===t?0:5)),s=r?o.jsx("g",{transform:`translate(${m},-16)scale(0.1428571429)`,children:o.jsx(X,{info:e})},t):n?o.jsx("g",{transform:`translate(${m},0)`,children:o.jsx(Z,{info:e})},t):o.jsx("g",{transform:`translate(${m},0)`,children:o.jsx(q,{info:e})},t),"l"===d&&(m+=n||r?25:14*e.name[0].length+12+5),s})}))}),X=d.memo(function(e){var t,n;return o.jsx(o.Fragment,{children:o.jsx("use",{xlinkHref:"#intbox_maglev",fill:null===(t=e.info.theme)||void 0===t?void 0:t[2],stroke:null===(n=e.info.theme)||void 0===n?void 0:n[2]})})},(e,t)=>JSON.stringify(e.info)===JSON.stringify(t.info)),Z=d.memo(function(e){var t,n,r;return o.jsxs(o.Fragment,{children:[o.jsx("use",{xlinkHref:"#intbox_number",fill:null===(t=e.info.theme)||void 0===t?void 0:t[2]}),o.jsx("text",{x:10,className:"rmg-name__zh",fill:null===(n=e.info.theme)||void 0===n?void 0:n[3],dominantBaseline:"central",children:null===(r=e.info.name[0].match(/(\d*)\w+/))||void 0===r?void 0:r[0]})]})},(e,t)=>JSON.stringify(e.info)===JSON.stringify(t.info)),q=d.memo(function(e){var t,n;const r=e.info.name[0].split("\\")[0].length;return o.jsxs(o.Fragment,{children:[o.jsx("rect",{height:22,width:14*r+12,y:-11,fill:null===(t=e.info.theme)||void 0===t?void 0:t[2]}),o.jsx("text",{x:7*r+6,className:"rmg-name__zh",fill:null===(n=e.info.theme)||void 0===n?void 0:n[3],dominantBaseline:"central",children:e.info.name[0].split("\\")[0]})]})},(e,t)=>JSON.stringify(e.info)===JSON.stringify(t.info)),K=e=>{const t=e.osiInfos.map(e=>e.name[0]).join("，");return d.useMemo(()=>o.jsxs("g",{textAnchor:"middle",fontSize:"50%",children:[o.jsx("text",{className:"rmg-name__zh",dy:-5,children:`换乘${t}`}),o.jsx("text",{className:"rmg-name__zh",dy:5,children:"仅限公共交通卡"}),o.jsx("text",{className:"rmg-name__en",dy:12.5,fontSize:"75%",children:"Only for Public Transportation Card"})]}),[t.toString()])},Q=e=>{const t=e.osysiInfos.map(e=>e.name[0]).join("，"),n=e.osysiInfos.map(e=>e.name[1]).join(", ");return d.useMemo(()=>o.jsxs("g",{textAnchor:"l"===e.direction?"start":"end",fontSize:"50%",children:[o.jsxs("text",{className:"rmg-name__zh",dy:3,children:["转乘",t]}),o.jsxs("text",{className:"rmg-name__en",dy:10,fontSize:"75%",children:["To ",n]})]}),[JSON.stringify(e.osysiInfos),e.direction])},ee=["shanghai","sh4","#5F259F","#fff","4号线","Line 4"],te=e=>{const{xs:t,servicesPresent:n,stnStates:r}=e,{svg_height:s,direction:i,stn_list:a,current_stn_idx:c,branchSpacingPct:m,info_panel_type:u,coline:g}=h(e=>e.param),{branches:x,depsStr:p}=h(e=>e.helper),v=d.useMemo(()=>(console.log("computing y shares"),Object.keys(a).reduce((e,t)=>{if(x[0].includes(t))return l(l({},e),{},{[t]:0});{const n=x.slice(1).filter(e=>e.includes(t))[0];return l(l({},e),{},{[t]:a[n[0]].children.indexOf(n[1])?-3:3})}},{})),[p]),j=Object.entries(v).filter(([,e])=>e<=0).reduce((e,[t,n])=>l(l({},e),{},{[t]:n}),{}),_=Object.keys(j).reduce((e,t)=>l(l({},e),{},{[t]:-j[t]*m*s/300}),{}),$=d.useMemo(()=>((e,t)=>e.map(e=>{const n=f(e.linePath,t);return{main:[{linePath:n.main,colors:e.colors}],pass:[{linePath:n.pass,colors:e.colors}]}}).reduce((e,t)=>(e.main=[...e.main,...t.main],e.pass=[...e.pass,...t.pass],e),{main:[],pass:[]}))(I(Object.values(g).filter(e=>e.display),x),r),[JSON.stringify(g),c,i,p]),y=n.reduce((e,r)=>l(l({},e),{},{[r]:Object.keys($).reduce((e,s)=>l(l({},e),{},{[s]:$[s].map(e=>({path:ae(e.linePath,s,t,_,i,r,n.length,a,"diagonal"),colors:e.colors})).filter(e=>""!==e.path)}),{})}),{}),b=I(Object.values(g).filter(e=>e.display),x).map(e=>e.linePath).flat(),k="sh2020"===u?3:0;return o.jsx(o.Fragment,{children:o.jsxs("g",{id:"coline",transform:`translate(0,${12+k})`,children:[o.jsx(ne,{paths:y,direction:i}),o.jsx(re,{colineStns:$,branches:x,xs:t,ys:_,stnStates:r,lineWidth:12,colineGap:k}),o.jsx(se,{stnIds:Object.entries(v).filter(([,e])=>e<0).reduce((e,[t])=>[...e,t],[]).filter(e=>!["linestart","lineend"].includes(e)).filter(e=>0!==a[e].services.length).filter(e=>b.includes(e)),xs:t,ys:_,stnStates:r})]})})},ne=e=>{const{paths:t,direction:n}=e;return o.jsx(o.Fragment,{children:Object.keys(t).map((e,r)=>{var s,l;return o.jsx("g",{transform:`translate(0,${25*r})`,children:o.jsxs("g",{children:[null===(s=t[e])||void 0===s?void 0:s.pass.map((t,n)=>o.jsx(d.Fragment,{children:o.jsx("path",{stroke:"var(--rmg-grey)",strokeWidth:12,fill:"none",d:t.path,strokeLinejoin:"round",filter:e===u.local?void 0:`url(#contrast-${e})`},n)},n)),null===(l=t[e])||void 0===l?void 0:l.main.map((t,r)=>{var s;return o.jsxs(d.Fragment,{children:[t.colors.length>1&&o.jsx("linearGradient",{id:`grad${r}`,y1:"-100%",y2:"100%",x1:"0",x2:"0",gradientUnits:"userSpaceOnUse",children:t.colors.map((e,n)=>o.jsxs(d.Fragment,{children:[o.jsx("stop",{offset:100/t.colors.length*(n+0)+"%",stopColor:e[2]}),o.jsx("stop",{offset:100/t.colors.length*(n+1)+"%",stopColor:e[2]})]},n))}),"l"===n&&o.jsx("marker",{id:`arrow_left_${r}_${t.colors.map(e=>e[2]).join("_")}`,refY:.5,refX:1,children:o.jsx("path",{d:"M1,0L0,1H1z",fill:t.colors.length>1?`url(#grad${r})`:t.colors[0][2]})}),"r"===n&&o.jsx("marker",{id:`arrow_right_${r}_${t.colors.map(e=>e[2]).join("_")}`,refY:.5,children:o.jsx("path",{d:"M0,0L1,1H-1z",fill:t.colors.length>1?`url(#grad${r})`:t.colors[0][2]})}),o.jsx("path",{stroke:(null!==(s=t.colors.at(-1))&&void 0!==s?s:ee)[2],strokeWidth:12,fill:"none",d:t.path,markerStart:"l"===n?`url(#arrow_left_${r}_${t.colors.map(e=>e[2]).join("_")})`:void 0,markerEnd:"r"===n?`url(#arrow_right_${r}_${t.colors.map(e=>e[2]).join("_")})`:void 0,strokeLinejoin:"round",filter:e===u.local?void 0:`url(#contrast-${e})`},r)]},r)})]})},`servicePath${r}`)})})},re=e=>{const{colineStns:t,branches:n,xs:r,ys:s,stnStates:l,lineWidth:i,colineGap:a}=e,{line_name:d,theme:c,info_panel_type:m}=h(e=>e.param),u=[...t.main,...t.pass].map(e=>e.linePath.map(t=>{var n;return{curStn:t,x:r[t],y:s[t],color:null!==(n=e.colors.at(-1))&&void 0!==n?n:[...c,...d]}})).flat().reduce((e,t)=>e.find(e=>e.curStn===t.curStn)?e:e.concat(t),[]).filter(e=>n[0].includes(e.curStn));return console.log(u),o.jsx("g",{id:"stations_in_mainline",children:u.map(e=>{const{curStn:t,x:n,y:r,color:s}=e,d=(-1===l[t]?0:i)+a+i,c=(-1===l[t]?0:-i)-a-i/2;return o.jsx("g",{transform:`translate(${n},${r})`,children:"sh2020"===m?o.jsx("rect",{stroke:"none",height:d,width:12,x:-6,y:c,fill:-1===l[t]?"var(--rmg-grey)":s[2]}):o.jsx("use",{xlinkHref:"#int2_sh",stroke:"var(--rmg-theme-colour)",transform:`translate(0,${-i})`})},t)})})},se=e=>{const{xs:t,ys:n,stnStates:r,stnIds:s}=e,{branches:i,depsStr:a}=h(e=>e.helper),{line_name:c,theme:m,coline:u}=h(e=>e.param),g=d.useMemo(()=>I(Object.values(u),i),[JSON.stringify(u),a]),x=s.reduce((e,t)=>{var n;return l(l({},e),{},{[t]:null!==(n=g.filter(e=>e.linePath.includes(t)).map(e=>e.colors).flat().at(0))&&void 0!==n?n:[...m,...c]})},{});return o.jsx("g",{id:"stations_in_coline",children:s.map(e=>o.jsx("g",{transform:`translate(${t[e]},${n[e]})`,children:o.jsx(J,{stnId:e,stnState:r[e],color:x[e][2]})},e))})},le=()=>{const{routes:e,branches:t,depsStr:n}=h(e=>e.helper),r=h(e=>e.param),{svg_height:s,stn_list:i,branchSpacingPct:a,coline:c,direction:m}=h(e=>e.param),g=p(r.stn_list,()=>0,()=>0),x=v("linestart","lineend",g),$=v(x.nodes[1],x.nodes.slice(-2)[0],g),y=d.useMemo(()=>(console.log("computing x shares"),Object.keys(r.stn_list).reduce((e,n)=>l(l({},e),{},{[n]:j(n,g,t)}),{})),[t.toString(),JSON.stringify(g)]),b=[r.svgWidth.railmap*r.padding/100,r.svgWidth.railmap*(1-r.padding/100)],k=Object.keys(y).reduce((e,t)=>l(l({},e),{},{[t]:b[0]+y[t]/$.len*(b[1]-b[0])}),{}),w=d.useMemo(()=>(console.log("computing y shares"),Object.keys(i).reduce((e,n)=>{if(t[0].includes(n))return l(l({},e),{},{[n]:0});{const r=t.slice(1).filter(e=>e.includes(n))[0];return l(l({},e),{},{[n]:i[r[0]].children.indexOf(r[1])?-3:3})}},{})),[n]),S=Object.entries(w).filter(([,e])=>e>=0).reduce((e,[t,n])=>l(l({},e),{},{[t]:n}),{}),O=Object.keys(S).reduce((e,t)=>l(l({},e),{},{[t]:-S[t]*a*s/300}),{}),M=d.useMemo(()=>_(r.current_stn_idx,e,r.direction),[r.current_stn_idx,r.direction,e.toString()]),z=Object.values(u),N=Object.values(r.stn_list).map(e=>e.services).flat().reduce((e,t)=>(e[z.indexOf(t)]=!0,e),[!1,!1,!1]).map((e,t)=>[z[t],e]).filter(e=>e[1]).map(e=>e[0]),I=t.map(e=>f(e,M)).reduce((e,t)=>(e.main.push(t.main),e.pass.push(t.pass),e),{main:[],pass:[]}),H=N.reduce((e,t)=>l(l({},e),{},{[t]:Object.keys(I).reduce((e,n)=>l(l({},e),{},{[n]:I[n].map(e=>ae(e,n,k,O,m,t,N.length,i)).filter(e=>""!==e)}),{})}),{});return o.jsxs("g",{id:"main",transform:`translate(0,${r.svg_height*(Object.keys(c).length>0?.5:.7+.1)})`,children:[o.jsx(ie,{paths:H,direction:r.direction}),o.jsx(oe,{stnIds:Object.keys(S).filter(e=>!["linestart","lineend"].includes(e)).filter(e=>0!==i[e].services.length),xs:k,ys:O,stnStates:M}),Object.keys(c).length>0&&o.jsx(te,{xs:k,servicesPresent:N,stnStates:M}),N.length>1&&o.jsx(de,{servicesLevel:N,lineXs:b})]})},ie=e=>{const{theme:t}=h(e=>e.param),{paths:n,direction:r}=e;return o.jsx(o.Fragment,{children:Object.keys(n).map((s,l)=>{var i,a;return o.jsxs("g",{transform:`translate(0,${25*l})`,filter:"#B5B5B6"===t[2]?"url(#pujiang_outline)":void 0,children:[o.jsx("g",{children:null===(i=n[s])||void 0===i?void 0:i.pass.map((t,n)=>o.jsx("path",{stroke:"var(--rmg-grey)",strokeWidth:12,fill:"none",d:t,markerStart:"l"===e.direction?"url(#arrow_gray)":void 0,markerEnd:"r"===e.direction?"url(#arrow_gray)":void 0,strokeLinejoin:"round"},n))}),o.jsx("g",{children:null===(a=n[s])||void 0===a?void 0:a.main.map((e,t)=>o.jsx("path",{stroke:"var(--rmg-theme-colour)",strokeWidth:12,fill:"none",d:e,markerStart:"l"===r?"url(#arrow_theme_left)":void 0,markerEnd:"r"===r?"url(#arrow_theme_right)":void 0,strokeLinejoin:"round",filter:s===u.local?void 0:`url(#contrast-${s})`},t))})]},`servicePath${l}`)})})},ae=(e,t,n,r,s,l,i,a,o="rightangle")=>{let[d,c]=[];const h={},m={local:0,express:20,direct:40}[l],u=i>1?50:0;let g=30;if(e.length>0){let t=!1,n=!1;a[e.at(-1)||0].children.some(e=>["linestart","lineend"].includes(e))?n=!0:a[e.at(0)||0].parents.some(e=>["linestart","lineend"].includes(e))&&(t=!0),g=t||n?g:0}const x=30;if(e.forEach(e=>{const t=n[e],s=r[e];if(!d&&0!==d)return[c,d]=[t,s],void(h.start=[t,s]);0===s?s!==d&&(h.bifurcate=[c,d]):s!==d&&(h.bifurcate=[t,s]),h.end=[t,s],[c,d]=[t,s]}),"start"in h){if("end"in h){if("bifurcate"in h){const[e,n]=h.start,r=h.bifurcate[0],[l,i]=h.end;return"main"===t?"l"===s?i>n?(console.log(h),"rightangle"===o?`M ${e-g},${n} H ${l} V ${i}`:`M ${e},${n} H ${e+x} L ${r-x},${i} H ${l}`):"rightangle"===o?`M ${e},${n} V ${i} H ${l}`:`M ${e-g},${n} H ${r+x} L ${l-x},${i} H ${l}`:i>n?"rightangle"===o?`M ${e},${n} H ${l} V ${i}`:`M ${e},${n} H ${e+x} L ${r-x},${i} H ${l+g}`:"rightangle"===o?`M ${e},${n} V ${i} H ${l+g}`:`M ${e},${n} H ${r+x} L ${l-x},${i} H ${l}`:i>n?"rightangle"===o?`M ${e-g},${n} H ${l} V ${i}`:`M ${e},${n} H ${e+x} L ${r-x},${i} H ${l+g}`:"rightangle"===o?`M ${e},${n} V ${i} H ${l+g}`:`M ${e-g},${n} H ${r+x} L ${l-x},${i} H ${l}`}{const[e,n]=h.start,r=h.end[0];return"main"===t?"l"===s?`M ${e-g-m},${n} H ${r}`:`M ${e},${n} H ${r+g+m}`:"l"===s?`M ${e-g},${n} H ${r+g+u}`:`M ${e-g-u},${n} H ${r+g}`}}{const[e,n]=h.start;return"main"===t?"l"===s?`M ${e-g-m},${n} H ${e}`:`M ${e},${n} H ${e+g+m}`:"l"===s?`M ${e},${n} L ${e+g+u},${n}`:`M ${e-g-u},${n} L ${e},${n}`}}return""},oe=e=>{const{xs:t,ys:n,stnStates:r,stnIds:s}=e;return o.jsx("g",{children:s.map(e=>o.jsx("g",{transform:`translate(${t[e]},${n[e]})`,children:o.jsx(J,{stnId:e,stnState:r[e]})},e))})},de=e=>{const{svg_height:t,direction:n,svgWidth:r}=h(e=>e.param),s=130-t,l=e.servicesLevel.map(e=>({local:"普通车",express:"大站车",direct:"直达车"}[e])),i="r"===n?e.lineXs[0]-42:e.lineXs[1]+42,a=2===e.servicesLevel.length?350:500;return d.useMemo(()=>o.jsxs("g",{children:[l.map((e,t)=>o.jsxs("g",{transform:`translate(${i},${25*t})`,children:[o.jsx("rect",{x:-27.5,height:10,width:55,fill:"white",stroke:"black",y:-5}),o.jsx("text",{className:"rmg-name__zh",fontSize:9,y:3,textAnchor:"middle",children:`${e}运行线`})]},e)),o.jsxs("g",{transform:`translate(${"r"===n?30:r.railmap-a},${s})`,children:[o.jsx("text",{className:"rmg-name__zh",children:"图例："}),l.map((e,t)=>o.jsxs("g",{transform:`translate(${150*t+50},0)`,children:[o.jsx("line",{x1:"0",x2:"35",y1:"-5",y2:"-5",stroke:"var(--rmg-theme-colour)",strokeWidth:"12",filter:2===t?"url(#contrast-direct)":1===t?"url(#contrast-express)":""}),o.jsx("use",{x:"17.5",y:"-5",xlinkHref:"#stn_sh",fill:"var(--rmg-theme-colour)"}),o.jsx("text",{x:"40",className:"rmg-name__zh",children:`${e}停靠站`})]},`serviceLevel${t}`))]})]}),[t,n,r,e.servicesLevel,e.lineXs])},ce=()=>{const{direction:e,svgWidth:t,coline:n}=h(e=>e.param),r=!!Object.keys(n).length;return d.useMemo(()=>o.jsxs("g",{transform:`translate(${"l"===e?50:t.railmap-150},50)`,children:[o.jsx("text",{className:"rmg-name__zh",children:"列车前进方向"}),o.jsx("path",{d:"M60,60L0,0L60-60H100L55-15H160V15H55L100,60z",stroke:r?"var(--rmg-black)":void 0,strokeWidth:r?5:void 0,fill:r?"var(--rmg-white)":"var(--rmg-theme-colour)",transform:`translate(${"l"===e?-30:125},-5)rotate(${"l"===e?0:180})scale(0.15)`})]}),[e,n,t.railmap])},he=e=>{var t,n,r,s;const{stnId:l,nameDirection:i,services:a,color:d}=e,c=h(e=>e.param.stn_list[l]),m=[...(null===(t=c.transfer.groups[0])||void 0===t?void 0:t.lines)||[],...(null===(n=c.transfer.groups[1])||void 0===n?void 0:n.lines)||[]];let u;u=3===c.services.length?"direct_indoor_sh":2===c.services.length?"express_indoor_sh":null!==(r=null===(s=c.transfer.groups[1])||void 0===s||null===(s=s.lines)||void 0===s?void 0:s.length)&&void 0!==r&&r?"osi_indoor_sh":m.length>0?"int2_indoor_sh":"stn_indoor_sh";const g="left"===i||"right"===i?90:0;return o.jsxs(o.Fragment,{children:[o.jsx(me,{name:c.localisedName,groups:c.transfer.groups,nameDirection:i,services:a}),o.jsx("use",{xlinkHref:`#${u}`,stroke:m.length>0?"var(--rmg-black)":null!=d?d:"var(--rmg-theme-colour)",transform:`rotate(${g})`}),c.services.length>1&&o.jsx("text",{className:"rmg-name__zh",writingMode:"tb",fontSize:"60%",dy:"-12",children:`大站车${c.services.length>2?" 直达车":""}停靠`})]})},me=e=>{var t,n,r,s,l,i,a,c,h,m,u,g,x,f,p,v,j,_,$,y,b,k,w,S,O;const{name:M,groups:z,nameDirection:N,services:I}=e,H={upward:60,downward:-30,left:0,right:0}[N],W=null!==(t=z[2])&&void 0!==t&&null!==(t=t.lines)&&void 0!==t&&t.length?{upward:0,downward:0,left:((null===(n=z[0].lines)||void 0===n?void 0:n.length)||0)+((null===(r=z[1])||void 0===r||null===(r=r.lines)||void 0===r?void 0:r.length)||0)!==0?85:25,right:((null===(s=z[0].lines)||void 0===s?void 0:s.length)||0)+((null===(l=z[1])||void 0===l||null===(l=l.lines)||void 0===l?void 0:l.length)||0)!==0?-85:-25}[N]:0,L=null!==(i=z[2])&&void 0!==i&&null!==(i=i.lines)&&void 0!==i&&i.length?{upward:null!==(a=z[0])&&void 0!==a&&null!==(a=a.lines)&&void 0!==a&&a.length&&null!==(c=z[1])&&void 0!==c&&null!==(c=c.lines)&&void 0!==c&&c.length?-210:null!==(h=z[0])&&void 0!==h&&null!==(h=h.lines)&&void 0!==h&&h.length||null!==(m=z[1])&&void 0!==m&&null!==(m=m.lines)&&void 0!==m&&m.length?-177.5:-145,downward:(null!==(u=z[0])&&void 0!==u&&null!==(u=u.lines)&&void 0!==u&&u.length&&null!==(g=z[1])&&void 0!==g&&null!==(g=g.lines)&&void 0!==g&&g.length?185:null!==(x=z[0].lines)&&void 0!==x&&x.length||null!==(f=z[1])&&void 0!==f&&null!==(f=f.lines)&&void 0!==f&&f.length?157.5:125)+(3===I.length?40:0),left:null!==(p=z[0])&&void 0!==p&&null!==(p=p.lines)&&void 0!==p&&p.length&&null!==(v=z[1])&&void 0!==v&&null!==(v=v.lines)&&void 0!==v&&v.length?-67:null!==(j=z[0].lines)&&void 0!==j&&j.length||null!==(_=z[1])&&void 0!==_&&null!==(_=_.lines)&&void 0!==_&&_.length?-30:0,right:null!==($=z[0])&&void 0!==$&&null!==($=$.lines)&&void 0!==$&&$.length&&null!==(y=z[1])&&void 0!==y&&null!==(y=y.lines)&&void 0!==y&&y.length?-67:null!==(b=z[0].lines)&&void 0!==b&&b.length||null!==(k=z[1])&&void 0!==k&&null!==(k=k.lines)&&void 0!==k&&k.length?-30:0}[N]:0,P=d.useRef(null),[F,B]=d.useState(60);return d.useEffect(()=>{null!=P&&P.current&&B(Math.max(60,P.current.getBBox().width))},[M.zh,M.en]),o.jsxs("g",{transform:`translate(0,${H})`,children:["upward"===N||"downward"===N?o.jsxs(o.Fragment,{children:[o.jsx("line",{x1:-F/2,x2:F/2,y1:"upward"===N?-23:-10,y2:"upward"===N?-23:-10,stroke:"black"}),o.jsx("line",{y1:"upward"===N?-23:-10,y2:"upward"===N?-48:20,stroke:"black"})]}):o.jsxs(o.Fragment,{children:[o.jsx("line",{x1:"left"===N?-50:15,x2:"left"===N?-15:50,y1:0,y2:0,stroke:"black"}),o.jsx("line",{x1:"left"===N?-50:50,x2:"left"===N?-50:50,y1:-30,y2:30,stroke:"black"})]}),[...z[0].lines||[],...(null===(w=z[1])||void 0===w?void 0:w.lines)||[]].length&&o.jsx(ge,{intInfos:[z[0].lines||[],(null===(S=z[1])||void 0===S?void 0:S.lines)||[]],arrowDirection:N,services:I}),o.jsx(ue,{ref:P,stnName:M,nameDirection:N,fill:"black"}),(null===(O=z[2])||void 0===O||null===(O=O.lines)||void 0===O?void 0:O.length)&&o.jsx("g",{transform:`translate(${W},${L})`,children:o.jsx(xe,{osysiInfos:z[2].lines,nameDirection:N})})]})},ue=d.forwardRef(function(e,t){const{stnName:n,nameDirection:s}=e,i=a(e,r),{zh:c="",en:h=""}=n,m=c.split("\\"),u=h.split("\\").length,g={upward:0,downward:0,left:-60,right:60}[s],x={upward:-2,downward:-30-12*(u-1),left:-10*(u-1),right:-10*(u-1)}[s],f={upward:"middle",downward:"middle",left:"end",right:"start"}[s];return o.jsx("g",l(l({ref:t},i),{},{textAnchor:f,transform:`translate(${g},${x})`,children:d.useMemo(()=>{var e;return o.jsxs(o.Fragment,{children:[m.map((e,t,n)=>o.jsx("text",{className:"rmg-name__zh",dy:"upward"===s?16*t:-16*(n.length-1-t),children:e},t)),o.jsx("g",{fontSize:9.6,children:null===(e=h.split("\\"))||void 0===e?void 0:e.map((e,t)=>o.jsx("text",{className:"rmg-name__en",dy:12*(t+1)+("upward"===s&&m.length>1?7.5*m.length:0),children:e},t))})]})},[c,h])}))}),ge=e=>{var t,n,r,s,l,i,a,c,h,m,u,g,x;const{intInfos:f,arrowDirection:p,services:v}=e,j=f.flatMap(e=>e.map(e=>{var t;return null===(t=e.theme)||void 0===t?void 0:t[2]})).reduce((e,t)=>e+t,""),_=f.map(e=>[e.filter(e=>e.name[0].match(/^\d+.*$/)).map(e=>e.name[0].replace(/^(\d+)(.*)$/,"$1")).join("，").concat("号线"),e.filter(e=>!e.name[0].match(/^\d+.*$/)).map(e=>e.name[0]).join("，")].filter(e=>e&&"号线"!==e).join("，")),$=f.map(e=>["Line ".concat(e.filter(e=>/^(L|l)ine \d+$/.test(e.name[1])).map(e=>e.name[1].replace("Line","").replace("line","").trim()).join(",")),e.filter(e=>!/^(L|l)ine \d+$/.test(e.name[1])).map(e=>e.name[1]).join(", ")].filter(e=>e&&"Line "!==e).join(", ")),y=3===v.length?80:45,b={upward:-145,downward:125+(3===v.length?40:0),left:7,right:7}[p],k={upward:0,downward:0,left:20,right:-20}[p],w={upward:-74,downward:44,left:0,right:0}[p],S={upward:0,downward:180,left:90,right:-90}[p],O={upward:0,downward:0,left:85,right:-85}[p],M={upward:"middle",downward:"middle",left:"start",right:"end"}[p],z=O,N={upward:null!==(t=null===(n=f.at(0))||void 0===n?void 0:n.length)&&void 0!==t&&t?-177.5:-145,downward:(null!==(r=null===(s=f.at(0))||void 0===s?void 0:s.length)&&void 0!==r&&r?157.5:125)+(3===v.length?40:0),left:null!==(l=null===(i=f.at(0))||void 0===i?void 0:i.length)&&void 0!==l&&l?-30:7,right:null!==(a=null===(c=f.at(0))||void 0===c?void 0:c.length)&&void 0!==a&&a?-30:7}[p];return o.jsxs("g",{children:[o.jsx("path",{id:"int_indoor_arrow_sh",stroke:"var(--rmg-black)",strokeWidth:1,transform:`translate(${k},${w})rotate(${S})`,fill:1===f.flat().length?null===(h=f.flat()[0].theme)||void 0===h?void 0:h[2]:`url(#grad${j})`,d:`M -7.5,0 v -${y} h -7.5 l 15,-15 l 15,15 h -7.5 v ${y} Z`}),f.flat().length>1&&o.jsx("linearGradient",{id:`grad${j}`,y1:"0",y2:"0",x1:"upward"===p?"25%":"75%",x2:"upward"===p?"75%":"25%",children:f.flat().map((e,t)=>{var n,r;return o.jsxs(d.Fragment,{children:[o.jsx("stop",{offset:100/f.flat().length*t+"%",stopColor:null===(n=e.theme)||void 0===n?void 0:n[2]}),o.jsx("stop",{offset:100/f.flat().length*(t+1)+"%",stopColor:null===(r=e.theme)||void 0===r?void 0:r[2]})]},t)})}),(null!==(m=null===(u=f.at(0))||void 0===u?void 0:u.length)&&void 0!==m?m:0)>0&&o.jsxs("g",{transform:`translate(${O},${b})`,textAnchor:`${M}`,children:[o.jsx("text",{className:"rmg-name__zh",dy:-7,children:`换乘${_[0]}`}),o.jsx("text",{className:"rmg-name__en",dy:5,fontSize:9.6,children:`Interchange ${$[0]}`})]}),(null!==(g=null===(x=f.at(1))||void 0===x?void 0:x.length)&&void 0!==g?g:0)>0&&o.jsxs("g",{transform:`translate(${z},${N})`,textAnchor:`${M}`,children:[o.jsx("text",{className:"rmg-name__zh",dy:-7,children:`出站换乘${_[1]}`}),o.jsx("text",{className:"rmg-name__en",dy:5,fontSize:9.6,children:`Out-of-station Transfer ${$[1]}`})]})]})},xe=e=>{const t={upward:"middle",downward:"middle",left:"start",right:"end"}[e.nameDirection];return d.useMemo(()=>o.jsxs("g",{textAnchor:`${t}`,children:[o.jsx("text",{className:"rmg-name__zh",dy:-5,children:`转乘${e.osysiInfos.map(e=>e.name[0]).join("，")}`}),o.jsx("text",{className:"rmg-name__en",dy:7.5,fontSize:9.6,children:`To ${e.osysiInfos.map(e=>e.name[1]).join(", ")}`})]}),[JSON.stringify(e.osysiInfos),e.nameDirection])},fe=e=>{var t,n,r,s;const{loop_branches:l,edges:i,xs:a,ys:d,canvas:g}=e,[x,f,p,v]=i,{branches:j}=h(e=>e.helper),{current_stn_idx:_,direction:$,coline:y}=h(e=>e.param),b=g===m.RailMap?30:0,k=[`M ${x},${p} H ${Number(a[null!==(t=null===(n=l.at(0))||void 0===n?void 0:n.at(0))&&void 0!==t?t:""])-b}`,`M ${f},${p} H ${Number(a[null!==(r=null===(s=l.at(1))||void 0===s?void 0:s.at(-1))&&void 0!==r?r:""])+b}`],w=j[0].filter(e=>!["linestart","lineend"].includes(e)),S=Object.values(y).filter(e=>![e.from,e.to].every(e=>w.includes(e))).map(e=>e.colors);return o.jsx(o.Fragment,{children:l.map((e,t)=>{var n,r;return o.jsxs(c.Fragment,{children:[S.filter((e,t,n)=>t===n.findIndex(t=>{var n,r;return(null===(n=t.at(0))||void 0===n?void 0:n.at(2))===(null===(r=e.at(0))||void 0===r?void 0:r.at(2))})).map(e=>o.jsx("marker",{id:`arrow_theme_${e[0][2]}`,refX:1,refY:.5,children:o.jsx("path",{d:"M0,1H2L1,0z",fill:e[0][2]})},e[0][2])),o.jsx("path",{stroke:null!==(n=null===(r=S.at(t))||void 0===r||null===(r=r.at(0))||void 0===r?void 0:r.at(2))&&void 0!==n?n:"var(--rmg-theme-colour)",strokeWidth:12,fill:"none",d:k[t],markerEnd:g===m.RailMap&&("l"===$&&0===t||"r"===$&&1===t)?S.at(t)?`url(#arrow_theme_${S[t][0][2]})`:"url(#arrow_theme)":void 0}),e.filter(e=>!["linestart","lineend"].includes(e)).map(e=>{var n,r;return o.jsxs(c.Fragment,{children:[g===m.RailMap&&o.jsx("g",{transform:`translate(${a[e]},${d[e]})`,children:o.jsx(J,{stnId:e,stnState:_===e?0:1,bank:0,direction:$,color:null===(n=S.at(t))||void 0===n||null===(n=n.at(0))||void 0===n?void 0:n.at(2)})},e),g===m.Indoor&&o.jsx("g",{transform:`translate(${a[e]},${d[e]})`,children:o.jsx(he,{stnId:e,nameDirection:l.filter(t=>t.includes(e)).map(t=>t.indexOf(e)%2==0?"downward":"upward")[0],services:[u.local],color:null===(r=S.at(t))||void 0===r||null===(r=r.at(0))||void 0===r?void 0:r.at(2)})},e)]},e)})]},e.at(0))})})},pe=e=>{var t;const{edges:n,loop_stns:r,xs:s,ys:l,canvas:i}=e,[a,d,c,u]=n,{info_panel_type:x,stn_list:f,coline:p}=h(e=>e.param),{branches:v}=h(e=>e.helper),j=Object.values(p).filter(e=>[e.from,e.to].every(e=>v.slice(1,3).filter(e=>g(e,f)).flat().includes(e))).map(e=>e.colors).at(0),_=i===m.RailMap&&"sh2020"===x?3:0;return o.jsxs("g",{id:"coline_main",children:[o.jsx("path",{d:`M ${a},${c} H${d}`,strokeWidth:12,stroke:null==j||null===(t=j.at(0))||void 0===t?void 0:t.at(2)}),i===m.RailMap&&Object.keys(p).length>0&&r.top.map(e=>{var t;return o.jsx("g",{transform:`translate(${s[e]},${l[e]})`,children:"sh2020"===x?o.jsxs(o.Fragment,{children:[o.jsx("rect",{stroke:"none",height:24,width:12,x:-6,y:-_-1,fill:null==j||null===(t=j.at(0))||void 0===t?void 0:t.at(2)}),o.jsx("rect",{stroke:"none",height:_+12,width:12,x:-6,y:10,fill:"var(--rmg-theme-colour)"})]}):o.jsx("use",{xlinkHref:"#int2_sh",stroke:"var(--rmg-theme-colour)",transform:"translate(0,13)"})},e)})]})},ve=e=>{var t;const{bank_angle:n,canvas:r}=e,{branches:s}=h(e=>e.helper),{current_stn_idx:a,svgWidth:d,svg_height:c,padding:u,branchSpacingPct:x,direction:f,info_panel_type:p,stn_list:v,loop_info:{left_and_right_factor:j,bottom_factor:_},coline:$}=h(e=>e.param),y=s[0].filter(e=>!["linestart","lineend"].includes(e)),b=s.slice(0,3).flat().filter((e=>t=>2===(e[t]=(e[t]||0)+1))({})).filter(e=>!["linestart","lineend"].includes(e)),k=null!==(t=Object.values($).filter(e=>[e.from,e.to].every(e=>s.slice(1,3).filter(e=>g(e,v)).flat().includes(e))).map(e=>{const t=y.findIndex(t=>t===e.from),n=y.findIndex(t=>t===e.to);return Math.abs(n-t)>y.length-2-Math.abs(n-t)?"major":"minor"}).at(0))&&void 0!==t?t:"minor",w=b.at(1)?((e,t,n,r)=>{let s=e.findIndex(e=>e===t[0]),l=e.findIndex(e=>e===t[1]);[s,l,t[0],t[1]]=s>l?[l,s,t[1],t[0]]:[s,l,t[0],t[1]];const a=e.slice(s,l+1),o=e.filter(e=>!a.filter(e=>!t.includes(e)).includes(e)),d=e.length-("major"===r?Math.max:Math.min)(a.length,o.length)-2*n,c="major"===r?a.length>o.length?t[0]:t[1]:a.length>o.length?t[1]:t[0];return i(e,c,d,n)})(y,b,j,k):b.at(0)?i(y,b[0],_,j):((e,t,n,r)=>{const s=e.length-2*r-n,l=e.findIndex(e=>e===t),i=[...e,...e,...e],a=e.length+l-Math.floor(s/2)+(s%2==0?1:0),o=e.length+l+Math.floor(s/2);return{top:i.slice(a,o+1),left:i.slice(a-r,a),right:i.slice(o+1,o+1+r),bottom:i.slice(o+1+r,o+1+r+n)}})(y,a,_,j),{x_shares:S,y_shares:O}=((e,t)=>{const n=Object.fromEntries(e.map(e=>[e,-1])),r=Object.fromEntries(e.map(e=>[e,-1])),[s,l,i,a]=[0,1,0,1];return t.top.forEach((e,l)=>{n[e]=0+1/(t.top.length+1)*(l+1),r[e]=s}),t.right.forEach((e,s)=>{n[e]=a,r[e]=0+1/(t.right.length+1)*(s+1)}),t.bottom.forEach((e,s)=>{n[e]=1-1/(t.bottom.length+1)*(s+1),r[e]=l}),t.left.forEach((e,s)=>{n[e]=i,r[e]=1-1/(t.left.length+1)*(s+1)}),{x_shares:n,y_shares:r}})(y,w),{loop_branches:M,line_xs_branches:z,xs_branches:N}=((e,t,n,r,s,i)=>{var a,o,d,c;const h=e[0].filter(e=>!["linestart","lineend"].includes(e)),m=e.slice(1,3).map(e=>e.slice(1,e.length-1)),u=m.reduce((e,n)=>e+n.filter(e=>!["linestart","lineend",...t].includes(e)).length,0)+h.length-i-2*s,g=(n-n*r/100*2)/(1+u),x=[n*r/100+(null!==(a=m.at(0))&&void 0!==a?a:[]).length*g,n*(1-r/100)-(null!==(o=m.at(1))&&void 0!==o?o:[]).length*g],f=l(l({},Object.fromEntries((null!==(d=m.at(0))&&void 0!==d?d:[]).map((e,t)=>[e,n*r/100+t*g]))),Object.fromEntries((null!==(c=m.at(1))&&void 0!==c?c:[]).map((e,t)=>[e,x[1]+(1+t)*g])));return{loop_branches:m,line_xs_branches:x,xs_branches:f}})(s,b,d[r],u,j,w.bottom.length),I=l(l({},O),Object.fromEntries(M.flat().map(e=>[e,0]))),H=x*c/300,W=[225+H,c-75-(r===m.RailMap?0:125)-H],L=Object.keys(I).reduce((e,t)=>l(l({},e),{},{[t]:W[0]+I[t]*(W[1]-W[0])}),{}),P=[Math.max(d[r]*u/100+(n&&r===m.RailMap?100:0),z[0]),Math.min(d[r]*(1-u/100)-(n&&r===m.RailMap?100:0),z[1])],F=Object.keys(S).reduce((e,t)=>l(l({},e),{},{[t]:P[0]+S[t]*(P[1]-P[0])}),{}),B=n?{l:1,r:-1}[f]:0;[...w.right,...w.left].forEach(e=>{F[e]-=(L[e]-W[0])*B}),w.bottom.forEach(e=>{F[e]-=(W[1]-W[0])*B});const E=l(l({},N),F),R=je(w,E,L,B,[...P,...W],f),D=r===m.RailMap&&"sh2020"===p?3:0;Object.keys($).length>0&&w.top.forEach(e=>{L[e]-=D+12});const A=M.length?0:(W[1]-W[0])*B/2;return o.jsxs("g",{id:"loop",transform:`translate(${A},0)`,children:[o.jsx("path",{stroke:"var(--rmg-theme-colour)",strokeWidth:12,fill:"none",d:R,strokeLinejoin:"round"}),r===m.RailMap&&o.jsx(_e,{canvas:r,loop_stns:w,xs:E,ys:L}),o.jsxs("g",{transform:`translate(0,${Object.keys($).length>0?-12-D:0})`,children:[o.jsx(fe,{loop_branches:M,edges:[...P,...W],xs:E,ys:L,canvas:r}),Object.keys($).length>0&&o.jsx(pe,{edges:[...P,...W],loop_stns:w,xs:E,ys:L,canvas:r})]}),r===m.Indoor&&o.jsx(_e,{canvas:r,loop_stns:w,xs:E,ys:L})]})},je=(e,t,n,r,s,l)=>{const[i,a,o,d]=s,c=(e,t,n,s,l)=>({right:[n+(s-o)*r,t],bottom:[e-(d-t)*r,s],left:[n-(d-s)*r,t],top:[e+(t-o)*r,s]}[l]),h=[];e.top.forEach(e=>{h.push([t[e],n[e]])}),["right","bottom","left"].forEach(s=>{if(e[s].length>0)h.push(c(h.at(-1)[0],h.at(-1)[1],t[e[s][0]],n[e[s][0]],s)),e[s].forEach(e=>{h.push([t[e],n[e]])});else{const e={right:[a,h.at(-1)[1]],bottom:[h.at(-1)[0]+(d-h.at(-1)[1])*-r,h.at(-1)[1]+(d-h.at(-1)[1])],left:[i+(0===r?0:(d-o)*("l"===l?-1:1)),h.at(-1)[1]]};h.push(e[s])}}),h.push(c(h.at(-1)[0],h.at(-1)[1],t[e.top[0]],n[e.top[0]],"top"));const m=h.slice(1).map(([e,t])=>`L${e},${t} `).join(" ");return`M${h[0][0]},${h[0][1]} ${m} Z`},_e=e=>{const{canvas:t,loop_stns:n,xs:r,ys:s}=e,{current_stn_idx:l,stn_list:i}=h(e=>e.param),a={top:0,bottom:0,left:-1,right:1},d={left:"r",right:"l",top:void 0,bottom:void 0},c=(e,t)=>({top:t%2==0?"upward":"downward",bottom:t%2==0?"upward":"downward",left:"left",right:"right"}[e]);return o.jsxs("g",{id:"loop_stations",children:[t===m.RailMap&&Object.entries(n).map(([e,t])=>t.filter(e=>i[e].services.length).map(t=>o.jsx("g",{transform:`translate(${r[t]},${s[t]})`,children:o.jsx(J,{stnId:t,stnState:l===t?0:1,bank:a[e],direction:d[e]})},t))),t===m.Indoor&&Object.entries(n).map(([e,t])=>t.filter(e=>i[e].services.length).map((t,n)=>o.jsx("g",{transform:`translate(${r[t]},${s[t]})`,children:o.jsx(he,{stnId:t,nameDirection:c(e,n),services:[u.local]})},t)))]})},$e=m.RailMap;function ye(){const{canvasScale:e}=h(e=>e.app),{svgWidth:t,svg_height:n,theme:r,loop:s,loop_info:{bank:l}}=h(e=>e.param),i=t[$e];return o.jsxs(x,{type:$e,svgWidth:i,svgHeight:n,canvasScale:e,theme:r,children:[o.jsx(be,{}),s?o.jsx(ve,{bank_angle:l,canvas:m.RailMap}):o.jsx(le,{}),o.jsx(ce,{})]})}const be=d.memo(function(){return o.jsxs("defs",{children:[o.jsx("circle",{id:"stn_sh",fill:"var(--rmg-white)",strokeWidth:2,r:5}),o.jsx("path",{id:"int2_sh",fill:"var(--rmg-white)",strokeWidth:2,d:"M -5,0 a 5,5 0 1 1 10,0 V10 a 5,5 0 1 1 -10,0Z"}),o.jsx("path",{id:"express_sh",fill:"var(--rmg-white)",strokeWidth:2,d:"M -5,0 a 5,5 0 1 1 10,0 V25 a 5,5 0 1 1 -10,0Z"}),o.jsx("path",{id:"direct_sh",fill:"var(--rmg-white)",strokeWidth:2,d:"M -5,0 a 5,5 0 1 1 10,0 V50 a 5,5 0 1 1 -10,0Z"}),o.jsx("rect",{id:"stn_sh_2020",stroke:"none",height:24,width:12,x:-6,y:-18}),o.jsx("rect",{id:"stn_sh_2020_express",stroke:"none",height:49,width:12,x:-6,y:-18}),o.jsx("rect",{id:"stn_sh_2020_direct",stroke:"none",height:74,width:12,x:-6,y:-18}),o.jsx("rect",{id:"intbox_number",height:22,width:20,y:-11}),o.jsxs("g",{id:"intbox_maglev",transform:"translate(-25,0)",children:[o.jsx("rect",{id:"maglev_5",height:144,width:130,y:"40",x:"30",strokeWidth:10}),o.jsx("path",{id:"maglev_3",fill:"var(--rmg-white)",d:"m90,55a40,5 0 0 0 -40,3a5,5 0 0 0 -5,5a5,60 0 0 0 -3,60a5,5 0 0 0 5,5l96,0a5,5 0 0 0 5,-5a5,60 0 0 0 -3,-60a5,5 0 0 0 -5,-5a40,5 0 0 0 -40,-3l-5,-10l-5,10"}),o.jsx("path",{id:"maglev_4",fill:"var(--rmg-white)",d:"m90,140l-40,0a10,5 0 0 1 -10,-5l0,25a10,15 0 0 0 10,15l15,0l0,-10l-15,0l0,-15l90,0l0,15l-15,0l0,10l15,0a10,15 0 0 0 10,-15l0,-25a10,5 0 0 1 -10,5l-50,0"}),o.jsx("rect",{id:"maglev_1",height:"25",width:"40",y:"80",x:"50"}),o.jsx("rect",{id:"maglev_2",height:"25",width:"40",y:"80",x:"100"})]}),o.jsxs("g",{id:"airport",transform:"scale(0.5)",children:[o.jsx("circle",{cx:"0",cy:"29.33899",r:"29.33899",fill:"var(--rmg-grey)"}),o.jsx("path",{id:"airport",d:"M28.9769,6.60134c1.711.013,3.111,2.53205,3.111,4.241v10.337s17.106,15.435,17.358,15.666a1.145,1.145,0,0,1,.488,1.152v2.833c0,.651-.451.61-.695.467-.334-.119-17.151-8.863-17.151-8.863-.004,1.458-.797,9.006-1.326,13.304,0,0,4.61,2.457,4.699,2.521.334.268.352.359.352.852v2.001c0,.477-.352.428-.51.324-.183-.062-5.693-1.921-5.693-1.921a2.56018,2.56018,0,0,0-.633-.127,2.31654,2.31654,0,0,0-.666.127s-5.477,1.859-5.672,1.921c-.185.104-.523.153-.523-.324v-2.001c0-.493.029-.584.367-.852.086-.064,4.678-2.521,4.678-2.521-.524-4.298-1.307-11.846-1.325-13.304,0,0-16.822,8.744-17.148,8.863-.217.143-.69.184-.69-.467v-2.833a1.16206,1.16206,0,0,1,.473-1.152c.276-.231,17.365-15.666,17.365-15.666v-10.337c0-1.709,1.403-4.228,3.14105-4.241",transform:"translate(-28.9697,0.14347)",fill:"var(--rmg-white)"})]}),o.jsxs("g",{id:"disney",transform:"scale(0.5)",children:[o.jsx("circle",{cx:"0",cy:"29.33899",r:"29.33899",fill:"var(--rmg-grey)"}),o.jsx("path",{fill:"var(--rmg-white)",d:"M45.6152,7.85015a9.80248,9.80248,0,0,0-9.79907,9.801,9.70059,9.70059,0,0,0,.342,2.582c.002.026.002.055.002.093a.31815.31815,0,0,1-.31494.318.67741.67741,0,0,1-.12806-.02,15.71521,15.71521,0,0,0-13.498,0,.61.61,0,0,1-.122.02.31841.31841,0,0,1-.322-.318v-.067a9.62553,9.62553,0,0,0,.35608-2.608,9.803,9.803,0,1,0-9.797,9.8,10.10364,10.10364,0,0,0,2.308-.271h.05493a.31113.31113,0,0,1,.31409.318.32433.32433,0,0,1-.019.12,15.72588,15.72588,0,1,0,29.703,7.216,15.83676,15.83676,0,0,0-1.746-7.23.18417.18417,0,0,1-.0271-.106.31612.31612,0,0,1,.32007-.318h.057a10.15953,10.15953,0,0,0,2.316.271,9.80051,9.80051,0,0,0,0-19.601",transform:"translate(-28.9697 0.13398)"})]}),o.jsxs("g",{id:"railway",children:[o.jsx("circle",{cx:"0",cy:"29.33899",r:"29.33899",fill:"var(--rmg-grey)",transform:"translate(0,-2)scale(0.5)"}),o.jsx("path",{fill:"var(--rmg-white)",d:"M169,273.5c0-19,14.7-34.8,33.7-36.3c18.9-1.5,38.1-2.2,57.4-2.2c19.3,0,38.4,0.8,57.3,2.2  c19,1.5,33.7,17.3,33.7,36.3v47.3l-51.3,14.7c-11.2,3.2-18.9,13.4-18.9,25v147.8c0,17.4,12.2,32.3,29.3,35.7l110.6,22.1  c4.9,1,8.4,5.2,8.4,10.2V599H91v-22.7c0-5,3.5-9.2,8.4-10.2L209.9,544c17-3.4,29.3-18.3,29.3-35.7V360.5c0-11.6-7.7-21.8-18.9-25  L169,320.8V273.5z M309.4,31.7c0.2-1.2,0.3-2.4,0.3-3.6c0-14-11.1-25.4-24.9-26C276.6,1.4,268.3,1,260,1c-8.3,0-16.6,0.4-24.7,1.1  c-13.9,0.6-24.9,12-24.9,26c0,1.2,0.1,2.5,0.3,3.6C90.6,54.8,0,160.3,0,287c0,97.2,53.4,182,132.4,226.6l36.8-48.1  C104.3,432.4,59.8,364.9,59.8,287c0-110.6,89.6-200.2,200.2-200.2S460.2,176.4,460.2,287c0,77.9-44.5,145.4-109.4,178.5  c15,19.6,25.6,33.5,36.8,48.1C466.6,469,520,384.2,520,287C520,160.3,429.4,54.8,309.4,31.7z",transform:"translate(-10,0)scale(0.04)"})]}),o.jsx("marker",{id:"arrow_gray",viewBox:"-1.5 0 3 1.5",refY:.5,children:o.jsx("path",{d:"M0,0L1,1H-1z",fill:"var(--rmg-grey)"})}),o.jsx("marker",{id:"arrow_theme_left",refX:1,refY:.5,children:o.jsx("path",{d:"M1,0L0,1H1z",fill:"var(--rmg-theme-colour)"})}),o.jsx("marker",{id:"arrow_theme_right",refY:.5,children:o.jsx("path",{d:"M0,0L1,1H-1z",fill:"var(--rmg-theme-colour)"})}),o.jsx("marker",{id:"arrow_theme",refX:1,refY:.5,children:o.jsx("path",{d:"M0,1H2L1,0z",fill:"var(--rmg-theme-colour)"})}),o.jsx("filter",{id:"contrast-direct",filterUnits:"userSpaceOnUse",children:o.jsxs("feComponentTransfer",{children:[o.jsx("feFuncR",{type:"linear",slope:.5,intercept:.25}),o.jsx("feFuncG",{type:"linear",slope:.5,intercept:.25}),o.jsx("feFuncB",{type:"linear",slope:.5,intercept:.25})]})}),o.jsx("filter",{id:"contrast-express",filterUnits:"userSpaceOnUse",children:o.jsxs("feComponentTransfer",{children:[o.jsx("feFuncR",{type:"linear",slope:.75,intercept:.125}),o.jsx("feFuncG",{type:"linear",slope:.75,intercept:.125}),o.jsx("feFuncB",{type:"linear",slope:.75,intercept:.125})]})}),o.jsx(H,{})]})}),ke=m.Indoor;function we(){const{canvasScale:e}=h(e=>e.app),{svgWidth:t,svg_height:n,theme:r,loop:s}=h(e=>e.param),l=t[ke];return o.jsxs(x,{type:ke,svgWidth:l,svgHeight:n,canvasScale:e,theme:r,children:[o.jsx(Se,{}),s?o.jsx(ve,{bank_angle:!1,canvas:m.Indoor}):o.jsx(ze,{}),o.jsx(He,{})]})}const Se=d.memo(function(){return o.jsxs("defs",{children:[o.jsx("circle",{id:"stn_indoor_sh",fill:"var(--rmg-white)",strokeWidth:5,r:8,transform:"scale(1.5)"}),o.jsx("path",{id:"int2_indoor_sh",fill:"var(--rmg-white)",transform:"translate(0, -10)scale(2)",strokeWidth:4,d:"M -5,0 a 5,5 0 1 1 10,0 V10 a 5,5 0 1 1 -10,0Z"}),o.jsx("path",{id:"express_indoor_sh",fill:"var(--rmg-white)",transform:"translate(0, -10)scale(2)",strokeWidth:4,d:"M -5,0 a 5,5 0 1 1 10,0 V25 a 5,5 0 1 1 -10,0Z"}),o.jsx("path",{id:"direct_indoor_sh",fill:"var(--rmg-white)",transform:"translate(0, -10)scale(2)",strokeWidth:4,d:"M -5,0 a 5,5 0 1 1 10,0 V40 a 5,5 0 1 1 -10,0Z"}),o.jsxs("g",{id:"osi_indoor_sh",children:[o.jsx("line",{x1:"0",x2:"0",y1:"-12",y2:"12",stroke:"var(--rmg-black)",strokeWidth:22}),o.jsx("line",{x1:"0",x2:"0",y1:"-12",y2:"12",stroke:"var(--rmg-white)",strokeWidth:10}),o.jsx("circle",{cy:"-12",fill:"var(--rmg-white)",strokeWidth:5,r:8,transform:"scale(1.5)"}),o.jsx("circle",{cy:"12",fill:"var(--rmg-white)",strokeWidth:5,r:8,transform:"scale(1.5)"})]})]})}),Oe=(e,t)=>{let n=0;return 2===e[t].parents.length&&(n+=1),2===e[e[t].parents[0]].children.length&&(n+=1),n},Me=(e,t)=>{let n=0;return 2===e[t].children.length&&(n+=1),2===e[e[t].children[0]].parents.length&&(n+=1),n},ze=()=>{const{routes:e,branches:t,depsStr:n}=h(e=>e.helper),r=h(e=>e.param),s=p(r.stn_list,Oe,Me),i=v("linestart","lineend",s),a=v(i.nodes[1],i.nodes.slice(-2)[0],s),c=d.useMemo(()=>(console.log("computing x shares"),Object.keys(r.stn_list).reduce((e,n)=>l(l({},e),{},{[n]:j(n,s,t)}),{})),[t.toString(),JSON.stringify(s)]),m=[r.svgWidth.indoor*r.padding/100,r.svgWidth.indoor*(1-r.padding/100)],g=Object.keys(c).reduce((e,t)=>l(l({},e),{},{[t]:m[0]+c[t]/a.len*(m[1]-m[0])}),{}),x=d.useMemo(()=>$.getYShares(r.stn_list),[n]),f=Object.keys(x).reduce((e,t)=>l(l({},e),{},{[t]:x[t]*r.branchSpacingPct*r.svg_height/200}),{}),y=d.useMemo(()=>_(r.current_stn_idx,e,r.direction),[r.current_stn_idx,r.direction,e.toString()]),b=Object.values(u),k=Object.values(r.stn_list).map(e=>e.services).flat().reduce((e,t)=>(e[b.indexOf(t)]=!0,e),[!1,!1,!1]).map((e,t)=>[b[t],e]).filter(e=>e[1]).map(e=>e[0]),w=$.drawLine(t,y,r.stn_list,m,g,f,r.branchSpacingPct*r.svg_height/200,i,0);return o.jsxs("g",{id:"main",transform:`translate(0,${r.svg_height/2})`,children:[o.jsx(Ne,{paths:w,services:k}),o.jsx(Ie,{xs:g,ys:f,services:k})]})},Ne=e=>o.jsx("g",{fill:"none",strokeWidth:12,stroke:"var(--rmg-theme-colour)",children:e.services.map((t,n)=>o.jsxs("g",{transform:`translate(0, ${30*n})`,children:[e.paths.main.map((e,t)=>o.jsx("path",{d:e},t)),e.paths.pass.map((e,t)=>o.jsx("path",{d:e},t))]},`indoor_line_${n}`))}),Ie=e=>{const{branches:t}=h(e=>e.helper),{stn_list:n,namePosMTR:{isFlip:r}}=h(e=>e.param),{xs:s,ys:l,services:i}=e,a=null==r||r?"upward":"downward",d="upward"===a?"downward":"upward";return o.jsx("g",{children:Object.keys(n).filter(e=>!["linestart","lineend"].includes(e)).filter(e=>n[e].services.length).map(e=>o.jsx("g",{transform:`translate(${s[e]},${l[e]})`,children:o.jsx(he,{stnId:e,nameDirection:i.length>1?"downward":t.filter(t=>t.includes(e)).map(t=>t.indexOf(e)%2==0?a:d)[0],services:i})},e))})},He=d.memo(()=>{const{svg_height:e,svgWidth:{indoor:t},line_name:n,stn_list:r}=h(e=>e.param),s=Math.max(...Object.values(r).map(e=>{var t,n;return null!==(t=null===(n=e.transfer.groups.at(1))||void 0===n||null===(n=n.lines)||void 0===n?void 0:n.length)&&void 0!==t?t:0})),l=s>0?210:110;return o.jsxs(o.Fragment,{children:[o.jsx("g",{transform:`translate(${t/2},50)`,children:o.jsxs("text",{textAnchor:"middle",fontSize:"30",className:"rmg-name__zh",children:["轨道交通",n[0],"运营线路示意图"]})}),o.jsxs("g",{transform:`translate(${t/2},${e-270})`,children:[o.jsx("text",{textAnchor:"middle",fontSize:"18",className:"rmg-name__zh",dx:"-30",dy:"230",children:"友情提示：请留意您需要换乘线路的首末班时间，以免耽误您的出行，末班车进站前三分钟停售该末班车车票。"}),o.jsx("text",{textAnchor:"middle",fontSize:"12",className:"rmg-name__en",dx:"10",dy:"250",children:"Please pay attention to the interchange schedule if you want to transfer to other lines. Stop selling tickets 3 minutes before the last train services."}),o.jsxs("g",{transform:"translate(-700,215)",children:[o.jsx("rect",{x:"-5",y:"-25",width:l,height:"70",fill:"none",stroke:"black",rx:"5"}),o.jsx("line",{x1:"28",x2:"28",y1:"-20",y2:"40",stroke:"black"}),o.jsx("text",{className:"rmg-name__zh",dx:"3",fontSize:"18",children:"图"}),o.jsx("text",{className:"rmg-name__zh",dx:"3",dy:"18",fontSize:"18",children:"例"}),o.jsx("text",{className:"rmg-name__en",dy:"35",fontSize:"8",children:"legend"}),o.jsx("use",{transform:"translate(50,10)",xlinkHref:"#int2_indoor_sh",stroke:"var(--rmg-black)"}),o.jsx("text",{className:"rmg-name__zh",dx:"70",dy:"5",fontSize:"10",children:"换乘站"}),o.jsx("text",{className:"rmg-name__en",dx:"70",dy:"15",fontSize:"6",children:"Interchange"}),o.jsx("text",{className:"rmg-name__en",dx:"70",dy:"25",fontSize:"6",children:"Station"}),s>0&&o.jsxs(o.Fragment,{children:[o.jsx("use",{transform:"translate(120,10)scale(0.75)",xlinkHref:"#osi_indoor_sh",stroke:"var(--rmg-black)"}),o.jsx("text",{className:"rmg-name__zh",dx:"135",dy:"5",fontSize:"10",children:"出站换乘车站"}),o.jsx("text",{className:"rmg-name__en",dx:"135",dy:"15",fontSize:"6",children:"Out-of-station Transfer"}),o.jsx("text",{className:"rmg-name__en",dx:"135",dy:"25",fontSize:"6",children:"Station"})]})]})]})]})});He.displayName="InfoElements";s("default",{destination:o.jsx(b,{}),runin:o.jsx(L,{}),railmap:o.jsx(ye,{}),indoor:o.jsx(we,{})})}}})}();
