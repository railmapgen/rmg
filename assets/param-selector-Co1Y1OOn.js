import{j as R,ak as I,aV as M,aW as C,aj as T,e as v,ad as x,l as g,aX as A,r as h,aY as D,V as N,i as P,aO as _,aZ as j,a_ as E,m as k}from"./index-HyGScCuj.js";import{u as W,j as a,c as L,h as w,aC as F,aj as B,M as z,ak as U,J as $,K as Y,L as G,O as J,t as V,B as Z,s as H,a2 as m,N as K}from"./chakra-jT2-teuD.js";import{a as y,u as O}from"./react-BNX4K-US.js";var X=function(e){var t=e.children,n=e.noWrap,s=W("RmgOutput",{noWrap:n});return a.jsx(L.output,{sx:s,children:t})};function q(e){var t=e.fields,n=e.noLabel,s=e.minW;return a.jsx(w,{wrap:"wrap",children:t.map(function(i,l){if(i.hidden)return a.jsx(y.Fragment,{},l);var r=i.minW||s,c=r==="full";return a.jsx(R,{className:c?"mw-full":"",label:i.label,flex:c?void 0:1,minW:c?void 0:r,noLabel:n,oneLine:i.oneLine,helper:i.helper,errorMessage:i.errorMessage,children:function(o){switch(o.type){case"input":return a.jsx(T,{placeholder:o.placeholder,defaultValue:o.value,type:o.variant,validator:o.validator,onDebouncedChange:o.onChange,delay:o.debouncedDelay,optionList:o.optionList,isDisabled:o.isDisabled});case"output":return a.jsx(X,{noWrap:o.noWrap,children:o.value});case"textarea":return a.jsx(C,{placeholder:o.placeholder,defaultValue:o.value,onDebouncedChange:o.onChange,isDisabled:o.isDisabled});case"slider":return a.jsx(M,{defaultValue:o.value,min:o.min,max:o.max,step:o.step,onThrottledChange:o.onChange,leftIcon:o.leftIcon,rightIcon:o.rightIcon,isDisabled:o.isDisabled});case"select":return a.jsx(I,{defaultValue:o.value,onChange:function(u){var f,d=u.target.value;return(f=o.onChange)===null||f===void 0?void 0:f.call(o,typeof o.value=="number"?Number(d):d.toString())},options:o.options,disabledOptions:o.disabledOptions,isInvalid:o.isInvalid,isDisabled:o.isDisabled});case"switch":return a.jsx(F,{isChecked:o.isChecked,isDisabled:o.isDisabled,onChange:function(u){var f,d=u.target.checked;return(f=o.onChange)===null||f===void 0?void 0:f.call(o,d)}});case"custom":return o.component;default:return a.jsx("div",{})}}(i)},l)})})}const ye=(e,t,n)=>{const s=new Blob([n],{type:t});Q(e,s)},Q=(e,t)=>{const n=window.URL.createObjectURL(t),s=document.createElement("a");s.href=n,s.download=e,document.body.appendChild(s),s.click(),document.body.removeChild(s),window.URL.revokeObjectURL(n)},ve=e=>new Promise(t=>{const n=new FileReader;n.onloadend=()=>t(n.result),n.readAsText(e)}),je=()=>navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome"),ee=e=>{if(e){const t=new Date().getTime()-e;return t<60*1e3?["Just now"]:t<2*60*1e3?["1","minute ago"]:t<60*60*1e3?[Math.floor(t/1e3/60).toString(),"minutes ago"]:t<2*60*60*1e3?["1","hour ago"]:t<24*60*60*1e3?[Math.floor(t/1e3/60/60).toString(),"hours ago"]:t<48*60*60*1e3?["1","day ago"]:[Math.floor(t/1e3/60/60/24).toString(),"days ago"]}else return["Unknown"]},me=e=>new Promise(t=>{setTimeout(t,e)}),pe=e=>{"line_name"in e||(e.line_name=["路線名","Name of Line"]),delete e.fontZH,delete e.fontEN,delete e.weightZH,delete e.weightEN;for(const[t,n]of Object.entries(e.stn_list))"branch"in n||(e.stn_list[t].branch={},n.children.length===2&&(e.stn_list[t].branch.right=["through",n.children[1]]),n.parents.length===2&&(e.stn_list[t].branch.left=["through",n.parents[1]]),Object.keys(e.stn_list[t].branch).length===0&&delete e.stn_list[t].branch);"psd_num"in e?e.psd_num=e.psd_num.toString():e.psd_num="1","line_num"in e||(e.line_num="1"),e.theme.length===3&&e.theme.push("#fff");for(const[t,n]of Object.entries(e.stn_list))"num"in n||(e.stn_list[t].num="00"),"interchange"in n&&n.interchange.map(s=>s.forEach(i=>{i.length===5&&i.splice(3,0,"#fff")}));for(const[t,n]of Object.entries(e.stn_list))n.change_type==="osi22_end_p"&&(e.stn_list[t].change_type="osi22_pr"),n.change_type==="osi22_end_u"&&(e.stn_list[t].change_type="osi22_ur");for(const[t,n]of Object.entries(e.stn_list))"interchange"in n||(e.stn_list[t].interchange=[[]]);"info_panel_type"in e?e.info_panel_type=(t=>{switch(t){case"gz_1":case"panasonic":return"gz28";case"gz_2":return"gz6";case"gz_3":return"gz3";default:return t}})(e.info_panel_type):e.info_panel_type="gz28","direction_gz_x"in e||(e.direction_gz_x=50),"direction_gz_y"in e||(e.direction_gz_y=70);for(const[t,n]of Object.entries(e.stn_list))"transfer"in n||(e.stn_list[t].transfer={tick_direc:n.change_type==="none"||n.change_type==="int2"?"r":n.change_type?.split("_")[1].split("").slice().reverse()[0],paid_area:n.change_type?.indexOf("osi")!==-1?n.change_type?.split("_")[1][0]==="p":!0,osi_names:n.change_type?.indexOf("osi")!==-1?[n.interchange[1][0]]:[],info:n.interchange.length===2?[n.interchange[0],n.interchange[1].slice(1)]:n.interchange}),delete e.stn_list[t].change_type,delete e.stn_list[t].interchange;for(const[t,n]of Object.entries(e.stn_list))"services"in n||(e.stn_list[t].services=["local"]),"facility"in n?n.facility===""&&(e.stn_list[t].facility=void 0):e.stn_list[t].facility=n.usage||void 0,delete e.stn_list[t].usage;"customiseMTRDest"in e||(e.customiseMTRDest={isLegacy:e.dest_legacy||!1,terminal:!1}),delete e.dest_legacy,"svgWidth"in e||(e.svgWidth={destination:e.svg_dest_width,runin:e.svg_dest_width,railmap:e.svg_width,indoor:e.svg_width}),"indoor"in e.svgWidth||(e.svgWidth.indoor=e.svgWidth.railmap),delete e.svg_width,delete e.svg_dest_width,e.notesGZMTR=e.notesGZMTR?.map(t=>t.length===4?t.concat([!1]):t),delete e.char_form,delete e.show_outer,delete e.strip_pc,delete e.txt_bg_gap,"namePosMTR"in e||(e.namePosMTR={isStagger:!0,isFlip:e.txt_flip}),delete e.txt_flip,Object.keys(e.stn_list).forEach(t=>{"secondaryName"in e.stn_list[t]&&e.stn_list[t].secondaryName===!1&&delete e.stn_list[t].secondaryName,"type"in e.stn_list[t].transfer&&delete e.stn_list[t].transfer.type}),e.style=e.style===void 0||!Object.values(v).includes(e.style)?v.MTR:e.style,e.coline=e.coline??[],e.loop=e.loop??!1,e.loop_info=e.loop_info??{bank:!0,left_and_right_factor:0,bottom_factor:1},e.loop_info.left_and_right_factor+e.loop_info.bottom_factor===0&&(e.loop_info.left_and_right_factor=1);for(const[t,n]of Object.entries(e.stn_list))"loop_pivot"in n||(e.stn_list[t].loop_pivot=!1);return Array.isArray(e.coline)&&(e.coline=e.coline.reduce((t,n)=>({...t,[x(4)]:n}),{})),e.platform_num===!1&&(e.platform_num=""),Object.values(e.stn_list).forEach(t=>{const n=t;n.one_line=n.one_line??!1,n.int_padding=n.int_padding??(e.loop?250:355)}),e.branchSpacingPct===void 0&&(e.style===v.SHMetro?e.branchSpacingPct=Math.round(e.branch_spacing/e.svg_height*300):e.branchSpacingPct=Math.round(e.branch_spacing/e.svg_height*200),delete e.branch_spacing),te(e),ne(e),se(e),ie(e),ce(e),e},te=e=>{for(const[t,n]of Object.entries(e.stn_list)){const s=n.transfer.info;s&&(e.stn_list[t].transfer.groups=s.map((i,l)=>i.length?{name:n.transfer.osi_names[l-1],lines:i.map(r=>{const c=r;return{theme:c.slice(0,4),name:c.slice(4,6)}})}:{lines:[]})),delete e.stn_list[t].transfer.info,delete e.stn_list[t].transfer.osi_names}},ne=e=>{for(const[t,n]of Object.entries(e.stn_list)){const{name:s,secondaryName:i,localisedName:l,localisedSecondaryName:r}=n;!l&&s&&(e.stn_list[t].localisedName={zh:s[0],en:s[1]},delete e.stn_list[t].name),!r&&i&&(e.stn_list[t].localisedSecondaryName={zh:i[0],en:i[1]},delete e.stn_list[t].secondaryName)}},se=e=>{const{svgWidth:t}=e;D.Platform in t||(e.svgWidth.platform=1200);for(const[n,s]of Object.entries(e.stn_list)){const{character_spacing:i}=s;i===void 0&&(e.stn_list[n].character_spacing=75)}},ie=e=>{"psdLabel"in e||(e.psdLabel=N.screen)},p=e=>e.length===4&&e.every(t=>typeof t=="string")&&!!e[2].match(/^#[0-9a-fA-F]{6}$/)&&Object.values(P).includes(e[3]),oe=e=>{const t=[],n=(s,i)=>{if(Array.isArray(s)&&p(s)){t.push({path:i||"",value:s});return}for(const l in s){const r=s[l],c=i?`${i}.${l}`:l;Array.isArray(r)?p(r)?t.push({path:c,value:r}):r.forEach((o,u)=>n(o,`${c}.${u}`)):r&&typeof r=="object"&&n(r,c)}};return n(e),t},re=(e,t)=>{const n={},s=(i,l,r)=>{let c=i;for(let u=0;u<r.length-1;u++){if(r[u]==="*"){Object.keys(c).forEach(f=>s(c,[...l,...r.slice(0,u)],[f,...r.slice(u+1)]));return}if(c=c?.[r[u]],c===void 0)return}c?.[r[r.length-1]]!==void 0&&(n[[...l,...r].join(".")]=c?.[r[r.length-1]])};return s(e,[],t.split(".")),n},S=(e,t,n)=>{const s=t.split(".");let i=e;for(let l=0;l<s.length-1;l++)i=i[s[l]];i[s[s.length-1]]=n},xe=async e=>{const t=new Date().getTime(),n=oe(e);g.info("Found all themes pending for update",n);const s=JSON.parse(JSON.stringify(e)),i=5e3;let l,r=!1;const c=new Promise((o,u)=>{l=setTimeout(()=>{r=!0,u(`Executing time exceeds ${i}ms`)},i),(async()=>{for(const{path:f,value:d}of n){if(r)throw new Error("Update aborted");const b=await A(d);S(s,f,b)}})().then(o).catch(u)});try{return await c,g.info(`Themes update completed, elapsed time ${(new Date().getTime()-t)/1e3} sec`),s}catch(o){return g.warn(`Error occurs when updating themes, elapsed time ${(new Date().getTime()-t)/1e3} sec`,o),s}finally{clearTimeout(l)}},le={notesGZMTR:e=>!e?.length,"stn_list.*.branch.left":e=>!e?.length,"stn_list.*.branch.right":e=>!e?.length,"stn_list.*.branch":e=>!e||Object.keys(e).length===0,"stn_list.*.facility":e=>!e,"stn_list.*.transfer.groups.*.lines":e=>!e?.length},ce=e=>{const t=structuredClone(e);return Object.entries(le).forEach(([n,s])=>{Object.entries(re(t,n)).forEach(([i,l])=>{g.debug("Sanitising",i,l),s(l)&&S(t,i,void 0)})}),t.version=h.getAppVersion(),t},ae=()=>{const e=`${h.getAppName()}__${_.PARAM_CONFIG_BY_ID}`,t=Object.entries(h.storage.getAll()).filter(([n])=>n.startsWith(e)).map(([n,s])=>{const i=n.slice(e.length);if(s)try{return{...JSON.parse(s),id:i}}catch{return{id:i}}else return{id:i}});return g.info("loadParamRegistry(), Found param config in localStorage",t.map(n=>n.id)),t},we=()=>{const e=ae(),t=`${h.getAppName()}__${_.PARAM_BY_ID}`,n=Object.keys(h.storage.getAll()).filter(s=>s.startsWith(t)).map(s=>{const i=s.slice(t.length);return e.find(l=>l.id===i)??{id:i}});return g.info("getParamRegistry(), Actual param found in localStorage",n.map(s=>s.id)),e.filter(s=>n.every(i=>i.id!==s.id)).forEach(s=>h.storage.remove(_.PARAM_CONFIG_BY_ID+s.id)),n},de=e=>{const t=h.storage.get(_.PARAM_CONFIG_BY_ID+e);return t?JSON.parse(t):void 0},Oe=e=>{const t=h.storage.get(_.PARAM_BY_ID+e);return{param:t&&JSON.parse(t),config:de(e)}},ue=(e,t)=>{const n=x();return h.storage.set(_.PARAM_BY_ID+n,e),h.storage.set(_.PARAM_CONFIG_BY_ID+n,JSON.stringify({name:t,lastModified:Date.now()})),n},Se=async e=>{const t=e.split("/").at(-1);try{const n=await fetch(e);if(n.ok){const s=await n.text();return ue(s,t)}else return g.warn("Failed to download param"),null}catch(n){return g.warn("Failed to download param.",n),null}};function fe(e){const{config:t,onClose:n,onUpdate:s}=e,{t:i}=O(),[l,r]=y.useState(t?.name??"");y.useEffect(()=>{t&&r(t.name??"")},[t]);const c=[{type:"input",label:i("Project name"),value:l,onChange:r,debouncedDelay:0}],o=()=>{t&&(t.name??"")!==l&&s({...t,name:l})};return a.jsxs(B,{isOpen:!!t,onClose:n,isCentered:!0,children:[a.jsx(z,{}),a.jsxs(U,{children:[a.jsx($,{children:i("Edit project info")}),a.jsx(Y,{}),a.jsx(G,{children:a.jsx(q,{fields:c})}),a.jsx(J,{children:a.jsx(V,{colorScheme:"primary",onClick:o,children:i("Confirm")})})]})]})}const he={flex:"2 1 0%",overflow:"hidden",minW:{base:"unset",md:240},w:{base:"100%",md:"unset"},mr:{base:0,md:2},mb:{base:2,md:0},"& > div":{flexDirection:"column",h:200,overflowX:"hidden",overflowY:"auto",borderRadius:"md",borderWidth:2,"& >.chakra-button":{alignItems:"center"},"& .chakra-button__group":{"& button:not(:first-of-type)":{h:"100%"}}}};function Re(e){const{paramRegistry:t,downloading:n,selectedParam:s,onParamSelect:i,onParamRemove:l,onParamUpdate:r}=e,{t:c}=O(),[o,u]=y.useState(),f=d=>{r?.(d),u(void 0)};return a.jsxs(Z,{sx:he,children:[a.jsxs(w,{children:[n&&a.jsx(j,{variant:"ghost",primaryText:c("Downloading")+"...",secondaryText:n,isDisabled:!0}),t.slice().sort((d,b)=>(b.lastModified??0)-(d.lastModified??0)).map(d=>a.jsxs(H,{size:"sm",isAttached:!0,colorScheme:s===d.id?"primary":void 0,variant:s===d.id?"solid":"ghost",children:[a.jsx(j,{primaryText:d.name??c("Project")+" "+d.id,secondaryText:c("Last modified")+": "+ee(d.lastModified).map(b=>c(b)).join(" "),"aria-pressed":s===d.id,onClick:()=>i(d.id)}),r&&a.jsx(m,{"aria-label":c("Edit project info"),title:c("Edit project info"),icon:a.jsx(E,{}),onClick:()=>u(d)}),l&&a.jsx(m,{"aria-label":c("Remove project"),title:c("Remove project"),icon:a.jsx(k,{}),onClick:()=>l(d.id)})]},d.id))]}),t.length>=10&&a.jsx(K,{as:"em",fontSize:"xs",children:c("You have reached the maximum number of projects.")}),a.jsx(fe,{config:o,onClose:()=>u(void 0),onUpdate:f})]})}export{Re as P,q as R,ye as a,ue as b,we as c,Q as d,Oe as e,xe as f,de as g,Se as h,je as i,ve as r,ce as s,pe as u,me as w};
