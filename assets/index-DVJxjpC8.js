import{j as e}from"./chakra-wEho0Aiu.js";import{a as k,d as Q}from"./react-Caefwd5V.js";import{aV as W,u as w,m as F}from"./index-C2NFXcxx.js";import{i as U}from"./app-router-CepQYJ7M.js";import{S as q}from"./svg-wrapper-De-OsOcz.js";import{d as Ne,a as ke,c as J,g as we,b as Me}from"./share-Cu8tq7x5.js";import{a as ue}from"./mtr-CtvGRPHv.js";import"./param-selector-D8cRRNp9.js";const Le=(r,s,t,n)=>{const i=r.length-n*2-t,h=r.findIndex(o=>o===s),c=[...r,...r,...r],l=r.length+h-Math.floor(i/2)+(i%2===0?1:0),a=r.length+h+Math.floor(i/2);return{top:c.slice(l,a+1),left:c.slice(l-n,l),right:c.slice(a+1,a+1+n),bottom:c.slice(a+1+n,a+1+n+t)}},be=(r,s,t,n)=>{const i=r.length-n*2-t,h=[...r,...r,...r],c=r.length+r.findIndex(o=>o===s),l=h[c+i-1],a=r.length+r.findIndex(o=>o===l)+(c+i>r.length*2?r.length:0);return{top:h.slice(c,a+1),left:h.slice(c-n,c),right:h.slice(a+1,a+1+n),bottom:h.slice(a+1+n,a+1+n+t)}},Ee=(r,s,t,n)=>{let i=r.findIndex(d=>d===s[0]),h=r.findIndex(d=>d===s[1]);[i,h,s[0],s[1]]=i>h?[h,i,s[1],s[0]]:[i,h,s[0],s[1]];const c=r.slice(i,h+1),l=r.filter(d=>!c.filter(f=>!s.includes(f)).includes(d)),a=r.length-(n==="major"?Math.max:Math.min)(c.length,l.length)-t*2,o=n==="major"?c.length>l.length?s[0]:s[1]:c.length>l.length?s[1]:s[0];return be(r,o,a,t)},We=(r,s)=>{const t=Object.fromEntries(r.map(o=>[o,-1])),n=Object.fromEntries(r.map(o=>[o,-1])),[i,h,c,l]=[0,1,0,1],a=0;return s.top.forEach((o,d)=>{t[o]=a/2+(1-a)/(s.top.length+1)*(d+1),n[o]=i}),s.right.forEach((o,d)=>{t[o]=l,n[o]=a/2+(1-a)/(s.right.length+1)*(d+1)}),s.bottom.forEach((o,d)=>{t[o]=1-a/2-(1-a)/(s.bottom.length+1)*(d+1),n[o]=h}),s.left.forEach((o,d)=>{t[o]=c,n[o]=1-a/2-(1-a)/(s.left.length+1)*(d+1)}),{x_shares:t,y_shares:n}},Be=(r,s,t,n)=>{const i=r[0].filter(a=>!["linestart","lineend"].includes(a)),h=[...i,...i,...i],c=s==="r"?h:h.reverse(),l=c.findIndex(a=>n===a)+i.length;return c.slice(l+1).filter(a=>t[a].loop_pivot).slice(void 0,2)},pe=W.Destination;function Te(){const{canvasScale:r}=w(h=>h.app),{svgWidth:s,svg_height:t,theme:n}=w(h=>h.param),i=s[pe];return e.jsxs(q,{type:pe,svgWidth:i,svgHeight:t,canvasScale:r,theme:n,children:[e.jsx(Pe,{}),e.jsx(Ce,{})]})}const Pe=k.memo(function(){return e.jsx("defs",{children:e.jsx("marker",{id:"slope",viewBox:"-1.5 0 3 1.5",refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:"var(--rmg-theme-colour)"})})})}),Ce=()=>{const{routes:r,branches:s}=w(v=>v.helper),{line_name:t,theme:n,current_stn_idx:i,direction:h,stn_list:c,info_panel_type:l,loop:a,coline:o}=w(v=>v.param),d=(v,S,$)=>[...new Set(v.filter(N=>N.includes($)).map(N=>{const y=N.filter(M=>!["linestart","lineend"].includes(M));return S==="l"?y[0]:y.reverse()[0]}))],f=(v,S)=>S?[[v.map($=>c[$].localisedName.zh).join("，"),v.map($=>c[$].localisedName.en).join(", ")].map($=>$.replace("\\",""))]:v.map($=>{const{zh:N="",en:y=""}=c[$].localisedName;return[N.replace("\\",""),y.replace("\\","")]}),j=a?Be(s,h,c,i):d(r,h,i),p=(a?d(r,h,i):j).filter(v=>s.slice(1).filter(S=>U(S,c)).some(S=>S.includes(v))),x=j.filter(v=>!p.includes(v)),g=f(x,!a&&l!=="sh2020"),m=f(p,!0),u=250,_=Object.fromEntries(p.map(v=>[v,Object.values(o).filter(S=>S.from===v||S.to===v).at(0)]).filter(([,v])=>v));return e.jsxs(e.Fragment,{children:[e.jsx(je,{dest_names:g,line_name:t,line_color:[n[2],n[3]],coline:!!p.length,upper:!!p.length}),p.length&&p.map(v=>{var S,$,N;return e.jsx("g",{transform:"translate(0,".concat(-u,")"),children:e.jsx(je,{dest_names:[m.at(0)],line_name:(S=_[v])==null?void 0:S.colors.at(0).slice(4),line_color:[($=_[v])==null?void 0:$.colors.at(0)[2],(N=_[v])==null?void 0:N.colors.at(0)[3]],coline:!0,upper:!1})},"coline_".concat(v))})]})},je=r=>{const{dest_names:s,line_name:t,line_color:n,coline:i,upper:h}=r,{current_stn_idx:c,direction:l,platform_num:a,svgWidth:o,svg_height:d}=w(S=>S.param),f=k.useRef(null),[j,p]=k.useState({width:0});k.useEffect(()=>{f.current&&p(f.current.getBBox())},[JSON.stringify(s),JSON.stringify(c)]);const[x,g,m,u,_]=[o.destination/2,10,36,264,325],v=x-g-m-j.width>=_/2&&x-g-m-u>=_/2?x:l==="l"?(o.destination+j.width-u)/2:(o.destination-j.width+u)/2;return e.jsxs("g",{transform:"translate(0,".concat(d-300,")"),children:[e.jsx("path",{stroke:n[0],strokeWidth:12,d:l==="l"?"M".concat(o.destination-24,",16 H 36"):"M24,16 H ".concat(o.destination-36),transform:"translate(0,".concat(h?-20:220,")"),markerEnd:i?void 0:"url(#slope)"}),e.jsx(Fe,{ref:f,dest_names:s}),a!==""&&e.jsx("g",{transform:"translate(".concat(v,",0)"),children:e.jsx(De,{})}),t[0].match(/^[\w\d]+(号)?线/)?e.jsx(Re,{line_name:t,line_color:n}):e.jsx(Ae,{line_name:t,line_color:n})]})},Fe=k.forwardRef(function(s,t){const{dest_names:n}=s,{direction:i,svgWidth:h}=w(c=>c.param);return e.jsxs("g",{ref:t,transform:"translate(".concat(i==="l"?36:h.destination-36,",145)"),children:[e.jsx("g",{transform:"translate(0,".concat(n.length===2?-20:20,")"),children:e.jsx("path",{d:"M60,60L0,0L60-60H100L55-15H160V15H55L100,60z",fill:"black",transform:"rotate(".concat(i==="l"?0:180,")scale(0.8)")})}),e.jsx("g",{textAnchor:i==="l"?"start":"end",transform:"translate(".concat(i==="l"?148:-148,",25)"),children:n.map((c,l)=>e.jsxs(k.Fragment,{children:[e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:70,dy:l*-100+7,children:"往"+c[0]},"zh".concat(l)),e.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:25,dy:l*-100+40,children:"To "+c[1]},"en".concat(l))]},l))})]})}),De=()=>{const{platform_num:r}=w(s=>s.param);return k.useMemo(()=>e.jsxs("g",{transform:"translate(".concat(-325/2+60,",150)"),children:[e.jsx("circle",{r:60,fill:"none",stroke:"black",strokeWidth:2}),e.jsx("text",{className:"rmg-name__en rmg-outline",dominantBaseline:"central",fontSize:120,textAnchor:"middle",children:r}),e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:100,dominantBaseline:"central",x:65,children:"站台"})]}),[r])},Ae=r=>{const{line_name:s,line_color:t}=r,{direction:n,svgWidth:i}=w(f=>f.param),h=n==="l"?i.destination-42:42,c=k.useRef(null),[l,a]=k.useState({width:0});k.useEffect(()=>{c.current&&a(c.current.getBBox())},[...s]);const o=(n==="l"?-l.width:0)-6,d=(n==="l"?-1:1)*l.width/2;return k.useMemo(()=>e.jsxs("g",{transform:"translate(".concat(h,",92)"),children:[e.jsx("rect",{fill:t[0],x:o,width:l.width+10,height:120}),e.jsxs("g",{textAnchor:n==="r"?"start":"end",transform:"translate(0,68)",fill:t[1],children:[e.jsx("g",{ref:c,children:e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:68,children:s[0]})}),e.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:30,textAnchor:"middle",x:d,dy:42,children:s[1]})]})]}),[l,...s,...t,n,i.destination])},Re=r=>{const{line_name:s,line_color:t}=r,{direction:n,svgWidth:i}=w(a=>a.param),[h,c]=s[0].match(/^[\w\d]+|.+/g),l=n==="l"?i.destination-36-210:90;return k.useMemo(()=>e.jsxs("g",{transform:"translate(".concat(l,",92)"),children:[e.jsx("rect",{fill:t[0],x:-54,width:108,height:120}),e.jsx("text",{className:"rmg-name__zh rmg-outline",fill:t[1],fontSize:96,textAnchor:"middle",dominantBaseline:"central",transform:"translate(0,60)",letterSpacing:-5,children:h}),e.jsxs("g",{textAnchor:"start",transform:"translate(74,68)",children:[e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:68,children:c}),e.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:30,dy:42,children:s[1]})]})]}),[l,...s,...t,n,i.destination])},R=(r,s)=>r.map(t=>{const n=s.filter(a=>a.includes(t.from)&&a.includes(t.to));if(n.length!==1)return{linePath:[],colors:t.colors};const i=n.flat(),h=i.indexOf(t.from),c=i.indexOf(t.to);return{linePath:h<c?i.slice(h,c+1):i.slice(c,h+1),colors:t.colors}}).filter(t=>t.linePath.length!==0),Ge=(r,s)=>r.map(t=>{const n=Ne(t.linePath,s);return{main:[{linePath:n.main,colors:t.colors}],pass:[{linePath:n.pass,colors:t.colors}]}}).reduce((t,n)=>(t.main=[...t.main,...n.main],t.pass=[...t.pass,...n.pass],t),{main:[],pass:[]}),ee=()=>Q.useMemo(()=>e.jsxs("filter",{id:"pujiang_outline",colorInterpolationFilters:"sRGB",filterUnits:"userSpaceOnUse",x:"0",y:"-1000",width:"5000",height:"2000",children:[e.jsxs("feComponentTransfer",{in:"SourceGraphic",children:[e.jsx("feFuncR",{type:"discrete",tableValues:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0"}),e.jsx("feFuncG",{type:"discrete",tableValues:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0"}),e.jsx("feFuncB",{type:"discrete",tableValues:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0"})]}),e.jsx("feColorMatrix",{type:"matrix",values:"1 0 0 0 0\n                            0 1 0 0 0\n                            0 0 1 0 0\n                            1 1 1 1 -3",result:"selectedColor"}),e.jsx("feMorphology",{operator:"erode",in:"selectedColor",radius:"0",result:"e1"}),e.jsx("feMorphology",{operator:"erode",in:"selectedColor",radius:"1",result:"e2"}),e.jsx("feComposite",{in:"e1",in2:"e2",operator:"xor",result:"uncoloredOutline"}),e.jsx("feFlood",{floodColor:"rgb(0,0,0)"}),e.jsx("feComposite",{operator:"in",in2:"uncoloredOutline",result:"outline"}),e.jsx("feComposite",{in:"outline",in2:"selectedColor",operator:"over",result:"result"}),e.jsx("feComposite",{in:"result",in2:"SourceGraphic",operator:"over"})]}),[]);ee.displayName="PujiangLineDefs";const A=12,_e=W.RunIn,Ye=()=>{const{canvasScale:r}=w(x=>x.app),{branches:s,routes:t,depsStr:n}=w(x=>x.helper),{svgWidth:i,svg_height:h,current_stn_idx:c,direction:l,loop:a,theme:o}=w(x=>x.param),d=i[_e],f=h-300,j=k.useMemo(()=>{let x=t.filter(g=>g.includes(c)).map(g=>g[g.indexOf(c)+(l==="l"?1:-1)]).filter(g=>g!==void 0).reduce((g,m)=>g.includes(m)?g:g.concat(m),[]);return a&&s[0].includes(c)&&x.length===1&&["linestart","lineend"].includes(x[0])&&(x=l==="l"?[s[0][1]]:[s[0][s[0].length-2]]),x},[n,c,l,a]),p=k.useMemo(()=>{let x=t.filter(g=>g.includes(c)).map(g=>g[g.indexOf(c)+(l==="l"?-1:1)]).filter(g=>g!==void 0).reduce((g,m)=>g.includes(m)?g:g.concat(m),[]);return a&&s[0].includes(c)&&x.length===1&&["linestart","lineend"].includes(x[0])&&(x=l==="l"?[s[0][s[0].length-2]]:[s[0][1]]),x},[n,c,l,a]);return e.jsxs(q,{type:_e,svgWidth:d,svgHeight:h,canvasScale:r,theme:o,children:[e.jsx(Ve,{}),e.jsx("g",{transform:"translate(0,".concat(f,")"),children:e.jsx(Xe,{prevStnIds:j,nextStnIds:p})})]})},Ve=k.memo(function(){return e.jsxs("defs",{children:[e.jsx("marker",{id:"slope",viewBox:"-1.5 0 3 1.5",refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:"var(--rmg-theme-colour)"})}),e.jsx(ee,{})]})}),Xe=r=>{const{prevStnIds:s,nextStnIds:t}=r,{info_panel_type:n,svgWidth:i,stn_list:h}=w(u=>u.param),c=i.runin/2,l=t.length===1&&["linestart","lineend"].includes(t[0]),a=s.length===1&&["linestart","lineend"].includes(s[0]),o=t.map(u=>h[u].localisedName),d=s.map(u=>h[u].localisedName),[{zh:f="",en:j=""}]=o,[{zh:p="",en:x=""}]=d,g=(t.length>1?(f.split("\\").length-1)*-50+(j.split("\\").length-1)*-30:0)+10,m=(s.length>1?(p.split("\\").length-1)*-50+(x.split("\\").length-1)*-30:0)+10;return e.jsxs(e.Fragment,{children:[e.jsx(Ze,{prevStnIds:s,nextStnIds:t,nextBranchLineDy:g,prevBranchLineDy:m}),l&&n!=="sh2020"?e.jsx($e,{mode:"terminal",prevStnIds:s,nextStnIds:t}):a&&n!=="sh2020"?e.jsx($e,{mode:"original",prevStnIds:s,nextStnIds:t}):e.jsxs(e.Fragment,{children:[e.jsx(Je,{prevStnIds:s,nextStnIds:t}),e.jsx("g",{transform:"translate(".concat(c,",160)"),textAnchor:"middle",children:e.jsx(He,{})})]}),(a||!l)&&e.jsx(qe,{stnIds:r.nextStnIds}),(l||!a)&&e.jsx(Ue,{stnIds:r.prevStnIds})]})},$e=r=>{var x;const{mode:s,prevStnIds:t,nextStnIds:n}=r,{current_stn_idx:i,theme:h,svgWidth:c,direction:l,coline:a}=w(g=>g.param),{branches:o}=w(g=>g.helper),d={l:{original:{x:c.runin-36,anchor:"end"},terminal:{x:36,anchor:"start"}},r:{original:{x:36,anchor:"start"},terminal:{x:c.runin-36,anchor:"end"}}},f=R(Object.values(a),o),j=s==="terminal"?t:n,p=n.length>1?"var(--rmg-theme-colour)":(x=f.filter(g=>g.linePath.includes(i)&&g.linePath.includes(j[0])).map(g=>g.colors[0][2])[0])!=null?x:"var(--rmg-theme-colour)";return e.jsxs(e.Fragment,{children:[s==="original"&&e.jsx("path",{transform:"translate(0,".concat(a.length?"198":"220",")").concat(a.length?"scale(1,2)":""),stroke:p,strokeWidth:12,d:l==="l"?"M ".concat(c.runin-24,",16 H 36"):"M24,16 H ".concat(c.runin-36),markerEnd:"url(#slope)"}),s==="terminal"&&e.jsx("g",{filter:h[2]==="#B5B5B6"?"url(#pujiang_outline)":void 0,children:e.jsx("path",{transform:"translate(0,".concat(a.length?"198":"220",")").concat(a.length?"scale(1,2)":""),stroke:"var(--rmg-grey)",strokeWidth:12,d:"M24,16 H ".concat(c.runin-24)})}),e.jsx("g",{transform:"translate(".concat(d[l][s].x,",160)"),textAnchor:d[l][s].anchor,children:e.jsx(He,{})})]})},Je=r=>{var S;const{prevStnIds:s,nextStnIds:t}=r,{direction:n,svgWidth:i,theme:h,coline:c,current_stn_idx:l,stn_list:a}=w($=>$.param),{branches:o}=w($=>$.helper),d=i.runin/2,f=$=>$.includes("linestart")||$.includes("lineend"),j=R(Object.values(c),o),p=t.length>1?"single":f(t)?j.filter($=>[l,s[0]].every(N=>$.linePath.includes(N))).length>0?"multiple":"single":[l,t[0]].every($=>o[0].includes($))&&j.filter($=>[l,t[0]].every(N=>$.linePath.includes(N))).length>0?"multiple":"single",x=f(t)?s:t,g=t.length>1?"var(--rmg-theme-colour)":(S=j.filter($=>$.linePath.includes(l)&&$.linePath.includes(x[0])).map($=>$.colors[0][2])[0])!=null?S:"var(--rmg-theme-colour)",m=($,N,y,M)=>$.slice(1).filter(I=>[N,y[0]].every(z=>I.includes(z))).filter(I=>U(I,M)).length>0,u=Object.keys(c).length>0&&m(o,l,t,a)?g:"var(--rmg-theme-colour)",_=Object.keys(c).length>0&&t.length===1&&(f(s)||f(t)?!0:!([l,t[0]].every($=>o[0].includes($))&&j.filter($=>$.linePath.includes(l)&&$.linePath.includes(t[0])).length!==0)),v=Object.keys(c).length>0&&s.length===1;return e.jsxs("g",{transform:"translate(0,220)",strokeWidth:12,children:[e.jsxs(e.Fragment,{children:[u!=="var(--rmg-theme-colour)"&&e.jsx("marker",{id:"slope_".concat(u),viewBox:"-1.5 0 3 1.5",refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:u})}),e.jsx("path",{stroke:u,d:"M ".concat(d,",16 H ").concat(n==="l"?36:i.runin-36),markerEnd:u==="var(--rmg-theme-colour)"?"url(#slope)":"url(#slope_".concat(u,")"),transform:_?"translate(0,-22)scale(1,2)":void 0})]}),p==="multiple"&&e.jsxs(e.Fragment,{children:[e.jsx("marker",{id:"slope_".concat(g),viewBox:"-1.5 0 3 1.5",refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:g})}),e.jsx("path",{stroke:g,d:"M ".concat(d,",16 H ").concat(n==="l"?36+A:i.runin-(36+A)),markerEnd:"url(#slope_".concat(g,")"),transform:"translate(0,-12)"})]}),e.jsx("g",{filter:h[2]==="#B5B5B6"?"url(#pujiang_outline)":void 0,transform:"translate(0,".concat(v?-22:0,")scale(1,").concat(v?2:1,")"),children:e.jsx("path",{stroke:"var(--rmg-grey)",d:"M ".concat(d,",16 H ").concat(n==="l"?i.runin-24:24," ")})})]})},Ze=r=>{const{prevStnIds:s,nextStnIds:t,nextBranchLineDy:n,prevBranchLineDy:i}=r,{direction:h,svgWidth:c,current_stn_idx:l,coline:a,theme:o}=w(_=>_.param),{branches:d}=w(_=>_.helper),f=c.runin/2,j=125,p=_=>"".concat(_[0],",").concat(_[1]),x=_=>"M".concat(p(_.at(0))," ")+_.slice(1).map(v=>"L".concat(p(v))).join(" "),g=h==="l"?[[c.runin/3,j],[c.runin/6,n],[36,n]]:[[c.runin/3*2,j],[c.runin/6*5,n],[c.runin-36,n]],m=h==="l"?[[c.runin/3*2,j],[c.runin/6*5,i],[c.runin-24,i]]:[[c.runin/3,j],[c.runin/6,i],[24,i]];let u="var(--rmg-theme-colour)";if(Object.keys(a).length>0){const _=R(Object.values(a),d);t.length>1&&_.filter(v=>v.linePath.includes(l)&&t.some(S=>v.linePath.includes(S)))&&(g[0][1]-=A-1,g.unshift([f,j-A+1]),u=_.filter(v=>v.linePath.includes(l)&&t.some(S=>v.linePath.includes(S))).at(0).colors.at(0)[2]),s.length>1&&_.filter(v=>v.linePath.includes(l)&&s.some(S=>v.linePath.includes(S)))&&(m[0][1]-=A-1,m.unshift([f,j-A+1]))}return e.jsxs("g",{transform:"translate(0,110)",strokeWidth:12,fill:"none",filter:o[2]==="#B5B5B6"?"url(#pujiang_outline)":void 0,children:[e.jsx("marker",{id:"slope_branch",viewBox:"-1.5 0 3 1.5",refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:u})}),t.length>1&&e.jsx("path",{stroke:u,d:x(g),markerEnd:"url(#slope_branch)"}),s.length>1&&e.jsx("path",{stroke:"var(--rmg-grey)",d:x(m)})]})},He=()=>{const r=w(i=>i.param),{localisedName:s}=r.stn_list[r.current_stn_idx],{zh:t="",en:n=""}=s;return k.useMemo(()=>e.jsxs(e.Fragment,{children:[e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:112,children:t.replace("\\","")}),e.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:36,dy:50,children:n.replace("\\","")})]}),[t,n])},Z=r=>{const{nextName:s,...t}=r,{zh:n="",en:i=""}=s;return e.jsx("g",{...t,children:k.useMemo(()=>e.jsxs(e.Fragment,{children:[n.split("\\").map((h,c,l)=>e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:48,dy:(l.length-1-c)*-50-(i.split("\\").length-1)*30,children:h},h)),i.split("\\").map((h,c,l)=>e.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:24,dy:28+(l.length-1-c)*-30,children:h},h))]}),[n,i])})},Ue=r=>{const s=w(l=>l.param),t=r.stnIds.map(l=>s.stn_list[l].localisedName),n=(r.stnIds.length>1?15:125)+t.map(l=>{var a,o,d;return(d=(o=(a=l.zh)==null?void 0:a.split("\\"))==null?void 0:o.length)!=null?d:1}).reduce((l,a)=>l+a,-t.length)*-50+t.map(l=>{var a,o,d;return(d=(o=(a=l.en)==null?void 0:a.split("\\"))==null?void 0:o.length)!=null?d:1}).reduce((l,a)=>l+a,-t.length)*-30,[{zh:i="",en:h=""}]=t,c=(r.stnIds.length>1?(i.split("\\").length-1)*-50+(h.split("\\").length-1)*-30:0)+70;return e.jsxs("g",{fill:"gray",textAnchor:s.direction==="l"?"end":"start",transform:"translate(".concat(s.direction==="l"?s.svgWidth.runin-36:36,",0)"),children:[e.jsx(Z,{nextName:t[0],transform:"translate(0,183)"}),r.stnIds.length>1&&e.jsx(Z,{nextName:t[1],transform:"translate(0,".concat(c,")")}),e.jsxs("g",{transform:"translate(0, ".concat(n,")"),children:[e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:22,children:"上一站"}),e.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:12,dx:s.direction==="l"?-70:70,children:"Past Stop"})]})]})},qe=r=>{const s=w(l=>l.param),t=r.stnIds.map(l=>s.stn_list[l].localisedName),n=(r.stnIds.length>1?15:125)+t.map(l=>{var a,o,d;return(d=(o=(a=l.zh)==null?void 0:a.split("\\"))==null?void 0:o.length)!=null?d:1}).reduce((l,a)=>l+a,-t.length)*-50+t.map(l=>{var a,o,d;return(d=(o=(a=l.en)==null?void 0:a.split("\\"))==null?void 0:o.length)!=null?d:1}).reduce((l,a)=>l+a,-t.length)*-30,[{zh:i="",en:h=""}]=t,c=(r.stnIds.length>1?(i.split("\\").length-1)*-50+(h.split("\\").length-1)*-30:0)+70;return e.jsxs("g",{textAnchor:s.direction==="l"?"start":"end",transform:"translate(".concat(s.direction==="l"?36:s.svgWidth.runin-36,",0)"),children:[e.jsx(Z,{nextName:s.stn_list[r.stnIds[0]].localisedName,transform:"translate(0,183)"}),r.stnIds.length>1&&e.jsx(Z,{nextName:s.stn_list[r.stnIds[1]].localisedName,transform:"translate(0,".concat(c,")")}),e.jsxs("g",{transform:"translate(0, ".concat(n,")"),children:[e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:22,children:"下一站"}),e.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:12,dx:s.direction==="l"?70:-70,children:"Next Stop"})]})]})},K=r=>{var v,S,$,N;const{stnId:s,stnState:t,color:n,bank:i,direction:h}=r,{direction:c,info_panel_type:l,stn_list:a,loop:o}=w(y=>y.param),d=a[s],f=h!=null?h:c,j=o?0:(d.parents.length>1||d.children.length>1?8+12*(($=(S=(v=d.localisedName.en)==null?void 0:v.split("\\"))==null?void 0:S.length)!=null?$:1):0)*(f==="r"?-1:1);let p;const x={};l==="sh2020"?(d.services.length===3?p="stn_sh_2020_direct":d.services.length===2?p="stn_sh_2020_express":p="stn_sh_2020",x.fill=t===-1?"gray":n||"var(--rmg-theme-colour)"):(d.services.length===3?p="direct_sh":d.services.length===2?p="express_sh":[...d.transfer.groups[0].lines||[],...((N=d.transfer.groups[1])==null?void 0:N.lines)||[]].length>0?p="int2_sh":p="stn_sh",x.stroke=t===-1?"gray":n||"var(--rmg-theme-colour)");const g=i!=null?i:0,m=(f==="l"?6:-6)+j+g*30,u=(l==="sh2020"?-20:-6)+Math.abs(g)*(l==="sh2020"?25:11),_=g?0:f==="l"?-45:45;return e.jsxs(e.Fragment,{children:[e.jsx("use",{xlinkHref:"#".concat(p),...x,transform:"translate(".concat(g*(l==="sh2020"?5:0),",0)rotate(").concat(g*90*(l==="sh2020"?1:-1),")")}),e.jsx("g",{transform:"translate(".concat(m,",").concat(u,")rotate(").concat(_,")"),children:e.jsx(Ke,{name:d.localisedName,groups:d.transfer.groups,stnState:t,direction:f,facility:d.facility,bank:g,oneLine:d.one_line,intPadding:d.int_padding})}),t===0?e.jsx(et,{}):void 0]})},Ke=r=>{var u,_,v,S;const{name:s,groups:t,stnState:n,direction:i,facility:h,bank:c,oneLine:l,intPadding:a}=r,o=k.useRef(null),d=i==="l"?1:-1,f=h?30:0,j=c?-12:0,p=k.useRef(null),[x,g]=k.useState(0);k.useEffect(()=>{var $,N;return g((N=($=p.current)==null?void 0:$.getBBox().width)!=null?N:0)},[JSON.stringify(t)]);const m=a-x;return e.jsxs(e.Fragment,{children:[t.map($=>{var N;return(N=$.lines)!=null?N:[]}).flat().length>0&&e.jsxs(e.Fragment,{children:[e.jsx("line",{x1:(j+f)*d,x2:m*d,stroke:n===-1?"gray":"black",strokeWidth:.5}),e.jsx(tt,{ref:p,groups:t,direction:i,transform:"translate(".concat(m*d,",-10.75)")})]}),h&&e.jsx("use",{xlinkHref:"#"+h,x:10*d,y:-30}),e.jsxs("g",{textAnchor:i==="l"?"start":"end",transform:"translate(".concat(f*d,",-14)"),children:[e.jsx(Qe,{ref:o,stnName:s,oneLine:l,directionPolarity:d,fill:n===-1?"gray":n===0?"red":"black"}),((_=(u=t[1])==null?void 0:u.lines)==null?void 0:_.length)&&e.jsx("g",{transform:"translate(".concat((m+x/2)*d,",-30)"),children:e.jsx(lt,{osiInfos:t[1].lines})}),((S=(v=t[2])==null?void 0:v.lines)==null?void 0:S.length)&&e.jsx("g",{transform:"translate(".concat((a+5)*d,",0)"),children:e.jsx(at,{osysiInfos:t[2].lines,direction:r.direction})})]})]})},Qe=k.forwardRef(function(s,t){const{stnName:n,oneLine:i,directionPolarity:h,...c}=s,{zh:l="",en:a=""}=n,o=k.useRef(null),[d,f]=k.useState(0);k.useEffect(()=>{i&&o.current?f(o.current.getBBox().width+5):f(0)},[n.zh,n.en,i]);const[j,p]=[20,8];return e.jsx("g",{ref:t,...c,children:k.useMemo(()=>e.jsxs(e.Fragment,{children:[e.jsx("g",{ref:o,children:l.split("\\").map((x,g,m)=>e.jsx("text",{className:"rmg-name__zh rmg-outline",dy:(m.length-1-g)*-j+(i?p:(a.split("\\").length-1)*-p),children:x},g))}),e.jsx("g",{fontSize:8,transform:"translate(".concat(d*h,",0)"),children:a.split("\\").map((x,g,m)=>e.jsx("text",{className:"rmg-name__en rmg-outline",dy:(m.length-2-g)*-p+2,children:x},g))})]}),[l,a,i,d,h])})}),et=()=>{const{stn_list:r}=w(n=>n.param),s=new Set(Object.values(r).map(n=>n.services).flat()),t=[-1,35,50,75][s.size];return e.jsx("g",{transform:"translate(0, ".concat(t,")"),children:e.jsx("text",{className:"rmg-name__zh",fill:"red",textAnchor:"middle",children:"本站"})})},tt=k.forwardRef(function(s,t){var a,o,d;const{groups:n,direction:i,...h}=s,c=[...n[0].lines||[],...((a=n[1])==null?void 0:a.lines)||[],...((d=(o=n[2])==null?void 0:o.lines)==null?void 0:d.filter(f=>!!f.name[0].match(/^磁(悬)*浮/)))||[]];let l=0;return e.jsx("g",{ref:t,fontSize:14,textAnchor:"middle",...h,children:c.map((f,j)=>{const p=!!f.name[0].match(/^\w+(号)?线/),x=!!f.name[0].match(/^磁(悬)*浮/);i==="r"&&(l-=(p||x?20:f.name[0].length*14+12)+(j===0?0:5));let g;return x?g=e.jsx("g",{transform:"translate(".concat(l,",-16)scale(0.1428571429)"),children:e.jsx(nt,{info:f})},j):p?g=e.jsx("g",{transform:"translate(".concat(l,",0)"),children:e.jsx(st,{info:f})},j):g=e.jsx("g",{transform:"translate(".concat(l,",0)"),children:e.jsx(rt,{info:f})},j),i==="l"&&(l+=p||x?25:f.name[0].length*14+12+5),g})})}),nt=k.memo(function(s){var t,n;return e.jsx(e.Fragment,{children:e.jsx("use",{xlinkHref:"#intbox_maglev",fill:(t=s.info.theme)==null?void 0:t[2],stroke:(n=s.info.theme)==null?void 0:n[2]})})},(r,s)=>JSON.stringify(r.info)===JSON.stringify(s.info)),st=k.memo(function(s){var t,n,i;return e.jsxs(e.Fragment,{children:[e.jsx("use",{xlinkHref:"#intbox_number",fill:(t=s.info.theme)==null?void 0:t[2]}),e.jsx("text",{x:10,className:"rmg-name__zh",fill:(n=s.info.theme)==null?void 0:n[3],dominantBaseline:"central",children:(i=s.info.name[0].match(/(\d*)\w+/))==null?void 0:i[0]})]})},(r,s)=>JSON.stringify(r.info)===JSON.stringify(s.info)),rt=k.memo(function(s){var n,i;const t=s.info.name[0].split("\\")[0].length;return e.jsxs(e.Fragment,{children:[e.jsx("rect",{height:22,width:t*14+12,y:-11,fill:(n=s.info.theme)==null?void 0:n[2]}),e.jsx("text",{x:t*7+6,className:"rmg-name__zh",fill:(i=s.info.theme)==null?void 0:i[3],dominantBaseline:"central",children:s.info.name[0].split("\\")[0]})]})},(r,s)=>JSON.stringify(r.info)===JSON.stringify(s.info)),lt=r=>{const s=r.osiInfos.map(t=>t.name[0]).join("，");return k.useMemo(()=>e.jsxs("g",{textAnchor:"middle",fontSize:"50%",children:[e.jsx("text",{className:"rmg-name__zh",dy:-5,children:"换乘".concat(s)}),e.jsx("text",{className:"rmg-name__zh",dy:5,children:"仅限公共交通卡"}),e.jsx("text",{className:"rmg-name__en",dy:12.5,fontSize:"75%",children:"Only for Public Transportation Card"})]}),[s.toString()])},at=r=>{const s=r.osysiInfos.map(n=>n.name[0]).join("，"),t=r.osysiInfos.map(n=>n.name[1]).join(", ");return k.useMemo(()=>e.jsxs("g",{textAnchor:r.direction==="l"?"start":"end",fontSize:"50%",children:[e.jsxs("text",{className:"rmg-name__zh",dy:3,children:["转乘",s]}),e.jsxs("text",{className:"rmg-name__en",dy:10,fontSize:"75%",children:["To ",t]})]}),[JSON.stringify(r.osysiInfos),r.direction])},it=["shanghai","sh4","#5F259F","#fff","4号线","Line 4"],ot=r=>{const{xs:s,servicesPresent:t,stnStates:n}=r,{svg_height:i,direction:h,stn_list:c,current_stn_idx:l,branchSpacingPct:a,info_panel_type:o,coline:d}=w($=>$.param),{branches:f,depsStr:j}=w($=>$.helper),p=k.useMemo(()=>(console.log("computing y shares"),Object.keys(c).reduce(($,N)=>{if(f[0].includes(N))return{...$,[N]:0};{const y=f.slice(1).filter(M=>M.includes(N))[0];return{...$,[N]:c[y[0]].children.indexOf(y[1])?-3:3}}},{})),[j]),x=Object.entries(p).filter(([,$])=>$<=0).reduce(($,[N,y])=>({...$,[N]:y}),{}),g=Object.keys(x).reduce(($,N)=>({...$,[N]:-x[N]*a*i/300}),{}),m=k.useMemo(()=>Ge(R(Object.values(d).filter($=>$.display),f),n),[JSON.stringify(d),l,h,j]),u=t.reduce(($,N)=>({...$,[N]:Object.keys(m).reduce((y,M)=>({...y,[M]:m[M].map(I=>({path:Oe(I.linePath,M,s,g,h,N,t.length,c,"diagonal"),colors:I.colors})).filter(I=>I.path!=="")}),{})}),{}),_=R(Object.values(d).filter($=>$.display),f).map($=>$.linePath).flat(),v=12,S=o==="sh2020"?3:0;return e.jsx(e.Fragment,{children:e.jsxs("g",{id:"coline",transform:"translate(0,".concat(v+S,")"),children:[e.jsx(ct,{paths:u,direction:h}),e.jsx(ht,{colineStns:m,branches:f,xs:s,ys:g,stnStates:n,lineWidth:v,colineGap:S}),e.jsx(dt,{stnIds:Object.entries(p).filter(([,$])=>$<0).reduce(($,[N])=>[...$,N],[]).filter($=>!["linestart","lineend"].includes($)).filter($=>c[$].services.length!==0).filter($=>_.includes($)),xs:s,ys:g,stnStates:n})]})})},ct=r=>{const{paths:s,direction:t}=r;return e.jsx(e.Fragment,{children:Object.keys(s).map((n,i)=>{var h,c;return e.jsx("g",{transform:"translate(0,".concat(i*25,")"),children:e.jsxs("g",{children:[(h=s[n])==null?void 0:h.pass.map((l,a)=>e.jsx(k.Fragment,{children:e.jsx("path",{stroke:"var(--rmg-grey)",strokeWidth:12,fill:"none",d:l.path,strokeLinejoin:"round",filter:n===F.local?void 0:"url(#contrast-".concat(n,")")},a)},a)),(c=s[n])==null?void 0:c.main.map((l,a)=>{var o;return e.jsxs(k.Fragment,{children:[l.colors.length>1&&e.jsx("linearGradient",{id:"grad".concat(a),y1:"-100%",y2:"100%",x1:"0",x2:"0",gradientUnits:"userSpaceOnUse",children:l.colors.map((d,f)=>e.jsxs(k.Fragment,{children:[e.jsx("stop",{offset:"".concat(100/l.colors.length*(f+0),"%"),stopColor:d[2]}),e.jsx("stop",{offset:"".concat(100/l.colors.length*(f+1),"%"),stopColor:d[2]})]},f))}),t==="l"&&e.jsx("marker",{id:"arrow_left_".concat(a,"_").concat(l.colors.map(d=>d[2]).join("_")),refY:.5,refX:1,children:e.jsx("path",{d:"M1,0L0,1H1z",fill:l.colors.length>1?"url(#grad".concat(a,")"):l.colors[0][2]})}),t==="r"&&e.jsx("marker",{id:"arrow_right_".concat(a,"_").concat(l.colors.map(d=>d[2]).join("_")),refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:l.colors.length>1?"url(#grad".concat(a,")"):l.colors[0][2]})}),e.jsx("path",{stroke:((o=l.colors.at(-1))!=null?o:it)[2],strokeWidth:12,fill:"none",d:l.path,markerStart:t==="l"?"url(#arrow_left_".concat(a,"_").concat(l.colors.map(d=>d[2]).join("_"),")"):void 0,markerEnd:t==="r"?"url(#arrow_right_".concat(a,"_").concat(l.colors.map(d=>d[2]).join("_"),")"):void 0,strokeLinejoin:"round",filter:n===F.local?void 0:"url(#contrast-".concat(n,")")},a)]},a)})]})},"servicePath".concat(i))})})},ht=r=>{const{colineStns:s,branches:t,xs:n,ys:i,stnStates:h,lineWidth:c,colineGap:l}=r,{line_name:a,theme:o,info_panel_type:d}=w(j=>j.param),f=[...s.main,...s.pass].map(j=>j.linePath.map(p=>{var x;return{curStn:p,x:n[p],y:i[p],color:(x=j.colors.at(-1))!=null?x:[...o,...a]}})).flat().reduce((j,p)=>j.find(x=>x.curStn===p.curStn)?j:j.concat(p),[]).filter(j=>t[0].includes(j.curStn));return console.log(f),e.jsx("g",{id:"stations_in_mainline",children:f.map(j=>{const{curStn:p,x,y:g,color:m}=j,u=(h[p]===-1?0:c)+l+c,_=(h[p]===-1?0:-c)-l-c/2;return e.jsx("g",{transform:"translate(".concat(x,",").concat(g,")"),children:d==="sh2020"?e.jsx("rect",{stroke:"none",height:u,width:12,x:-6,y:_,fill:h[p]===-1?"var(--rmg-grey)":m[2]}):e.jsx("use",{xlinkHref:"#int2_sh",stroke:"var(--rmg-theme-colour)",transform:"translate(0,".concat(-c,")")})},p)})})},dt=r=>{const{xs:s,ys:t,stnStates:n,stnIds:i}=r,{branches:h,depsStr:c}=w(j=>j.helper),{line_name:l,theme:a,coline:o}=w(j=>j.param),d=k.useMemo(()=>R(Object.values(o),h),[JSON.stringify(o),c]),f=i.reduce((j,p)=>{var x;return{...j,[p]:(x=d.filter(g=>g.linePath.includes(p)).map(g=>g.colors).flat().at(0))!=null?x:[...a,...l]}},{});return e.jsx("g",{id:"stations_in_coline",children:i.map(j=>e.jsx("g",{transform:"translate(".concat(s[j],",").concat(t[j],")"),children:e.jsx(K,{stnId:j,stnState:n[j],color:f[j][2]})},j))})},mt=()=>{const{routes:r,branches:s,depsStr:t}=w(y=>y.helper),n=w(y=>y.param),{svg_height:i,stn_list:h,branchSpacingPct:c,coline:l,direction:a}=w(y=>y.param),o=ke(n.stn_list,()=>0,()=>0),d=J("linestart","lineend",o),f=J(d.nodes[1],d.nodes.slice(-2)[0],o),j=k.useMemo(()=>(console.log("computing x shares"),Object.keys(n.stn_list).reduce((y,M)=>({...y,[M]:we(M,o,s)}),{})),[s.toString(),JSON.stringify(o)]),p=[n.svgWidth.railmap*n.padding/100,n.svgWidth.railmap*(1-n.padding/100)],x=Object.keys(j).reduce((y,M)=>({...y,[M]:p[0]+j[M]/f.len*(p[1]-p[0])}),{}),g=k.useMemo(()=>(console.log("computing y shares"),Object.keys(h).reduce((y,M)=>{if(s[0].includes(M))return{...y,[M]:0};{const I=s.slice(1).filter(z=>z.includes(M))[0];return{...y,[M]:h[I[0]].children.indexOf(I[1])?-3:3}}},{})),[t]),m=Object.entries(g).filter(([,y])=>y>=0).reduce((y,[M,I])=>({...y,[M]:I}),{}),u=Object.keys(m).reduce((y,M)=>({...y,[M]:-m[M]*c*i/300}),{}),_=k.useMemo(()=>Me(n.current_stn_idx,r,n.direction),[n.current_stn_idx,n.direction,r.toString()]),v=Object.values(F),S=Object.values(n.stn_list).map(y=>y.services).flat().reduce((y,M)=>(y[v.indexOf(M)]=!0,y),[!1,!1,!1]).map((y,M)=>[v[M],y]).filter(y=>y[1]).map(y=>y[0]),$=s.map(y=>Ne(y,_)).reduce((y,M)=>(y.main.push(M.main),y.pass.push(M.pass),y),{main:[],pass:[]}),N=S.reduce((y,M)=>({...y,[M]:Object.keys($).reduce((I,z)=>({...I,[z]:$[z].map(H=>Oe(H,z,x,u,a,M,S.length,h)).filter(H=>H!=="")}),{})}),{});return e.jsxs("g",{id:"main",transform:"translate(0,".concat(n.svg_height*(Object.keys(l).length>0?.5:.7+.1),")"),children:[e.jsx(xt,{paths:N,direction:n.direction}),e.jsx(gt,{stnIds:Object.keys(m).filter(y=>!["linestart","lineend"].includes(y)).filter(y=>h[y].services.length!==0),xs:x,ys:u,stnStates:_}),Object.keys(l).length>0&&e.jsx(ot,{xs:x,servicesPresent:S,stnStates:_}),S.length>1&&e.jsx(ft,{servicesLevel:S,lineXs:p})]})},xt=r=>{const{theme:s}=w(i=>i.param),{paths:t,direction:n}=r;return e.jsx(e.Fragment,{children:Object.keys(t).map((i,h)=>{var c,l;return e.jsxs("g",{transform:"translate(0,".concat(h*25,")"),filter:s[2]==="#B5B5B6"?"url(#pujiang_outline)":void 0,children:[e.jsx("g",{children:(c=t[i])==null?void 0:c.pass.map((a,o)=>e.jsx("path",{stroke:"var(--rmg-grey)",strokeWidth:12,fill:"none",d:a,markerStart:r.direction==="l"?"url(#arrow_gray)":void 0,markerEnd:r.direction==="r"?"url(#arrow_gray)":void 0,strokeLinejoin:"round"},o))}),e.jsx("g",{children:(l=t[i])==null?void 0:l.main.map((a,o)=>e.jsx("path",{stroke:"var(--rmg-theme-colour)",strokeWidth:12,fill:"none",d:a,markerStart:n==="l"?"url(#arrow_theme_left)":void 0,markerEnd:n==="r"?"url(#arrow_theme_right)":void 0,strokeLinejoin:"round",filter:i===F.local?void 0:"url(#contrast-".concat(i,")")},o))})]},"servicePath".concat(h))})})},Oe=(r,s,t,n,i,h,c,l,a="rightangle")=>{let[o,d]=[];const f={},j={local:0,express:20,direct:40}[h],p=c>1?50:0;let x=30;if(r.length>0){let m=!1,u=!1;l[r.at(-1)||0].children.some(_=>["linestart","lineend"].includes(_))?u=!0:l[r.at(0)||0].parents.some(_=>["linestart","lineend"].includes(_))&&(m=!0),x=m||u?x:0}const g=30;if(r.forEach(m=>{const u=t[m],_=n[m];if(!o&&o!==0){[d,o]=[u,_],f.start=[u,_];return}_===0?_!==o&&(f.bifurcate=[d,o]):_!==o&&(f.bifurcate=[u,_]),f.end=[u,_],[d,o]=[u,_]}),"start"in f)if("end"in f)if("bifurcate"in f){const[m,u]=f.start,_=f.bifurcate[0],[v,S]=f.end;return s==="main"?i==="l"?S>u?(console.log(f),a==="rightangle"?"M ".concat(m-x,",").concat(u," H ").concat(v," V ").concat(S):"M ".concat(m,",").concat(u," H ").concat(m+g," L ").concat(_-g,",").concat(S," H ").concat(v)):a==="rightangle"?"M ".concat(m,",").concat(u," V ").concat(S," H ").concat(v):"M ".concat(m-x,",").concat(u," H ").concat(_+g," L ").concat(v-g,",").concat(S," H ").concat(v):S>u?a==="rightangle"?"M ".concat(m,",").concat(u," H ").concat(v," V ").concat(S):"M ".concat(m,",").concat(u," H ").concat(m+g," L ").concat(_-g,",").concat(S," H ").concat(v+x):a==="rightangle"?"M ".concat(m,",").concat(u," V ").concat(S," H ").concat(v+x):"M ".concat(m,",").concat(u," H ").concat(_+g," L ").concat(v-g,",").concat(S," H ").concat(v):S>u?a==="rightangle"?"M ".concat(m-x,",").concat(u," H ").concat(v," V ").concat(S):"M ".concat(m,",").concat(u," H ").concat(m+g," L ").concat(_-g,",").concat(S," H ").concat(v+x):a==="rightangle"?"M ".concat(m,",").concat(u," V ").concat(S," H ").concat(v+x):"M ".concat(m-x,",").concat(u," H ").concat(_+g," L ").concat(v-g,",").concat(S," H ").concat(v)}else{const[m,u]=f.start,_=f.end[0];return s==="main"?i==="l"?"M ".concat(m-x-j,",").concat(u," H ").concat(_):"M ".concat(m,",").concat(u," H ").concat(_+x+j):i==="l"?"M ".concat(m-x,",").concat(u," H ").concat(_+x+p):"M ".concat(m-x-p,",").concat(u," H ").concat(_+x)}else{const[m,u]=f.start;return s==="main"?i==="l"?"M ".concat(m-x-j,",").concat(u," H ").concat(m):"M ".concat(m,",").concat(u," H ").concat(m+x+j):i==="l"?"M ".concat(m,",").concat(u," L ").concat(m+x+p,",").concat(u):"M ".concat(m-x-p,",").concat(u," L ").concat(m,",").concat(u)}else return""},gt=r=>{const{xs:s,ys:t,stnStates:n,stnIds:i}=r;return e.jsx("g",{children:i.map(h=>e.jsx("g",{transform:"translate(".concat(s[h],",").concat(t[h],")"),children:e.jsx(K,{stnId:h,stnState:n[h]})},h))})},ft=r=>{const{svg_height:s,direction:t,svgWidth:n}=w(a=>a.param),i=-s+130,h=r.servicesLevel.map(a=>({local:"普通车",express:"大站车",direct:"直达车"})[a]),c=t==="r"?r.lineXs[0]-42:r.lineXs[1]+42,l=r.servicesLevel.length===2?350:500;return k.useMemo(()=>e.jsxs("g",{children:[h.map((a,o)=>e.jsxs("g",{transform:"translate(".concat(c,",").concat(o*25,")"),children:[e.jsx("rect",{x:-27.5,height:10,width:55,fill:"white",stroke:"black",y:-5}),e.jsx("text",{className:"rmg-name__zh",fontSize:9,y:3,textAnchor:"middle",children:"".concat(a,"运行线")})]},a)),e.jsxs("g",{transform:"translate(".concat(t==="r"?30:n.railmap-l,",").concat(i,")"),children:[e.jsx("text",{className:"rmg-name__zh",children:"图例："}),h.map((a,o)=>e.jsxs("g",{transform:"translate(".concat(o*150+50,",0)"),children:[e.jsx("line",{x1:"0",x2:"35",y1:"-5",y2:"-5",stroke:"var(--rmg-theme-colour)",strokeWidth:"12",filter:o===2?"url(#contrast-direct)":o===1?"url(#contrast-express)":""}),e.jsx("use",{x:"17.5",y:"-5",xlinkHref:"#stn_sh",fill:"var(--rmg-theme-colour)"}),e.jsx("text",{x:"40",className:"rmg-name__zh",children:"".concat(a,"停靠站")})]},"serviceLevel".concat(o)))]})]}),[s,t,n,r.servicesLevel,r.lineXs])},ut=()=>{const{direction:r,svgWidth:s,coline:t}=w(i=>i.param),n=!!Object.keys(t).length;return k.useMemo(()=>e.jsxs("g",{transform:"translate(".concat(r==="l"?50:s.railmap-150,",50)"),children:[e.jsx("text",{className:"rmg-name__zh",children:"列车前进方向"}),e.jsx("path",{d:"M60,60L0,0L60-60H100L55-15H160V15H55L100,60z",stroke:n?"var(--rmg-black)":void 0,strokeWidth:n?5:void 0,fill:n?"var(--rmg-white)":"var(--rmg-theme-colour)",transform:"translate(".concat(r==="l"?-30:125,",-5)rotate(").concat(r==="l"?0:180,")scale(0.15)")})]}),[r,t,s.railmap])},te=r=>{var o,d,f,j,p;const{stnId:s,nameDirection:t,services:n,color:i}=r,h=w(x=>x.param.stn_list[s]),c=[...((o=h.transfer.groups[0])==null?void 0:o.lines)||[],...((d=h.transfer.groups[1])==null?void 0:d.lines)||[]];let l;h.services.length===3?l="direct_indoor_sh":h.services.length===2?l="express_indoor_sh":(p=(j=(f=h.transfer.groups[1])==null?void 0:f.lines)==null?void 0:j.length)!=null&&p?l="osi_indoor_sh":c.length>0?l="int2_indoor_sh":l="stn_indoor_sh";const a=t==="left"||t==="right"?90:0;return e.jsxs(e.Fragment,{children:[e.jsx(pt,{name:h.localisedName,groups:h.transfer.groups,nameDirection:t,services:n}),e.jsx("use",{xlinkHref:"#".concat(l),stroke:c.length>0?"var(--rmg-black)":i!=null?i:"var(--rmg-theme-colour)",transform:"rotate(".concat(a,")")}),h.services.length>1&&e.jsx("text",{className:"rmg-name__zh",writingMode:"tb",fontSize:"60%",dy:"-12",children:"大站车".concat(h.services.length>2?" 直达车":"","停靠")})]})},pt=r=>{var j,p,x,g,m,u,_,v,S,$,N,y,M,I,z,H,B,L,b,E,P,G,Y,X,V,O,T,C,D,ne,se,re,le,ae,ie,oe,ce,he,de,me,xe,ge,fe;const{name:s,groups:t,nameDirection:n,services:i}=r,h={upward:60,downward:-30,left:0,right:0}[n],c=(p=(j=t[2])==null?void 0:j.lines)!=null&&p.length?{upward:0,downward:0,left:(((x=t[0].lines)==null?void 0:x.length)||0)+(((m=(g=t[1])==null?void 0:g.lines)==null?void 0:m.length)||0)!==0?85:25,right:(((u=t[0].lines)==null?void 0:u.length)||0)+(((v=(_=t[1])==null?void 0:_.lines)==null?void 0:v.length)||0)!==0?-85:-25}[n]:0,l=($=(S=t[2])==null?void 0:S.lines)!=null&&$.length?{upward:(y=(N=t[0])==null?void 0:N.lines)!=null&&y.length&&((I=(M=t[1])==null?void 0:M.lines)!=null&&I.length)?-210:(H=(z=t[0])==null?void 0:z.lines)!=null&&H.length||(L=(B=t[1])==null?void 0:B.lines)!=null&&L.length?-177.5:-145,downward:((E=(b=t[0])==null?void 0:b.lines)!=null&&E.length&&((G=(P=t[1])==null?void 0:P.lines)!=null&&G.length)?185:(Y=t[0].lines)!=null&&Y.length||(V=(X=t[1])==null?void 0:X.lines)!=null&&V.length?157.5:125)+(i.length===3?40:0),left:(T=(O=t[0])==null?void 0:O.lines)!=null&&T.length&&((D=(C=t[1])==null?void 0:C.lines)!=null&&D.length)?-67:(ne=t[0].lines)!=null&&ne.length||(re=(se=t[1])==null?void 0:se.lines)!=null&&re.length?-30:0,right:(ae=(le=t[0])==null?void 0:le.lines)!=null&&ae.length&&((oe=(ie=t[1])==null?void 0:ie.lines)!=null&&oe.length)?-67:(ce=t[0].lines)!=null&&ce.length||(de=(he=t[1])==null?void 0:he.lines)!=null&&de.length?-30:0}[n]:0,a=k.useRef(null),o=60,[d,f]=k.useState(o);return k.useEffect(()=>{a!=null&&a.current&&f(Math.max(o,a.current.getBBox().width))},[s.zh,s.en]),e.jsxs("g",{transform:"translate(0,".concat(h,")"),children:[n==="upward"||n==="downward"?e.jsxs(e.Fragment,{children:[e.jsx("line",{x1:-d/2,x2:d/2,y1:n==="upward"?-23:-10,y2:n==="upward"?-23:-10,stroke:"black"}),e.jsx("line",{y1:n==="upward"?-23:-10,y2:n==="upward"?-48:20,stroke:"black"})]}):e.jsxs(e.Fragment,{children:[e.jsx("line",{x1:n==="left"?-50:15,x2:n==="left"?-15:50,y1:0,y2:0,stroke:"black"}),e.jsx("line",{x1:n==="left"?-50:50,x2:n==="left"?-50:50,y1:-30,y2:30,stroke:"black"})]}),[...t[0].lines||[],...((me=t[1])==null?void 0:me.lines)||[]].length&&e.jsx(_t,{intInfos:[t[0].lines||[],((xe=t[1])==null?void 0:xe.lines)||[]],arrowDirection:n,services:i}),e.jsx(jt,{ref:a,stnName:s,nameDirection:n,fill:"black"}),((fe=(ge=t[2])==null?void 0:ge.lines)==null?void 0:fe.length)&&e.jsx("g",{transform:"translate(".concat(c,",").concat(l,")"),children:e.jsx($t,{osysiInfos:t[2].lines,nameDirection:n})})]})},jt=k.forwardRef(function(s,t){const{stnName:n,nameDirection:i,...h}=s,{zh:c="",en:l=""}=n,a=c.split("\\"),o=l.split("\\").length,d={upward:0,downward:0,left:-60,right:60}[i],f={upward:-2,downward:-30-12*(o-1),left:-10*(o-1),right:-10*(o-1)}[i],j={upward:"middle",downward:"middle",left:"end",right:"start"}[i];return e.jsx("g",{ref:t,...h,textAnchor:j,transform:"translate(".concat(d,",").concat(f,")"),children:k.useMemo(()=>{var p;return e.jsxs(e.Fragment,{children:[a.map((x,g,m)=>e.jsx("text",{className:"rmg-name__zh",dy:i==="upward"?16*g:(m.length-1-g)*-16,children:x},g)),e.jsx("g",{fontSize:9.6,children:(p=l.split("\\"))==null?void 0:p.map((x,g)=>e.jsx("text",{className:"rmg-name__en",dy:12*(g+1)+(i==="upward"&&a.length>1?a.length*7.5:0),children:x},g))})]})},[c,l])})}),_t=r=>{var m,u,_,v,S,$,N,y,M,I,z,H,B;const{intInfos:s,arrowDirection:t,services:n}=r,i=s.flatMap(L=>L.map(b=>{var E;return(E=b.theme)==null?void 0:E[2]})).reduce((L,b)=>L+b,""),h=s.map(L=>[L.filter(b=>b.name[0].match(/^\d+.*$/)).map(b=>b.name[0].replace(/^(\d+)(.*)$/,"$1")).join("，").concat("号线"),L.filter(b=>!b.name[0].match(/^\d+.*$/)).map(b=>b.name[0]).join("，")].filter(b=>b&&b!=="号线").join("，")),c=s.map(L=>["Line ".concat(L.filter(b=>/^(L|l)ine \d+$/.test(b.name[1])).map(b=>b.name[1].replace("Line","").replace("line","").trim()).join(",")),L.filter(b=>!/^(L|l)ine \d+$/.test(b.name[1])).map(b=>b.name[1]).join(", ")].filter(b=>b&&b!=="Line ").join(", ")),l=n.length===3?80:45,a={upward:-145,downward:125+(n.length===3?40:0),left:7,right:7}[t],o={upward:0,downward:0,left:20,right:-20}[t],d={upward:-74,downward:44,left:0,right:0}[t],f={upward:0,downward:180,left:90,right:-90}[t],j={upward:0,downward:0,left:85,right:-85}[t],p={upward:"middle",downward:"middle",left:"start",right:"end"}[t],x=j,g={upward:(u=(m=s.at(0))==null?void 0:m.length)!=null&&u?-177.5:-145,downward:((v=(_=s.at(0))==null?void 0:_.length)!=null&&v?157.5:125)+(n.length===3?40:0),left:($=(S=s.at(0))==null?void 0:S.length)!=null&&$?-30:7,right:(y=(N=s.at(0))==null?void 0:N.length)!=null&&y?-30:7}[t];return e.jsxs("g",{children:[e.jsx("path",{id:"int_indoor_arrow_sh",stroke:"var(--rmg-black)",strokeWidth:1,transform:"translate(".concat(o,",").concat(d,")rotate(").concat(f,")"),fill:s.flat().length===1?(M=s.flat()[0].theme)==null?void 0:M[2]:"url(#grad".concat(i,")"),d:"M -7.5,0 v -".concat(l," h -7.5 l 15,-15 l 15,15 h -7.5 v ").concat(l," Z")}),s.flat().length>1&&e.jsx("linearGradient",{id:"grad".concat(i),y1:"0",y2:"0",x1:t==="upward"?"25%":"75%",x2:t==="upward"?"75%":"25%",children:s.flat().map((L,b)=>{var E,P;return e.jsxs(k.Fragment,{children:[e.jsx("stop",{offset:"".concat(100/s.flat().length*b,"%"),stopColor:(E=L.theme)==null?void 0:E[2]}),e.jsx("stop",{offset:"".concat(100/s.flat().length*(b+1),"%"),stopColor:(P=L.theme)==null?void 0:P[2]})]},b)})}),((z=(I=s.at(0))==null?void 0:I.length)!=null?z:0)>0&&e.jsxs("g",{transform:"translate(".concat(j,",").concat(a,")"),textAnchor:"".concat(p),children:[e.jsx("text",{className:"rmg-name__zh",dy:-7,children:"换乘".concat(h[0])}),e.jsx("text",{className:"rmg-name__en",dy:5,fontSize:9.6,children:"Interchange ".concat(c[0])})]}),((B=(H=s.at(1))==null?void 0:H.length)!=null?B:0)>0&&e.jsxs("g",{transform:"translate(".concat(x,",").concat(g,")"),textAnchor:"".concat(p),children:[e.jsx("text",{className:"rmg-name__zh",dy:-7,children:"出站换乘".concat(h[1])}),e.jsx("text",{className:"rmg-name__en",dy:5,fontSize:9.6,children:"Out-of-station Transfer ".concat(c[1])})]})]})},$t=r=>{const s={upward:"middle",downward:"middle",left:"start",right:"end"}[r.nameDirection];return k.useMemo(()=>e.jsxs("g",{textAnchor:"".concat(s),children:[e.jsx("text",{className:"rmg-name__zh",dy:-5,children:"转乘".concat(r.osysiInfos.map(t=>t.name[0]).join("，"))}),e.jsx("text",{className:"rmg-name__en",dy:7.5,fontSize:9.6,children:"To ".concat(r.osysiInfos.map(t=>t.name[1]).join(", "))})]}),[JSON.stringify(r.osysiInfos),r.nameDirection])},vt=(r,s,t,n,i,h)=>{var j,p,x,g;const c=r[0].filter(m=>!["linestart","lineend"].includes(m)),l=r.slice(1,3).map(m=>m.slice(1,m.length-1)),a=l.reduce((m,u)=>m+u.filter(_=>!["linestart","lineend",...s].includes(_)).length,0)+c.length-h-i*2,o=(t-t*n/100*2)/(1+a),d=[t*n/100+((j=l.at(0))!=null?j:[]).length*o,t*(1-n/100)-((p=l.at(1))!=null?p:[]).length*o],f={...Object.fromEntries(((x=l.at(0))!=null?x:[]).map((m,u)=>[m,t*n/100+u*o])),...Object.fromEntries(((g=l.at(1))!=null?g:[]).map((m,u)=>[m,d[1]+(1+u)*o]))};return{loop_branches:l,line_xs_branches:d,xs_branches:f}},yt=r=>{var _,v,S,$;const{loop_branches:s,edges:t,xs:n,ys:i,canvas:h}=r,[c,l,a,o]=t,{branches:d}=w(N=>N.helper),{current_stn_idx:f,direction:j,coline:p}=w(N=>N.param),x=h===W.RailMap?30:0,g=["M ".concat(c,",").concat(a," H ").concat(Number(n[(v=(_=s.at(0))==null?void 0:_.at(0))!=null?v:""])-x),"M ".concat(l,",").concat(a," H ").concat(Number(n[($=(S=s.at(1))==null?void 0:S.at(-1))!=null?$:""])+x)],m=d[0].filter(N=>!["linestart","lineend"].includes(N)),u=Object.values(p).filter(N=>![N.from,N.to].every(y=>m.includes(y))).map(N=>N.colors);return e.jsx(e.Fragment,{children:s.map((N,y)=>{var M,I,z;return e.jsxs(Q.Fragment,{children:[u.filter((H,B,L)=>B===L.findIndex(b=>{var E,P;return((E=b.at(0))==null?void 0:E.at(2))===((P=H.at(0))==null?void 0:P.at(2))})).map(H=>e.jsx("marker",{id:"arrow_theme_".concat(H[0][2]),refX:1,refY:.5,children:e.jsx("path",{d:"M0,1H2L1,0z",fill:H[0][2]})},H[0][2])),e.jsx("path",{stroke:(z=(I=(M=u.at(y))==null?void 0:M.at(0))==null?void 0:I.at(2))!=null?z:"var(--rmg-theme-colour)",strokeWidth:12,fill:"none",d:g[y],markerEnd:h===W.RailMap&&(j==="l"&&y===0||j==="r"&&y===1)?u.at(y)?"url(#arrow_theme_".concat(u[y][0][2],")"):"url(#arrow_theme)":void 0}),N.filter(H=>!["linestart","lineend"].includes(H)).map(H=>{var B,L,b,E;return e.jsxs(Q.Fragment,{children:[h===W.RailMap&&e.jsx("g",{transform:"translate(".concat(n[H],",").concat(i[H],")"),children:e.jsx(K,{stnId:H,stnState:f===H?0:1,bank:0,direction:j,color:(L=(B=u.at(y))==null?void 0:B.at(0))==null?void 0:L.at(2)})},H),h===W.Indoor&&e.jsx("g",{transform:"translate(".concat(n[H],",").concat(i[H],")"),children:e.jsx(te,{stnId:H,nameDirection:s.filter(P=>P.includes(H)).map(P=>P.indexOf(H)%2===0?"downward":"upward")[0],services:[F.local],color:(E=(b=u.at(y))==null?void 0:b.at(0))==null?void 0:E.at(2)})},H)]},H)})]},N.at(0))})})},St=r=>{var u;const{edges:s,loop_stns:t,xs:n,ys:i,canvas:h}=r,[c,l,a,o]=s,{info_panel_type:d,stn_list:f,coline:j}=w(_=>_.param),{branches:p}=w(_=>_.helper),x=Object.values(j).filter(_=>[_.from,_.to].every(v=>p.slice(1,3).filter(S=>U(S,f)).flat().includes(v))).map(_=>_.colors).at(0),g=12,m=h===W.RailMap&&d==="sh2020"?3:0;return e.jsxs("g",{id:"coline_main",children:[e.jsx("path",{d:"M ".concat(c,",").concat(a," H").concat(l),strokeWidth:12,stroke:(u=x==null?void 0:x.at(0))==null?void 0:u.at(2)}),h===W.RailMap&&Object.keys(j).length>0&&t.top.map(_=>{var v;return e.jsx("g",{transform:"translate(".concat(n[_],",").concat(i[_],")"),children:d==="sh2020"?e.jsxs(e.Fragment,{children:[e.jsx("rect",{stroke:"none",height:24,width:12,x:-6,y:-m-1,fill:(v=x==null?void 0:x.at(0))==null?void 0:v.at(2)}),e.jsx("rect",{stroke:"none",height:m+g,width:12,x:-6,y:g-2,fill:"var(--rmg-theme-colour)"})]}):e.jsx("use",{xlinkHref:"#int2_sh",stroke:"var(--rmg-theme-colour)",transform:"translate(0,".concat(1+g,")")})},_)})]})},ze=r=>{var V;const{bank_angle:s,canvas:t}=r,{branches:n}=w(O=>O.helper),{current_stn_idx:i,svgWidth:h,svg_height:c,padding:l,branchSpacingPct:a,direction:o,info_panel_type:d,stn_list:f,loop_info:{left_and_right_factor:j,bottom_factor:p},coline:x}=w(O=>O.param),g=n[0].filter(O=>!["linestart","lineend"].includes(O)),m=n.slice(0,3).flat().filter((O=>T=>(O[T]=(O[T]||0)+1)===2)({})).filter(O=>!["linestart","lineend"].includes(O)),u=(V=Object.values(x).filter(O=>[O.from,O.to].every(T=>n.slice(1,3).filter(C=>U(C,f)).flat().includes(T))).map(O=>{const T=g.findIndex(D=>D===O.from),C=g.findIndex(D=>D===O.to);return Math.abs(C-T)>g.length-2-Math.abs(C-T)?"major":"minor"}).at(0))!=null?V:"minor",_=m.at(1)?Ee(g,m,j,u):m.at(0)?be(g,m[0],p,j):Le(g,i,p,j),{x_shares:v,y_shares:S}=We(g,_),{loop_branches:$,line_xs_branches:N,xs_branches:y}=vt(n,m,h[t],l,j,_.bottom.length),M={...S,...Object.fromEntries($.flat().map(O=>[O,0]))},I=a*c/300,z=[225+I,c-75-(t===W.RailMap?0:125)-I],H=Object.keys(M).reduce((O,T)=>({...O,[T]:z[0]+M[T]*(z[1]-z[0])}),{}),B=[Math.max(h[t]*l/100+(s&&t===W.RailMap?100:0),N[0]),Math.min(h[t]*(1-l/100)-(s&&t===W.RailMap?100:0),N[1])],L=Object.keys(v).reduce((O,T)=>({...O,[T]:B[0]+v[T]*(B[1]-B[0])}),{}),b=s?{l:1,r:-1}[o]:0;[..._.right,..._.left].forEach(O=>{L[O]-=(H[O]-z[0])*b}),_.bottom.forEach(O=>{L[O]-=(z[1]-z[0])*b});const E={...y,...L},P=Nt(_,E,H,b,[...B,...z],o),G=12,Y=t===W.RailMap&&d==="sh2020"?3:0;Object.keys(x).length>0&&_.top.forEach(O=>{H[O]-=Y+G});const X=$.length?0:(z[1]-z[0])*b/2;return e.jsxs("g",{id:"loop",transform:"translate(".concat(X,",0)"),children:[e.jsx("path",{stroke:"var(--rmg-theme-colour)",strokeWidth:12,fill:"none",d:P,strokeLinejoin:"round"}),t===W.RailMap&&e.jsx(ve,{canvas:t,loop_stns:_,xs:E,ys:H}),e.jsxs("g",{transform:"translate(0,".concat(Object.keys(x).length>0?-G-Y:0,")"),children:[e.jsx(yt,{loop_branches:$,edges:[...B,...z],xs:E,ys:H,canvas:t}),Object.keys(x).length>0&&e.jsx(St,{edges:[...B,...z],loop_stns:_,xs:E,ys:H,canvas:t})]}),t===W.Indoor&&e.jsx(ve,{canvas:t,loop_stns:_,xs:E,ys:H})]})},Nt=(r,s,t,n,i,h)=>{const[c,l,a,o]=i,d=(p,x,g,m,u)=>({right:[g+(m-a)*n,x],bottom:[p-(o-x)*n,m],left:[g-(o-m)*n,x],top:[p+(x-a)*n,m]})[u],f=[];r.top.forEach(p=>{f.push([s[p],t[p]])}),["right","bottom","left"].forEach(p=>{if(r[p].length>0)f.push(d(f.at(-1)[0],f.at(-1)[1],s[r[p][0]],t[r[p][0]],p)),r[p].forEach(x=>{f.push([s[x],t[x]])});else{const x={right:[l,f.at(-1)[1]],bottom:[f.at(-1)[0]+(o-f.at(-1)[1])*-n,f.at(-1)[1]+(o-f.at(-1)[1])],left:[c+(n===0?0:(o-a)*(h==="l"?-1:1)),f.at(-1)[1]]};f.push(x[p])}}),f.push(d(f.at(-1)[0],f.at(-1)[1],s[r.top[0]],t[r.top[0]],"top"));const j=f.slice(1).map(([p,x])=>"L".concat(p,",").concat(x," ")).join(" ");return"M".concat(f[0][0],",").concat(f[0][1]," ").concat(j," Z")},ve=r=>{const{canvas:s,loop_stns:t,xs:n,ys:i}=r,{current_stn_idx:h}=w(o=>o.param),c={top:0,bottom:0,left:-1,right:1},l={left:"r",right:"l",top:void 0,bottom:void 0},a=(o,d)=>({top:d%2===0?"upward":"downward",bottom:d%2===0?"upward":"downward",left:"left",right:"right"})[o];return e.jsxs("g",{id:"loop_stations",children:[s===W.RailMap&&Object.entries(t).map(([o,d])=>d.map(f=>e.jsx("g",{transform:"translate(".concat(n[f],",").concat(i[f],")"),children:e.jsx(K,{stnId:f,stnState:h===f?0:1,bank:c[o],direction:l[o]})},f))),s===W.Indoor&&Object.entries(t).map(([o,d])=>d.map((f,j)=>e.jsx("g",{transform:"translate(".concat(n[f],",").concat(i[f],")"),children:e.jsx(te,{stnId:f,nameDirection:a(o,j),services:[F.local]})},f)))]})},ye=W.RailMap;function kt(){const{canvasScale:r}=w(l=>l.app),{svgWidth:s,svg_height:t,theme:n,loop:i,loop_info:{bank:h}}=w(l=>l.param),c=s[ye];return e.jsxs(q,{type:ye,svgWidth:c,svgHeight:t,canvasScale:r,theme:n,children:[e.jsx(wt,{}),i?e.jsx(ze,{bank_angle:h,canvas:W.RailMap}):e.jsx(mt,{}),e.jsx(ut,{})]})}const wt=k.memo(function(){return e.jsxs("defs",{children:[e.jsx("circle",{id:"stn_sh",fill:"var(--rmg-white)",strokeWidth:2,r:5}),e.jsx("path",{id:"int2_sh",fill:"var(--rmg-white)",strokeWidth:2,d:"M -5,0 a 5,5 0 1 1 10,0 V10 a 5,5 0 1 1 -10,0Z"}),e.jsx("path",{id:"express_sh",fill:"var(--rmg-white)",strokeWidth:2,d:"M -5,0 a 5,5 0 1 1 10,0 V25 a 5,5 0 1 1 -10,0Z"}),e.jsx("path",{id:"direct_sh",fill:"var(--rmg-white)",strokeWidth:2,d:"M -5,0 a 5,5 0 1 1 10,0 V50 a 5,5 0 1 1 -10,0Z"}),e.jsx("rect",{id:"stn_sh_2020",stroke:"none",height:24,width:12,x:-6,y:-18}),e.jsx("rect",{id:"stn_sh_2020_express",stroke:"none",height:49,width:12,x:-6,y:-18}),e.jsx("rect",{id:"stn_sh_2020_direct",stroke:"none",height:74,width:12,x:-6,y:-18}),e.jsx("rect",{id:"intbox_number",height:22,width:20,y:-11}),e.jsxs("g",{id:"intbox_maglev",transform:"translate(-25,0)",children:[e.jsx("rect",{id:"maglev_5",height:144,width:130,y:"40",x:"30",strokeWidth:10}),e.jsx("path",{id:"maglev_3",fill:"var(--rmg-white)",d:"m90,55a40,5 0 0 0 -40,3a5,5 0 0 0 -5,5a5,60 0 0 0 -3,60a5,5 0 0 0 5,5l96,0a5,5 0 0 0 5,-5a5,60 0 0 0 -3,-60a5,5 0 0 0 -5,-5a40,5 0 0 0 -40,-3l-5,-10l-5,10"}),e.jsx("path",{id:"maglev_4",fill:"var(--rmg-white)",d:"m90,140l-40,0a10,5 0 0 1 -10,-5l0,25a10,15 0 0 0 10,15l15,0l0,-10l-15,0l0,-15l90,0l0,15l-15,0l0,10l15,0a10,15 0 0 0 10,-15l0,-25a10,5 0 0 1 -10,5l-50,0"}),e.jsx("rect",{id:"maglev_1",height:"25",width:"40",y:"80",x:"50"}),e.jsx("rect",{id:"maglev_2",height:"25",width:"40",y:"80",x:"100"})]}),e.jsxs("g",{id:"airport",transform:"scale(0.5)",children:[e.jsx("circle",{cx:"0",cy:"29.33899",r:"29.33899",fill:"var(--rmg-grey)"}),e.jsx("path",{id:"airport",d:"M28.9769,6.60134c1.711.013,3.111,2.53205,3.111,4.241v10.337s17.106,15.435,17.358,15.666a1.145,1.145,0,0,1,.488,1.152v2.833c0,.651-.451.61-.695.467-.334-.119-17.151-8.863-17.151-8.863-.004,1.458-.797,9.006-1.326,13.304,0,0,4.61,2.457,4.699,2.521.334.268.352.359.352.852v2.001c0,.477-.352.428-.51.324-.183-.062-5.693-1.921-5.693-1.921a2.56018,2.56018,0,0,0-.633-.127,2.31654,2.31654,0,0,0-.666.127s-5.477,1.859-5.672,1.921c-.185.104-.523.153-.523-.324v-2.001c0-.493.029-.584.367-.852.086-.064,4.678-2.521,4.678-2.521-.524-4.298-1.307-11.846-1.325-13.304,0,0-16.822,8.744-17.148,8.863-.217.143-.69.184-.69-.467v-2.833a1.16206,1.16206,0,0,1,.473-1.152c.276-.231,17.365-15.666,17.365-15.666v-10.337c0-1.709,1.403-4.228,3.14105-4.241",transform:"translate(-28.9697,0.14347)",fill:"var(--rmg-white)"})]}),e.jsxs("g",{id:"disney",transform:"scale(0.5)",children:[e.jsx("circle",{cx:"0",cy:"29.33899",r:"29.33899",fill:"var(--rmg-grey)"}),e.jsx("path",{fill:"var(--rmg-white)",d:"M45.6152,7.85015a9.80248,9.80248,0,0,0-9.79907,9.801,9.70059,9.70059,0,0,0,.342,2.582c.002.026.002.055.002.093a.31815.31815,0,0,1-.31494.318.67741.67741,0,0,1-.12806-.02,15.71521,15.71521,0,0,0-13.498,0,.61.61,0,0,1-.122.02.31841.31841,0,0,1-.322-.318v-.067a9.62553,9.62553,0,0,0,.35608-2.608,9.803,9.803,0,1,0-9.797,9.8,10.10364,10.10364,0,0,0,2.308-.271h.05493a.31113.31113,0,0,1,.31409.318.32433.32433,0,0,1-.019.12,15.72588,15.72588,0,1,0,29.703,7.216,15.83676,15.83676,0,0,0-1.746-7.23.18417.18417,0,0,1-.0271-.106.31612.31612,0,0,1,.32007-.318h.057a10.15953,10.15953,0,0,0,2.316.271,9.80051,9.80051,0,0,0,0-19.601",transform:"translate(-28.9697 0.13398)"})]}),e.jsxs("g",{id:"railway",children:[e.jsx("circle",{cx:"0",cy:"29.33899",r:"29.33899",fill:"var(--rmg-grey)",transform:"translate(0,-2)scale(0.5)"}),e.jsx("path",{fill:"var(--rmg-white)",d:"M169,273.5c0-19,14.7-34.8,33.7-36.3c18.9-1.5,38.1-2.2,57.4-2.2c19.3,0,38.4,0.8,57.3,2.2  c19,1.5,33.7,17.3,33.7,36.3v47.3l-51.3,14.7c-11.2,3.2-18.9,13.4-18.9,25v147.8c0,17.4,12.2,32.3,29.3,35.7l110.6,22.1  c4.9,1,8.4,5.2,8.4,10.2V599H91v-22.7c0-5,3.5-9.2,8.4-10.2L209.9,544c17-3.4,29.3-18.3,29.3-35.7V360.5c0-11.6-7.7-21.8-18.9-25  L169,320.8V273.5z M309.4,31.7c0.2-1.2,0.3-2.4,0.3-3.6c0-14-11.1-25.4-24.9-26C276.6,1.4,268.3,1,260,1c-8.3,0-16.6,0.4-24.7,1.1  c-13.9,0.6-24.9,12-24.9,26c0,1.2,0.1,2.5,0.3,3.6C90.6,54.8,0,160.3,0,287c0,97.2,53.4,182,132.4,226.6l36.8-48.1  C104.3,432.4,59.8,364.9,59.8,287c0-110.6,89.6-200.2,200.2-200.2S460.2,176.4,460.2,287c0,77.9-44.5,145.4-109.4,178.5  c15,19.6,25.6,33.5,36.8,48.1C466.6,469,520,384.2,520,287C520,160.3,429.4,54.8,309.4,31.7z",transform:"translate(-10,0)scale(0.04)"})]}),e.jsx("marker",{id:"arrow_gray",viewBox:"-1.5 0 3 1.5",refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:"var(--rmg-grey)"})}),e.jsx("marker",{id:"arrow_theme_left",refX:1,refY:.5,children:e.jsx("path",{d:"M1,0L0,1H1z",fill:"var(--rmg-theme-colour)"})}),e.jsx("marker",{id:"arrow_theme_right",refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:"var(--rmg-theme-colour)"})}),e.jsx("marker",{id:"arrow_theme",refX:1,refY:.5,children:e.jsx("path",{d:"M0,1H2L1,0z",fill:"var(--rmg-theme-colour)"})}),e.jsx("filter",{id:"contrast-direct",filterUnits:"userSpaceOnUse",children:e.jsxs("feComponentTransfer",{children:[e.jsx("feFuncR",{type:"linear",slope:.5,intercept:.25}),e.jsx("feFuncG",{type:"linear",slope:.5,intercept:.25}),e.jsx("feFuncB",{type:"linear",slope:.5,intercept:.25})]})}),e.jsx("filter",{id:"contrast-express",filterUnits:"userSpaceOnUse",children:e.jsxs("feComponentTransfer",{children:[e.jsx("feFuncR",{type:"linear",slope:.75,intercept:.125}),e.jsx("feFuncG",{type:"linear",slope:.75,intercept:.125}),e.jsx("feFuncB",{type:"linear",slope:.75,intercept:.125})]})}),e.jsx(ee,{})]})}),Se=W.Indoor;function Mt(){const{canvasScale:r}=w(c=>c.app),{svgWidth:s,svg_height:t,theme:n,loop:i}=w(c=>c.param),h=s[Se];return e.jsxs(q,{type:Se,svgWidth:h,svgHeight:t,canvasScale:r,theme:n,children:[e.jsx(bt,{}),i?e.jsx(ze,{bank_angle:!1,canvas:W.Indoor}):e.jsx(zt,{}),e.jsx(Ie,{})]})}const bt=k.memo(function(){return e.jsxs("defs",{children:[e.jsx("circle",{id:"stn_indoor_sh",fill:"var(--rmg-white)",strokeWidth:5,r:8,transform:"scale(1.5)"}),e.jsx("path",{id:"int2_indoor_sh",fill:"var(--rmg-white)",transform:"translate(0, -10)scale(2)",strokeWidth:4,d:"M -5,0 a 5,5 0 1 1 10,0 V10 a 5,5 0 1 1 -10,0Z"}),e.jsx("path",{id:"express_indoor_sh",fill:"var(--rmg-white)",transform:"translate(0, -10)scale(2)",strokeWidth:4,d:"M -5,0 a 5,5 0 1 1 10,0 V25 a 5,5 0 1 1 -10,0Z"}),e.jsx("path",{id:"direct_indoor_sh",fill:"var(--rmg-white)",transform:"translate(0, -10)scale(2)",strokeWidth:4,d:"M -5,0 a 5,5 0 1 1 10,0 V40 a 5,5 0 1 1 -10,0Z"}),e.jsxs("g",{id:"osi_indoor_sh",children:[e.jsx("line",{x1:"0",x2:"0",y1:"-12",y2:"12",stroke:"var(--rmg-black)",strokeWidth:22}),e.jsx("line",{x1:"0",x2:"0",y1:"-12",y2:"12",stroke:"var(--rmg-white)",strokeWidth:10}),e.jsx("circle",{cy:"-12",fill:"var(--rmg-white)",strokeWidth:5,r:8,transform:"scale(1.5)"}),e.jsx("circle",{cy:"12",fill:"var(--rmg-white)",strokeWidth:5,r:8,transform:"scale(1.5)"})]})]})}),Ht=(r,s)=>{let t=0;return r[s].parents.length===2&&(t+=1),r[r[s].parents[0]].children.length===2&&(t+=1),t},Ot=(r,s)=>{let t=0;return r[s].children.length===2&&(t+=1),r[r[s].children[0]].parents.length===2&&(t+=1),t},zt=()=>{const{routes:r,branches:s,depsStr:t}=w(m=>m.helper),n=w(m=>m.param),i=ke(n.stn_list,Ht,Ot),h=J("linestart","lineend",i),c=J(h.nodes[1],h.nodes.slice(-2)[0],i),l=k.useMemo(()=>(console.log("computing x shares"),Object.keys(n.stn_list).reduce((m,u)=>({...m,[u]:we(u,i,s)}),{})),[s.toString(),JSON.stringify(i)]),a=[n.svgWidth.indoor*n.padding/100,n.svgWidth.indoor*(1-n.padding/100)],o=Object.keys(l).reduce((m,u)=>({...m,[u]:a[0]+l[u]/c.len*(a[1]-a[0])}),{}),d=k.useMemo(()=>ue.getYShares(n.stn_list),[t]),f=Object.keys(d).reduce((m,u)=>({...m,[u]:d[u]*n.branchSpacingPct*n.svg_height/200}),{}),j=k.useMemo(()=>Me(n.current_stn_idx,r,n.direction),[n.current_stn_idx,n.direction,r.toString()]),p=Object.values(F),x=Object.values(n.stn_list).map(m=>m.services).flat().reduce((m,u)=>(m[p.indexOf(u)]=!0,m),[!1,!1,!1]).map((m,u)=>[p[u],m]).filter(m=>m[1]).map(m=>m[0]),g=ue.drawLine(s,j,n.stn_list,a,o,f,n.branchSpacingPct*n.svg_height/200,h,0);return e.jsxs("g",{id:"main",transform:"translate(0,".concat(n.svg_height/2,")"),children:[e.jsx(It,{paths:g,services:x}),e.jsx(Lt,{xs:o,ys:f,services:x})]})},It=r=>e.jsx("g",{fill:"none",strokeWidth:12,stroke:"var(--rmg-theme-colour)",children:r.services.map((s,t)=>e.jsxs("g",{transform:"translate(0, ".concat(t*30,")"),children:[r.paths.main.map((n,i)=>e.jsx("path",{d:n},i)),r.paths.pass.map((n,i)=>e.jsx("path",{d:n},i))]},"indoor_line_".concat(t)))}),Lt=r=>{const{branches:s}=w(o=>o.helper),{stn_list:t,namePosMTR:{isFlip:n}}=w(o=>o.param),{xs:i,ys:h,services:c}=r,l=n==null||n?"upward":"downward",a=l==="upward"?"downward":"upward";return e.jsx("g",{children:Object.keys(t).filter(o=>!["linestart","lineend"].includes(o)).filter(o=>t[o].services.length!==0).map(o=>e.jsx("g",{transform:"translate(".concat(i[o],",").concat(h[o],")"),children:e.jsx(te,{stnId:o,nameDirection:c.length>1?"downward":s.filter(d=>d.includes(o)).map(d=>d.indexOf(o)%2===0?l:a)[0],services:c})},o))})},Ie=k.memo(()=>{const{svg_height:r,svgWidth:{indoor:s},line_name:t,stn_list:n}=w(c=>c.param),i=Math.max(...Object.values(n).map(c=>{var l,a,o;return(o=(a=(l=c.transfer.groups.at(1))==null?void 0:l.lines)==null?void 0:a.length)!=null?o:0})),h=i>0?210:110;return e.jsxs(e.Fragment,{children:[e.jsx("g",{transform:"translate(".concat(s/2,",50)"),children:e.jsxs("text",{textAnchor:"middle",fontSize:"30",className:"rmg-name__zh",children:["轨道交通",t[0],"运营线路示意图"]})}),e.jsxs("g",{transform:"translate(".concat(s/2,",").concat(r-270,")"),children:[e.jsx("text",{textAnchor:"middle",fontSize:"18",className:"rmg-name__zh",dx:"-30",dy:"230",children:"友情提示：请留意您需要换乘线路的首末班时间，以免耽误您的出行，末班车进站前三分钟停售该末班车车票。"}),e.jsx("text",{textAnchor:"middle",fontSize:"12",className:"rmg-name__en",dx:"10",dy:"250",children:"Please pay attention to the interchange schedule if you want to transfer to other lines. Stop selling tickets 3 minutes before the last train services."}),e.jsxs("g",{transform:"translate(-700,215)",children:[e.jsx("rect",{x:"-5",y:"-25",width:h,height:"70",fill:"none",stroke:"black",rx:"5"}),e.jsx("line",{x1:"28",x2:"28",y1:"-20",y2:"40",stroke:"black"}),e.jsx("text",{className:"rmg-name__zh",dx:"3",fontSize:"18",children:"图"}),e.jsx("text",{className:"rmg-name__zh",dx:"3",dy:"18",fontSize:"18",children:"例"}),e.jsx("text",{className:"rmg-name__en",dy:"35",fontSize:"8",children:"legend"}),e.jsx("use",{transform:"translate(50,10)",xlinkHref:"#int2_indoor_sh",stroke:"var(--rmg-black)"}),e.jsx("text",{className:"rmg-name__zh",dx:"70",dy:"5",fontSize:"10",children:"换乘站"}),e.jsx("text",{className:"rmg-name__en",dx:"70",dy:"15",fontSize:"6",children:"Interchange"}),e.jsx("text",{className:"rmg-name__en",dx:"70",dy:"25",fontSize:"6",children:"Station"}),i>0&&e.jsxs(e.Fragment,{children:[e.jsx("use",{transform:"translate(120,10)scale(0.75)",xlinkHref:"#osi_indoor_sh",stroke:"var(--rmg-black)"}),e.jsx("text",{className:"rmg-name__zh",dx:"135",dy:"5",fontSize:"10",children:"出站换乘车站"}),e.jsx("text",{className:"rmg-name__en",dx:"135",dy:"15",fontSize:"6",children:"Out-of-station Transfer"}),e.jsx("text",{className:"rmg-name__en",dx:"135",dy:"25",fontSize:"6",children:"Station"})]})]})]})]})});Ie.displayName="InfoElements";const At={destination:e.jsx(Te,{}),runin:e.jsx(Ye,{}),railmap:e.jsx(kt,{}),indoor:e.jsx(Mt,{})};export{At as default};
