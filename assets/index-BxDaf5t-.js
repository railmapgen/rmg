import{j as e}from"./chakra-jT2-teuD.js";import{a as S,d as J}from"./react-BNX4K-US.js";import{u as N,aY as O,n as E}from"./index-HyGScCuj.js";import{i as A}from"./app-router-rOJHvELN.js";import{S as G}from"./svg-wrapper-h0h12Ph0.js";import{d as ie,a as oe,c as D,g as ce,b as he}from"./share-BVgUIVfG.js";import{a as Q}from"./mtr-CL9fu2Bp.js";import"./param-selector-Co1Y1OOn.js";const je=(r,n,t,s)=>{const o=r.length-s*2-t,i=r.findIndex(d=>d===n),a=[...r,...r,...r],l=r.length+i-Math.floor(o/2)+(o%2===0?1:0),c=r.length+i+Math.floor(o/2);return{top:a.slice(l,c+1),left:a.slice(l-s,l),right:a.slice(c+1,c+1+s),bottom:a.slice(c+1+s,c+1+s+t)}},de=(r,n,t,s)=>{const o=r.length-s*2-t,i=[...r,...r,...r],a=r.length+r.findIndex(d=>d===n),l=i[a+o-1],c=r.length+r.findIndex(d=>d===l)+(a+o>r.length*2?r.length:0);return{top:i.slice(a,c+1),left:i.slice(a-s,a),right:i.slice(c+1,c+1+s),bottom:i.slice(c+1+s,c+1+s+t)}},_e=(r,n,t,s)=>{let o=r.findIndex(f=>f===n[0]),i=r.findIndex(f=>f===n[1]);[o,i,n[0],n[1]]=o>i?[i,o,n[1],n[0]]:[o,i,n[0],n[1]];const a=r.slice(o,i+1),l=r.filter(f=>!a.filter(u=>!n.includes(u)).includes(f)),c=r.length-(s==="major"?Math.max:Math.min)(a.length,l.length)-t*2,d=s==="major"?a.length>l.length?n[0]:n[1]:a.length>l.length?n[1]:n[0];return de(r,d,c,t)},$e=(r,n)=>{const t=Object.fromEntries(r.map(d=>[d,-1])),s=Object.fromEntries(r.map(d=>[d,-1])),[o,i,a,l]=[0,1,0,1],c=0;return n.top.forEach((d,f)=>{t[d]=c/2+(1-c)/(n.top.length+1)*(f+1),s[d]=o}),n.right.forEach((d,f)=>{t[d]=l,s[d]=c/2+(1-c)/(n.right.length+1)*(f+1)}),n.bottom.forEach((d,f)=>{t[d]=1-c/2-(1-c)/(n.bottom.length+1)*(f+1),s[d]=i}),n.left.forEach((d,f)=>{t[d]=a,s[d]=1-c/2-(1-c)/(n.left.length+1)*(f+1)}),{x_shares:t,y_shares:s}},ve=(r,n,t,s)=>{const o=r[0].filter(c=>!["linestart","lineend"].includes(c)),i=[...o,...o,...o],a=n==="r"?i:i.reverse(),l=a.findIndex(c=>s===c)+o.length;return a.slice(l+1).filter(c=>t[c].loop_pivot).slice(void 0,2)},ee=O.Destination;function ye(){const{canvasScale:r}=N(i=>i.app),{svgWidth:n,svg_height:t,theme:s}=N(i=>i.param),o=n[ee];return e.jsxs(G,{type:ee,svgWidth:o,svgHeight:t,canvasScale:r,theme:s,children:[e.jsx(Se,{}),e.jsx(ke,{})]})}const Se=S.memo(function(){return e.jsx("defs",{children:e.jsx("marker",{id:"slope",viewBox:"-1.5 0 3 1.5",refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:"var(--rmg-theme-colour)"})})})}),ke=()=>{const{routes:r,branches:n}=N(p=>p.helper),{line_name:t,theme:s,current_stn_idx:o,direction:i,stn_list:a,info_panel_type:l,loop:c,coline:d}=N(p=>p.param),f=(p,v,$)=>[...new Set(p.filter(k=>k.includes($)).map(k=>{const b=k.filter(y=>!["linestart","lineend"].includes(y));return v==="l"?b[0]:b.reverse()[0]}))],u=(p,v)=>v?[[p.map($=>a[$].localisedName.zh).join("，"),p.map($=>a[$].localisedName.en).join(", ")].map($=>$.replace("\\",""))]:p.map($=>{const{zh:k="",en:b=""}=a[$].localisedName;return[k.replace("\\",""),b.replace("\\","")]}),g=c?ve(n,i,a,o):f(r,i,o),j=(c?f(r,i,o):g).filter(p=>n.slice(1).filter(v=>A(v,a)).some(v=>v.includes(p))),x=g.filter(p=>!j.includes(p)),_=u(x,!c&&l!=="sh2020"),m=u(j,!0),h=Object.fromEntries(j.map(p=>[p,Object.values(d).filter(v=>v.from===p||v.to===p).at(0)]).filter(([,p])=>p));return e.jsxs(e.Fragment,{children:[e.jsx(te,{dest_names:_,line_name:t,line_color:[s[2],s[3]],coline:!!j.length,upper:!!j.length}),j.length&&j.filter(p=>Object.values(d).some(v=>v.from===p||v.to===p)).map(p=>e.jsx("g",{transform:"translate(0,-250)",children:e.jsx(te,{dest_names:[m.at(0)],line_name:h[p]?.colors.at(0).slice(4),line_color:[h[p]?.colors.at(0)[2],h[p]?.colors.at(0)[3]],coline:!0,upper:!1})},`coline_${p}`))]})},te=r=>{const{dest_names:n,line_name:t,line_color:s,coline:o,upper:i}=r,{current_stn_idx:a,direction:l,platform_num:c,svgWidth:d,svg_height:f}=N($=>$.param),u=S.useRef(null),[g,j]=S.useState({width:0});S.useEffect(()=>{u.current&&j(u.current.getBBox())},[JSON.stringify(n),JSON.stringify(a)]);const[x,_,m,h,p]=[d.destination/2,10,36,264,325],v=x-_-m-g.width>=p/2&&x-_-m-h>=p/2?x:l==="l"?(d.destination+g.width-h)/2:(d.destination-g.width+h)/2;return e.jsxs("g",{transform:`translate(0,${f-300})`,children:[e.jsx("path",{stroke:s[0],strokeWidth:12,d:l==="l"?`M${d.destination-24},16 H 36`:`M24,16 H ${d.destination-36}`,transform:`translate(0,${i?-20:220})`,markerEnd:o?void 0:"url(#slope)"}),e.jsx(Ne,{ref:u,dest_names:n}),c!==""&&e.jsx("g",{transform:`translate(${v},0)`,children:e.jsx(we,{})}),t[0].match(/^[\w\d]+(号)?线/)?e.jsx(be,{line_name:t,line_color:s}):e.jsx(Me,{line_name:t,line_color:s})]})},Ne=S.forwardRef(function(n,t){const{dest_names:s}=n,{direction:o,svgWidth:i}=N(a=>a.param);return e.jsxs("g",{ref:t,transform:`translate(${o==="l"?36:i.destination-36},145)`,children:[e.jsx("g",{transform:`translate(0,${s.length===2?-20:20})`,children:e.jsx("path",{d:"M60,60L0,0L60-60H100L55-15H160V15H55L100,60z",fill:"black",transform:`rotate(${o==="l"?0:180})scale(0.8)`})}),e.jsx("g",{textAnchor:o==="l"?"start":"end",transform:`translate(${o==="l"?148:-148},25)`,children:s.map((a,l)=>e.jsxs(S.Fragment,{children:[e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:70,dy:l*-100+7,children:"往"+a[0]},`zh${l}`),e.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:25,dy:l*-100+40,children:"To "+a[1]},`en${l}`)]},l))})]})}),we=()=>{const{platform_num:r}=N(n=>n.param);return S.useMemo(()=>e.jsxs("g",{transform:`translate(${-325/2+60},150)`,children:[e.jsx("circle",{r:60,fill:"none",stroke:"black",strokeWidth:2}),e.jsx("text",{className:"rmg-name__en rmg-outline",dominantBaseline:"central",fontSize:120,textAnchor:"middle",children:r}),e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:100,dominantBaseline:"central",x:65,children:"站台"})]}),[r])},Me=r=>{const{line_name:n,line_color:t}=r,{direction:s,svgWidth:o}=N(u=>u.param),i=s==="l"?o.destination-42:42,a=S.useRef(null),[l,c]=S.useState({width:0});S.useEffect(()=>{a.current&&c(a.current.getBBox())},[...n]);const d=(s==="l"?-l.width:0)-6,f=(s==="l"?-1:1)*l.width/2;return S.useMemo(()=>e.jsxs("g",{transform:`translate(${i},92)`,children:[e.jsx("rect",{fill:t[0],x:d,width:l.width+10,height:120}),e.jsxs("g",{textAnchor:s==="r"?"start":"end",transform:"translate(0,68)",fill:t[1],children:[e.jsx("g",{ref:a,children:e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:68,children:n[0]})}),e.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:30,textAnchor:"middle",x:f,dy:42,children:n[1]})]})]}),[l,...n,...t,s,o.destination])},be=r=>{const{line_name:n,line_color:t}=r,{direction:s,svgWidth:o}=N(c=>c.param),[i,a]=n[0].match(/^[\w\d]+|.+/g),l=s==="l"?o.destination-36-210:90;return S.useMemo(()=>e.jsxs("g",{transform:`translate(${l},92)`,children:[e.jsx("rect",{fill:t[0],x:-54,width:108,height:120}),e.jsx("text",{className:"rmg-name__zh rmg-outline",fill:t[1],fontSize:96,textAnchor:"middle",dominantBaseline:"central",transform:"translate(0,60)",letterSpacing:-5,children:i}),e.jsxs("g",{textAnchor:"start",transform:"translate(74,68)",children:[e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:68,children:a}),e.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:30,dy:42,children:n[1]})]})]}),[l,...n,...t,s,o.destination])},T=(r,n)=>r.map(t=>{const s=n.filter(c=>c.includes(t.from)&&c.includes(t.to));if(s.length!==1)return{linePath:[],colors:t.colors};const o=s.flat(),i=o.indexOf(t.from),a=o.indexOf(t.to);return{linePath:i<a?o.slice(i,a+1):o.slice(a,i+1),colors:t.colors}}).filter(t=>t.linePath.length!==0),Oe=(r,n)=>r.map(t=>{const s=ie(t.linePath,n);return{main:[{linePath:s.main,colors:t.colors}],pass:[{linePath:s.pass,colors:t.colors}]}}).reduce((t,s)=>(t.main=[...t.main,...s.main],t.pass=[...t.pass,...s.pass],t),{main:[],pass:[]}),Z=()=>J.useMemo(()=>e.jsxs("filter",{id:"pujiang_outline",colorInterpolationFilters:"sRGB",filterUnits:"userSpaceOnUse",x:"0",y:"-1000",width:"5000",height:"2000",children:[e.jsxs("feComponentTransfer",{in:"SourceGraphic",children:[e.jsx("feFuncR",{type:"discrete",tableValues:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0"}),e.jsx("feFuncG",{type:"discrete",tableValues:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0"}),e.jsx("feFuncB",{type:"discrete",tableValues:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0"})]}),e.jsx("feColorMatrix",{type:"matrix",values:`1 0 0 0 0
                            0 1 0 0 0
                            0 0 1 0 0
                            1 1 1 1 -3`,result:"selectedColor"}),e.jsx("feMorphology",{operator:"erode",in:"selectedColor",radius:"0",result:"e1"}),e.jsx("feMorphology",{operator:"erode",in:"selectedColor",radius:"1",result:"e2"}),e.jsx("feComposite",{in:"e1",in2:"e2",operator:"xor",result:"uncoloredOutline"}),e.jsx("feFlood",{floodColor:"rgb(0,0,0)"}),e.jsx("feComposite",{operator:"in",in2:"uncoloredOutline",result:"outline"}),e.jsx("feComposite",{in:"outline",in2:"selectedColor",operator:"over",result:"result"}),e.jsx("feComposite",{in:"result",in2:"SourceGraphic",operator:"over"})]}),[]);Z.displayName="PujiangLineDefs";const B=12,ne=O.RunIn,He=()=>{const{canvasScale:r}=N(x=>x.app),{branches:n,routes:t,depsStr:s}=N(x=>x.helper),{svgWidth:o,svg_height:i,current_stn_idx:a,direction:l,loop:c,theme:d}=N(x=>x.param),f=o[ne],u=i-300,g=S.useMemo(()=>{let x=t.filter(_=>_.includes(a)).map(_=>_[_.indexOf(a)+(l==="l"?1:-1)]).filter(_=>_!==void 0).reduce((_,m)=>_.includes(m)?_:_.concat(m),[]);return c&&n[0].includes(a)&&x.length===1&&["linestart","lineend"].includes(x[0])&&(x=l==="l"?[n[0][1]]:[n[0][n[0].length-2]]),x},[s,a,l,c]),j=S.useMemo(()=>{let x=t.filter(_=>_.includes(a)).map(_=>_[_.indexOf(a)+(l==="l"?-1:1)]).filter(_=>_!==void 0).reduce((_,m)=>_.includes(m)?_:_.concat(m),[]);return c&&n[0].includes(a)&&x.length===1&&["linestart","lineend"].includes(x[0])&&(x=l==="l"?[n[0][n[0].length-2]]:[n[0][1]]),x},[s,a,l,c]);return e.jsxs(G,{type:ne,svgWidth:f,svgHeight:i,canvasScale:r,theme:d,children:[e.jsx(ze,{}),e.jsx("g",{transform:`translate(0,${u})`,children:e.jsx(Ie,{prevStnIds:g,nextStnIds:j})})]})},ze=S.memo(function(){return e.jsxs("defs",{children:[e.jsx("marker",{id:"slope",viewBox:"-1.5 0 3 1.5",refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:"var(--rmg-theme-colour)"})}),e.jsx(Z,{})]})}),Ie=r=>{const{prevStnIds:n,nextStnIds:t}=r,{info_panel_type:s,svgWidth:o,stn_list:i}=N(h=>h.param),a=o.runin/2,l=t.length===1&&["linestart","lineend"].includes(t[0]),c=n.length===1&&["linestart","lineend"].includes(n[0]),d=t.map(h=>i[h].localisedName),f=n.map(h=>i[h].localisedName),[{zh:u="",en:g=""}]=d,[{zh:j="",en:x=""}]=f,_=(t.length>1?(u.split("\\").length-1)*-50+(g.split("\\").length-1)*-30:0)+10,m=(n.length>1?(j.split("\\").length-1)*-50+(x.split("\\").length-1)*-30:0)+10;return e.jsxs(e.Fragment,{children:[e.jsx(Ee,{prevStnIds:n,nextStnIds:t,nextBranchLineDy:_,prevBranchLineDy:m}),l&&s!=="sh2020"?e.jsx(se,{mode:"terminal",prevStnIds:n,nextStnIds:t}):c&&s!=="sh2020"?e.jsx(se,{mode:"original",prevStnIds:n,nextStnIds:t}):e.jsxs(e.Fragment,{children:[e.jsx(Le,{prevStnIds:n,nextStnIds:t}),e.jsx("g",{transform:`translate(${a},160)`,textAnchor:"middle",children:e.jsx(me,{})})]}),(c||!l)&&e.jsx(Be,{stnIds:r.nextStnIds}),(l||!c)&&e.jsx(We,{stnIds:r.prevStnIds})]})},se=r=>{const{mode:n,prevStnIds:t,nextStnIds:s}=r,{current_stn_idx:o,theme:i,svgWidth:a,direction:l,coline:c}=N(x=>x.param),{branches:d}=N(x=>x.helper),f={l:{original:{x:a.runin-36,anchor:"end"},terminal:{x:36,anchor:"start"}},r:{original:{x:36,anchor:"start"},terminal:{x:a.runin-36,anchor:"end"}}},u=T(Object.values(c),d),g=n==="terminal"?t:s,j=s.length>1?"var(--rmg-theme-colour)":u.filter(x=>x.linePath.includes(o)&&x.linePath.includes(g[0])).map(x=>x.colors[0][2])[0]??"var(--rmg-theme-colour)";return e.jsxs(e.Fragment,{children:[n==="original"&&e.jsx("path",{transform:`translate(0,${c.length?"198":"220"})${c.length?"scale(1,2)":""}`,stroke:j,strokeWidth:12,d:l==="l"?`M ${a.runin-24},16 H 36`:`M24,16 H ${a.runin-36}`,markerEnd:"url(#slope)"}),n==="terminal"&&e.jsx("g",{filter:i[2]==="#B5B5B6"?"url(#pujiang_outline)":void 0,children:e.jsx("path",{transform:`translate(0,${c.length?"198":"220"})${c.length?"scale(1,2)":""}`,stroke:"var(--rmg-grey)",strokeWidth:12,d:`M24,16 H ${a.runin-24}`})}),e.jsx("g",{transform:`translate(${f[l][n].x},160)`,textAnchor:f[l][n].anchor,children:e.jsx(me,{})})]})},Le=r=>{const{prevStnIds:n,nextStnIds:t}=r,{direction:s,svgWidth:o,theme:i,coline:a,current_stn_idx:l,stn_list:c}=N($=>$.param),{branches:d}=N($=>$.helper),f=o.runin/2,u=$=>$.includes("linestart")||$.includes("lineend"),g=T(Object.values(a),d),j=t.length>1?"single":u(t)?g.filter($=>[l,n[0]].every(k=>$.linePath.includes(k))).length>0?"multiple":"single":[l,t[0]].every($=>d[0].includes($))&&g.filter($=>[l,t[0]].every(k=>$.linePath.includes(k))).length>0?"multiple":"single",x=u(t)?n:t,_=t.length>1?"var(--rmg-theme-colour)":g.filter($=>$.linePath.includes(l)&&$.linePath.includes(x[0])).map($=>$.colors[0][2])[0]??"var(--rmg-theme-colour)",m=($,k,b,y)=>$.slice(1).filter(w=>[k,b[0]].every(z=>w.includes(z))).filter(w=>A(w,y)).length>0,h=Object.keys(a).length>0&&m(d,l,t,c)?_:"var(--rmg-theme-colour)",p=Object.keys(a).length>0&&t.length===1&&(u(n)||u(t)?!0:!([l,t[0]].every($=>d[0].includes($))&&g.filter($=>$.linePath.includes(l)&&$.linePath.includes(t[0])).length!==0)),v=Object.keys(a).length>0&&n.length===1;return e.jsxs("g",{transform:"translate(0,220)",strokeWidth:12,children:[e.jsxs(e.Fragment,{children:[h!=="var(--rmg-theme-colour)"&&e.jsx("marker",{id:`slope_${h}`,viewBox:"-1.5 0 3 1.5",refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:h})}),e.jsx("path",{stroke:h,d:`M ${f},16 H ${s==="l"?36:o.runin-36}`,markerEnd:h==="var(--rmg-theme-colour)"?"url(#slope)":`url(#slope_${h})`,transform:p?"translate(0,-22)scale(1,2)":void 0})]}),j==="multiple"&&e.jsxs(e.Fragment,{children:[e.jsx("marker",{id:`slope_${_}`,viewBox:"-1.5 0 3 1.5",refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:_})}),e.jsx("path",{stroke:_,d:`M ${f},16 H ${s==="l"?36+B:o.runin-(36+B)}`,markerEnd:`url(#slope_${_})`,transform:"translate(0,-12)"})]}),e.jsx("g",{filter:i[2]==="#B5B5B6"?"url(#pujiang_outline)":void 0,transform:`translate(0,${v?-22:0})scale(1,${v?2:1})`,children:e.jsx("path",{stroke:"var(--rmg-grey)",d:`M ${f},16 H ${s==="l"?o.runin-24:24} `})})]})},Ee=r=>{const{prevStnIds:n,nextStnIds:t,nextBranchLineDy:s,prevBranchLineDy:o}=r,{direction:i,svgWidth:a,current_stn_idx:l,coline:c,theme:d}=N(p=>p.param),{branches:f}=N(p=>p.helper),u=a.runin/2,g=125,j=p=>`${p[0]},${p[1]}`,x=p=>`M${j(p.at(0))} `+p.slice(1).map(v=>`L${j(v)}`).join(" "),_=i==="l"?[[a.runin/3,g],[a.runin/6,s],[36,s]]:[[a.runin/3*2,g],[a.runin/6*5,s],[a.runin-36,s]],m=i==="l"?[[a.runin/3*2,g],[a.runin/6*5,o],[a.runin-24,o]]:[[a.runin/3,g],[a.runin/6,o],[24,o]];let h="var(--rmg-theme-colour)";if(Object.keys(c).length>0){const p=T(Object.values(c),f);t.length>1&&p.filter(v=>v.linePath.includes(l)&&t.some($=>v.linePath.includes($)))&&(_[0][1]-=B-1,_.unshift([u,g-B+1]),h=p.filter(v=>v.linePath.includes(l)&&t.some($=>v.linePath.includes($))).at(0).colors.at(0)[2]),n.length>1&&p.filter(v=>v.linePath.includes(l)&&n.some($=>v.linePath.includes($)))&&(m[0][1]-=B-1,m.unshift([u,g-B+1]))}return e.jsxs("g",{transform:"translate(0,110)",strokeWidth:12,fill:"none",filter:d[2]==="#B5B5B6"?"url(#pujiang_outline)":void 0,children:[e.jsx("marker",{id:"slope_branch",viewBox:"-1.5 0 3 1.5",refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:h})}),t.length>1&&e.jsx("path",{stroke:h,d:x(_),markerEnd:"url(#slope_branch)"}),n.length>1&&e.jsx("path",{stroke:"var(--rmg-grey)",d:x(m)})]})},me=()=>{const r=N(o=>o.param),{localisedName:n}=r.stn_list[r.current_stn_idx],{zh:t="",en:s=""}=n;return S.useMemo(()=>e.jsxs(e.Fragment,{children:[e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:112,children:t.replace("\\","")}),e.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:36,dy:50,children:s.replace("\\","")})]}),[t,s])},R=r=>{const{nextName:n,...t}=r,{zh:s="",en:o=""}=n;return e.jsx("g",{...t,children:S.useMemo(()=>e.jsxs(e.Fragment,{children:[s.split("\\").map((i,a,l)=>e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:48,dy:(l.length-1-a)*-50-(o.split("\\").length-1)*30,children:i},i)),o.split("\\").map((i,a,l)=>e.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:24,dy:28+(l.length-1-a)*-30,children:i},i))]}),[s,o])})},We=r=>{const n=N(l=>l.param),t=r.stnIds.map(l=>n.stn_list[l].localisedName),s=(r.stnIds.length>1?15:125)+t.map(l=>l.zh?.split("\\")?.length??1).reduce((l,c)=>l+c,-t.length)*-50+t.map(l=>l.en?.split("\\")?.length??1).reduce((l,c)=>l+c,-t.length)*-30,[{zh:o="",en:i=""}]=t,a=(r.stnIds.length>1?(o.split("\\").length-1)*-50+(i.split("\\").length-1)*-30:0)+70;return e.jsxs("g",{fill:"gray",textAnchor:n.direction==="l"?"end":"start",transform:`translate(${n.direction==="l"?n.svgWidth.runin-36:36},0)`,children:[e.jsx(R,{nextName:t[0],transform:"translate(0,183)"}),r.stnIds.length>1&&e.jsx(R,{nextName:t[1],transform:`translate(0,${a})`}),e.jsxs("g",{transform:`translate(0, ${s})`,children:[e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:22,children:"上一站"}),e.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:12,dx:n.direction==="l"?-70:70,children:"Past Stop"})]})]})},Be=r=>{const n=N(l=>l.param),t=r.stnIds.map(l=>n.stn_list[l].localisedName),s=(r.stnIds.length>1?15:125)+t.map(l=>l.zh?.split("\\")?.length??1).reduce((l,c)=>l+c,-t.length)*-50+t.map(l=>l.en?.split("\\")?.length??1).reduce((l,c)=>l+c,-t.length)*-30,[{zh:o="",en:i=""}]=t,a=(r.stnIds.length>1?(o.split("\\").length-1)*-50+(i.split("\\").length-1)*-30:0)+70;return e.jsxs("g",{textAnchor:n.direction==="l"?"start":"end",transform:`translate(${n.direction==="l"?36:n.svgWidth.runin-36},0)`,children:[e.jsx(R,{nextName:n.stn_list[r.stnIds[0]].localisedName,transform:"translate(0,183)"}),r.stnIds.length>1&&e.jsx(R,{nextName:n.stn_list[r.stnIds[1]].localisedName,transform:`translate(0,${a})`}),e.jsxs("g",{transform:`translate(0, ${s})`,children:[e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:22,children:"下一站"}),e.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:12,dx:n.direction==="l"?70:-70,children:"Next Stop"})]})]})},Y=r=>{const{stnId:n,stnState:t,color:s,bank:o,direction:i}=r,{direction:a,info_panel_type:l,stn_list:c,loop:d}=N(v=>v.param),f=c[n],u=i??a,g=d?0:(f.parents.length>1||f.children.length>1?8+12*(f.localisedName.en?.split("\\")?.length??1):0)*(u==="r"?-1:1);let j;const x={};l==="sh2020"?(f.services.length===3?j="stn_sh_2020_direct":f.services.length===2?j="stn_sh_2020_express":j="stn_sh_2020",x.fill=t===-1?"gray":s||"var(--rmg-theme-colour)"):(f.services.length===3?j="direct_sh":f.services.length===2?j="express_sh":[...f.transfer.groups[0].lines||[],...f.transfer.groups[1]?.lines||[]].length>0?j="int2_sh":j="stn_sh",x.stroke=t===-1?"gray":s||"var(--rmg-theme-colour)");const _=o??0,m=(u==="l"?6:-6)+g+_*30,h=(l==="sh2020"?-20:-6)+Math.abs(_)*(l==="sh2020"?25:11),p=_?0:u==="l"?-45:45;return e.jsxs(e.Fragment,{children:[e.jsx("use",{xlinkHref:`#${j}`,...x,transform:`translate(${_*(l==="sh2020"?5:0)},0)rotate(${_*90*(l==="sh2020"?1:-1)})`}),e.jsx("g",{transform:`translate(${m},${h})rotate(${p})`,children:e.jsx(Te,{name:f.localisedName,groups:f.transfer.groups,stnState:t,direction:u,facility:f.facility,bank:_,oneLine:f.one_line,intPadding:f.int_padding})}),t===0?e.jsx(Ce,{}):void 0]})},Te=r=>{const{name:n,groups:t,stnState:s,direction:o,facility:i,bank:a,oneLine:l,intPadding:c}=r,d=S.useRef(null),f=o==="l"?1:-1,u=i?30:0,g=a?-12:0,j=S.useRef(null),[x,_]=S.useState(0);S.useEffect(()=>_(j.current?.getBBox().width??0),[JSON.stringify(t)]);const m=c-x;return e.jsxs(e.Fragment,{children:[t.map(h=>h.lines??[]).flat().length>0&&e.jsxs(e.Fragment,{children:[e.jsx("line",{x1:(g+u)*f,x2:m*f,stroke:s===-1?"gray":"black",strokeWidth:.5}),e.jsx(Fe,{ref:j,groups:t,direction:o,transform:`translate(${m*f},-10.75)`})]}),i&&e.jsx("use",{xlinkHref:"#"+i,x:10*f,y:-30}),e.jsxs("g",{textAnchor:o==="l"?"start":"end",transform:`translate(${u*f},-14)`,children:[e.jsx(Pe,{ref:d,stnName:n,oneLine:l,directionPolarity:f,fill:s===-1?"gray":s===0?"red":"black"}),t[1]?.lines?.length&&e.jsx("g",{transform:`translate(${(m+x/2)*f},-30)`,children:e.jsx(Ge,{osiInfos:t[1].lines})}),t[2]?.lines?.length&&e.jsx("g",{transform:`translate(${(c+5)*f},0)`,children:e.jsx(Ye,{osysiInfos:t[2].lines,direction:r.direction})})]})]})},Pe=S.forwardRef(function(n,t){const{stnName:s,oneLine:o,directionPolarity:i,...a}=n,{zh:l="",en:c=""}=s,d=S.useRef(null),[f,u]=S.useState(0);S.useEffect(()=>{o&&d.current?u(d.current.getBBox().width+5):u(0)},[s.zh,s.en,o]);const[g,j]=[20,8];return e.jsx("g",{ref:t,...a,children:S.useMemo(()=>e.jsxs(e.Fragment,{children:[e.jsx("g",{ref:d,children:l.split("\\").map((x,_,m)=>e.jsx("text",{className:"rmg-name__zh rmg-outline",dy:(m.length-1-_)*-g+(o?j:(c.split("\\").length-1)*-j),children:x},_))}),e.jsx("g",{fontSize:8,transform:`translate(${f*i},0)`,children:c.split("\\").map((x,_,m)=>e.jsx("text",{className:"rmg-name__en rmg-outline",dy:(m.length-2-_)*-j+2,children:x},_))})]}),[l,c,o,f,i])})}),Ce=()=>{const{stn_list:r}=N(s=>s.param),n=new Set(Object.values(r).map(s=>s.services).flat()),t=[-1,35,50,75][n.size];return e.jsx("g",{transform:`translate(0, ${t})`,children:e.jsx("text",{className:"rmg-name__zh",fill:"red",textAnchor:"middle",children:"本站"})})},Fe=S.forwardRef(function(n,t){const{groups:s,direction:o,...i}=n,a=[...s[0].lines||[],...s[1]?.lines||[],...s[2]?.lines?.filter(c=>!!c.name[0].match(/^磁(悬)*浮/))||[]];let l=0;return e.jsx("g",{ref:t,fontSize:14,textAnchor:"middle",...i,children:a.map((c,d)=>{const f=!!c.name[0].match(/^\w+(号)?线/),u=!!c.name[0].match(/^磁(悬)*浮/);o==="r"&&(l-=(f||u?20:c.name[0].length*14+12)+(d===0?0:5));let g;return u?g=e.jsx("g",{transform:`translate(${l},-16)scale(0.1428571429)`,children:e.jsx(De,{info:c})},d):f?g=e.jsx("g",{transform:`translate(${l},0)`,children:e.jsx(Re,{info:c})},d):g=e.jsx("g",{transform:`translate(${l},0)`,children:e.jsx(Ae,{info:c})},d),o==="l"&&(l+=f||u?25:c.name[0].length*14+12+5),g})})}),De=S.memo(function(n){return e.jsx(e.Fragment,{children:e.jsx("use",{xlinkHref:"#intbox_maglev",fill:n.info.theme?.[2],stroke:n.info.theme?.[2]})})},(r,n)=>JSON.stringify(r.info)===JSON.stringify(n.info)),Re=S.memo(function(n){return e.jsxs(e.Fragment,{children:[e.jsx("use",{xlinkHref:"#intbox_number",fill:n.info.theme?.[2]}),e.jsx("text",{x:10,className:"rmg-name__zh",fill:n.info.theme?.[3],dominantBaseline:"central",children:n.info.name[0].match(/(\d*)\w+/)?.[0]})]})},(r,n)=>JSON.stringify(r.info)===JSON.stringify(n.info)),Ae=S.memo(function(n){const t=n.info.name[0].split("\\")[0].length;return e.jsxs(e.Fragment,{children:[e.jsx("rect",{height:22,width:t*14+12,y:-11,fill:n.info.theme?.[2]}),e.jsx("text",{x:t*7+6,className:"rmg-name__zh",fill:n.info.theme?.[3],dominantBaseline:"central",children:n.info.name[0].split("\\")[0]})]})},(r,n)=>JSON.stringify(r.info)===JSON.stringify(n.info)),Ge=r=>{const n=r.osiInfos.map(t=>t.name[0]).join("，");return S.useMemo(()=>e.jsxs("g",{textAnchor:"middle",fontSize:"50%",children:[e.jsx("text",{className:"rmg-name__zh",dy:-5,children:`换乘${n}`}),e.jsx("text",{className:"rmg-name__zh",dy:5,children:"仅限公共交通卡"}),e.jsx("text",{className:"rmg-name__en",dy:12.5,fontSize:"75%",children:"Only for Public Transportation Card"})]}),[n.toString()])},Ye=r=>{const n=r.osysiInfos.map(s=>s.name[0]).join("，"),t=r.osysiInfos.map(s=>s.name[1]).join(", ");return S.useMemo(()=>e.jsxs("g",{textAnchor:r.direction==="l"?"start":"end",fontSize:"50%",children:[e.jsxs("text",{className:"rmg-name__zh",dy:3,children:["转乘",n]}),e.jsxs("text",{className:"rmg-name__en",dy:10,fontSize:"75%",children:["To ",t]})]}),[JSON.stringify(r.osysiInfos),r.direction])},Ve=["shanghai","sh4","#5F259F","#fff","4号线","Line 4"],Xe=r=>{const{xs:n,servicesPresent:t,stnStates:s}=r,{svg_height:o,direction:i,stn_list:a,current_stn_idx:l,branchSpacingPct:c,info_panel_type:d,coline:f}=N(k=>k.param),{branches:u,depsStr:g}=N(k=>k.helper),j=S.useMemo(()=>(console.log("computing y shares"),Object.keys(a).reduce((k,b)=>{if(u[0].includes(b))return{...k,[b]:0};{const y=u.slice(1).filter(w=>w.includes(b))[0];return{...k,[b]:a[y[0]].children.indexOf(y[1])?-3:3}}},{})),[g]),x=Object.entries(j).filter(([,k])=>k<=0).reduce((k,[b,y])=>({...k,[b]:y}),{}),_=Object.keys(x).reduce((k,b)=>({...k,[b]:-x[b]*c*o/300}),{}),m=S.useMemo(()=>Oe(T(Object.values(f).filter(k=>k.display),u),s),[JSON.stringify(f),l,i,g]),h=t.reduce((k,b)=>({...k,[b]:Object.keys(m).reduce((y,w)=>({...y,[w]:m[w].map(z=>({path:xe(z.linePath,w,n,_,i,b,t.length,a,"diagonal"),colors:z.colors})).filter(z=>z.path!=="")}),{})}),{}),p=T(Object.values(f).filter(k=>k.display),u).map(k=>k.linePath).flat(),v=12,$=d==="sh2020"?3:0;return e.jsx(e.Fragment,{children:e.jsxs("g",{id:"coline",transform:`translate(0,${v+$})`,children:[e.jsx(Je,{paths:h,direction:i}),e.jsx(Ze,{colineStns:m,branches:u,xs:n,ys:_,stnStates:s,lineWidth:v,colineGap:$}),e.jsx(Ue,{stnIds:Object.entries(j).filter(([,k])=>k<0).reduce((k,[b])=>[...k,b],[]).filter(k=>!["linestart","lineend"].includes(k)).filter(k=>a[k].services.length!==0).filter(k=>p.includes(k)),xs:n,ys:_,stnStates:s})]})})},Je=r=>{const{paths:n,direction:t}=r;return e.jsx(e.Fragment,{children:Object.keys(n).map((s,o)=>e.jsx("g",{transform:`translate(0,${o*25})`,children:e.jsxs("g",{children:[n[s]?.pass.map((i,a)=>e.jsx(S.Fragment,{children:e.jsx("path",{stroke:"var(--rmg-grey)",strokeWidth:12,fill:"none",d:i.path,strokeLinejoin:"round",filter:s===E.local?void 0:`url(#contrast-${s})`},a)},a)),n[s]?.main.map((i,a)=>e.jsxs(S.Fragment,{children:[i.colors.length>1&&e.jsx("linearGradient",{id:`grad${a}`,y1:"-100%",y2:"100%",x1:"0",x2:"0",gradientUnits:"userSpaceOnUse",children:i.colors.map((l,c)=>e.jsxs(S.Fragment,{children:[e.jsx("stop",{offset:`${100/i.colors.length*(c+0)}%`,stopColor:l[2]}),e.jsx("stop",{offset:`${100/i.colors.length*(c+1)}%`,stopColor:l[2]})]},c))}),t==="l"&&e.jsx("marker",{id:`arrow_left_${a}_${i.colors.map(l=>l[2]).join("_")}`,refY:.5,refX:1,children:e.jsx("path",{d:"M1,0L0,1H1z",fill:i.colors.length>1?`url(#grad${a})`:i.colors[0][2]})}),t==="r"&&e.jsx("marker",{id:`arrow_right_${a}_${i.colors.map(l=>l[2]).join("_")}`,refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:i.colors.length>1?`url(#grad${a})`:i.colors[0][2]})}),e.jsx("path",{stroke:(i.colors.at(-1)??Ve)[2],strokeWidth:12,fill:"none",d:i.path,markerStart:t==="l"?`url(#arrow_left_${a}_${i.colors.map(l=>l[2]).join("_")})`:void 0,markerEnd:t==="r"?`url(#arrow_right_${a}_${i.colors.map(l=>l[2]).join("_")})`:void 0,strokeLinejoin:"round",filter:s===E.local?void 0:`url(#contrast-${s})`},a)]},a))]})},`servicePath${o}`))})},Ze=r=>{const{colineStns:n,branches:t,xs:s,ys:o,stnStates:i,lineWidth:a,colineGap:l}=r,{line_name:c,theme:d,info_panel_type:f}=N(g=>g.param),u=[...n.main,...n.pass].map(g=>g.linePath.map(j=>({curStn:j,x:s[j],y:o[j],color:g.colors.at(-1)??[...d,...c]}))).flat().reduce((g,j)=>g.find(x=>x.curStn===j.curStn)?g:g.concat(j),[]).filter(g=>t[0].includes(g.curStn));return console.log(u),e.jsx("g",{id:"stations_in_mainline",children:u.map(g=>{const{curStn:j,x,y:_,color:m}=g,h=(i[j]===-1?0:a)+l+a,p=(i[j]===-1?0:-a)-l-a/2;return e.jsx("g",{transform:`translate(${x},${_})`,children:f==="sh2020"?e.jsx("rect",{stroke:"none",height:h,width:12,x:-6,y:p,fill:i[j]===-1?"var(--rmg-grey)":m[2]}):e.jsx("use",{xlinkHref:"#int2_sh",stroke:"var(--rmg-theme-colour)",transform:`translate(0,${-a})`})},j)})})},Ue=r=>{const{xs:n,ys:t,stnStates:s,stnIds:o}=r,{branches:i,depsStr:a}=N(g=>g.helper),{line_name:l,theme:c,coline:d}=N(g=>g.param),f=S.useMemo(()=>T(Object.values(d),i),[JSON.stringify(d),a]),u=o.reduce((g,j)=>({...g,[j]:f.filter(x=>x.linePath.includes(j)).map(x=>x.colors).flat().at(0)??[...c,...l]}),{});return e.jsx("g",{id:"stations_in_coline",children:o.map(g=>e.jsx("g",{transform:`translate(${n[g]},${t[g]})`,children:e.jsx(Y,{stnId:g,stnState:s[g],color:u[g][2]})},g))})},qe=()=>{const{routes:r,branches:n,depsStr:t}=N(y=>y.helper),s=N(y=>y.param),{svg_height:o,stn_list:i,branchSpacingPct:a,coline:l,direction:c}=N(y=>y.param),d=oe(s.stn_list,()=>0,()=>0),f=D("linestart","lineend",d),u=D(f.nodes[1],f.nodes.slice(-2)[0],d),g=S.useMemo(()=>(console.log("computing x shares"),Object.keys(s.stn_list).reduce((y,w)=>({...y,[w]:ce(w,d,n)}),{})),[n.toString(),JSON.stringify(d)]),j=[s.svgWidth.railmap*s.padding/100,s.svgWidth.railmap*(1-s.padding/100)],x=Object.keys(g).reduce((y,w)=>({...y,[w]:j[0]+g[w]/u.len*(j[1]-j[0])}),{}),_=S.useMemo(()=>(console.log("computing y shares"),Object.keys(i).reduce((y,w)=>{if(n[0].includes(w))return{...y,[w]:0};{const z=n.slice(1).filter(H=>H.includes(w))[0];return{...y,[w]:i[z[0]].children.indexOf(z[1])?-3:3}}},{})),[t]),m=Object.entries(_).filter(([,y])=>y>=0).reduce((y,[w,z])=>({...y,[w]:z}),{}),h=Object.keys(m).reduce((y,w)=>({...y,[w]:-m[w]*a*o/300}),{}),p=S.useMemo(()=>he(s.current_stn_idx,r,s.direction),[s.current_stn_idx,s.direction,r.toString()]),v=Object.values(E),$=Object.values(s.stn_list).map(y=>y.services).flat().reduce((y,w)=>(y[v.indexOf(w)]=!0,y),[!1,!1,!1]).map((y,w)=>[v[w],y]).filter(y=>y[1]).map(y=>y[0]),k=n.map(y=>ie(y,p)).reduce((y,w)=>(y.main.push(w.main),y.pass.push(w.pass),y),{main:[],pass:[]}),b=$.reduce((y,w)=>({...y,[w]:Object.keys(k).reduce((z,H)=>({...z,[H]:k[H].map(L=>xe(L,H,x,h,c,w,$.length,i)).filter(L=>L!=="")}),{})}),{});return e.jsxs("g",{id:"main",transform:`translate(0,${s.svg_height*(Object.keys(l).length>0?.5:.7+.1)})`,children:[e.jsx(Ke,{paths:b,direction:s.direction}),e.jsx(Qe,{stnIds:Object.keys(m).filter(y=>!["linestart","lineend"].includes(y)).filter(y=>i[y].services.length!==0),xs:x,ys:h,stnStates:p}),Object.keys(l).length>0&&e.jsx(Xe,{xs:x,servicesPresent:$,stnStates:p}),$.length>1&&e.jsx(et,{servicesLevel:$,lineXs:j})]})},Ke=r=>{const{theme:n}=N(o=>o.param),{paths:t,direction:s}=r;return e.jsx(e.Fragment,{children:Object.keys(t).map((o,i)=>e.jsxs("g",{transform:`translate(0,${i*25})`,filter:n[2]==="#B5B5B6"?"url(#pujiang_outline)":void 0,children:[e.jsx("g",{children:t[o]?.pass.map((a,l)=>e.jsx("path",{stroke:"var(--rmg-grey)",strokeWidth:12,fill:"none",d:a,markerStart:r.direction==="l"?"url(#arrow_gray)":void 0,markerEnd:r.direction==="r"?"url(#arrow_gray)":void 0,strokeLinejoin:"round"},l))}),e.jsx("g",{children:t[o]?.main.map((a,l)=>e.jsx("path",{stroke:"var(--rmg-theme-colour)",strokeWidth:12,fill:"none",d:a,markerStart:s==="l"?"url(#arrow_theme_left)":void 0,markerEnd:s==="r"?"url(#arrow_theme_right)":void 0,strokeLinejoin:"round",filter:o===E.local?void 0:`url(#contrast-${o})`},l))})]},`servicePath${i}`))})},xe=(r,n,t,s,o,i,a,l,c="rightangle")=>{let[d,f]=[];const u={},g={local:0,express:20,direct:40}[i],j=a>1?50:0;let x=30;if(r.length>0){let m=!1,h=!1;l[r.at(-1)||0].children.some(p=>["linestart","lineend"].includes(p))?h=!0:l[r.at(0)||0].parents.some(p=>["linestart","lineend"].includes(p))&&(m=!0),x=m||h?x:0}const _=30;if(r.forEach(m=>{const h=t[m],p=s[m];if(!d&&d!==0){[f,d]=[h,p],u.start=[h,p];return}p===0?p!==d&&(u.bifurcate=[f,d]):p!==d&&(u.bifurcate=[h,p]),u.end=[h,p],[f,d]=[h,p]}),"start"in u)if("end"in u)if("bifurcate"in u){const[m,h]=u.start,p=u.bifurcate[0],[v,$]=u.end;return n==="main"?o==="l"?$>h?(console.log(u),c==="rightangle"?`M ${m-x},${h} H ${v} V ${$}`:`M ${m},${h} H ${m+_} L ${p-_},${$} H ${v}`):c==="rightangle"?`M ${m},${h} V ${$} H ${v}`:`M ${m-x},${h} H ${p+_} L ${v-_},${$} H ${v}`:$>h?c==="rightangle"?`M ${m},${h} H ${v} V ${$}`:`M ${m},${h} H ${m+_} L ${p-_},${$} H ${v+x}`:c==="rightangle"?`M ${m},${h} V ${$} H ${v+x}`:`M ${m},${h} H ${p+_} L ${v-_},${$} H ${v}`:o==="l"?$>h?c==="rightangle"?`M ${m-x},${h} H ${v} V ${$}`:`M ${m},${h} H ${m+_} L ${p-_},${$} H ${v+x}`:c==="rightangle"?`M ${m},${h} V ${$} H ${v+x}`:`M ${m-x},${h} H ${p+_} L ${v-_},${$} H ${v}`:$>h?c==="rightangle"?`M ${m-x},${h} H ${v} V ${$}`:`M ${m},${h} H ${m+_} L ${p-_},${$} H ${v+x}`:c==="rightangle"?`M ${m},${h} V ${$} H ${v+x}`:`M ${m-x},${h} H ${p+_} L ${v-_},${$} H ${v}`}else{const[m,h]=u.start,p=u.end[0];return n==="main"?o==="l"?`M ${m-x-g},${h} H ${p}`:`M ${m},${h} H ${p+x+g}`:o==="l"?`M ${m-x},${h} H ${p+x+j}`:`M ${m-x-j},${h} H ${p+x}`}else{const[m,h]=u.start;return n==="main"?o==="l"?`M ${m-x-g},${h} H ${m}`:`M ${m},${h} H ${m+x+g}`:o==="l"?`M ${m},${h} L ${m+x+j},${h}`:`M ${m-x-j},${h} L ${m},${h}`}else return""},Qe=r=>{const{xs:n,ys:t,stnStates:s,stnIds:o}=r;return e.jsx("g",{children:o.map(i=>e.jsx("g",{transform:`translate(${n[i]},${t[i]})`,children:e.jsx(Y,{stnId:i,stnState:s[i]})},i))})},et=r=>{const{svg_height:n,direction:t,svgWidth:s}=N(c=>c.param),o=-n+130,i=r.servicesLevel.map(c=>({local:"普通车",express:"大站车",direct:"直达车"})[c]),a=t==="r"?r.lineXs[0]-42:r.lineXs[1]+42,l=r.servicesLevel.length===2?350:500;return S.useMemo(()=>e.jsxs("g",{children:[i.map((c,d)=>e.jsxs("g",{transform:`translate(${a},${d*25})`,children:[e.jsx("rect",{x:-27.5,height:10,width:55,fill:"white",stroke:"black",y:-5}),e.jsx("text",{className:"rmg-name__zh",fontSize:9,y:3,textAnchor:"middle",children:`${c}运行线`})]},c)),e.jsxs("g",{transform:`translate(${t==="r"?30:s.railmap-l},${o})`,children:[e.jsx("text",{className:"rmg-name__zh",children:"图例："}),i.map((c,d)=>e.jsxs("g",{transform:`translate(${d*150+50},0)`,children:[e.jsx("line",{x1:"0",x2:"35",y1:"-5",y2:"-5",stroke:"var(--rmg-theme-colour)",strokeWidth:"12",filter:d===2?"url(#contrast-direct)":d===1?"url(#contrast-express)":""}),e.jsx("use",{x:"17.5",y:"-5",xlinkHref:"#stn_sh",fill:"var(--rmg-theme-colour)"}),e.jsx("text",{x:"40",className:"rmg-name__zh",children:`${c}停靠站`})]},`serviceLevel${d}`))]})]}),[n,t,s,r.servicesLevel,r.lineXs])},tt=()=>{const{direction:r,svgWidth:n,coline:t}=N(o=>o.param),s=!!Object.keys(t).length;return S.useMemo(()=>e.jsxs("g",{transform:`translate(${r==="l"?50:n.railmap-150},50)`,children:[e.jsx("text",{className:"rmg-name__zh",children:"列车前进方向"}),e.jsx("path",{d:"M60,60L0,0L60-60H100L55-15H160V15H55L100,60z",stroke:s?"var(--rmg-black)":void 0,strokeWidth:s?5:void 0,fill:s?"var(--rmg-white)":"var(--rmg-theme-colour)",transform:`translate(${r==="l"?-30:125},-5)rotate(${r==="l"?0:180})scale(0.15)`})]}),[r,t,n.railmap])},U=r=>{const{stnId:n,nameDirection:t,services:s,color:o}=r,i=N(d=>d.param.stn_list[n]),a=[...i.transfer.groups[0]?.lines||[],...i.transfer.groups[1]?.lines||[]];let l;i.services.length===3?l="direct_indoor_sh":i.services.length===2?l="express_indoor_sh":i.transfer.groups[1]?.lines?.length??!1?l="osi_indoor_sh":a.length>0?l="int2_indoor_sh":l="stn_indoor_sh";const c=t==="left"||t==="right"?90:0;return e.jsxs(e.Fragment,{children:[e.jsx(nt,{name:i.localisedName,groups:i.transfer.groups,nameDirection:t,services:s}),e.jsx("use",{xlinkHref:`#${l}`,stroke:a.length>0?"var(--rmg-black)":o??"var(--rmg-theme-colour)",transform:`rotate(${c})`}),i.services.length>1&&e.jsx("text",{className:"rmg-name__zh",writingMode:"tb",fontSize:"60%",dy:"-12",children:`大站车${i.services.length>2?" 直达车":""}停靠`})]})},nt=r=>{const{name:n,groups:t,nameDirection:s,services:o}=r,i={upward:60,downward:-30,left:0,right:0}[s],a=t[2]?.lines?.length?{upward:0,downward:0,left:(t[0].lines?.length||0)+(t[1]?.lines?.length||0)!==0?85:25,right:(t[0].lines?.length||0)+(t[1]?.lines?.length||0)!==0?-85:-25}[s]:0,l=t[2]?.lines?.length?{upward:t[0]?.lines?.length&&t[1]?.lines?.length?-210:t[0]?.lines?.length||t[1]?.lines?.length?-177.5:-145,downward:(t[0]?.lines?.length&&t[1]?.lines?.length?185:t[0].lines?.length||t[1]?.lines?.length?157.5:125)+(o.length===3?40:0),left:t[0]?.lines?.length&&t[1]?.lines?.length?-67:t[0].lines?.length||t[1]?.lines?.length?-30:0,right:t[0]?.lines?.length&&t[1]?.lines?.length?-67:t[0].lines?.length||t[1]?.lines?.length?-30:0}[s]:0,c=S.useRef(null),d=60,[f,u]=S.useState(d);return S.useEffect(()=>{c?.current&&u(Math.max(d,c.current.getBBox().width))},[n.zh,n.en]),e.jsxs("g",{transform:`translate(0,${i})`,children:[s==="upward"||s==="downward"?e.jsxs(e.Fragment,{children:[e.jsx("line",{x1:-f/2,x2:f/2,y1:s==="upward"?-23:-10,y2:s==="upward"?-23:-10,stroke:"black"}),e.jsx("line",{y1:s==="upward"?-23:-10,y2:s==="upward"?-48:20,stroke:"black"})]}):e.jsxs(e.Fragment,{children:[e.jsx("line",{x1:s==="left"?-50:15,x2:s==="left"?-15:50,y1:0,y2:0,stroke:"black"}),e.jsx("line",{x1:s==="left"?-50:50,x2:s==="left"?-50:50,y1:-30,y2:30,stroke:"black"})]}),[...t[0].lines||[],...t[1]?.lines||[]].length&&e.jsx(rt,{intInfos:[t[0].lines||[],t[1]?.lines||[]],arrowDirection:s,services:o}),e.jsx(st,{ref:c,stnName:n,nameDirection:s,fill:"black"}),t[2]?.lines?.length&&e.jsx("g",{transform:`translate(${a},${l})`,children:e.jsx(lt,{osysiInfos:t[2].lines,nameDirection:s})})]})},st=S.forwardRef(function(n,t){const{stnName:s,nameDirection:o,...i}=n,{zh:a="",en:l=""}=s,c=a.split("\\"),d=l.split("\\").length,f={upward:0,downward:0,left:-60,right:60}[o],u={upward:-2,downward:-30-12*(d-1),left:-10*(d-1),right:-10*(d-1)}[o],g={upward:"middle",downward:"middle",left:"end",right:"start"}[o];return e.jsx("g",{ref:t,...i,textAnchor:g,transform:`translate(${f},${u})`,children:S.useMemo(()=>e.jsxs(e.Fragment,{children:[c.map((j,x,_)=>e.jsx("text",{className:"rmg-name__zh",dy:o==="upward"?16*x:(_.length-1-x)*-16,children:j},x)),e.jsx("g",{fontSize:9.6,children:l.split("\\")?.map((j,x)=>e.jsx("text",{className:"rmg-name__en",dy:12*(x+1)+(o==="upward"&&c.length>1?c.length*7.5:0),children:j},x))})]}),[a,l])})}),rt=r=>{const{intInfos:n,arrowDirection:t,services:s}=r,o=n.flatMap(m=>m.map(h=>h.theme?.[2])).reduce((m,h)=>m+h,""),i=n.map(m=>[m.filter(h=>h.name[0].match(/^\d+.*$/)).map(h=>h.name[0].replace(/^(\d+)(.*)$/,"$1")).join("，").concat("号线"),m.filter(h=>!h.name[0].match(/^\d+.*$/)).map(h=>h.name[0]).join("，")].filter(h=>h&&h!=="号线").join("，")),a=n.map(m=>["Line ".concat(m.filter(h=>/^(L|l)ine \d+$/.test(h.name[1])).map(h=>h.name[1].replace("Line","").replace("line","").trim()).join(",")),m.filter(h=>!/^(L|l)ine \d+$/.test(h.name[1])).map(h=>h.name[1]).join(", ")].filter(h=>h&&h!=="Line ").join(", ")),l=s.length===3?80:45,c={upward:-145,downward:125+(s.length===3?40:0),left:7,right:7}[t],d={upward:0,downward:0,left:20,right:-20}[t],f={upward:-74,downward:44,left:0,right:0}[t],u={upward:0,downward:180,left:90,right:-90}[t],g={upward:0,downward:0,left:85,right:-85}[t],j={upward:"middle",downward:"middle",left:"start",right:"end"}[t],x=g,_={upward:n.at(0)?.length??0?-177.5:-145,downward:(n.at(0)?.length??0?157.5:125)+(s.length===3?40:0),left:n.at(0)?.length??0?-30:7,right:n.at(0)?.length??0?-30:7}[t];return e.jsxs("g",{children:[e.jsx("path",{id:"int_indoor_arrow_sh",stroke:"var(--rmg-black)",strokeWidth:1,transform:`translate(${d},${f})rotate(${u})`,fill:n.flat().length===1?n.flat()[0].theme?.[2]:`url(#grad${o})`,d:`M -7.5,0 v -${l} h -7.5 l 15,-15 l 15,15 h -7.5 v ${l} Z`}),n.flat().length>1&&e.jsx("linearGradient",{id:`grad${o}`,y1:"0",y2:"0",x1:t==="upward"?"25%":"75%",x2:t==="upward"?"75%":"25%",children:n.flat().map((m,h)=>e.jsxs(S.Fragment,{children:[e.jsx("stop",{offset:`${100/n.flat().length*h}%`,stopColor:m.theme?.[2]}),e.jsx("stop",{offset:`${100/n.flat().length*(h+1)}%`,stopColor:m.theme?.[2]})]},h))}),(n.at(0)?.length??0)>0&&e.jsxs("g",{transform:`translate(${g},${c})`,textAnchor:`${j}`,children:[e.jsx("text",{className:"rmg-name__zh",dy:-7,children:`换乘${i[0]}`}),e.jsx("text",{className:"rmg-name__en",dy:5,fontSize:9.6,children:`Interchange ${a[0]}`})]}),(n.at(1)?.length??0)>0&&e.jsxs("g",{transform:`translate(${x},${_})`,textAnchor:`${j}`,children:[e.jsx("text",{className:"rmg-name__zh",dy:-7,children:`出站换乘${i[1]}`}),e.jsx("text",{className:"rmg-name__en",dy:5,fontSize:9.6,children:`Out-of-station Transfer ${a[1]}`})]})]})},lt=r=>{const n={upward:"middle",downward:"middle",left:"start",right:"end"}[r.nameDirection];return S.useMemo(()=>e.jsxs("g",{textAnchor:`${n}`,children:[e.jsx("text",{className:"rmg-name__zh",dy:-5,children:`转乘${r.osysiInfos.map(t=>t.name[0]).join("，")}`}),e.jsx("text",{className:"rmg-name__en",dy:7.5,fontSize:9.6,children:`To ${r.osysiInfos.map(t=>t.name[1]).join(", ")}`})]}),[JSON.stringify(r.osysiInfos),r.nameDirection])},at=(r,n,t,s,o,i)=>{const a=r[0].filter(g=>!["linestart","lineend"].includes(g)),l=r.slice(1,3).map(g=>g.slice(1,g.length-1)),c=l.reduce((g,j)=>g+j.filter(x=>!["linestart","lineend",...n].includes(x)).length,0)+a.length-i-o*2,d=(t-t*s/100*2)/(1+c),f=[t*s/100+(l.at(0)??[]).length*d,t*(1-s/100)-(l.at(1)??[]).length*d],u={...Object.fromEntries((l.at(0)??[]).map((g,j)=>[g,t*s/100+j*d])),...Object.fromEntries((l.at(1)??[]).map((g,j)=>[g,f[1]+(1+j)*d]))};return{loop_branches:l,line_xs_branches:f,xs_branches:u}},it=r=>{const{loop_branches:n,edges:t,xs:s,ys:o,canvas:i}=r,[a,l,c,d]=t,{branches:f}=N(p=>p.helper),{current_stn_idx:u,direction:g,coline:j}=N(p=>p.param),x=i===O.RailMap?30:0,_=[`M ${a},${c} H ${Number(s[n.at(0)?.at(0)??""])-x}`,`M ${l},${c} H ${Number(s[n.at(1)?.at(-1)??""])+x}`],m=f[0].filter(p=>!["linestart","lineend"].includes(p)),h=Object.values(j).filter(p=>![p.from,p.to].every(v=>m.includes(v))).map(p=>p.colors);return e.jsx(e.Fragment,{children:n.map((p,v)=>e.jsxs(J.Fragment,{children:[h.filter(($,k,b)=>k===b.findIndex(y=>y.at(0)?.at(2)===$.at(0)?.at(2))).map($=>e.jsx("marker",{id:`arrow_theme_${$[0][2]}`,refX:1,refY:.5,children:e.jsx("path",{d:"M0,1H2L1,0z",fill:$[0][2]})},$[0][2])),e.jsx("path",{stroke:h.at(v)?.at(0)?.at(2)??"var(--rmg-theme-colour)",strokeWidth:12,fill:"none",d:_[v],markerEnd:i===O.RailMap&&(g==="l"&&v===0||g==="r"&&v===1)?h.at(v)?`url(#arrow_theme_${h[v][0][2]})`:"url(#arrow_theme)":void 0}),p.filter($=>!["linestart","lineend"].includes($)).map($=>e.jsxs(J.Fragment,{children:[i===O.RailMap&&e.jsx("g",{transform:`translate(${s[$]},${o[$]})`,children:e.jsx(Y,{stnId:$,stnState:u===$?0:1,bank:0,direction:g,color:h.at(v)?.at(0)?.at(2)})},$),i===O.Indoor&&e.jsx("g",{transform:`translate(${s[$]},${o[$]})`,children:e.jsx(U,{stnId:$,nameDirection:n.filter(k=>k.includes($)).map(k=>k.indexOf($)%2===0?"downward":"upward")[0],services:[E.local],color:h.at(v)?.at(0)?.at(2)})},$)]},$))]},p.at(0)))})},ot=r=>{const{edges:n,loop_stns:t,xs:s,ys:o,canvas:i}=r,[a,l,c,d]=n,{info_panel_type:f,stn_list:u,coline:g}=N(h=>h.param),{branches:j}=N(h=>h.helper),x=Object.values(g).filter(h=>[h.from,h.to].every(p=>j.slice(1,3).filter(v=>A(v,u)).flat().includes(p))).map(h=>h.colors).at(0),_=12,m=i===O.RailMap&&f==="sh2020"?3:0;return e.jsxs("g",{id:"coline_main",children:[e.jsx("path",{d:`M ${a},${c} H${l}`,strokeWidth:12,stroke:x?.at(0)?.at(2)}),i===O.RailMap&&Object.keys(g).length>0&&t.top.map(h=>e.jsx("g",{transform:`translate(${s[h]},${o[h]})`,children:f==="sh2020"?e.jsxs(e.Fragment,{children:[e.jsx("rect",{stroke:"none",height:24,width:12,x:-6,y:-m-1,fill:x?.at(0)?.at(2)}),e.jsx("rect",{stroke:"none",height:m+_,width:12,x:-6,y:_-2,fill:"var(--rmg-theme-colour)"})]}):e.jsx("use",{xlinkHref:"#int2_sh",stroke:"var(--rmg-theme-colour)",transform:`translate(0,${1+_})`})},h))]})},ge=r=>{const{bank_angle:n,canvas:t}=r,{branches:s}=N(M=>M.helper),{current_stn_idx:o,svgWidth:i,svg_height:a,padding:l,branchSpacingPct:c,direction:d,info_panel_type:f,stn_list:u,loop_info:{left_and_right_factor:g,bottom_factor:j},coline:x}=N(M=>M.param),_=s[0].filter(M=>!["linestart","lineend"].includes(M)),m=s.slice(0,3).flat().filter((M=>I=>(M[I]=(M[I]||0)+1)===2)({})).filter(M=>!["linestart","lineend"].includes(M)),h=Object.values(x).filter(M=>[M.from,M.to].every(I=>s.slice(1,3).filter(F=>A(F,u)).flat().includes(I))).map(M=>{const I=_.findIndex(X=>X===M.from),F=_.findIndex(X=>X===M.to);return Math.abs(F-I)>_.length-2-Math.abs(F-I)?"major":"minor"}).at(0)??"minor",p=m.at(1)?_e(_,m,g,h):m.at(0)?de(_,m[0],j,g):je(_,o,j,g),{x_shares:v,y_shares:$}=$e(_,p),{loop_branches:k,line_xs_branches:b,xs_branches:y}=at(s,m,i[t],l,g,p.bottom.length),w={...$,...Object.fromEntries(k.flat().map(M=>[M,0]))},z=c*a/300,H=[225+z,a-75-(t===O.RailMap?0:125)-z],L=Object.keys(w).reduce((M,I)=>({...M,[I]:H[0]+w[I]*(H[1]-H[0])}),{}),W=[Math.max(i[t]*l/100+(n&&t===O.RailMap?100:0),b[0]),Math.min(i[t]*(1-l/100)-(n&&t===O.RailMap?100:0),b[1])],V=Object.keys(v).reduce((M,I)=>({...M,[I]:W[0]+v[I]*(W[1]-W[0])}),{}),C=n?{l:1,r:-1}[d]:0;[...p.right,...p.left].forEach(M=>{V[M]-=(L[M]-H[0])*C}),p.bottom.forEach(M=>{V[M]-=(H[1]-H[0])*C});const P={...y,...V},ue=ct(p,P,L,C,[...W,...H],d),q=12,K=t===O.RailMap&&f==="sh2020"?3:0;Object.keys(x).length>0&&p.top.forEach(M=>{L[M]-=K+q});const pe=k.length?0:(H[1]-H[0])*C/2;return e.jsxs("g",{id:"loop",transform:`translate(${pe},0)`,children:[e.jsx("path",{stroke:"var(--rmg-theme-colour)",strokeWidth:12,fill:"none",d:ue,strokeLinejoin:"round"}),t===O.RailMap&&e.jsx(re,{canvas:t,loop_stns:p,xs:P,ys:L}),e.jsxs("g",{transform:`translate(0,${Object.keys(x).length>0?-q-K:0})`,children:[e.jsx(it,{loop_branches:k,edges:[...W,...H],xs:P,ys:L,canvas:t}),Object.keys(x).length>0&&e.jsx(ot,{edges:[...W,...H],loop_stns:p,xs:P,ys:L,canvas:t})]}),t===O.Indoor&&e.jsx(re,{canvas:t,loop_stns:p,xs:P,ys:L})]})},ct=(r,n,t,s,o,i)=>{const[a,l,c,d]=o,f=(j,x,_,m,h)=>({right:[_+(m-c)*s,x],bottom:[j-(d-x)*s,m],left:[_-(d-m)*s,x],top:[j+(x-c)*s,m]})[h],u=[];r.top.forEach(j=>{u.push([n[j],t[j]])}),["right","bottom","left"].forEach(j=>{if(r[j].length>0)u.push(f(u.at(-1)[0],u.at(-1)[1],n[r[j][0]],t[r[j][0]],j)),r[j].forEach(x=>{u.push([n[x],t[x]])});else{const x={right:[l,u.at(-1)[1]],bottom:[u.at(-1)[0]+(d-u.at(-1)[1])*-s,u.at(-1)[1]+(d-u.at(-1)[1])],left:[a+(s===0?0:(d-c)*(i==="l"?-1:1)),u.at(-1)[1]]};u.push(x[j])}}),u.push(f(u.at(-1)[0],u.at(-1)[1],n[r.top[0]],t[r.top[0]],"top"));const g=u.slice(1).map(([j,x])=>`L${j},${x} `).join(" ");return`M${u[0][0]},${u[0][1]} ${g} Z`},re=r=>{const{canvas:n,loop_stns:t,xs:s,ys:o}=r,{current_stn_idx:i,stn_list:a}=N(f=>f.param),l={top:0,bottom:0,left:-1,right:1},c={left:"r",right:"l",top:void 0,bottom:void 0},d=(f,u)=>({top:u%2===0?"upward":"downward",bottom:u%2===0?"upward":"downward",left:"left",right:"right"})[f];return e.jsxs("g",{id:"loop_stations",children:[n===O.RailMap&&Object.entries(t).map(([f,u])=>u.filter(g=>a[g].services.length).map(g=>e.jsx("g",{transform:`translate(${s[g]},${o[g]})`,children:e.jsx(Y,{stnId:g,stnState:i===g?0:1,bank:l[f],direction:c[f]})},g))),n===O.Indoor&&Object.entries(t).map(([f,u])=>u.filter(g=>a[g].services.length).map((g,j)=>e.jsx("g",{transform:`translate(${s[g]},${o[g]})`,children:e.jsx(U,{stnId:g,nameDirection:d(f,j),services:[E.local]})},g)))]})},le=O.RailMap;function ht(){const{canvasScale:r}=N(l=>l.app),{svgWidth:n,svg_height:t,theme:s,loop:o,loop_info:{bank:i}}=N(l=>l.param),a=n[le];return e.jsxs(G,{type:le,svgWidth:a,svgHeight:t,canvasScale:r,theme:s,children:[e.jsx(dt,{}),o?e.jsx(ge,{bank_angle:i,canvas:O.RailMap}):e.jsx(qe,{}),e.jsx(tt,{})]})}const dt=S.memo(function(){return e.jsxs("defs",{children:[e.jsx("circle",{id:"stn_sh",fill:"var(--rmg-white)",strokeWidth:2,r:5}),e.jsx("path",{id:"int2_sh",fill:"var(--rmg-white)",strokeWidth:2,d:"M -5,0 a 5,5 0 1 1 10,0 V10 a 5,5 0 1 1 -10,0Z"}),e.jsx("path",{id:"express_sh",fill:"var(--rmg-white)",strokeWidth:2,d:"M -5,0 a 5,5 0 1 1 10,0 V25 a 5,5 0 1 1 -10,0Z"}),e.jsx("path",{id:"direct_sh",fill:"var(--rmg-white)",strokeWidth:2,d:"M -5,0 a 5,5 0 1 1 10,0 V50 a 5,5 0 1 1 -10,0Z"}),e.jsx("rect",{id:"stn_sh_2020",stroke:"none",height:24,width:12,x:-6,y:-18}),e.jsx("rect",{id:"stn_sh_2020_express",stroke:"none",height:49,width:12,x:-6,y:-18}),e.jsx("rect",{id:"stn_sh_2020_direct",stroke:"none",height:74,width:12,x:-6,y:-18}),e.jsx("rect",{id:"intbox_number",height:22,width:20,y:-11}),e.jsxs("g",{id:"intbox_maglev",transform:"translate(-25,0)",children:[e.jsx("rect",{id:"maglev_5",height:144,width:130,y:"40",x:"30",strokeWidth:10}),e.jsx("path",{id:"maglev_3",fill:"var(--rmg-white)",d:"m90,55a40,5 0 0 0 -40,3a5,5 0 0 0 -5,5a5,60 0 0 0 -3,60a5,5 0 0 0 5,5l96,0a5,5 0 0 0 5,-5a5,60 0 0 0 -3,-60a5,5 0 0 0 -5,-5a40,5 0 0 0 -40,-3l-5,-10l-5,10"}),e.jsx("path",{id:"maglev_4",fill:"var(--rmg-white)",d:"m90,140l-40,0a10,5 0 0 1 -10,-5l0,25a10,15 0 0 0 10,15l15,0l0,-10l-15,0l0,-15l90,0l0,15l-15,0l0,10l15,0a10,15 0 0 0 10,-15l0,-25a10,5 0 0 1 -10,5l-50,0"}),e.jsx("rect",{id:"maglev_1",height:"25",width:"40",y:"80",x:"50"}),e.jsx("rect",{id:"maglev_2",height:"25",width:"40",y:"80",x:"100"})]}),e.jsxs("g",{id:"airport",transform:"scale(0.5)",children:[e.jsx("circle",{cx:"0",cy:"29.33899",r:"29.33899",fill:"var(--rmg-grey)"}),e.jsx("path",{id:"airport",d:"M28.9769,6.60134c1.711.013,3.111,2.53205,3.111,4.241v10.337s17.106,15.435,17.358,15.666a1.145,1.145,0,0,1,.488,1.152v2.833c0,.651-.451.61-.695.467-.334-.119-17.151-8.863-17.151-8.863-.004,1.458-.797,9.006-1.326,13.304,0,0,4.61,2.457,4.699,2.521.334.268.352.359.352.852v2.001c0,.477-.352.428-.51.324-.183-.062-5.693-1.921-5.693-1.921a2.56018,2.56018,0,0,0-.633-.127,2.31654,2.31654,0,0,0-.666.127s-5.477,1.859-5.672,1.921c-.185.104-.523.153-.523-.324v-2.001c0-.493.029-.584.367-.852.086-.064,4.678-2.521,4.678-2.521-.524-4.298-1.307-11.846-1.325-13.304,0,0-16.822,8.744-17.148,8.863-.217.143-.69.184-.69-.467v-2.833a1.16206,1.16206,0,0,1,.473-1.152c.276-.231,17.365-15.666,17.365-15.666v-10.337c0-1.709,1.403-4.228,3.14105-4.241",transform:"translate(-28.9697,0.14347)",fill:"var(--rmg-white)"})]}),e.jsxs("g",{id:"disney",transform:"scale(0.5)",children:[e.jsx("circle",{cx:"0",cy:"29.33899",r:"29.33899",fill:"var(--rmg-grey)"}),e.jsx("path",{fill:"var(--rmg-white)",d:"M45.6152,7.85015a9.80248,9.80248,0,0,0-9.79907,9.801,9.70059,9.70059,0,0,0,.342,2.582c.002.026.002.055.002.093a.31815.31815,0,0,1-.31494.318.67741.67741,0,0,1-.12806-.02,15.71521,15.71521,0,0,0-13.498,0,.61.61,0,0,1-.122.02.31841.31841,0,0,1-.322-.318v-.067a9.62553,9.62553,0,0,0,.35608-2.608,9.803,9.803,0,1,0-9.797,9.8,10.10364,10.10364,0,0,0,2.308-.271h.05493a.31113.31113,0,0,1,.31409.318.32433.32433,0,0,1-.019.12,15.72588,15.72588,0,1,0,29.703,7.216,15.83676,15.83676,0,0,0-1.746-7.23.18417.18417,0,0,1-.0271-.106.31612.31612,0,0,1,.32007-.318h.057a10.15953,10.15953,0,0,0,2.316.271,9.80051,9.80051,0,0,0,0-19.601",transform:"translate(-28.9697 0.13398)"})]}),e.jsxs("g",{id:"railway",children:[e.jsx("circle",{cx:"0",cy:"29.33899",r:"29.33899",fill:"var(--rmg-grey)",transform:"translate(0,-2)scale(0.5)"}),e.jsx("path",{fill:"var(--rmg-white)",d:"M169,273.5c0-19,14.7-34.8,33.7-36.3c18.9-1.5,38.1-2.2,57.4-2.2c19.3,0,38.4,0.8,57.3,2.2  c19,1.5,33.7,17.3,33.7,36.3v47.3l-51.3,14.7c-11.2,3.2-18.9,13.4-18.9,25v147.8c0,17.4,12.2,32.3,29.3,35.7l110.6,22.1  c4.9,1,8.4,5.2,8.4,10.2V599H91v-22.7c0-5,3.5-9.2,8.4-10.2L209.9,544c17-3.4,29.3-18.3,29.3-35.7V360.5c0-11.6-7.7-21.8-18.9-25  L169,320.8V273.5z M309.4,31.7c0.2-1.2,0.3-2.4,0.3-3.6c0-14-11.1-25.4-24.9-26C276.6,1.4,268.3,1,260,1c-8.3,0-16.6,0.4-24.7,1.1  c-13.9,0.6-24.9,12-24.9,26c0,1.2,0.1,2.5,0.3,3.6C90.6,54.8,0,160.3,0,287c0,97.2,53.4,182,132.4,226.6l36.8-48.1  C104.3,432.4,59.8,364.9,59.8,287c0-110.6,89.6-200.2,200.2-200.2S460.2,176.4,460.2,287c0,77.9-44.5,145.4-109.4,178.5  c15,19.6,25.6,33.5,36.8,48.1C466.6,469,520,384.2,520,287C520,160.3,429.4,54.8,309.4,31.7z",transform:"translate(-10,0)scale(0.04)"})]}),e.jsx("marker",{id:"arrow_gray",viewBox:"-1.5 0 3 1.5",refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:"var(--rmg-grey)"})}),e.jsx("marker",{id:"arrow_theme_left",refX:1,refY:.5,children:e.jsx("path",{d:"M1,0L0,1H1z",fill:"var(--rmg-theme-colour)"})}),e.jsx("marker",{id:"arrow_theme_right",refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:"var(--rmg-theme-colour)"})}),e.jsx("marker",{id:"arrow_theme",refX:1,refY:.5,children:e.jsx("path",{d:"M0,1H2L1,0z",fill:"var(--rmg-theme-colour)"})}),e.jsx("filter",{id:"contrast-direct",filterUnits:"userSpaceOnUse",children:e.jsxs("feComponentTransfer",{children:[e.jsx("feFuncR",{type:"linear",slope:.5,intercept:.25}),e.jsx("feFuncG",{type:"linear",slope:.5,intercept:.25}),e.jsx("feFuncB",{type:"linear",slope:.5,intercept:.25})]})}),e.jsx("filter",{id:"contrast-express",filterUnits:"userSpaceOnUse",children:e.jsxs("feComponentTransfer",{children:[e.jsx("feFuncR",{type:"linear",slope:.75,intercept:.125}),e.jsx("feFuncG",{type:"linear",slope:.75,intercept:.125}),e.jsx("feFuncB",{type:"linear",slope:.75,intercept:.125})]})}),e.jsx(Z,{})]})}),ae=O.Indoor;function mt(){const{canvasScale:r}=N(a=>a.app),{svgWidth:n,svg_height:t,theme:s,loop:o}=N(a=>a.param),i=n[ae];return e.jsxs(G,{type:ae,svgWidth:i,svgHeight:t,canvasScale:r,theme:s,children:[e.jsx(xt,{}),o?e.jsx(ge,{bank_angle:!1,canvas:O.Indoor}):e.jsx(ut,{}),e.jsx(fe,{})]})}const xt=S.memo(function(){return e.jsxs("defs",{children:[e.jsx("circle",{id:"stn_indoor_sh",fill:"var(--rmg-white)",strokeWidth:5,r:8,transform:"scale(1.5)"}),e.jsx("path",{id:"int2_indoor_sh",fill:"var(--rmg-white)",transform:"translate(0, -10)scale(2)",strokeWidth:4,d:"M -5,0 a 5,5 0 1 1 10,0 V10 a 5,5 0 1 1 -10,0Z"}),e.jsx("path",{id:"express_indoor_sh",fill:"var(--rmg-white)",transform:"translate(0, -10)scale(2)",strokeWidth:4,d:"M -5,0 a 5,5 0 1 1 10,0 V25 a 5,5 0 1 1 -10,0Z"}),e.jsx("path",{id:"direct_indoor_sh",fill:"var(--rmg-white)",transform:"translate(0, -10)scale(2)",strokeWidth:4,d:"M -5,0 a 5,5 0 1 1 10,0 V40 a 5,5 0 1 1 -10,0Z"}),e.jsxs("g",{id:"osi_indoor_sh",children:[e.jsx("line",{x1:"0",x2:"0",y1:"-12",y2:"12",stroke:"var(--rmg-black)",strokeWidth:22}),e.jsx("line",{x1:"0",x2:"0",y1:"-12",y2:"12",stroke:"var(--rmg-white)",strokeWidth:10}),e.jsx("circle",{cy:"-12",fill:"var(--rmg-white)",strokeWidth:5,r:8,transform:"scale(1.5)"}),e.jsx("circle",{cy:"12",fill:"var(--rmg-white)",strokeWidth:5,r:8,transform:"scale(1.5)"})]})]})}),gt=(r,n)=>{let t=0;return r[n].parents.length===2&&(t+=1),r[r[n].parents[0]].children.length===2&&(t+=1),t},ft=(r,n)=>{let t=0;return r[n].children.length===2&&(t+=1),r[r[n].children[0]].parents.length===2&&(t+=1),t},ut=()=>{const{routes:r,branches:n,depsStr:t}=N(m=>m.helper),s=N(m=>m.param),o=oe(s.stn_list,gt,ft),i=D("linestart","lineend",o),a=D(i.nodes[1],i.nodes.slice(-2)[0],o),l=S.useMemo(()=>(console.log("computing x shares"),Object.keys(s.stn_list).reduce((m,h)=>({...m,[h]:ce(h,o,n)}),{})),[n.toString(),JSON.stringify(o)]),c=[s.svgWidth.indoor*s.padding/100,s.svgWidth.indoor*(1-s.padding/100)],d=Object.keys(l).reduce((m,h)=>({...m,[h]:c[0]+l[h]/a.len*(c[1]-c[0])}),{}),f=S.useMemo(()=>Q.getYShares(s.stn_list),[t]),u=Object.keys(f).reduce((m,h)=>({...m,[h]:f[h]*s.branchSpacingPct*s.svg_height/200}),{}),g=S.useMemo(()=>he(s.current_stn_idx,r,s.direction),[s.current_stn_idx,s.direction,r.toString()]),j=Object.values(E),x=Object.values(s.stn_list).map(m=>m.services).flat().reduce((m,h)=>(m[j.indexOf(h)]=!0,m),[!1,!1,!1]).map((m,h)=>[j[h],m]).filter(m=>m[1]).map(m=>m[0]),_=Q.drawLine(n,g,s.stn_list,c,d,u,s.branchSpacingPct*s.svg_height/200,i,0);return e.jsxs("g",{id:"main",transform:`translate(0,${s.svg_height/2})`,children:[e.jsx(pt,{paths:_,services:x}),e.jsx(jt,{xs:d,ys:u,services:x})]})},pt=r=>e.jsx("g",{fill:"none",strokeWidth:12,stroke:"var(--rmg-theme-colour)",children:r.services.map((n,t)=>e.jsxs("g",{transform:`translate(0, ${t*30})`,children:[r.paths.main.map((s,o)=>e.jsx("path",{d:s},o)),r.paths.pass.map((s,o)=>e.jsx("path",{d:s},o))]},`indoor_line_${t}`))}),jt=r=>{const{branches:n}=N(d=>d.helper),{stn_list:t,namePosMTR:{isFlip:s}}=N(d=>d.param),{xs:o,ys:i,services:a}=r,l=s??!0?"upward":"downward",c=l==="upward"?"downward":"upward";return e.jsx("g",{children:Object.keys(t).filter(d=>!["linestart","lineend"].includes(d)).filter(d=>t[d].services.length).map(d=>e.jsx("g",{transform:`translate(${o[d]},${i[d]})`,children:e.jsx(U,{stnId:d,nameDirection:a.length>1?"downward":n.filter(f=>f.includes(d)).map(f=>f.indexOf(d)%2===0?l:c)[0],services:a})},d))})},fe=S.memo(()=>{const{svg_height:r,svgWidth:{indoor:n},line_name:t,stn_list:s}=N(a=>a.param),o=Math.max(...Object.values(s).map(a=>a.transfer.groups.at(1)?.lines?.length??0)),i=o>0?210:110;return e.jsxs(e.Fragment,{children:[e.jsx("g",{transform:`translate(${n/2},50)`,children:e.jsxs("text",{textAnchor:"middle",fontSize:"30",className:"rmg-name__zh",children:["轨道交通",t[0],"运营线路示意图"]})}),e.jsxs("g",{transform:`translate(${n/2},${r-270})`,children:[e.jsx("text",{textAnchor:"middle",fontSize:"18",className:"rmg-name__zh",dx:"-30",dy:"230",children:"友情提示：请留意您需要换乘线路的首末班时间，以免耽误您的出行，末班车进站前三分钟停售该末班车车票。"}),e.jsx("text",{textAnchor:"middle",fontSize:"12",className:"rmg-name__en",dx:"10",dy:"250",children:"Please pay attention to the interchange schedule if you want to transfer to other lines. Stop selling tickets 3 minutes before the last train services."}),e.jsxs("g",{transform:"translate(-700,215)",children:[e.jsx("rect",{x:"-5",y:"-25",width:i,height:"70",fill:"none",stroke:"black",rx:"5"}),e.jsx("line",{x1:"28",x2:"28",y1:"-20",y2:"40",stroke:"black"}),e.jsx("text",{className:"rmg-name__zh",dx:"3",fontSize:"18",children:"图"}),e.jsx("text",{className:"rmg-name__zh",dx:"3",dy:"18",fontSize:"18",children:"例"}),e.jsx("text",{className:"rmg-name__en",dy:"35",fontSize:"8",children:"legend"}),e.jsx("use",{transform:"translate(50,10)",xlinkHref:"#int2_indoor_sh",stroke:"var(--rmg-black)"}),e.jsx("text",{className:"rmg-name__zh",dx:"70",dy:"5",fontSize:"10",children:"换乘站"}),e.jsx("text",{className:"rmg-name__en",dx:"70",dy:"15",fontSize:"6",children:"Interchange"}),e.jsx("text",{className:"rmg-name__en",dx:"70",dy:"25",fontSize:"6",children:"Station"}),o>0&&e.jsxs(e.Fragment,{children:[e.jsx("use",{transform:"translate(120,10)scale(0.75)",xlinkHref:"#osi_indoor_sh",stroke:"var(--rmg-black)"}),e.jsx("text",{className:"rmg-name__zh",dx:"135",dy:"5",fontSize:"10",children:"出站换乘车站"}),e.jsx("text",{className:"rmg-name__en",dx:"135",dy:"15",fontSize:"6",children:"Out-of-station Transfer"}),e.jsx("text",{className:"rmg-name__en",dx:"135",dy:"25",fontSize:"6",children:"Station"})]})]})]})]})});fe.displayName="InfoElements";const Mt={destination:e.jsx(ye,{}),runin:e.jsx(He,{}),railmap:e.jsx(ht,{}),indoor:e.jsx(mt,{})};export{Mt as default};
