import{j as T,ah as C,aT as O,aU as A,ag as D,e as j,aa as R,aV as N,aR as g,aW as E,r as f,h as P,aL as _,aX as x,aY as k,l as W}from"./index-CC0Z92ma.js";import{u as L,j as d,c as F,h as S,aC as B,aj as z,M as $,ak as U,J as Y,K as G,L as J,O as V,t as Z,B as H,s as K,a2 as p,N as X}from"./chakra-wEho0Aiu.js";import{a as v,u as M}from"./react-Caefwd5V.js";var q=function(e){var n=e.children,o=e.noWrap,s=L("RmgOutput",{noWrap:o});return d.jsx(F.output,{sx:s,children:n})};function Q(e){var n=e.fields,o=e.noLabel,s=e.minW;return d.jsx(S,{wrap:"wrap",children:n.map(function(r,a){if(r.hidden)return d.jsx(v.Fragment,{},a);var l=r.minW||s,c=l==="full";return d.jsx(T,{className:c?"mw-full":"",label:r.label,flex:c?void 0:1,minW:c?void 0:l,noLabel:o,oneLine:r.oneLine,helper:r.helper,errorMessage:r.errorMessage,children:function(t){switch(t.type){case"input":return d.jsx(D,{placeholder:t.placeholder,defaultValue:t.value,type:t.variant,validator:t.validator,onDebouncedChange:t.onChange,delay:t.debouncedDelay,optionList:t.optionList,isDisabled:t.isDisabled});case"output":return d.jsx(q,{noWrap:t.noWrap,children:t.value});case"textarea":return d.jsx(A,{placeholder:t.placeholder,defaultValue:t.value,onDebouncedChange:t.onChange,isDisabled:t.isDisabled});case"slider":return d.jsx(O,{defaultValue:t.value,min:t.min,max:t.max,step:t.step,onThrottledChange:t.onChange,leftIcon:t.leftIcon,rightIcon:t.rightIcon,isDisabled:t.isDisabled});case"select":return d.jsx(C,{defaultValue:t.value,onChange:function(i){var u,h=i.target.value;return(u=t.onChange)===null||u===void 0?void 0:u.call(t,typeof t.value=="number"?Number(h):h.toString())},options:t.options,disabledOptions:t.disabledOptions,isInvalid:t.isInvalid,isDisabled:t.isDisabled});case"switch":return d.jsx(B,{isChecked:t.isChecked,isDisabled:t.isDisabled,onChange:function(i){var u,h=i.target.checked;return(u=t.onChange)===null||u===void 0?void 0:u.call(t,h)}});case"custom":return t.component;default:return d.jsx("div",{})}}(r)},a)})})}const ye=(e,n,o)=>{const s=new Blob([o],{type:n});ee(e,s)},ee=(e,n)=>{const o=window.URL.createObjectURL(n),s=document.createElement("a");s.href=o,s.download=e,document.body.appendChild(s),s.click(),document.body.removeChild(s),window.URL.revokeObjectURL(o)},ve=e=>new Promise(n=>{const o=new FileReader;o.onloadend=()=>n(o.result),o.readAsText(e)}),je=()=>navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome"),te=e=>{if(e){const n=new Date().getTime()-e;return n<60*1e3?["Just now"]:n<2*60*1e3?["1","minute ago"]:n<60*60*1e3?[Math.floor(n/1e3/60).toString(),"minutes ago"]:n<2*60*60*1e3?["1","hour ago"]:n<24*60*60*1e3?[Math.floor(n/1e3/60/60).toString(),"hours ago"]:n<48*60*60*1e3?["1","day ago"]:[Math.floor(n/1e3/60/60/24).toString(),"days ago"]}else return["Unknown"]},me=e=>new Promise(n=>{setTimeout(n,e)}),xe=e=>{var n,o,s,r,a,l,c;"line_name"in e||(e.line_name=["路線名","Name of Line"]),delete e.fontZH,delete e.fontEN,delete e.weightZH,delete e.weightEN;for(const[t,i]of Object.entries(e.stn_list))"branch"in i||(e.stn_list[t].branch={},i.children.length===2&&(e.stn_list[t].branch.right=["through",i.children[1]]),i.parents.length===2&&(e.stn_list[t].branch.left=["through",i.parents[1]]),Object.keys(e.stn_list[t].branch).length===0&&delete e.stn_list[t].branch);"psd_num"in e?e.psd_num=e.psd_num.toString():e.psd_num="1","line_num"in e||(e.line_num="1"),e.theme.length===3&&e.theme.push("#fff");for(const[t,i]of Object.entries(e.stn_list))"num"in i||(e.stn_list[t].num="00"),"interchange"in i&&i.interchange.map(u=>u.forEach(h=>{h.length===5&&h.splice(3,0,"#fff")}));for(const[t,i]of Object.entries(e.stn_list))i.change_type==="osi22_end_p"&&(e.stn_list[t].change_type="osi22_pr"),i.change_type==="osi22_end_u"&&(e.stn_list[t].change_type="osi22_ur");for(const[t,i]of Object.entries(e.stn_list))"interchange"in i||(e.stn_list[t].interchange=[[]]);"info_panel_type"in e?e.info_panel_type=(t=>{switch(t){case"gz_1":case"panasonic":return"gz28";case"gz_2":return"gz6";case"gz_3":return"gz3";default:return t}})(e.info_panel_type):e.info_panel_type="gz28","direction_gz_x"in e||(e.direction_gz_x=50),"direction_gz_y"in e||(e.direction_gz_y=70);for(const[t,i]of Object.entries(e.stn_list))"transfer"in i||(e.stn_list[t].transfer={tick_direc:i.change_type==="none"||i.change_type==="int2"?"r":(n=i.change_type)==null?void 0:n.split("_")[1].split("").slice().reverse()[0],paid_area:((o=i.change_type)==null?void 0:o.indexOf("osi"))!==-1?((s=i.change_type)==null?void 0:s.split("_")[1][0])==="p":!0,osi_names:((r=i.change_type)==null?void 0:r.indexOf("osi"))!==-1?[i.interchange[1][0]]:[],info:i.interchange.length===2?[i.interchange[0],i.interchange[1].slice(1)]:i.interchange}),delete e.stn_list[t].change_type,delete e.stn_list[t].interchange;for(const[t,i]of Object.entries(e.stn_list))"services"in i||(e.stn_list[t].services=["local"]),"facility"in i?i.facility===""&&(e.stn_list[t].facility=void 0):e.stn_list[t].facility=i.usage||void 0,delete e.stn_list[t].usage;"customiseMTRDest"in e||(e.customiseMTRDest={isLegacy:e.dest_legacy||!1,terminal:!1}),delete e.dest_legacy,"svgWidth"in e||(e.svgWidth={destination:e.svg_dest_width,runin:e.svg_dest_width,railmap:e.svg_width,indoor:e.svg_width}),"indoor"in e.svgWidth||(e.svgWidth.indoor=e.svgWidth.railmap),delete e.svg_width,delete e.svg_dest_width,e.notesGZMTR=(a=e.notesGZMTR)==null?void 0:a.map(t=>t.length===4?t.concat([!1]):t),delete e.char_form,delete e.show_outer,delete e.strip_pc,delete e.txt_bg_gap,"namePosMTR"in e||(e.namePosMTR={isStagger:!0,isFlip:e.txt_flip}),delete e.txt_flip,Object.keys(e.stn_list).forEach(t=>{"secondaryName"in e.stn_list[t]&&e.stn_list[t].secondaryName===!1&&delete e.stn_list[t].secondaryName,"type"in e.stn_list[t].transfer&&delete e.stn_list[t].transfer.type}),e.style=e.style===void 0||!Object.values(j).includes(e.style)?j.MTR:e.style,e.coline=(l=e.coline)!=null?l:[],e.loop=(c=e.loop)!=null?c:!1,e.loop_info=e.loop_info===void 0?{bank:!0,left_and_right_factor:0,bottom_factor:1}:{...e.loop_info,bottom_factor:Math.max(e.loop_info.bottom_factor,1)};for(const[t,i]of Object.entries(e.stn_list))"loop_pivot"in i||(e.stn_list[t].loop_pivot=!1);return Array.isArray(e.coline)&&(e.coline=e.coline.reduce((t,i)=>({...t,[R(4)]:i}),{})),e.platform_num===!1&&(e.platform_num=""),Object.values(e.stn_list).forEach(t=>{var u,h;const i=t;i.one_line=(u=i.one_line)!=null?u:!1,i.int_padding=(h=i.int_padding)!=null?h:e.loop?250:355}),e.branchSpacingPct===void 0&&(e.style===j.SHMetro?e.branchSpacingPct=Math.round(e.branch_spacing/e.svg_height*300):e.branchSpacingPct=Math.round(e.branch_spacing/e.svg_height*200),delete e.branch_spacing),ne(e),se(e),ie(e),ce(e),e},ne=e=>{for(const[n,o]of Object.entries(e.stn_list)){const s=o.transfer.info;s&&(e.stn_list[n].transfer.groups=s.map((r,a)=>r.length?{name:o.transfer.osi_names[a-1],lines:r.map(l=>{const c=l;return{theme:c.slice(0,4),name:c.slice(4,6)}})}:{lines:[]})),delete e.stn_list[n].transfer.info,delete e.stn_list[n].transfer.osi_names}},se=e=>{for(const[n,o]of Object.entries(e.stn_list)){const{name:s,secondaryName:r,localisedName:a,localisedSecondaryName:l}=o;!a&&s&&(e.stn_list[n].localisedName={zh:s[0],en:s[1]},delete e.stn_list[n].name),!l&&r&&(e.stn_list[n].localisedSecondaryName={zh:r[0],en:r[1]},delete e.stn_list[n].secondaryName)}},ie=e=>{const{svgWidth:n}=e;N.Platform in n||(e.svgWidth.platform=1200);for(const[o,s]of Object.entries(e.stn_list)){const{character_spacing:r}=s;r===void 0&&(e.stn_list[o].character_spacing=75)}},w=e=>e.length===4&&e.every(n=>typeof n=="string")&&!!e[2].match(/^#[0-9a-fA-F]{6}$/)&&Object.values(P).includes(e[3]),oe=e=>{const n=[],o=(s,r)=>{if(Array.isArray(s)&&w(s)){n.push({path:r||"",value:s});return}for(const a in s){const l=s[a],c=r?"".concat(r,".").concat(a):a;Array.isArray(l)?w(l)?n.push({path:c,value:l}):l.forEach((t,i)=>o(t,"".concat(c,".").concat(i))):l&&typeof l=="object"&&o(l,c)}};return o(e),n},re=(e,n)=>{const o={},s=(r,a,l)=>{let c=r;for(let i=0;i<l.length-1;i++){if(l[i]==="*"){Object.keys(c).forEach(u=>s(c,[...a,...l.slice(0,i)],[u,...l.slice(i+1)]));return}if(c=c==null?void 0:c[l[i]],c===void 0)return}(c==null?void 0:c[l[l.length-1]])!==void 0&&(o[[...a,...l].join(".")]=c==null?void 0:c[l[l.length-1]])};return s(e,[],n.split(".")),o},I=(e,n,o)=>{const s=n.split(".");let r=e;for(let a=0;a<s.length-1;a++)r=r[s[a]];r[s[s.length-1]]=o},pe=async e=>{const n=new Date().getTime(),o=oe(e);g.info("Found all themes pending for update",o);const s=JSON.parse(JSON.stringify(e)),r=5e3;let a,l=!1;const c=new Promise((t,i)=>{a=setTimeout(()=>{l=!0,i("Executing time exceeds ".concat(r,"ms"))},r),(async()=>{for(const{path:u,value:h}of o){if(l)throw new Error("Update aborted");const b=await E(h);I(s,u,b)}})().then(t).catch(i)});try{return await c,g.info("Themes update completed, elapsed time ".concat((new Date().getTime()-n)/1e3," sec")),s}catch(t){return g.warn("Error occurs when updating themes, elapsed time ".concat((new Date().getTime()-n)/1e3," sec"),t),s}finally{clearTimeout(a)}},le={notesGZMTR:e=>!(e!=null&&e.length),"stn_list.*.branch.left":e=>!(e!=null&&e.length),"stn_list.*.branch.right":e=>!(e!=null&&e.length),"stn_list.*.branch":e=>!e||Object.keys(e).length===0,"stn_list.*.facility":e=>!e,"stn_list.*.transfer.groups.*.lines":e=>!(e!=null&&e.length)},ce=e=>{const n=structuredClone(e);return Object.entries(le).forEach(([o,s])=>{Object.entries(re(n,o)).forEach(([r,a])=>{g.debug("Sanitising",r,a),s(a)&&I(n,r,void 0)})}),n.version=f.getAppVersion(),n},ae=()=>{const e="".concat(f.getAppName(),"__").concat(_.PARAM_CONFIG_BY_ID),n=Object.entries(f.storage.getAll()).filter(([o])=>o.startsWith(e)).map(([o,s])=>{const r=o.slice(e.length);if(s)try{return{...JSON.parse(s),id:r}}catch(a){return{id:r}}else return{id:r}});return g.info("loadParamRegistry(), Found param config in localStorage",n.map(o=>o.id)),n},we=()=>{const e=ae(),n="".concat(f.getAppName(),"__").concat(_.PARAM_BY_ID),o=Object.keys(f.storage.getAll()).filter(s=>s.startsWith(n)).map(s=>{var a;const r=s.slice(n.length);return(a=e.find(l=>l.id===r))!=null?a:{id:r}});return g.info("getParamRegistry(), Actual param found in localStorage",o.map(s=>s.id)),e.filter(s=>o.every(r=>r.id!==s.id)).forEach(s=>f.storage.remove(_.PARAM_CONFIG_BY_ID+s.id)),o},de=e=>{const n=f.storage.get(_.PARAM_CONFIG_BY_ID+e);return n&&JSON.parse(n)},Re=e=>{const n=f.storage.get(_.PARAM_BY_ID+e);return{param:n&&JSON.parse(n),config:de(e)}},he=(e,n)=>{const o=R();return f.storage.set(_.PARAM_BY_ID+o,e),f.storage.set(_.PARAM_CONFIG_BY_ID+o,JSON.stringify({name:n,lastModified:Date.now()})),o},Se=async e=>{const n=e.split("/").at(-1);try{const o=await fetch(e);if(o.ok){const s=await o.text();return he(s,n)}else return g.warn("Failed to download param"),null}catch(o){return g.warn("Failed to download param.",o),null}};function ue(e){var i;const{config:n,onClose:o,onUpdate:s}=e,{t:r}=M(),[a,l]=v.useState((i=n==null?void 0:n.name)!=null?i:"");v.useEffect(()=>{var u;n&&l((u=n.name)!=null?u:"")},[n]);const c=[{type:"input",label:r("Project name"),value:a,onChange:l,debouncedDelay:0}],t=()=>{var u;n&&((u=n.name)!=null?u:"")!==a&&s({...n,name:a})};return d.jsxs(z,{isOpen:!!n,onClose:o,isCentered:!0,children:[d.jsx($,{}),d.jsxs(U,{children:[d.jsx(Y,{children:r("Edit project info")}),d.jsx(G,{}),d.jsx(J,{children:d.jsx(Q,{fields:c})}),d.jsx(V,{children:d.jsx(Z,{colorScheme:"primary",onClick:t,children:r("Confirm")})})]})]})}const fe={flex:"2 1 0%",overflow:"hidden",minW:{base:"unset",md:240},w:{base:"100%",md:"unset"},mr:{base:0,md:2},mb:{base:2,md:0},"& > div":{flexDirection:"column",h:200,overflowX:"hidden",overflowY:"auto",borderRadius:"md",borderWidth:2,"& >.chakra-button":{alignItems:"center"},"& .chakra-button__group":{"& button:not(:first-of-type)":{h:"100%"}}}};function Me(e){const{paramRegistry:n,downloading:o,selectedParam:s,onParamSelect:r,onParamRemove:a,onParamUpdate:l}=e,{t:c}=M(),[t,i]=v.useState(),u=h=>{l==null||l(h),i(void 0)};return d.jsxs(H,{sx:fe,children:[d.jsxs(S,{children:[o&&d.jsx(x,{variant:"ghost",primaryText:c("Downloading")+"...",secondaryText:o,isDisabled:!0}),n.slice().sort((h,b)=>{var y,m;return((y=b.lastModified)!=null?y:0)-((m=h.lastModified)!=null?m:0)}).map(h=>{var b;return d.jsxs(K,{size:"sm",isAttached:!0,colorScheme:s===h.id?"primary":void 0,variant:s===h.id?"solid":"ghost",children:[d.jsx(x,{primaryText:(b=h.name)!=null?b:c("Project")+" "+h.id,secondaryText:c("Last modified")+": "+te(h.lastModified).map(y=>c(y)).join(" "),"aria-pressed":s===h.id,onClick:()=>r(h.id)}),l&&d.jsx(p,{"aria-label":c("Edit project info"),title:c("Edit project info"),icon:d.jsx(k,{}),onClick:()=>i(h)}),a&&d.jsx(p,{"aria-label":c("Remove project"),title:c("Remove project"),icon:d.jsx(W,{}),onClick:()=>a(h.id)})]},h.id)})]}),n.length>=10&&d.jsx(X,{as:"em",fontSize:"xs",children:c("You have reached the maximum number of projects.")}),d.jsx(ue,{config:t,onClose:()=>i(void 0),onUpdate:u})]})}export{Me as P,Q as R,ye as a,he as b,we as c,ee as d,Re as e,pe as f,de as g,Se as h,je as i,ve as r,ce as s,xe as u,me as w};
