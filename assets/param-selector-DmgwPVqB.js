import{j as T,ai as C,aT as O,aU as A,ah as D,e as j,ab as S,l as _,aV as N,r as g,aW as E,i as P,aM as b,aX as x,aY as k,m as W}from"./index-C0iFBgzo.js";import{u as L,j as h,c as F,h as R,aC as B,aj as z,M as $,ak as U,J as Y,K as G,L as J,O as V,t as Z,B as H,s as K,a2 as p,N as X}from"./chakra-Dgz8Jjnv.js";import{a as v,u as M}from"./react-D3Mhupst.js";var q=function(e){var t=e.children,o=e.noWrap,n=L("RmgOutput",{noWrap:o});return h.jsx(F.output,{sx:n,children:t})};function Q(e){var t=e.fields,o=e.noLabel,n=e.minW;return h.jsx(R,{wrap:"wrap",children:t.map(function(r,d){if(r.hidden)return h.jsx(v.Fragment,{},d);var c=r.minW||n,a=c==="full";return h.jsx(T,{className:a?"mw-full":"",label:r.label,flex:a?void 0:1,minW:a?void 0:c,noLabel:o,oneLine:r.oneLine,helper:r.helper,errorMessage:r.errorMessage,children:function(l){switch(l.type){case"input":return h.jsx(D,{placeholder:l.placeholder,defaultValue:l.value,type:l.variant,validator:l.validator,onDebouncedChange:l.onChange,delay:l.debouncedDelay,optionList:l.optionList,isDisabled:l.isDisabled});case"output":return h.jsx(q,{noWrap:l.noWrap,children:l.value});case"textarea":return h.jsx(A,{placeholder:l.placeholder,defaultValue:l.value,onDebouncedChange:l.onChange,isDisabled:l.isDisabled});case"slider":return h.jsx(O,{defaultValue:l.value,min:l.min,max:l.max,step:l.step,onThrottledChange:l.onChange,leftIcon:l.leftIcon,rightIcon:l.rightIcon,isDisabled:l.isDisabled});case"select":return h.jsx(C,{defaultValue:l.value,onChange:function(s){var i,f=s.target.value;return(i=l.onChange)===null||i===void 0?void 0:i.call(l,typeof l.value=="number"?Number(f):f.toString())},options:l.options,disabledOptions:l.disabledOptions,isInvalid:l.isInvalid,isDisabled:l.isDisabled});case"switch":return h.jsx(B,{isChecked:l.isChecked,isDisabled:l.isDisabled,onChange:function(s){var i,f=s.target.checked;return(i=l.onChange)===null||i===void 0?void 0:i.call(l,f)}});case"custom":return l.component;default:return h.jsx("div",{})}}(r)},d)})})}const ye=(e,t,o)=>{const n=new Blob([o],{type:t});ee(e,n)},ee=(e,t)=>{const o=window.URL.createObjectURL(t),n=document.createElement("a");n.href=o,n.download=e,document.body.appendChild(n),n.click(),document.body.removeChild(n),window.URL.revokeObjectURL(o)},ve=e=>new Promise(t=>{const o=new FileReader;o.onloadend=()=>t(o.result),o.readAsText(e)}),je=()=>navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome"),te=e=>{if(e){const t=new Date().getTime()-e;return t<60*1e3?["Just now"]:t<2*60*1e3?["1","minute ago"]:t<60*60*1e3?[Math.floor(t/1e3/60).toString(),"minutes ago"]:t<2*60*60*1e3?["1","hour ago"]:t<24*60*60*1e3?[Math.floor(t/1e3/60/60).toString(),"hours ago"]:t<48*60*60*1e3?["1","day ago"]:[Math.floor(t/1e3/60/60/24).toString(),"days ago"]}else return["Unknown"]},me=e=>new Promise(t=>{setTimeout(t,e)}),xe=e=>{var t,o,n,r,d,c,a,l;"line_name"in e||(e.line_name=["路線名","Name of Line"]),delete e.fontZH,delete e.fontEN,delete e.weightZH,delete e.weightEN;for(const[s,i]of Object.entries(e.stn_list))"branch"in i||(e.stn_list[s].branch={},i.children.length===2&&(e.stn_list[s].branch.right=["through",i.children[1]]),i.parents.length===2&&(e.stn_list[s].branch.left=["through",i.parents[1]]),Object.keys(e.stn_list[s].branch).length===0&&delete e.stn_list[s].branch);"psd_num"in e?e.psd_num=e.psd_num.toString():e.psd_num="1","line_num"in e||(e.line_num="1"),e.theme.length===3&&e.theme.push("#fff");for(const[s,i]of Object.entries(e.stn_list))"num"in i||(e.stn_list[s].num="00"),"interchange"in i&&i.interchange.map(f=>f.forEach(u=>{u.length===5&&u.splice(3,0,"#fff")}));for(const[s,i]of Object.entries(e.stn_list))i.change_type==="osi22_end_p"&&(e.stn_list[s].change_type="osi22_pr"),i.change_type==="osi22_end_u"&&(e.stn_list[s].change_type="osi22_ur");for(const[s,i]of Object.entries(e.stn_list))"interchange"in i||(e.stn_list[s].interchange=[[]]);"info_panel_type"in e?e.info_panel_type=(s=>{switch(s){case"gz_1":case"panasonic":return"gz28";case"gz_2":return"gz6";case"gz_3":return"gz3";default:return s}})(e.info_panel_type):e.info_panel_type="gz28","direction_gz_x"in e||(e.direction_gz_x=50),"direction_gz_y"in e||(e.direction_gz_y=70);for(const[s,i]of Object.entries(e.stn_list))"transfer"in i||(e.stn_list[s].transfer={tick_direc:i.change_type==="none"||i.change_type==="int2"?"r":(t=i.change_type)==null?void 0:t.split("_")[1].split("").slice().reverse()[0],paid_area:((o=i.change_type)==null?void 0:o.indexOf("osi"))!==-1?((n=i.change_type)==null?void 0:n.split("_")[1][0])==="p":!0,osi_names:((r=i.change_type)==null?void 0:r.indexOf("osi"))!==-1?[i.interchange[1][0]]:[],info:i.interchange.length===2?[i.interchange[0],i.interchange[1].slice(1)]:i.interchange}),delete e.stn_list[s].change_type,delete e.stn_list[s].interchange;for(const[s,i]of Object.entries(e.stn_list))"services"in i||(e.stn_list[s].services=["local"]),"facility"in i?i.facility===""&&(e.stn_list[s].facility=void 0):e.stn_list[s].facility=i.usage||void 0,delete e.stn_list[s].usage;"customiseMTRDest"in e||(e.customiseMTRDest={isLegacy:e.dest_legacy||!1,terminal:!1}),delete e.dest_legacy,"svgWidth"in e||(e.svgWidth={destination:e.svg_dest_width,runin:e.svg_dest_width,railmap:e.svg_width,indoor:e.svg_width}),"indoor"in e.svgWidth||(e.svgWidth.indoor=e.svgWidth.railmap),delete e.svg_width,delete e.svg_dest_width,e.notesGZMTR=(d=e.notesGZMTR)==null?void 0:d.map(s=>s.length===4?s.concat([!1]):s),delete e.char_form,delete e.show_outer,delete e.strip_pc,delete e.txt_bg_gap,"namePosMTR"in e||(e.namePosMTR={isStagger:!0,isFlip:e.txt_flip}),delete e.txt_flip,Object.keys(e.stn_list).forEach(s=>{"secondaryName"in e.stn_list[s]&&e.stn_list[s].secondaryName===!1&&delete e.stn_list[s].secondaryName,"type"in e.stn_list[s].transfer&&delete e.stn_list[s].transfer.type}),e.style=e.style===void 0||!Object.values(j).includes(e.style)?j.MTR:e.style,e.coline=(c=e.coline)!=null?c:[],e.loop=(a=e.loop)!=null?a:!1,e.loop_info=(l=e.loop_info)!=null?l:{bank:!0,left_and_right_factor:0,bottom_factor:1},e.loop_info.left_and_right_factor+e.loop_info.bottom_factor===0&&(e.loop_info.left_and_right_factor=1);for(const[s,i]of Object.entries(e.stn_list))"loop_pivot"in i||(e.stn_list[s].loop_pivot=!1);return Array.isArray(e.coline)&&(e.coline=e.coline.reduce((s,i)=>({...s,[S(4)]:i}),{})),e.platform_num===!1&&(e.platform_num=""),Object.values(e.stn_list).forEach(s=>{var f,u;const i=s;i.one_line=(f=i.one_line)!=null?f:!1,i.int_padding=(u=i.int_padding)!=null?u:e.loop?250:355}),e.branchSpacingPct===void 0&&(e.style===j.SHMetro?e.branchSpacingPct=Math.round(e.branch_spacing/e.svg_height*300):e.branchSpacingPct=Math.round(e.branch_spacing/e.svg_height*200),delete e.branch_spacing),ne(e),se(e),ie(e),ce(e),e},ne=e=>{for(const[t,o]of Object.entries(e.stn_list)){const n=o.transfer.info;n&&(e.stn_list[t].transfer.groups=n.map((r,d)=>r.length?{name:o.transfer.osi_names[d-1],lines:r.map(c=>{const a=c;return{theme:a.slice(0,4),name:a.slice(4,6)}})}:{lines:[]})),delete e.stn_list[t].transfer.info,delete e.stn_list[t].transfer.osi_names}},se=e=>{for(const[t,o]of Object.entries(e.stn_list)){const{name:n,secondaryName:r,localisedName:d,localisedSecondaryName:c}=o;!d&&n&&(e.stn_list[t].localisedName={zh:n[0],en:n[1]},delete e.stn_list[t].name),!c&&r&&(e.stn_list[t].localisedSecondaryName={zh:r[0],en:r[1]},delete e.stn_list[t].secondaryName)}},ie=e=>{const{svgWidth:t}=e;E.Platform in t||(e.svgWidth.platform=1200);for(const[o,n]of Object.entries(e.stn_list)){const{character_spacing:r}=n;r===void 0&&(e.stn_list[o].character_spacing=75)}},w=e=>e.length===4&&e.every(t=>typeof t=="string")&&!!e[2].match(/^#[0-9a-fA-F]{6}$/)&&Object.values(P).includes(e[3]),oe=e=>{const t=[],o=(n,r)=>{if(Array.isArray(n)&&w(n)){t.push({path:r||"",value:n});return}for(const d in n){const c=n[d],a=r?"".concat(r,".").concat(d):d;Array.isArray(c)?w(c)?t.push({path:a,value:c}):c.forEach((l,s)=>o(l,"".concat(a,".").concat(s))):c&&typeof c=="object"&&o(c,a)}};return o(e),t},re=(e,t)=>{const o={},n=(r,d,c)=>{let a=r;for(let s=0;s<c.length-1;s++){if(c[s]==="*"){Object.keys(a).forEach(i=>n(a,[...d,...c.slice(0,s)],[i,...c.slice(s+1)]));return}if(a=a==null?void 0:a[c[s]],a===void 0)return}(a==null?void 0:a[c[c.length-1]])!==void 0&&(o[[...d,...c].join(".")]=a==null?void 0:a[c[c.length-1]])};return n(e,[],t.split(".")),o},I=(e,t,o)=>{const n=t.split(".");let r=e;for(let d=0;d<n.length-1;d++)r=r[n[d]];r[n[n.length-1]]=o},pe=async e=>{const t=new Date().getTime(),o=oe(e);_.info("Found all themes pending for update",o);const n=JSON.parse(JSON.stringify(e)),r=5e3;let d,c=!1;const a=new Promise((l,s)=>{d=setTimeout(()=>{c=!0,s("Executing time exceeds ".concat(r,"ms"))},r),(async()=>{for(const{path:i,value:f}of o){if(c)throw new Error("Update aborted");const u=await N(f);I(n,i,u)}})().then(l).catch(s)});try{return await a,_.info("Themes update completed, elapsed time ".concat((new Date().getTime()-t)/1e3," sec")),n}catch(l){return _.warn("Error occurs when updating themes, elapsed time ".concat((new Date().getTime()-t)/1e3," sec"),l),n}finally{clearTimeout(d)}},le={notesGZMTR:e=>!(e!=null&&e.length),"stn_list.*.branch.left":e=>!(e!=null&&e.length),"stn_list.*.branch.right":e=>!(e!=null&&e.length),"stn_list.*.branch":e=>!e||Object.keys(e).length===0,"stn_list.*.facility":e=>!e,"stn_list.*.transfer.groups.*.lines":e=>!(e!=null&&e.length)},ce=e=>{const t=structuredClone(e);return Object.entries(le).forEach(([o,n])=>{Object.entries(re(t,o)).forEach(([r,d])=>{_.debug("Sanitising",r,d),n(d)&&I(t,r,void 0)})}),t.version=g.getAppVersion(),t},ae=()=>{const e="".concat(g.getAppName(),"__").concat(b.PARAM_CONFIG_BY_ID),t=Object.entries(g.storage.getAll()).filter(([o])=>o.startsWith(e)).map(([o,n])=>{const r=o.slice(e.length);if(n)try{return{...JSON.parse(n),id:r}}catch(d){return{id:r}}else return{id:r}});return _.info("loadParamRegistry(), Found param config in localStorage",t.map(o=>o.id)),t},we=()=>{const e=ae(),t="".concat(g.getAppName(),"__").concat(b.PARAM_BY_ID),o=Object.keys(g.storage.getAll()).filter(n=>n.startsWith(t)).map(n=>{var d;const r=n.slice(t.length);return(d=e.find(c=>c.id===r))!=null?d:{id:r}});return _.info("getParamRegistry(), Actual param found in localStorage",o.map(n=>n.id)),e.filter(n=>o.every(r=>r.id!==n.id)).forEach(n=>g.storage.remove(b.PARAM_CONFIG_BY_ID+n.id)),o},de=e=>{const t=g.storage.get(b.PARAM_CONFIG_BY_ID+e);return t?JSON.parse(t):void 0},Se=e=>{const t=g.storage.get(b.PARAM_BY_ID+e);return{param:t&&JSON.parse(t),config:de(e)}},he=(e,t)=>{const o=S();return g.storage.set(b.PARAM_BY_ID+o,e),g.storage.set(b.PARAM_CONFIG_BY_ID+o,JSON.stringify({name:t,lastModified:Date.now()})),o},Re=async e=>{const t=e.split("/").at(-1);try{const o=await fetch(e);if(o.ok){const n=await o.text();return he(n,t)}else return _.warn("Failed to download param"),null}catch(o){return _.warn("Failed to download param.",o),null}};function fe(e){var s;const{config:t,onClose:o,onUpdate:n}=e,{t:r}=M(),[d,c]=v.useState((s=t==null?void 0:t.name)!=null?s:"");v.useEffect(()=>{var i;t&&c((i=t.name)!=null?i:"")},[t]);const a=[{type:"input",label:r("Project name"),value:d,onChange:c,debouncedDelay:0}],l=()=>{var i;t&&((i=t.name)!=null?i:"")!==d&&n({...t,name:d})};return h.jsxs(z,{isOpen:!!t,onClose:o,isCentered:!0,children:[h.jsx($,{}),h.jsxs(U,{children:[h.jsx(Y,{children:r("Edit project info")}),h.jsx(G,{}),h.jsx(J,{children:h.jsx(Q,{fields:a})}),h.jsx(V,{children:h.jsx(Z,{colorScheme:"primary",onClick:l,children:r("Confirm")})})]})]})}const ue={flex:"2 1 0%",overflow:"hidden",minW:{base:"unset",md:240},w:{base:"100%",md:"unset"},mr:{base:0,md:2},mb:{base:2,md:0},"& > div":{flexDirection:"column",h:200,overflowX:"hidden",overflowY:"auto",borderRadius:"md",borderWidth:2,"& >.chakra-button":{alignItems:"center"},"& .chakra-button__group":{"& button:not(:first-of-type)":{h:"100%"}}}};function Me(e){const{paramRegistry:t,downloading:o,selectedParam:n,onParamSelect:r,onParamRemove:d,onParamUpdate:c}=e,{t:a}=M(),[l,s]=v.useState(),i=f=>{c==null||c(f),s(void 0)};return h.jsxs(H,{sx:ue,children:[h.jsxs(R,{children:[o&&h.jsx(x,{variant:"ghost",primaryText:a("Downloading")+"...",secondaryText:o,isDisabled:!0}),t.slice().sort((f,u)=>{var y,m;return((y=u.lastModified)!=null?y:0)-((m=f.lastModified)!=null?m:0)}).map(f=>{var u;return h.jsxs(K,{size:"sm",isAttached:!0,colorScheme:n===f.id?"primary":void 0,variant:n===f.id?"solid":"ghost",children:[h.jsx(x,{primaryText:(u=f.name)!=null?u:a("Project")+" "+f.id,secondaryText:a("Last modified")+": "+te(f.lastModified).map(y=>a(y)).join(" "),"aria-pressed":n===f.id,onClick:()=>r(f.id)}),c&&h.jsx(p,{"aria-label":a("Edit project info"),title:a("Edit project info"),icon:h.jsx(k,{}),onClick:()=>s(f)}),d&&h.jsx(p,{"aria-label":a("Remove project"),title:a("Remove project"),icon:h.jsx(W,{}),onClick:()=>d(f.id)})]},f.id)})]}),t.length>=10&&h.jsx(X,{as:"em",fontSize:"xs",children:a("You have reached the maximum number of projects.")}),h.jsx(fe,{config:l,onClose:()=>s(void 0),onUpdate:i})]})}export{Me as P,Q as R,ye as a,he as b,we as c,ee as d,Se as e,pe as f,de as g,Re as h,je as i,ve as r,ce as s,xe as u,me as w};
