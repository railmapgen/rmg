System.register(["./chakra-legacy-Ck1twAYB.js","./react-legacy-jWjm0Xez.js","./index-legacy-CsUMaXd3.js","./app-router-legacy-C4F5S52C.js","./svg-wrapper-legacy-CDYZ4kzN.js","./share-legacy-Cpm8oP_E.js","./mtr-legacy-DFkLRAhQ.js","./param-selector-legacy-Db0fBTrW.js"],(function(e,t){"use strict";var n,r,s,l,i,a,o,c,d,h,m,g,x,f;return{setters:[e=>{n=e.j},e=>{r=e.a,s=e.d},e=>{l=e.u,i=e.aW,a=e.n},e=>{o=e.i},e=>{c=e.S},e=>{d=e.d,h=e.a,m=e.c,g=e.g,x=e.b},e=>{f=e.a},null],execute:function(){const t=(e,t,n,r)=>{const s=e.length-2*r-n,l=[...e,...e,...e],i=e.length+e.findIndex((e=>e===t)),a=l[i+s-1],o=e.length+e.findIndex((e=>e===a))+(i+s>2*e.length?e.length:0);return{top:l.slice(i,o+1),left:l.slice(i-r,i),right:l.slice(o+1,o+1+r),bottom:l.slice(o+1+r,o+1+r+n)}},u=i.Destination;function p(){const{canvasScale:e}=l((e=>e.app)),{svgWidth:t,svg_height:r,theme:s}=l((e=>e.param)),i=t[u];return n.jsxs(c,{type:u,svgWidth:i,svgHeight:r,canvasScale:e,theme:s,children:[n.jsx(j,{}),n.jsx(_,{})]})}const j=r.memo((function(){return n.jsx("defs",{children:n.jsx("marker",{id:"slope",viewBox:"-1.5 0 3 1.5",refY:.5,children:n.jsx("path",{d:"M0,0L1,1H-1z",fill:"var(--rmg-theme-colour)"})})})})),_=()=>{const{routes:e,branches:t}=l((e=>e.helper)),{line_name:r,theme:s,current_stn_idx:i,direction:a,stn_list:c,info_panel_type:d,loop:h,coline:m}=l((e=>e.param)),g=(e,t,n)=>[...new Set(e.filter((e=>e.includes(n))).map((e=>{const n=e.filter((e=>!["linestart","lineend"].includes(e)));return"l"===t?n[0]:n.reverse()[0]})))],x=(e,t)=>t?[[e.map((e=>c[e].localisedName.zh)).join("，"),e.map((e=>c[e].localisedName.en)).join(", ")].map((e=>e.replace("\\","")))]:e.map((e=>{const{zh:t="",en:n=""}=c[e].localisedName;return[t.replace("\\",""),n.replace("\\","")]})),f=h?((e,t,n,r)=>{const s=e[0].filter((e=>!["linestart","lineend"].includes(e))),l=[...s,...s,...s],i="r"===t?l:l.reverse(),a=i.findIndex((e=>r===e))+s.length;return i.slice(a+1).filter((e=>n[e].loop_pivot)).slice(void 0,2)})(t,a,c,i):g(e,a,i),u=(h?g(e,a,i):f).filter((e=>t.slice(1).filter((e=>o(e,c))).some((t=>t.includes(e))))),p=x(f.filter((e=>!u.includes(e))),!(h||"sh2020"===d)),j=x(u,!0),_=Object.fromEntries(u.map((e=>[e,Object.values(m).filter((t=>t.from===e||t.to===e)).at(0)])).filter((([,e])=>e)));return n.jsxs(n.Fragment,{children:[n.jsx(v,{dest_names:p,line_name:r,line_color:[s[2],s[3]],coline:!!u.length,upper:!!u.length}),u.length&&u.map((e=>n.jsx("g",{transform:"translate(0,-250)",children:n.jsx(v,{dest_names:[j.at(0)],line_name:_[e]?.colors.at(0).slice(4),line_color:[_[e]?.colors.at(0)[2],_[e]?.colors.at(0)[3]],coline:!0,upper:!1})},`coline_${e}`)))]})},v=e=>{const{dest_names:t,line_name:s,line_color:i,coline:a,upper:o}=e,{current_stn_idx:c,direction:d,platform_num:h,svgWidth:m,svg_height:g}=l((e=>e.param)),x=r.useRef(null),[f,u]=r.useState({width:0});r.useEffect((()=>{x.current&&u(x.current.getBBox())}),[JSON.stringify(t),JSON.stringify(c)]);const[p,j,_,v,b]=[m.destination/2,10,36,264,325],S=p-j-_-f.width>=b/2&&p-j-_-v>=b/2?p:"l"===d?(m.destination+f.width-v)/2:(m.destination-f.width+v)/2;return n.jsxs("g",{transform:`translate(0,${g-300})`,children:[n.jsx("path",{stroke:i[0],strokeWidth:12,d:"l"===d?`M${m.destination-24},16 H 36`:"M24,16 H "+(m.destination-36),transform:`translate(0,${o?-20:220})`,markerEnd:a?void 0:"url(#slope)"}),n.jsx($,{ref:x,dest_names:t}),""!==h&&n.jsx("g",{transform:`translate(${S},0)`,children:n.jsx(y,{})}),s[0].match(/^[\w\d]+(号)?线/)?n.jsx(w,{line_name:s,line_color:i}):n.jsx(k,{line_name:s,line_color:i})]})},$=r.forwardRef((function(e,t){const{dest_names:s}=e,{direction:i,svgWidth:a}=l((e=>e.param));return n.jsxs("g",{ref:t,transform:`translate(${"l"===i?36:a.destination-36},145)`,children:[n.jsx("g",{transform:`translate(0,${2===s.length?-20:20})`,children:n.jsx("path",{d:"M60,60L0,0L60-60H100L55-15H160V15H55L100,60z",fill:"black",transform:`rotate(${"l"===i?0:180})scale(0.8)`})}),n.jsx("g",{textAnchor:"l"===i?"start":"end",transform:`translate(${"l"===i?148:-148},25)`,children:s.map(((e,t)=>n.jsxs(r.Fragment,{children:[n.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:70,dy:-100*t+7,children:"往"+e[0]},`zh${t}`),n.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:25,dy:-100*t+40,children:"To "+e[1]},`en${t}`)]},t)))})]})})),y=()=>{const{platform_num:e}=l((e=>e.param));return r.useMemo((()=>n.jsxs("g",{transform:"translate(-102.5,150)",children:[n.jsx("circle",{r:60,fill:"none",stroke:"black",strokeWidth:2}),n.jsx("text",{className:"rmg-name__en rmg-outline",dominantBaseline:"central",fontSize:120,textAnchor:"middle",children:e}),n.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:100,dominantBaseline:"central",x:65,children:"站台"})]})),[e])},k=e=>{const{line_name:t,line_color:s}=e,{direction:i,svgWidth:a}=l((e=>e.param)),o="l"===i?a.destination-42:42,c=r.useRef(null),[d,h]=r.useState({width:0});r.useEffect((()=>{c.current&&h(c.current.getBBox())}),[...t]);const m=("l"===i?-d.width:0)-6,g=("l"===i?-1:1)*d.width/2;return r.useMemo((()=>n.jsxs("g",{transform:`translate(${o},92)`,children:[n.jsx("rect",{fill:s[0],x:m,width:d.width+10,height:120}),n.jsxs("g",{textAnchor:"r"===i?"start":"end",transform:"translate(0,68)",fill:s[1],children:[n.jsx("g",{ref:c,children:n.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:68,children:t[0]})}),n.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:30,textAnchor:"middle",x:g,dy:42,children:t[1]})]})]})),[d,...t,...s,i,a.destination])},w=e=>{const{line_name:t,line_color:s}=e,{direction:i,svgWidth:a}=l((e=>e.param)),[o,c]=t[0].match(/^[\w\d]+|.+/g),d="l"===i?a.destination-36-210:90;return r.useMemo((()=>n.jsxs("g",{transform:`translate(${d},92)`,children:[n.jsx("rect",{fill:s[0],x:-54,width:108,height:120}),n.jsx("text",{className:"rmg-name__zh rmg-outline",fill:s[1],fontSize:96,textAnchor:"middle",dominantBaseline:"central",transform:"translate(0,60)",letterSpacing:-5,children:o}),n.jsxs("g",{textAnchor:"start",transform:"translate(74,68)",children:[n.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:68,children:c}),n.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:30,dy:42,children:t[1]})]})]})),[d,...t,...s,i,a.destination])},b=(e,t)=>e.map((e=>{const n=t.filter((t=>t.includes(e.from)&&t.includes(e.to)));if(1!==n.length)return{linePath:[],colors:e.colors};const r=n.flat(),s=r.indexOf(e.from),l=r.indexOf(e.to);return{linePath:s<l?r.slice(s,l+1):r.slice(l,s+1),colors:e.colors}})).filter((e=>0!==e.linePath.length)),S=()=>s.useMemo((()=>n.jsxs("filter",{id:"pujiang_outline",colorInterpolationFilters:"sRGB",filterUnits:"userSpaceOnUse",x:"0",y:"-1000",width:"5000",height:"2000",children:[n.jsxs("feComponentTransfer",{in:"SourceGraphic",children:[n.jsx("feFuncR",{type:"discrete",tableValues:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0"}),n.jsx("feFuncG",{type:"discrete",tableValues:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0"}),n.jsx("feFuncB",{type:"discrete",tableValues:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0"})]}),n.jsx("feColorMatrix",{type:"matrix",values:"1 0 0 0 0\n                            0 1 0 0 0\n                            0 0 1 0 0\n                            1 1 1 1 -3",result:"selectedColor"}),n.jsx("feMorphology",{operator:"erode",in:"selectedColor",radius:"0",result:"e1"}),n.jsx("feMorphology",{operator:"erode",in:"selectedColor",radius:"1",result:"e2"}),n.jsx("feComposite",{in:"e1",in2:"e2",operator:"xor",result:"uncoloredOutline"}),n.jsx("feFlood",{floodColor:"rgb(0,0,0)"}),n.jsx("feComposite",{operator:"in",in2:"uncoloredOutline",result:"outline"}),n.jsx("feComposite",{in:"outline",in2:"selectedColor",operator:"over",result:"result"}),n.jsx("feComposite",{in:"result",in2:"SourceGraphic",operator:"over"})]})),[]);S.displayName="PujiangLineDefs";const M=i.RunIn,z=()=>{const{canvasScale:e}=l((e=>e.app)),{branches:t,routes:s,depsStr:i}=l((e=>e.helper)),{svgWidth:a,svg_height:o,current_stn_idx:d,direction:h,loop:m,theme:g}=l((e=>e.param)),x=a[M],f=o-300,u=r.useMemo((()=>{let e=s.filter((e=>e.includes(d))).map((e=>e[e.indexOf(d)+("l"===h?1:-1)])).filter((e=>void 0!==e)).reduce(((e,t)=>e.includes(t)?e:e.concat(t)),[]);return m&&t[0].includes(d)&&1===e.length&&["linestart","lineend"].includes(e[0])&&(e="l"===h?[t[0][1]]:[t[0][t[0].length-2]]),e}),[i,d,h,m]),p=r.useMemo((()=>{let e=s.filter((e=>e.includes(d))).map((e=>e[e.indexOf(d)+("l"===h?-1:1)])).filter((e=>void 0!==e)).reduce(((e,t)=>e.includes(t)?e:e.concat(t)),[]);return m&&t[0].includes(d)&&1===e.length&&["linestart","lineend"].includes(e[0])&&(e="l"===h?[t[0][t[0].length-2]]:[t[0][1]]),e}),[i,d,h,m]);return n.jsxs(c,{type:M,svgWidth:x,svgHeight:o,canvasScale:e,theme:g,children:[n.jsx(N,{}),n.jsx("g",{transform:`translate(0,${f})`,children:n.jsx(O,{prevStnIds:u,nextStnIds:p})})]})},N=r.memo((function(){return n.jsxs("defs",{children:[n.jsx("marker",{id:"slope",viewBox:"-1.5 0 3 1.5",refY:.5,children:n.jsx("path",{d:"M0,0L1,1H-1z",fill:"var(--rmg-theme-colour)"})}),n.jsx(S,{})]})})),O=e=>{const{prevStnIds:t,nextStnIds:r}=e,{info_panel_type:s,svgWidth:i,stn_list:a}=l((e=>e.param)),o=i.runin/2,c=1===r.length&&["linestart","lineend"].includes(r[0]),d=1===t.length&&["linestart","lineend"].includes(t[0]),h=r.map((e=>a[e].localisedName)),m=t.map((e=>a[e].localisedName)),[{zh:g="",en:x=""}]=h,[{zh:f="",en:u=""}]=m,p=10+(r.length>1?-50*(g.split("\\").length-1)+-30*(x.split("\\").length-1):0),j=10+(t.length>1?-50*(f.split("\\").length-1)+-30*(u.split("\\").length-1):0);return n.jsxs(n.Fragment,{children:[n.jsx(W,{prevStnIds:t,nextStnIds:r,nextBranchLineDy:p,prevBranchLineDy:j}),c&&"sh2020"!==s?n.jsx(I,{mode:"terminal",prevStnIds:t,nextStnIds:r}):d&&"sh2020"!==s?n.jsx(I,{mode:"original",prevStnIds:t,nextStnIds:r}):n.jsxs(n.Fragment,{children:[n.jsx(H,{prevStnIds:t,nextStnIds:r}),n.jsx("g",{transform:`translate(${o},160)`,textAnchor:"middle",children:n.jsx(L,{})})]}),(d||!c)&&n.jsx(P,{stnIds:e.nextStnIds}),(c||!d)&&n.jsx(B,{stnIds:e.prevStnIds})]})},I=e=>{const{mode:t,prevStnIds:r,nextStnIds:s}=e,{current_stn_idx:i,theme:a,svgWidth:o,direction:c,coline:d}=l((e=>e.param)),{branches:h}=l((e=>e.helper)),m={l:{original:{x:o.runin-36,anchor:"end"},terminal:{x:36,anchor:"start"}},r:{original:{x:36,anchor:"start"},terminal:{x:o.runin-36,anchor:"end"}}},g=b(Object.values(d),h),x="terminal"===t?r:s,f=s.length>1?"var(--rmg-theme-colour)":g.filter((e=>e.linePath.includes(i)&&e.linePath.includes(x[0]))).map((e=>e.colors[0][2]))[0]??"var(--rmg-theme-colour)";return n.jsxs(n.Fragment,{children:["original"===t&&n.jsx("path",{transform:`translate(0,${d.length?"198":"220"})${d.length?"scale(1,2)":""}`,stroke:f,strokeWidth:12,d:"l"===c?`M ${o.runin-24},16 H 36`:"M24,16 H "+(o.runin-36),markerEnd:"url(#slope)"}),"terminal"===t&&n.jsx("g",{filter:"#B5B5B6"===a[2]?"url(#pujiang_outline)":void 0,children:n.jsx("path",{transform:`translate(0,${d.length?"198":"220"})${d.length?"scale(1,2)":""}`,stroke:"var(--rmg-grey)",strokeWidth:12,d:"M24,16 H "+(o.runin-24)})}),n.jsx("g",{transform:`translate(${m[c][t].x},160)`,textAnchor:m[c][t].anchor,children:n.jsx(L,{})})]})},H=e=>{const{prevStnIds:t,nextStnIds:r}=e,{direction:s,svgWidth:i,theme:a,coline:c,current_stn_idx:d,stn_list:h}=l((e=>e.param)),{branches:m}=l((e=>e.helper)),g=i.runin/2,x=e=>e.includes("linestart")||e.includes("lineend"),f=b(Object.values(c),m),u=r.length>1?"single":x(r)?f.filter((e=>[d,t[0]].every((t=>e.linePath.includes(t))))).length>0?"multiple":"single":[d,r[0]].every((e=>m[0].includes(e)))&&f.filter((e=>[d,r[0]].every((t=>e.linePath.includes(t))))).length>0?"multiple":"single",p=x(r)?t:r,j=r.length>1?"var(--rmg-theme-colour)":f.filter((e=>e.linePath.includes(d)&&e.linePath.includes(p[0]))).map((e=>e.colors[0][2]))[0]??"var(--rmg-theme-colour)",_=Object.keys(c).length>0&&(v=d,$=r,y=h,m.slice(1).filter((e=>[v,$[0]].every((t=>e.includes(t))))).filter((e=>o(e,y))).length>0)?j:"var(--rmg-theme-colour)";var v,$,y;const k=Object.keys(c).length>0&&1===r.length&&(!(!x(t)&&!x(r))||!([d,r[0]].every((e=>m[0].includes(e)))&&0!==f.filter((e=>e.linePath.includes(d)&&e.linePath.includes(r[0]))).length)),w=Object.keys(c).length>0&&1===t.length;return n.jsxs("g",{transform:"translate(0,220)",strokeWidth:12,children:[n.jsxs(n.Fragment,{children:["var(--rmg-theme-colour)"!==_&&n.jsx("marker",{id:`slope_${_}`,viewBox:"-1.5 0 3 1.5",refY:.5,children:n.jsx("path",{d:"M0,0L1,1H-1z",fill:_})}),n.jsx("path",{stroke:_,d:`M ${g},16 H ${"l"===s?36:i.runin-36}`,markerEnd:"var(--rmg-theme-colour)"===_?"url(#slope)":`url(#slope_${_})`,transform:k?"translate(0,-22)scale(1,2)":void 0})]}),"multiple"===u&&n.jsxs(n.Fragment,{children:[n.jsx("marker",{id:`slope_${j}`,viewBox:"-1.5 0 3 1.5",refY:.5,children:n.jsx("path",{d:"M0,0L1,1H-1z",fill:j})}),n.jsx("path",{stroke:j,d:`M ${g},16 H ${"l"===s?48:i.runin-48}`,markerEnd:`url(#slope_${j})`,transform:"translate(0,-12)"})]}),n.jsx("g",{filter:"#B5B5B6"===a[2]?"url(#pujiang_outline)":void 0,transform:`translate(0,${w?-22:0})scale(1,${w?2:1})`,children:n.jsx("path",{stroke:"var(--rmg-grey)",d:`M ${g},16 H ${"l"===s?i.runin-24:24} `})})]})},W=e=>{const{prevStnIds:t,nextStnIds:r,nextBranchLineDy:s,prevBranchLineDy:i}=e,{direction:a,svgWidth:o,current_stn_idx:c,coline:d,theme:h}=l((e=>e.param)),{branches:m}=l((e=>e.helper)),g=o.runin/2,x=125,f=e=>`${e[0]},${e[1]}`,u=e=>`M${f(e.at(0))} `+e.slice(1).map((e=>`L${f(e)}`)).join(" "),p="l"===a?[[o.runin/3,x],[o.runin/6,s],[36,s]]:[[o.runin/3*2,x],[o.runin/6*5,s],[o.runin-36,s]],j="l"===a?[[o.runin/3*2,x],[o.runin/6*5,i],[o.runin-24,i]]:[[o.runin/3,x],[o.runin/6,i],[24,i]];let _="var(--rmg-theme-colour)";if(Object.keys(d).length>0){const e=b(Object.values(d),m);r.length>1&&e.filter((e=>e.linePath.includes(c)&&r.some((t=>e.linePath.includes(t)))))&&(p[0][1]-=11,p.unshift([g,114]),_=e.filter((e=>e.linePath.includes(c)&&r.some((t=>e.linePath.includes(t))))).at(0).colors.at(0)[2]),t.length>1&&e.filter((e=>e.linePath.includes(c)&&t.some((t=>e.linePath.includes(t)))))&&(j[0][1]-=11,j.unshift([g,114]))}return n.jsxs("g",{transform:"translate(0,110)",strokeWidth:12,fill:"none",filter:"#B5B5B6"===h[2]?"url(#pujiang_outline)":void 0,children:[n.jsx("marker",{id:"slope_branch",viewBox:"-1.5 0 3 1.5",refY:.5,children:n.jsx("path",{d:"M0,0L1,1H-1z",fill:_})}),r.length>1&&n.jsx("path",{stroke:_,d:u(p),markerEnd:"url(#slope_branch)"}),t.length>1&&n.jsx("path",{stroke:"var(--rmg-grey)",d:u(j)})]})},L=()=>{const e=l((e=>e.param)),{localisedName:t}=e.stn_list[e.current_stn_idx],{zh:s="",en:i=""}=t;return r.useMemo((()=>n.jsxs(n.Fragment,{children:[n.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:112,children:s.replace("\\","")}),n.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:36,dy:50,children:i.replace("\\","")})]})),[s,i])},F=e=>{const{nextName:t,...s}=e,{zh:l="",en:i=""}=t;return n.jsx("g",{...s,children:r.useMemo((()=>n.jsxs(n.Fragment,{children:[l.split("\\").map(((e,t,r)=>n.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:48,dy:-50*(r.length-1-t)-30*(i.split("\\").length-1),children:e},e))),i.split("\\").map(((e,t,r)=>n.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:24,dy:28+-30*(r.length-1-t),children:e},e)))]})),[l,i])})},B=e=>{const t=l((e=>e.param)),r=e.stnIds.map((e=>t.stn_list[e].localisedName)),s=(e.stnIds.length>1?15:125)+-50*r.map((e=>e.zh?.split("\\")?.length??1)).reduce(((e,t)=>e+t),-r.length)+-30*r.map((e=>e.en?.split("\\")?.length??1)).reduce(((e,t)=>e+t),-r.length),[{zh:i="",en:a=""}]=r,o=70+(e.stnIds.length>1?-50*(i.split("\\").length-1)+-30*(a.split("\\").length-1):0);return n.jsxs("g",{fill:"gray",textAnchor:"l"===t.direction?"end":"start",transform:`translate(${"l"===t.direction?t.svgWidth.runin-36:36},0)`,children:[n.jsx(F,{nextName:r[0],transform:"translate(0,183)"}),e.stnIds.length>1&&n.jsx(F,{nextName:r[1],transform:`translate(0,${o})`}),n.jsxs("g",{transform:`translate(0, ${s})`,children:[n.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:22,children:"上一站"}),n.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:12,dx:"l"===t.direction?-70:70,children:"Past Stop"})]})]})},P=e=>{const t=l((e=>e.param)),r=e.stnIds.map((e=>t.stn_list[e].localisedName)),s=(e.stnIds.length>1?15:125)+-50*r.map((e=>e.zh?.split("\\")?.length??1)).reduce(((e,t)=>e+t),-r.length)+-30*r.map((e=>e.en?.split("\\")?.length??1)).reduce(((e,t)=>e+t),-r.length),[{zh:i="",en:a=""}]=r,o=70+(e.stnIds.length>1?-50*(i.split("\\").length-1)+-30*(a.split("\\").length-1):0);return n.jsxs("g",{textAnchor:"l"===t.direction?"start":"end",transform:`translate(${"l"===t.direction?36:t.svgWidth.runin-36},0)`,children:[n.jsx(F,{nextName:t.stn_list[e.stnIds[0]].localisedName,transform:"translate(0,183)"}),e.stnIds.length>1&&n.jsx(F,{nextName:t.stn_list[e.stnIds[1]].localisedName,transform:`translate(0,${o})`}),n.jsxs("g",{transform:`translate(0, ${s})`,children:[n.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:22,children:"下一站"}),n.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:12,dx:"l"===t.direction?70:-70,children:"Next Stop"})]})]})},E=e=>{const{stnId:t,stnState:r,color:s,bank:i,direction:a}=e,{direction:o,info_panel_type:c,stn_list:d,loop:h}=l((e=>e.param)),m=d[t],g=a??o,x=h?0:(m.parents.length>1||m.children.length>1?8+12*(m.localisedName.en?.split("\\")?.length??1):0)*("r"===g?-1:1);let f;const u={};"sh2020"===c?(f=3===m.services.length?"stn_sh_2020_direct":2===m.services.length?"stn_sh_2020_express":"stn_sh_2020",u.fill=-1===r?"gray":s||"var(--rmg-theme-colour)"):(f=3===m.services.length?"direct_sh":2===m.services.length?"express_sh":[...m.transfer.groups[0].lines||[],...m.transfer.groups[1]?.lines||[]].length>0?"int2_sh":"stn_sh",u.stroke=-1===r?"gray":s||"var(--rmg-theme-colour)");const p=i??0,j=("l"===g?6:-6)+x+30*p,_=("sh2020"===c?-20:-6)+Math.abs(p)*("sh2020"===c?25:11),v=p?0:"l"===g?-45:45;return n.jsxs(n.Fragment,{children:[n.jsx("use",{xlinkHref:`#${f}`,...u,transform:`translate(${p*("sh2020"===c?5:0)},0)rotate(${90*p*("sh2020"===c?1:-1)})`}),n.jsx("g",{transform:`translate(${j},${_})rotate(${v})`,children:n.jsx(R,{name:m.localisedName,groups:m.transfer.groups,stnState:r,direction:g,facility:m.facility,bank:p,oneLine:m.one_line,intPadding:m.int_padding})}),0===r?n.jsx(C,{}):void 0]})},R=e=>{const{name:t,groups:s,stnState:l,direction:i,facility:a,bank:o,oneLine:c,intPadding:d}=e,h=r.useRef(null),m="l"===i?1:-1,g=a?30:0,x=o?-12:0,f=r.useRef(null),[u,p]=r.useState(0);r.useEffect((()=>p(f.current?.getBBox().width??0)),[JSON.stringify(s)]);const j=d-u;return n.jsxs(n.Fragment,{children:[s.map((e=>e.lines??[])).flat().length>0&&n.jsxs(n.Fragment,{children:[n.jsx("line",{x1:(x+g)*m,x2:j*m,stroke:-1===l?"gray":"black",strokeWidth:.5}),n.jsx(V,{ref:f,groups:s,direction:i,transform:`translate(${j*m},-10.75)`})]}),a&&n.jsx("use",{xlinkHref:"#"+a,x:10*m,y:-30}),n.jsxs("g",{textAnchor:"l"===i?"start":"end",transform:`translate(${g*m},-14)`,children:[n.jsx(A,{ref:h,stnName:t,oneLine:c,directionPolarity:m,fill:-1===l?"gray":0===l?"red":"black"}),s[1]?.lines?.length&&n.jsx("g",{transform:`translate(${(j+u/2)*m},-30)`,children:n.jsx(G,{osiInfos:s[1].lines})}),s[2]?.lines?.length&&n.jsx("g",{transform:`translate(${(d+5)*m},0)`,children:n.jsx(T,{osysiInfos:s[2].lines,direction:e.direction})})]})]})},A=r.forwardRef((function(e,t){const{stnName:s,oneLine:l,directionPolarity:i,...a}=e,{zh:o="",en:c=""}=s,d=r.useRef(null),[h,m]=r.useState(0);r.useEffect((()=>{l&&d.current?m(d.current.getBBox().width+5):m(0)}),[s.zh,s.en,l]);const[g,x]=[20,8];return n.jsx("g",{ref:t,...a,children:r.useMemo((()=>n.jsxs(n.Fragment,{children:[n.jsx("g",{ref:d,children:o.split("\\").map(((e,t,r)=>n.jsx("text",{className:"rmg-name__zh rmg-outline",dy:(r.length-1-t)*-g+(l?x:(c.split("\\").length-1)*-x),children:e},t)))}),n.jsx("g",{fontSize:8,transform:`translate(${h*i},0)`,children:c.split("\\").map(((e,t,r)=>n.jsx("text",{className:"rmg-name__en rmg-outline",dy:(r.length-2-t)*-x+2,children:e},t)))})]})),[o,c,l,h,i])})})),C=()=>{const{stn_list:e}=l((e=>e.param)),t=[-1,35,50,75][new Set(Object.values(e).map((e=>e.services)).flat()).size];return n.jsx("g",{transform:`translate(0, ${t})`,children:n.jsx("text",{className:"rmg-name__zh",fill:"red",textAnchor:"middle",children:"本站"})})},V=r.forwardRef((function(e,t){const{groups:r,direction:s,...l}=e,i=[...r[0].lines||[],...r[1]?.lines||[],...r[2]?.lines?.filter((e=>Boolean(e.name[0].match(/^磁(悬)*浮/))))||[]];let a=0;return n.jsx("g",{ref:t,fontSize:14,textAnchor:"middle",...l,children:i.map(((e,t)=>{const r=Boolean(e.name[0].match(/^\w+(号)?线/)),l=Boolean(e.name[0].match(/^磁(悬)*浮/));let i;return"r"===s&&(a-=(r||l?20:14*e.name[0].length+12)+(0===t?0:5)),i=l?n.jsx("g",{transform:`translate(${a},-16)scale(0.1428571429)`,children:n.jsx(D,{info:e})},t):r?n.jsx("g",{transform:`translate(${a},0)`,children:n.jsx(J,{info:e})},t):n.jsx("g",{transform:`translate(${a},0)`,children:n.jsx(Y,{info:e})},t),"l"===s&&(a+=r||l?25:14*e.name[0].length+12+5),i}))})})),D=r.memo((function(e){return n.jsx(n.Fragment,{children:n.jsx("use",{xlinkHref:"#intbox_maglev",fill:e.info.theme?.[2],stroke:e.info.theme?.[2]})})}),((e,t)=>JSON.stringify(e.info)===JSON.stringify(t.info))),J=r.memo((function(e){return n.jsxs(n.Fragment,{children:[n.jsx("use",{xlinkHref:"#intbox_number",fill:e.info.theme?.[2]}),n.jsx("text",{x:10,className:"rmg-name__zh",fill:e.info.theme?.[3],dominantBaseline:"central",children:e.info.name[0].match(/(\d*)\w+/)?.[0]})]})}),((e,t)=>JSON.stringify(e.info)===JSON.stringify(t.info))),Y=r.memo((function(e){const t=e.info.name[0].split("\\")[0].length;return n.jsxs(n.Fragment,{children:[n.jsx("rect",{height:22,width:14*t+12,y:-11,fill:e.info.theme?.[2]}),n.jsx("text",{x:7*t+6,className:"rmg-name__zh",fill:e.info.theme?.[3],dominantBaseline:"central",children:e.info.name[0].split("\\")[0]})]})}),((e,t)=>JSON.stringify(e.info)===JSON.stringify(t.info))),G=e=>{const t=e.osiInfos.map((e=>e.name[0])).join("，");return r.useMemo((()=>n.jsxs("g",{textAnchor:"middle",fontSize:"50%",children:[n.jsx("text",{className:"rmg-name__zh",dy:-5,children:`换乘${t}`}),n.jsx("text",{className:"rmg-name__zh",dy:5,children:"仅限公共交通卡"}),n.jsx("text",{className:"rmg-name__en",dy:12.5,fontSize:"75%",children:"Only for Public Transportation Card"})]})),[t.toString()])},T=e=>{const t=e.osysiInfos.map((e=>e.name[0])).join("，"),s=e.osysiInfos.map((e=>e.name[1])).join(", ");return r.useMemo((()=>n.jsxs("g",{textAnchor:"l"===e.direction?"start":"end",fontSize:"50%",children:[n.jsxs("text",{className:"rmg-name__zh",dy:3,children:["转乘",t]}),n.jsxs("text",{className:"rmg-name__en",dy:10,fontSize:"75%",children:["To ",s]})]})),[JSON.stringify(e.osysiInfos),e.direction])},U=["shanghai","sh4","#5F259F","#fff","4号线","Line 4"],X=e=>{const{xs:t,servicesPresent:s,stnStates:i}=e,{svg_height:a,direction:o,stn_list:c,current_stn_idx:h,branchSpacingPct:m,info_panel_type:g,coline:x}=l((e=>e.param)),{branches:f,depsStr:u}=l((e=>e.helper)),p=r.useMemo((()=>(console.log("computing y shares"),Object.keys(c).reduce(((e,t)=>{if(f[0].includes(t))return{...e,[t]:0};{const n=f.slice(1).filter((e=>e.includes(t)))[0];return{...e,[t]:c[n[0]].children.indexOf(n[1])?-3:3}}}),{}))),[u]),j=Object.entries(p).filter((([,e])=>e<=0)).reduce(((e,[t,n])=>({...e,[t]:n})),{}),_=Object.keys(j).reduce(((e,t)=>({...e,[t]:-j[t]*m*a/300})),{}),v=r.useMemo((()=>((e,t)=>e.map((e=>{const n=d(e.linePath,t);return{main:[{linePath:n.main,colors:e.colors}],pass:[{linePath:n.pass,colors:e.colors}]}})).reduce(((e,t)=>(e.main=[...e.main,...t.main],e.pass=[...e.pass,...t.pass],e)),{main:[],pass:[]}))(b(Object.values(x).filter((e=>e.display)),f),i)),[JSON.stringify(x),h,o,u]),$=s.reduce(((e,n)=>({...e,[n]:Object.keys(v).reduce(((e,r)=>({...e,[r]:v[r].map((e=>({path:te(e.linePath,r,t,_,o,n,s.length,c,"diagonal"),colors:e.colors}))).filter((e=>""!==e.path))})),{})})),{}),y=b(Object.values(x).filter((e=>e.display)),f).map((e=>e.linePath)).flat(),k="sh2020"===g?3:0;return n.jsx(n.Fragment,{children:n.jsxs("g",{id:"coline",transform:`translate(0,${12+k})`,children:[n.jsx(Z,{paths:$,direction:o}),n.jsx(q,{colineStns:v,branches:f,xs:t,ys:_,stnStates:i,lineWidth:12,colineGap:k}),n.jsx(K,{stnIds:Object.entries(p).filter((([,e])=>e<0)).reduce(((e,[t])=>[...e,t]),[]).filter((e=>!["linestart","lineend"].includes(e))).filter((e=>0!==c[e].services.length)).filter((e=>y.includes(e))),xs:t,ys:_,stnStates:i})]})})},Z=e=>{const{paths:t,direction:s}=e;return n.jsx(n.Fragment,{children:Object.keys(t).map(((e,l)=>n.jsx("g",{transform:`translate(0,${25*l})`,children:n.jsxs("g",{children:[t[e]?.pass.map(((t,s)=>n.jsx(r.Fragment,{children:n.jsx("path",{stroke:"var(--rmg-grey)",strokeWidth:12,fill:"none",d:t.path,strokeLinejoin:"round",filter:e===a.local?void 0:`url(#contrast-${e})`},s)},s))),t[e]?.main.map(((t,l)=>n.jsxs(r.Fragment,{children:[t.colors.length>1&&n.jsx("linearGradient",{id:`grad${l}`,y1:"-100%",y2:"100%",x1:"0",x2:"0",gradientUnits:"userSpaceOnUse",children:t.colors.map(((e,s)=>n.jsxs(r.Fragment,{children:[n.jsx("stop",{offset:100/t.colors.length*(s+0)+"%",stopColor:e[2]}),n.jsx("stop",{offset:100/t.colors.length*(s+1)+"%",stopColor:e[2]})]},s)))}),"l"===s&&n.jsx("marker",{id:`arrow_left_${l}_${t.colors.map((e=>e[2])).join("_")}`,refY:.5,refX:1,children:n.jsx("path",{d:"M1,0L0,1H1z",fill:t.colors.length>1?`url(#grad${l})`:t.colors[0][2]})}),"r"===s&&n.jsx("marker",{id:`arrow_right_${l}_${t.colors.map((e=>e[2])).join("_")}`,refY:.5,children:n.jsx("path",{d:"M0,0L1,1H-1z",fill:t.colors.length>1?`url(#grad${l})`:t.colors[0][2]})}),n.jsx("path",{stroke:(t.colors.at(-1)??U)[2],strokeWidth:12,fill:"none",d:t.path,markerStart:"l"===s?`url(#arrow_left_${l}_${t.colors.map((e=>e[2])).join("_")})`:void 0,markerEnd:"r"===s?`url(#arrow_right_${l}_${t.colors.map((e=>e[2])).join("_")})`:void 0,strokeLinejoin:"round",filter:e===a.local?void 0:`url(#contrast-${e})`},l)]},l)))]})},`servicePath${l}`)))})},q=e=>{const{colineStns:t,branches:r,xs:s,ys:i,stnStates:a,lineWidth:o,colineGap:c}=e,{line_name:d,theme:h,info_panel_type:m}=l((e=>e.param)),g=[...t.main,...t.pass].map((e=>e.linePath.map((t=>({curStn:t,x:s[t],y:i[t],color:e.colors.at(-1)??[...h,...d]}))))).flat().reduce(((e,t)=>e.find((e=>e.curStn===t.curStn))?e:e.concat(t)),[]).filter((e=>r[0].includes(e.curStn)));return console.log(g),n.jsx("g",{id:"stations_in_mainline",children:g.map((e=>{const{curStn:t,x:r,y:s,color:l}=e,i=(-1===a[t]?0:o)+c+o,d=(-1===a[t]?0:-o)-c-o/2;return n.jsx("g",{transform:`translate(${r},${s})`,children:"sh2020"===m?n.jsx("rect",{stroke:"none",height:i,width:12,x:-6,y:d,fill:-1===a[t]?"var(--rmg-grey)":l[2]}):n.jsx("use",{xlinkHref:"#int2_sh",stroke:"var(--rmg-theme-colour)",transform:`translate(0,${-o})`})},t)}))})},K=e=>{const{xs:t,ys:s,stnStates:i,stnIds:a}=e,{branches:o,depsStr:c}=l((e=>e.helper)),{line_name:d,theme:h,coline:m}=l((e=>e.param)),g=r.useMemo((()=>b(Object.values(m),o)),[JSON.stringify(m),c]),x=a.reduce(((e,t)=>({...e,[t]:g.filter((e=>e.linePath.includes(t))).map((e=>e.colors)).flat().at(0)??[...h,...d]})),{});return n.jsx("g",{id:"stations_in_coline",children:a.map((e=>n.jsx("g",{transform:`translate(${t[e]},${s[e]})`,children:n.jsx(E,{stnId:e,stnState:i[e],color:x[e][2]})},e)))})},Q=()=>{const{routes:e,branches:t,depsStr:s}=l((e=>e.helper)),i=l((e=>e.param)),{svg_height:o,stn_list:c,branchSpacingPct:f,coline:u,direction:p}=l((e=>e.param)),j=h(i.stn_list,(()=>0),(()=>0)),_=m("linestart","lineend",j),v=m(_.nodes[1],_.nodes.slice(-2)[0],j),$=r.useMemo((()=>(console.log("computing x shares"),Object.keys(i.stn_list).reduce(((e,n)=>({...e,[n]:g(n,j,t)})),{}))),[t.toString(),JSON.stringify(j)]),y=[i.svgWidth.railmap*i.padding/100,i.svgWidth.railmap*(1-i.padding/100)],k=Object.keys($).reduce(((e,t)=>({...e,[t]:y[0]+$[t]/v.len*(y[1]-y[0])})),{}),w=r.useMemo((()=>(console.log("computing y shares"),Object.keys(c).reduce(((e,n)=>{if(t[0].includes(n))return{...e,[n]:0};{const r=t.slice(1).filter((e=>e.includes(n)))[0];return{...e,[n]:c[r[0]].children.indexOf(r[1])?-3:3}}}),{}))),[s]),b=Object.entries(w).filter((([,e])=>e>=0)).reduce(((e,[t,n])=>({...e,[t]:n})),{}),S=Object.keys(b).reduce(((e,t)=>({...e,[t]:-b[t]*f*o/300})),{}),M=r.useMemo((()=>x(i.current_stn_idx,e,i.direction)),[i.current_stn_idx,i.direction,e.toString()]),z=Object.values(a),N=Object.values(i.stn_list).map((e=>e.services)).flat().reduce(((e,t)=>(e[z.indexOf(t)]=!0,e)),[!1,!1,!1]).map(((e,t)=>[z[t],e])).filter((e=>e[1])).map((e=>e[0])),O=t.map((e=>d(e,M))).reduce(((e,t)=>(e.main.push(t.main),e.pass.push(t.pass),e)),{main:[],pass:[]}),I=N.reduce(((e,t)=>({...e,[t]:Object.keys(O).reduce(((e,n)=>({...e,[n]:O[n].map((e=>te(e,n,k,S,p,t,N.length,c))).filter((e=>""!==e))})),{})})),{});return n.jsxs("g",{id:"main",transform:`translate(0,${i.svg_height*(Object.keys(u).length>0?.5:.7+.1)})`,children:[n.jsx(ee,{paths:I,direction:i.direction}),n.jsx(ne,{stnIds:Object.keys(b).filter((e=>!["linestart","lineend"].includes(e))).filter((e=>0!==c[e].services.length)),xs:k,ys:S,stnStates:M}),Object.keys(u).length>0&&n.jsx(X,{xs:k,servicesPresent:N,stnStates:M}),N.length>1&&n.jsx(re,{servicesLevel:N,lineXs:y})]})},ee=e=>{const{theme:t}=l((e=>e.param)),{paths:r,direction:s}=e;return n.jsx(n.Fragment,{children:Object.keys(r).map(((l,i)=>n.jsxs("g",{transform:`translate(0,${25*i})`,filter:"#B5B5B6"===t[2]?"url(#pujiang_outline)":void 0,children:[n.jsx("g",{children:r[l]?.pass.map(((t,r)=>n.jsx("path",{stroke:"var(--rmg-grey)",strokeWidth:12,fill:"none",d:t,markerStart:"l"===e.direction?"url(#arrow_gray)":void 0,markerEnd:"r"===e.direction?"url(#arrow_gray)":void 0,strokeLinejoin:"round"},r)))}),n.jsx("g",{children:r[l]?.main.map(((e,t)=>n.jsx("path",{stroke:"var(--rmg-theme-colour)",strokeWidth:12,fill:"none",d:e,markerStart:"l"===s?"url(#arrow_theme_left)":void 0,markerEnd:"r"===s?"url(#arrow_theme_right)":void 0,strokeLinejoin:"round",filter:l===a.local?void 0:`url(#contrast-${l})`},t)))})]},`servicePath${i}`)))})},te=(e,t,n,r,s,l,i,a,o="rightangle")=>{let[c,d]=[];const h={},m={local:0,express:20,direct:40}[l],g=i>1?50:0;let x=30;if(e.length>0){let t=!1,n=!1;a[e.at(-1)||0].children.some((e=>["linestart","lineend"].includes(e)))?n=!0:a[e.at(0)||0].parents.some((e=>["linestart","lineend"].includes(e)))&&(t=!0),x=t||n?x:0}const f=30;if(e.forEach((e=>{const t=n[e],s=r[e];if(!c&&0!==c)return[d,c]=[t,s],void(h.start=[t,s]);0===s?s!==c&&(h.bifurcate=[d,c]):s!==c&&(h.bifurcate=[t,s]),h.end=[t,s],[d,c]=[t,s]})),"start"in h){if("end"in h){if("bifurcate"in h){const[e,n]=h.start,r=h.bifurcate[0],[l,i]=h.end;return"main"===t?"l"===s?i>n?(console.log(h),"rightangle"===o?`M ${e-x},${n} H ${l} V ${i}`:`M ${e},${n} H ${e+f} L ${r-f},${i} H ${l}`):"rightangle"===o?`M ${e},${n} V ${i} H ${l}`:`M ${e-x},${n} H ${r+f} L ${l-f},${i} H ${l}`:i>n?"rightangle"===o?`M ${e},${n} H ${l} V ${i}`:`M ${e},${n} H ${e+f} L ${r-f},${i} H ${l+x}`:"rightangle"===o?`M ${e},${n} V ${i} H ${l+x}`:`M ${e},${n} H ${r+f} L ${l-f},${i} H ${l}`:i>n?"rightangle"===o?`M ${e-x},${n} H ${l} V ${i}`:`M ${e},${n} H ${e+f} L ${r-f},${i} H ${l+x}`:"rightangle"===o?`M ${e},${n} V ${i} H ${l+x}`:`M ${e-x},${n} H ${r+f} L ${l-f},${i} H ${l}`}{const[e,n]=h.start,r=h.end[0];return"main"===t?"l"===s?`M ${e-x-m},${n} H ${r}`:`M ${e},${n} H ${r+x+m}`:"l"===s?`M ${e-x},${n} H ${r+x+g}`:`M ${e-x-g},${n} H ${r+x}`}}{const[e,n]=h.start;return"main"===t?"l"===s?`M ${e-x-m},${n} H ${e}`:`M ${e},${n} H ${e+x+m}`:"l"===s?`M ${e},${n} L ${e+x+g},${n}`:`M ${e-x-g},${n} L ${e},${n}`}}return""},ne=e=>{const{xs:t,ys:r,stnStates:s,stnIds:l}=e;return n.jsx("g",{children:l.map((e=>n.jsx("g",{transform:`translate(${t[e]},${r[e]})`,children:n.jsx(E,{stnId:e,stnState:s[e]})},e)))})},re=e=>{const{svg_height:t,direction:s,svgWidth:i}=l((e=>e.param)),a=130-t,o=e.servicesLevel.map((e=>({local:"普通车",express:"大站车",direct:"直达车"}[e]))),c="r"===s?e.lineXs[0]-42:e.lineXs[1]+42,d=2===e.servicesLevel.length?350:500;return r.useMemo((()=>n.jsxs("g",{children:[o.map(((e,t)=>n.jsxs("g",{transform:`translate(${c},${25*t})`,children:[n.jsx("rect",{x:-27.5,height:10,width:55,fill:"white",stroke:"black",y:-5}),n.jsx("text",{className:"rmg-name__zh",fontSize:9,y:3,textAnchor:"middle",children:`${e}运行线`})]},e))),n.jsxs("g",{transform:`translate(${"r"===s?30:i.railmap-d},${a})`,children:[n.jsx("text",{className:"rmg-name__zh",children:"图例："}),o.map(((e,t)=>n.jsxs("g",{transform:`translate(${150*t+50},0)`,children:[n.jsx("line",{x1:"0",x2:"35",y1:"-5",y2:"-5",stroke:"var(--rmg-theme-colour)",strokeWidth:"12",filter:2===t?"url(#contrast-direct)":1===t?"url(#contrast-express)":""}),n.jsx("use",{x:"17.5",y:"-5",xlinkHref:"#stn_sh",fill:"var(--rmg-theme-colour)"}),n.jsx("text",{x:"40",className:"rmg-name__zh",children:`${e}停靠站`})]},`serviceLevel${t}`)))]})]})),[t,s,i,e.servicesLevel,e.lineXs])},se=()=>{const{direction:e,svgWidth:t,coline:s}=l((e=>e.param)),i=!!Object.keys(s).length;return r.useMemo((()=>n.jsxs("g",{transform:`translate(${"l"===e?50:t.railmap-150},50)`,children:[n.jsx("text",{className:"rmg-name__zh",children:"列车前进方向"}),n.jsx("path",{d:"M60,60L0,0L60-60H100L55-15H160V15H55L100,60z",stroke:i?"var(--rmg-black)":void 0,strokeWidth:i?5:void 0,fill:i?"var(--rmg-white)":"var(--rmg-theme-colour)",transform:`translate(${"l"===e?-30:125},-5)rotate(${"l"===e?0:180})scale(0.15)`})]})),[e,s,t.railmap])},le=e=>{const{stnId:t,nameDirection:r,services:s,color:i}=e,a=l((e=>e.param.stn_list[t])),o=[...a.transfer.groups[0]?.lines||[],...a.transfer.groups[1]?.lines||[]];let c;c=3===a.services.length?"direct_indoor_sh":2===a.services.length?"express_indoor_sh":a.transfer.groups[1]?.lines?.length?"osi_indoor_sh":o.length>0?"int2_indoor_sh":"stn_indoor_sh";const d="left"===r||"right"===r?90:0;return n.jsxs(n.Fragment,{children:[n.jsx(ie,{name:a.localisedName,groups:a.transfer.groups,nameDirection:r,services:s}),n.jsx("use",{xlinkHref:`#${c}`,stroke:o.length>0?"var(--rmg-black)":i??"var(--rmg-theme-colour)",transform:`rotate(${d})`}),a.services.length>1&&n.jsx("text",{className:"rmg-name__zh",writingMode:"tb",fontSize:"60%",dy:"-12",children:`大站车${a.services.length>2?" 直达车":""}停靠`})]})},ie=e=>{const{name:t,groups:s,nameDirection:l,services:i}=e,a={upward:60,downward:-30,left:0,right:0}[l],o=s[2]?.lines?.length?{upward:0,downward:0,left:(s[0].lines?.length||0)+(s[1]?.lines?.length||0)!==0?85:25,right:(s[0].lines?.length||0)+(s[1]?.lines?.length||0)!==0?-85:-25}[l]:0,c=s[2]?.lines?.length?{upward:s[0]?.lines?.length&&s[1]?.lines?.length?-210:s[0]?.lines?.length||s[1]?.lines?.length?-177.5:-145,downward:(s[0]?.lines?.length&&s[1]?.lines?.length?185:s[0].lines?.length||s[1]?.lines?.length?157.5:125)+(3===i.length?40:0),left:s[0]?.lines?.length&&s[1]?.lines?.length?-67:s[0].lines?.length||s[1]?.lines?.length?-30:0,right:s[0]?.lines?.length&&s[1]?.lines?.length?-67:s[0].lines?.length||s[1]?.lines?.length?-30:0}[l]:0,d=r.useRef(null),[h,m]=r.useState(60);return r.useEffect((()=>{d?.current&&m(Math.max(60,d.current.getBBox().width))}),[t.zh,t.en]),n.jsxs("g",{transform:`translate(0,${a})`,children:["upward"===l||"downward"===l?n.jsxs(n.Fragment,{children:[n.jsx("line",{x1:-h/2,x2:h/2,y1:"upward"===l?-23:-10,y2:"upward"===l?-23:-10,stroke:"black"}),n.jsx("line",{y1:"upward"===l?-23:-10,y2:"upward"===l?-48:20,stroke:"black"})]}):n.jsxs(n.Fragment,{children:[n.jsx("line",{x1:"left"===l?-50:15,x2:"left"===l?-15:50,y1:0,y2:0,stroke:"black"}),n.jsx("line",{x1:"left"===l?-50:50,x2:"left"===l?-50:50,y1:-30,y2:30,stroke:"black"})]}),[...s[0].lines||[],...s[1]?.lines||[]].length&&n.jsx(oe,{intInfos:[s[0].lines||[],s[1]?.lines||[]],arrowDirection:l,services:i}),n.jsx(ae,{ref:d,stnName:t,nameDirection:l,fill:"black"}),s[2]?.lines?.length&&n.jsx("g",{transform:`translate(${o},${c})`,children:n.jsx(ce,{osysiInfos:s[2].lines,nameDirection:l})})]})},ae=r.forwardRef((function(e,t){const{stnName:s,nameDirection:l,...i}=e,{zh:a="",en:o=""}=s,c=a.split("\\"),d=o.split("\\").length,h={upward:0,downward:0,left:-60,right:60}[l],m={upward:-2,downward:-30-12*(d-1),left:-10*(d-1),right:-10*(d-1)}[l],g={upward:"middle",downward:"middle",left:"end",right:"start"}[l];return n.jsx("g",{ref:t,...i,textAnchor:g,transform:`translate(${h},${m})`,children:r.useMemo((()=>n.jsxs(n.Fragment,{children:[c.map(((e,t,r)=>n.jsx("text",{className:"rmg-name__zh",dy:"upward"===l?16*t:-16*(r.length-1-t),children:e},t))),n.jsx("g",{fontSize:9.6,children:o.split("\\")?.map(((e,t)=>n.jsx("text",{className:"rmg-name__en",dy:12*(t+1)+("upward"===l&&c.length>1?7.5*c.length:0),children:e},t)))})]})),[a,o])})})),oe=e=>{const{intInfos:t,arrowDirection:s,services:l}=e,i=t.flatMap((e=>e.map((e=>e.theme?.[2])))).reduce(((e,t)=>e+t),""),a=t.map((e=>[e.filter((e=>e.name[0].match(/^\d+.*$/))).map((e=>e.name[0].replace(/^(\d+)(.*)$/,"$1"))).join("，").concat("号线"),e.filter((e=>!e.name[0].match(/^\d+.*$/))).map((e=>e.name[0])).join("，")].filter((e=>e&&"号线"!==e)).join("，"))),o=t.map((e=>["Line ".concat(e.filter((e=>/^(L|l)ine \d+$/.test(e.name[1]))).map((e=>e.name[1].replace("Line","").replace("line","").trim())).join(",")),e.filter((e=>!/^(L|l)ine \d+$/.test(e.name[1]))).map((e=>e.name[1])).join(", ")].filter((e=>e&&"Line "!==e)).join(", "))),c=3===l.length?80:45,d={upward:-145,downward:125+(3===l.length?40:0),left:7,right:7}[s],h={upward:0,downward:0,left:20,right:-20}[s],m={upward:-74,downward:44,left:0,right:0}[s],g={upward:0,downward:180,left:90,right:-90}[s],x={upward:0,downward:0,left:85,right:-85}[s],f={upward:"middle",downward:"middle",left:"start",right:"end"}[s],u=x,p={upward:t.at(0)?.length?-177.5:-145,downward:(t.at(0)?.length?157.5:125)+(3===l.length?40:0),left:t.at(0)?.length?-30:7,right:t.at(0)?.length?-30:7}[s];return n.jsxs("g",{children:[n.jsx("path",{id:"int_indoor_arrow_sh",stroke:"var(--rmg-black)",strokeWidth:1,transform:`translate(${h},${m})rotate(${g})`,fill:1===t.flat().length?t.flat()[0].theme?.[2]:`url(#grad${i})`,d:`M -7.5,0 v -${c} h -7.5 l 15,-15 l 15,15 h -7.5 v ${c} Z`}),t.flat().length>1&&n.jsx("linearGradient",{id:`grad${i}`,y1:"0",y2:"0",x1:"upward"===s?"25%":"75%",x2:"upward"===s?"75%":"25%",children:t.flat().map(((e,s)=>n.jsxs(r.Fragment,{children:[n.jsx("stop",{offset:100/t.flat().length*s+"%",stopColor:e.theme?.[2]}),n.jsx("stop",{offset:100/t.flat().length*(s+1)+"%",stopColor:e.theme?.[2]})]},s)))}),(t.at(0)?.length??0)>0&&n.jsxs("g",{transform:`translate(${x},${d})`,textAnchor:`${f}`,children:[n.jsx("text",{className:"rmg-name__zh",dy:-7,children:`换乘${a[0]}`}),n.jsx("text",{className:"rmg-name__en",dy:5,fontSize:9.6,children:`Interchange ${o[0]}`})]}),(t.at(1)?.length??0)>0&&n.jsxs("g",{transform:`translate(${u},${p})`,textAnchor:`${f}`,children:[n.jsx("text",{className:"rmg-name__zh",dy:-7,children:`出站换乘${a[1]}`}),n.jsx("text",{className:"rmg-name__en",dy:5,fontSize:9.6,children:`Out-of-station Transfer ${o[1]}`})]})]})},ce=e=>{const t={upward:"middle",downward:"middle",left:"start",right:"end"}[e.nameDirection];return r.useMemo((()=>n.jsxs("g",{textAnchor:`${t}`,children:[n.jsx("text",{className:"rmg-name__zh",dy:-5,children:`转乘${e.osysiInfos.map((e=>e.name[0])).join("，")}`}),n.jsx("text",{className:"rmg-name__en",dy:7.5,fontSize:9.6,children:`To ${e.osysiInfos.map((e=>e.name[1])).join(", ")}`})]})),[JSON.stringify(e.osysiInfos),e.nameDirection])},de=e=>{const{loop_branches:t,edges:r,xs:o,ys:c,canvas:d}=e,[h,m,g,x]=r,{branches:f}=l((e=>e.helper)),{current_stn_idx:u,direction:p,coline:j}=l((e=>e.param)),_=d===i.RailMap?30:0,v=[`M ${h},${g} H ${Number(o[t.at(0)?.at(0)??""])-_}`,`M ${m},${g} H ${Number(o[t.at(1)?.at(-1)??""])+_}`],$=f[0].filter((e=>!["linestart","lineend"].includes(e))),y=Object.values(j).filter((e=>![e.from,e.to].every((e=>$.includes(e))))).map((e=>e.colors));return n.jsx(n.Fragment,{children:t.map(((e,r)=>n.jsxs(s.Fragment,{children:[y.filter(((e,t,n)=>t===n.findIndex((t=>t.at(0)?.at(2)===e.at(0)?.at(2))))).map((e=>n.jsx("marker",{id:`arrow_theme_${e[0][2]}`,refX:1,refY:.5,children:n.jsx("path",{d:"M0,1H2L1,0z",fill:e[0][2]})},e[0][2]))),n.jsx("path",{stroke:y.at(r)?.at(0)?.at(2)??"var(--rmg-theme-colour)",strokeWidth:12,fill:"none",d:v[r],markerEnd:d===i.RailMap&&("l"===p&&0===r||"r"===p&&1===r)?y.at(r)?`url(#arrow_theme_${y[r][0][2]})`:"url(#arrow_theme)":void 0}),e.filter((e=>!["linestart","lineend"].includes(e))).map((e=>n.jsxs(s.Fragment,{children:[d===i.RailMap&&n.jsx("g",{transform:`translate(${o[e]},${c[e]})`,children:n.jsx(E,{stnId:e,stnState:u===e?0:1,bank:0,direction:p,color:y.at(r)?.at(0)?.at(2)})},e),d===i.Indoor&&n.jsx("g",{transform:`translate(${o[e]},${c[e]})`,children:n.jsx(le,{stnId:e,nameDirection:t.filter((t=>t.includes(e))).map((t=>t.indexOf(e)%2==0?"downward":"upward"))[0],services:[a.local],color:y.at(r)?.at(0)?.at(2)})},e)]},e)))]},e.at(0))))})},he=e=>{const{edges:t,loop_stns:r,xs:s,ys:a,canvas:c}=e,[d,h,m,g]=t,{info_panel_type:x,stn_list:f,coline:u}=l((e=>e.param)),{branches:p}=l((e=>e.helper)),j=Object.values(u).filter((e=>[e.from,e.to].every((e=>p.slice(1,3).filter((e=>o(e,f))).flat().includes(e))))).map((e=>e.colors)).at(0),_=c===i.RailMap&&"sh2020"===x?3:0;return n.jsxs("g",{id:"coline_main",children:[n.jsx("path",{d:`M ${d},${m} H${h}`,strokeWidth:12,stroke:j?.at(0)?.at(2)}),c===i.RailMap&&Object.keys(u).length>0&&r.top.map((e=>n.jsx("g",{transform:`translate(${s[e]},${a[e]})`,children:"sh2020"===x?n.jsxs(n.Fragment,{children:[n.jsx("rect",{stroke:"none",height:24,width:12,x:-6,y:-_-1,fill:j?.at(0)?.at(2)}),n.jsx("rect",{stroke:"none",height:_+12,width:12,x:-6,y:10,fill:"var(--rmg-theme-colour)"})]}):n.jsx("use",{xlinkHref:"#int2_sh",stroke:"var(--rmg-theme-colour)",transform:"translate(0,13)"})},e)))]})},me=e=>{const{bank_angle:r,canvas:s}=e,{branches:a}=l((e=>e.helper)),{current_stn_idx:c,svgWidth:d,svg_height:h,padding:m,branchSpacingPct:g,direction:x,info_panel_type:f,stn_list:u,loop_info:{left_and_right_factor:p,bottom_factor:j},coline:_}=l((e=>e.param)),v=a[0].filter((e=>!["linestart","lineend"].includes(e))),$=a.slice(0,3).flat().filter((e=>t=>2===(e[t]=(e[t]||0)+1))({})).filter((e=>!["linestart","lineend"].includes(e))),y=Object.values(_).filter((e=>[e.from,e.to].every((e=>a.slice(1,3).filter((e=>o(e,u))).flat().includes(e))))).map((e=>{const t=v.findIndex((t=>t===e.from)),n=v.findIndex((t=>t===e.to));return Math.abs(n-t)>v.length-2-Math.abs(n-t)?"major":"minor"})).at(0)??"minor",k=$.at(1)?((e,n,r,s)=>{let l=e.findIndex((e=>e===n[0])),i=e.findIndex((e=>e===n[1]));[l,i,n[0],n[1]]=l>i?[i,l,n[1],n[0]]:[l,i,n[0],n[1]];const a=e.slice(l,i+1),o=e.filter((e=>!a.filter((e=>!n.includes(e))).includes(e))),c=e.length-("major"===s?Math.max:Math.min)(a.length,o.length)-2*r,d="major"===s?a.length>o.length?n[0]:n[1]:a.length>o.length?n[1]:n[0];return t(e,d,c,r)})(v,$,p,y):$.at(0)?t(v,$[0],j,p):((e,t,n,r)=>{const s=e.length-2*r-n,l=e.findIndex((e=>e===t)),i=[...e,...e,...e],a=e.length+l-Math.floor(s/2)+(s%2==0?1:0),o=e.length+l+Math.floor(s/2);return{top:i.slice(a,o+1),left:i.slice(a-r,a),right:i.slice(o+1,o+1+r),bottom:i.slice(o+1+r,o+1+r+n)}})(v,c,j,p),{x_shares:w,y_shares:b}=((e,t)=>{const n=Object.fromEntries(e.map((e=>[e,-1]))),r=Object.fromEntries(e.map((e=>[e,-1]))),[s,l,i,a]=[0,1,0,1];return t.top.forEach(((e,l)=>{n[e]=0+1/(t.top.length+1)*(l+1),r[e]=s})),t.right.forEach(((e,s)=>{n[e]=a,r[e]=0+1/(t.right.length+1)*(s+1)})),t.bottom.forEach(((e,s)=>{n[e]=1-1/(t.bottom.length+1)*(s+1),r[e]=l})),t.left.forEach(((e,s)=>{n[e]=i,r[e]=1-1/(t.left.length+1)*(s+1)})),{x_shares:n,y_shares:r}})(v,k),{loop_branches:S,line_xs_branches:M,xs_branches:z}=((e,t,n,r,s,l)=>{const i=e[0].filter((e=>!["linestart","lineend"].includes(e))),a=e.slice(1,3).map((e=>e.slice(1,e.length-1))),o=a.reduce(((e,n)=>e+n.filter((e=>!["linestart","lineend",...t].includes(e))).length),0)+i.length-l-2*s,c=(n-n*r/100*2)/(1+o),d=[n*r/100+(a.at(0)??[]).length*c,n*(1-r/100)-(a.at(1)??[]).length*c],h={...Object.fromEntries((a.at(0)??[]).map(((e,t)=>[e,n*r/100+t*c]))),...Object.fromEntries((a.at(1)??[]).map(((e,t)=>[e,d[1]+(1+t)*c])))};return{loop_branches:a,line_xs_branches:d,xs_branches:h}})(a,$,d[s],m,p,k.bottom.length),N={...b,...Object.fromEntries(S.flat().map((e=>[e,0])))},O=g*h/300,I=[225+O,h-75-(s===i.RailMap?0:125)-O],H=Object.keys(N).reduce(((e,t)=>({...e,[t]:I[0]+N[t]*(I[1]-I[0])})),{}),W=[Math.max(d[s]*m/100+(r&&s===i.RailMap?100:0),M[0]),Math.min(d[s]*(1-m/100)-(r&&s===i.RailMap?100:0),M[1])],L=Object.keys(w).reduce(((e,t)=>({...e,[t]:W[0]+w[t]*(W[1]-W[0])})),{}),F=r?{l:1,r:-1}[x]:0;[...k.right,...k.left].forEach((e=>{L[e]-=(H[e]-I[0])*F})),k.bottom.forEach((e=>{L[e]-=(I[1]-I[0])*F}));const B={...z,...L},P=ge(k,B,H,F,[...W,...I],x),E=s===i.RailMap&&"sh2020"===f?3:0;Object.keys(_).length>0&&k.top.forEach((e=>{H[e]-=E+12}));const R=S.length?0:(I[1]-I[0])*F/2;return n.jsxs("g",{id:"loop",transform:`translate(${R},0)`,children:[n.jsx("path",{stroke:"var(--rmg-theme-colour)",strokeWidth:12,fill:"none",d:P,strokeLinejoin:"round"}),s===i.RailMap&&n.jsx(xe,{canvas:s,loop_stns:k,xs:B,ys:H}),n.jsxs("g",{transform:`translate(0,${Object.keys(_).length>0?-12-E:0})`,children:[n.jsx(de,{loop_branches:S,edges:[...W,...I],xs:B,ys:H,canvas:s}),Object.keys(_).length>0&&n.jsx(he,{edges:[...W,...I],loop_stns:k,xs:B,ys:H,canvas:s})]}),s===i.Indoor&&n.jsx(xe,{canvas:s,loop_stns:k,xs:B,ys:H})]})},ge=(e,t,n,r,s,l)=>{const[i,a,o,c]=s,d=(e,t,n,s,l)=>({right:[n+(s-o)*r,t],bottom:[e-(c-t)*r,s],left:[n-(c-s)*r,t],top:[e+(t-o)*r,s]}[l]),h=[];e.top.forEach((e=>{h.push([t[e],n[e]])})),["right","bottom","left"].forEach((s=>{if(e[s].length>0)h.push(d(h.at(-1)[0],h.at(-1)[1],t[e[s][0]],n[e[s][0]],s)),e[s].forEach((e=>{h.push([t[e],n[e]])}));else{const e={right:[a,h.at(-1)[1]],bottom:[h.at(-1)[0]+(c-h.at(-1)[1])*-r,h.at(-1)[1]+(c-h.at(-1)[1])],left:[i+(0===r?0:(c-o)*("l"===l?-1:1)),h.at(-1)[1]]};h.push(e[s])}})),h.push(d(h.at(-1)[0],h.at(-1)[1],t[e.top[0]],n[e.top[0]],"top"));const m=h.slice(1).map((([e,t])=>`L${e},${t} `)).join(" ");return`M${h[0][0]},${h[0][1]} ${m} Z`},xe=e=>{const{canvas:t,loop_stns:r,xs:s,ys:o}=e,{current_stn_idx:c}=l((e=>e.param)),d={top:0,bottom:0,left:-1,right:1},h={left:"r",right:"l",top:void 0,bottom:void 0},m=(e,t)=>({top:t%2==0?"upward":"downward",bottom:t%2==0?"upward":"downward",left:"left",right:"right"}[e]);return n.jsxs("g",{id:"loop_stations",children:[t===i.RailMap&&Object.entries(r).map((([e,t])=>t.map((t=>n.jsx("g",{transform:`translate(${s[t]},${o[t]})`,children:n.jsx(E,{stnId:t,stnState:c===t?0:1,bank:d[e],direction:h[e]})},t))))),t===i.Indoor&&Object.entries(r).map((([e,t])=>t.map(((t,r)=>n.jsx("g",{transform:`translate(${s[t]},${o[t]})`,children:n.jsx(le,{stnId:t,nameDirection:m(e,r),services:[a.local]})},t)))))]})},fe=i.RailMap;function ue(){const{canvasScale:e}=l((e=>e.app)),{svgWidth:t,svg_height:r,theme:s,loop:a,loop_info:{bank:o}}=l((e=>e.param)),d=t[fe];return n.jsxs(c,{type:fe,svgWidth:d,svgHeight:r,canvasScale:e,theme:s,children:[n.jsx(pe,{}),a?n.jsx(me,{bank_angle:o,canvas:i.RailMap}):n.jsx(Q,{}),n.jsx(se,{})]})}const pe=r.memo((function(){return n.jsxs("defs",{children:[n.jsx("circle",{id:"stn_sh",fill:"var(--rmg-white)",strokeWidth:2,r:5}),n.jsx("path",{id:"int2_sh",fill:"var(--rmg-white)",strokeWidth:2,d:"M -5,0 a 5,5 0 1 1 10,0 V10 a 5,5 0 1 1 -10,0Z"}),n.jsx("path",{id:"express_sh",fill:"var(--rmg-white)",strokeWidth:2,d:"M -5,0 a 5,5 0 1 1 10,0 V25 a 5,5 0 1 1 -10,0Z"}),n.jsx("path",{id:"direct_sh",fill:"var(--rmg-white)",strokeWidth:2,d:"M -5,0 a 5,5 0 1 1 10,0 V50 a 5,5 0 1 1 -10,0Z"}),n.jsx("rect",{id:"stn_sh_2020",stroke:"none",height:24,width:12,x:-6,y:-18}),n.jsx("rect",{id:"stn_sh_2020_express",stroke:"none",height:49,width:12,x:-6,y:-18}),n.jsx("rect",{id:"stn_sh_2020_direct",stroke:"none",height:74,width:12,x:-6,y:-18}),n.jsx("rect",{id:"intbox_number",height:22,width:20,y:-11}),n.jsxs("g",{id:"intbox_maglev",transform:"translate(-25,0)",children:[n.jsx("rect",{id:"maglev_5",height:144,width:130,y:"40",x:"30",strokeWidth:10}),n.jsx("path",{id:"maglev_3",fill:"var(--rmg-white)",d:"m90,55a40,5 0 0 0 -40,3a5,5 0 0 0 -5,5a5,60 0 0 0 -3,60a5,5 0 0 0 5,5l96,0a5,5 0 0 0 5,-5a5,60 0 0 0 -3,-60a5,5 0 0 0 -5,-5a40,5 0 0 0 -40,-3l-5,-10l-5,10"}),n.jsx("path",{id:"maglev_4",fill:"var(--rmg-white)",d:"m90,140l-40,0a10,5 0 0 1 -10,-5l0,25a10,15 0 0 0 10,15l15,0l0,-10l-15,0l0,-15l90,0l0,15l-15,0l0,10l15,0a10,15 0 0 0 10,-15l0,-25a10,5 0 0 1 -10,5l-50,0"}),n.jsx("rect",{id:"maglev_1",height:"25",width:"40",y:"80",x:"50"}),n.jsx("rect",{id:"maglev_2",height:"25",width:"40",y:"80",x:"100"})]}),n.jsxs("g",{id:"airport",transform:"scale(0.5)",children:[n.jsx("circle",{cx:"0",cy:"29.33899",r:"29.33899",fill:"var(--rmg-grey)"}),n.jsx("path",{id:"airport",d:"M28.9769,6.60134c1.711.013,3.111,2.53205,3.111,4.241v10.337s17.106,15.435,17.358,15.666a1.145,1.145,0,0,1,.488,1.152v2.833c0,.651-.451.61-.695.467-.334-.119-17.151-8.863-17.151-8.863-.004,1.458-.797,9.006-1.326,13.304,0,0,4.61,2.457,4.699,2.521.334.268.352.359.352.852v2.001c0,.477-.352.428-.51.324-.183-.062-5.693-1.921-5.693-1.921a2.56018,2.56018,0,0,0-.633-.127,2.31654,2.31654,0,0,0-.666.127s-5.477,1.859-5.672,1.921c-.185.104-.523.153-.523-.324v-2.001c0-.493.029-.584.367-.852.086-.064,4.678-2.521,4.678-2.521-.524-4.298-1.307-11.846-1.325-13.304,0,0-16.822,8.744-17.148,8.863-.217.143-.69.184-.69-.467v-2.833a1.16206,1.16206,0,0,1,.473-1.152c.276-.231,17.365-15.666,17.365-15.666v-10.337c0-1.709,1.403-4.228,3.14105-4.241",transform:"translate(-28.9697,0.14347)",fill:"var(--rmg-white)"})]}),n.jsxs("g",{id:"disney",transform:"scale(0.5)",children:[n.jsx("circle",{cx:"0",cy:"29.33899",r:"29.33899",fill:"var(--rmg-grey)"}),n.jsx("path",{fill:"var(--rmg-white)",d:"M45.6152,7.85015a9.80248,9.80248,0,0,0-9.79907,9.801,9.70059,9.70059,0,0,0,.342,2.582c.002.026.002.055.002.093a.31815.31815,0,0,1-.31494.318.67741.67741,0,0,1-.12806-.02,15.71521,15.71521,0,0,0-13.498,0,.61.61,0,0,1-.122.02.31841.31841,0,0,1-.322-.318v-.067a9.62553,9.62553,0,0,0,.35608-2.608,9.803,9.803,0,1,0-9.797,9.8,10.10364,10.10364,0,0,0,2.308-.271h.05493a.31113.31113,0,0,1,.31409.318.32433.32433,0,0,1-.019.12,15.72588,15.72588,0,1,0,29.703,7.216,15.83676,15.83676,0,0,0-1.746-7.23.18417.18417,0,0,1-.0271-.106.31612.31612,0,0,1,.32007-.318h.057a10.15953,10.15953,0,0,0,2.316.271,9.80051,9.80051,0,0,0,0-19.601",transform:"translate(-28.9697 0.13398)"})]}),n.jsxs("g",{id:"railway",children:[n.jsx("circle",{cx:"0",cy:"29.33899",r:"29.33899",fill:"var(--rmg-grey)",transform:"translate(0,-2)scale(0.5)"}),n.jsx("path",{fill:"var(--rmg-white)",d:"M169,273.5c0-19,14.7-34.8,33.7-36.3c18.9-1.5,38.1-2.2,57.4-2.2c19.3,0,38.4,0.8,57.3,2.2  c19,1.5,33.7,17.3,33.7,36.3v47.3l-51.3,14.7c-11.2,3.2-18.9,13.4-18.9,25v147.8c0,17.4,12.2,32.3,29.3,35.7l110.6,22.1  c4.9,1,8.4,5.2,8.4,10.2V599H91v-22.7c0-5,3.5-9.2,8.4-10.2L209.9,544c17-3.4,29.3-18.3,29.3-35.7V360.5c0-11.6-7.7-21.8-18.9-25  L169,320.8V273.5z M309.4,31.7c0.2-1.2,0.3-2.4,0.3-3.6c0-14-11.1-25.4-24.9-26C276.6,1.4,268.3,1,260,1c-8.3,0-16.6,0.4-24.7,1.1  c-13.9,0.6-24.9,12-24.9,26c0,1.2,0.1,2.5,0.3,3.6C90.6,54.8,0,160.3,0,287c0,97.2,53.4,182,132.4,226.6l36.8-48.1  C104.3,432.4,59.8,364.9,59.8,287c0-110.6,89.6-200.2,200.2-200.2S460.2,176.4,460.2,287c0,77.9-44.5,145.4-109.4,178.5  c15,19.6,25.6,33.5,36.8,48.1C466.6,469,520,384.2,520,287C520,160.3,429.4,54.8,309.4,31.7z",transform:"translate(-10,0)scale(0.04)"})]}),n.jsx("marker",{id:"arrow_gray",viewBox:"-1.5 0 3 1.5",refY:.5,children:n.jsx("path",{d:"M0,0L1,1H-1z",fill:"var(--rmg-grey)"})}),n.jsx("marker",{id:"arrow_theme_left",refX:1,refY:.5,children:n.jsx("path",{d:"M1,0L0,1H1z",fill:"var(--rmg-theme-colour)"})}),n.jsx("marker",{id:"arrow_theme_right",refY:.5,children:n.jsx("path",{d:"M0,0L1,1H-1z",fill:"var(--rmg-theme-colour)"})}),n.jsx("marker",{id:"arrow_theme",refX:1,refY:.5,children:n.jsx("path",{d:"M0,1H2L1,0z",fill:"var(--rmg-theme-colour)"})}),n.jsx("filter",{id:"contrast-direct",filterUnits:"userSpaceOnUse",children:n.jsxs("feComponentTransfer",{children:[n.jsx("feFuncR",{type:"linear",slope:.5,intercept:.25}),n.jsx("feFuncG",{type:"linear",slope:.5,intercept:.25}),n.jsx("feFuncB",{type:"linear",slope:.5,intercept:.25})]})}),n.jsx("filter",{id:"contrast-express",filterUnits:"userSpaceOnUse",children:n.jsxs("feComponentTransfer",{children:[n.jsx("feFuncR",{type:"linear",slope:.75,intercept:.125}),n.jsx("feFuncG",{type:"linear",slope:.75,intercept:.125}),n.jsx("feFuncB",{type:"linear",slope:.75,intercept:.125})]})}),n.jsx(S,{})]})})),je=i.Indoor;function _e(){const{canvasScale:e}=l((e=>e.app)),{svgWidth:t,svg_height:r,theme:s,loop:a}=l((e=>e.param)),o=t[je];return n.jsxs(c,{type:je,svgWidth:o,svgHeight:r,canvasScale:e,theme:s,children:[n.jsx(ve,{}),a?n.jsx(me,{bank_angle:!1,canvas:i.Indoor}):n.jsx(ke,{}),n.jsx(Se,{})]})}const ve=r.memo((function(){return n.jsxs("defs",{children:[n.jsx("circle",{id:"stn_indoor_sh",fill:"var(--rmg-white)",strokeWidth:5,r:8,transform:"scale(1.5)"}),n.jsx("path",{id:"int2_indoor_sh",fill:"var(--rmg-white)",transform:"translate(0, -10)scale(2)",strokeWidth:4,d:"M -5,0 a 5,5 0 1 1 10,0 V10 a 5,5 0 1 1 -10,0Z"}),n.jsx("path",{id:"express_indoor_sh",fill:"var(--rmg-white)",transform:"translate(0, -10)scale(2)",strokeWidth:4,d:"M -5,0 a 5,5 0 1 1 10,0 V25 a 5,5 0 1 1 -10,0Z"}),n.jsx("path",{id:"direct_indoor_sh",fill:"var(--rmg-white)",transform:"translate(0, -10)scale(2)",strokeWidth:4,d:"M -5,0 a 5,5 0 1 1 10,0 V40 a 5,5 0 1 1 -10,0Z"}),n.jsxs("g",{id:"osi_indoor_sh",children:[n.jsx("line",{x1:"0",x2:"0",y1:"-12",y2:"12",stroke:"var(--rmg-black)",strokeWidth:22}),n.jsx("line",{x1:"0",x2:"0",y1:"-12",y2:"12",stroke:"var(--rmg-white)",strokeWidth:10}),n.jsx("circle",{cy:"-12",fill:"var(--rmg-white)",strokeWidth:5,r:8,transform:"scale(1.5)"}),n.jsx("circle",{cy:"12",fill:"var(--rmg-white)",strokeWidth:5,r:8,transform:"scale(1.5)"})]})]})})),$e=(e,t)=>{let n=0;return 2===e[t].parents.length&&(n+=1),2===e[e[t].parents[0]].children.length&&(n+=1),n},ye=(e,t)=>{let n=0;return 2===e[t].children.length&&(n+=1),2===e[e[t].children[0]].parents.length&&(n+=1),n},ke=()=>{const{routes:e,branches:t,depsStr:s}=l((e=>e.helper)),i=l((e=>e.param)),o=h(i.stn_list,$e,ye),c=m("linestart","lineend",o),d=m(c.nodes[1],c.nodes.slice(-2)[0],o),u=r.useMemo((()=>(console.log("computing x shares"),Object.keys(i.stn_list).reduce(((e,n)=>({...e,[n]:g(n,o,t)})),{}))),[t.toString(),JSON.stringify(o)]),p=[i.svgWidth.indoor*i.padding/100,i.svgWidth.indoor*(1-i.padding/100)],j=Object.keys(u).reduce(((e,t)=>({...e,[t]:p[0]+u[t]/d.len*(p[1]-p[0])})),{}),_=r.useMemo((()=>f.getYShares(i.stn_list)),[s]),v=Object.keys(_).reduce(((e,t)=>({...e,[t]:_[t]*i.branchSpacingPct*i.svg_height/200})),{}),$=r.useMemo((()=>x(i.current_stn_idx,e,i.direction)),[i.current_stn_idx,i.direction,e.toString()]),y=Object.values(a),k=Object.values(i.stn_list).map((e=>e.services)).flat().reduce(((e,t)=>(e[y.indexOf(t)]=!0,e)),[!1,!1,!1]).map(((e,t)=>[y[t],e])).filter((e=>e[1])).map((e=>e[0])),w=f.drawLine(t,$,i.stn_list,p,j,v,i.branchSpacingPct*i.svg_height/200,c,0);return n.jsxs("g",{id:"main",transform:`translate(0,${i.svg_height/2})`,children:[n.jsx(we,{paths:w,services:k}),n.jsx(be,{xs:j,ys:v,services:k})]})},we=e=>n.jsx("g",{fill:"none",strokeWidth:12,stroke:"var(--rmg-theme-colour)",children:e.services.map(((t,r)=>n.jsxs("g",{transform:`translate(0, ${30*r})`,children:[e.paths.main.map(((e,t)=>n.jsx("path",{d:e},t))),e.paths.pass.map(((e,t)=>n.jsx("path",{d:e},t)))]},`indoor_line_${r}`)))}),be=e=>{const{branches:t}=l((e=>e.helper)),{stn_list:r,namePosMTR:{isFlip:s}}=l((e=>e.param)),{xs:i,ys:a,services:o}=e,c=s??1?"upward":"downward",d="upward"===c?"downward":"upward";return n.jsx("g",{children:Object.keys(r).filter((e=>!["linestart","lineend"].includes(e))).filter((e=>0!==r[e].services.length)).map((e=>n.jsx("g",{transform:`translate(${i[e]},${a[e]})`,children:n.jsx(le,{stnId:e,nameDirection:o.length>1?"downward":t.filter((t=>t.includes(e))).map((t=>t.indexOf(e)%2==0?c:d))[0],services:o})},e)))})},Se=r.memo((()=>{const{svg_height:e,svgWidth:{indoor:t},line_name:r,stn_list:s}=l((e=>e.param)),i=Math.max(...Object.values(s).map((e=>e.transfer.groups.at(1)?.lines?.length??0))),a=i>0?210:110;return n.jsxs(n.Fragment,{children:[n.jsx("g",{transform:`translate(${t/2},50)`,children:n.jsxs("text",{textAnchor:"middle",fontSize:"30",className:"rmg-name__zh",children:["轨道交通",r[0],"运营线路示意图"]})}),n.jsxs("g",{transform:`translate(${t/2},${e-270})`,children:[n.jsx("text",{textAnchor:"middle",fontSize:"18",className:"rmg-name__zh",dx:"-30",dy:"230",children:"友情提示：请留意您需要换乘线路的首末班时间，以免耽误您的出行，末班车进站前三分钟停售该末班车车票。"}),n.jsx("text",{textAnchor:"middle",fontSize:"12",className:"rmg-name__en",dx:"10",dy:"250",children:"Please pay attention to the interchange schedule if you want to transfer to other lines. Stop selling tickets 3 minutes before the last train services."}),n.jsxs("g",{transform:"translate(-700,215)",children:[n.jsx("rect",{x:"-5",y:"-25",width:a,height:"70",fill:"none",stroke:"black",rx:"5"}),n.jsx("line",{x1:"28",x2:"28",y1:"-20",y2:"40",stroke:"black"}),n.jsx("text",{className:"rmg-name__zh",dx:"3",fontSize:"18",children:"图"}),n.jsx("text",{className:"rmg-name__zh",dx:"3",dy:"18",fontSize:"18",children:"例"}),n.jsx("text",{className:"rmg-name__en",dy:"35",fontSize:"8",children:"legend"}),n.jsx("use",{transform:"translate(50,10)",xlinkHref:"#int2_indoor_sh",stroke:"var(--rmg-black)"}),n.jsx("text",{className:"rmg-name__zh",dx:"70",dy:"5",fontSize:"10",children:"换乘站"}),n.jsx("text",{className:"rmg-name__en",dx:"70",dy:"15",fontSize:"6",children:"Interchange"}),n.jsx("text",{className:"rmg-name__en",dx:"70",dy:"25",fontSize:"6",children:"Station"}),i>0&&n.jsxs(n.Fragment,{children:[n.jsx("use",{transform:"translate(120,10)scale(0.75)",xlinkHref:"#osi_indoor_sh",stroke:"var(--rmg-black)"}),n.jsx("text",{className:"rmg-name__zh",dx:"135",dy:"5",fontSize:"10",children:"出站换乘车站"}),n.jsx("text",{className:"rmg-name__en",dx:"135",dy:"15",fontSize:"6",children:"Out-of-station Transfer"}),n.jsx("text",{className:"rmg-name__en",dx:"135",dy:"25",fontSize:"6",children:"Station"})]})]})]})]})}));Se.displayName="InfoElements",e("default",{destination:n.jsx(p,{}),runin:n.jsx(z,{}),railmap:n.jsx(ue,{}),indoor:n.jsx(_e,{})})}}}));
