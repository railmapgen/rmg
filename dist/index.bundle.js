!function(t){function e(e){for(var i,r,l=e[0],h=e[1],o=e[2],d=0,_=[];d<l.length;d++)r=l[d],Object.prototype.hasOwnProperty.call(s,r)&&s[r]&&_.push(s[r][0]),s[r]=0;for(i in h)Object.prototype.hasOwnProperty.call(h,i)&&(t[i]=h[i]);for(c&&c(e);_.length;)_.shift()();return a.push.apply(a,o||[]),n()}function n(){for(var t,e=0;e<a.length;e++){for(var n=a[e],i=!0,l=1;l<n.length;l++){var h=n[l];0!==s[h]&&(i=!1)}i&&(a.splice(e--,1),t=r(r.s=n[0]))}return t}var i={},s={0:0},a=[];function r(e){if(i[e])return i[e].exports;var n=i[e]={i:e,l:!1,exports:{}};return t[e].call(n.exports,n,n.exports,r),n.l=!0,n.exports}r.m=t,r.c=i,r.d=function(t,e,n){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)r.d(n,i,function(e){return t[e]}.bind(null,i));return n},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="";var l=window.webpackJsonp=window.webpackJsonp||[],h=l.push.bind(l);l.push=e,l=l.slice();for(var o=0;o<l.length;o++)e(l[o]);var c=h;a.push([14,2]),n()}([,function(t,e){t.exports=mdc.textField},function(t,e){t.exports=mdc.dialog},function(t,e){t.exports=jQuery},function(t,e){t.exports=mdc.select},,function(t,e){t.exports=mdc.list},,function(t,e){t.exports=mdc.tabBar},function(t,e){t.exports=mdc.slider},function(t,e){t.exports=mdc.switchControl},,,,function(t,e,n){"use strict";function i(t){localStorage.setItem("rmgParam",JSON.stringify(t))}function s(){return JSON.parse(localStorage.rmgParam)}function a(t,e){let n=s();n[t]=e,i(n)}function r(t){var[e,n]=t.attr("viewBox").split(" ").slice(2),i=$("canvas")[0];$("canvas").attr({width:2.5*e,height:2.5*n});var s=i.getContext("2d");s.clearRect(0,0,i.width,i.height),t.find(".rmg-name__en.rmg-name__gzmtr--station, .rmg-name__en.rmg-name__mtr--station").each((t,e)=>{$(e).attr("font-size","10px")}),t.find(".rmg-name__en.rmg-name__gzmtr--int").each((t,e)=>{$(e).attr("font-size","8px")}),t.find(".rmg-name__en.rmg-name__gzmtr--int-small").each((t,e)=>{$(e).attr("font-size","8px")}),t.find("text:not([font-size]), tspan:not([font-size])").each((t,e)=>{$(e).attr("font-size",window.getComputedStyle(e).fontSize)}),t.find("text, tspan").each((t,e)=>{var n=window.getComputedStyle(e);$(e).attr({"font-family":n.getPropertyValue("font-family"),fill:n.getPropertyValue("fill"),"alignment-baseline":n.getPropertyValue("alignment-baseline"),"text-anchor":n.getPropertyValue("text-anchor")}).removeAttr("class")}),t.find("#strip, #dest_strip").each((t,e)=>{var n=window.getComputedStyle(e);$(e).attr({"stroke-width":n.getPropertyValue("stroke-width")})});var a=new Image;a.onload=function(){var t,i,r;s.drawImage(a,0,0,2.5*e,2.5*n),t=$("canvas")[0].toDataURL("image/png"),i="rmg_export","string"==typeof(r=document.createElement("a")).download?(r.href=t,r.download=i,document.body.appendChild(r),r.click(),document.body.removeChild(r)):window.open(t)},a.src="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(t[0].outerHTML)))}function l(t,e){let n=$("#"+e)[0],i=t.getBoundingClientRect(),s=n.createSVGPoint(),a=n.getScreenCTM();s.x=i.left,s.y=i.top;let r=s.matrixTransform(a.inverse());return{x:r.x,y:r.y,width:i.width,height:i.height}}function h(t,e,n){var[i,s]=t.map(t=>t.split(/\\/g)),a=$("<text>").addClass("rmg-name__zh IntName").text(i[0]);for(let t=1;t<i.length;t++)a=a.append($("<tspan>",{x:0,dy:e}).text(i[t]));var r=1==i.length?9:n;a=a.append($("<tspan>",{x:0,dy:r,class:"rmg-name__en IntName"}).text(s[0]));for(let t=1;t<s.length;t++)a=a.append($("<tspan>",{x:0,dy:n,class:"rmg-name__en IntName"}).text(s[t]));return[a,i.length,s.length]}function o(){return Math.floor(Math.random()*Math.pow(36,4)).toString(36).padStart(4,"0")}function c(t){var e=t.toUpperCase().split("");return 2==t.length?e.map(t=>String.fromCodePoint(t.codePointAt(0)+127397)).join(""):"ðŸ´"+e.map(t=>String.fromCodePoint(t.codePointAt(0)+917536)).join("")+"ó ¿"}function d(t){let e=t.match(/[\d]+/g).map(t=>Number(t).toString(16).padStart(2,"0")).join("");switch(e){case"000000":return"#000";case"ffffff":return"#fff";default:return"#"+e}}function _(){var t=s();"line_name"in t||(t.line_name=["è·¯ç·šå","Name of Line"]),"dest_legacy"in t||(t.dest_legacy=!1),"char_form"in t||(t.char_form=(t=>{switch(t){case"KR":return"trad";case"TC":return"tw";case"SC":return"cn";case"JP":return"jp"}})(t.fontZH[0].split(" ").reverse()[0])),delete t.fontZH,delete t.fontEN,delete t.weightZH,delete t.weightEN;for(let[e,n]of Object.entries(t.stn_list)){if("transfer"in n)switch(delete t.stn_list[e].interchange,n.change_type){case"int2":t.stn_list[e].interchange=[[n.transfer[1]]];break;case"int3_l":case"int3_r":t.stn_list[e].interchange=[n.transfer.slice(1,3)];break;case"osi11_pl":case"osi11_pr":case"osi11_ul":case"osi11_ur":t.stn_list[e].interchange=[[],n.transfer.slice(0,2)];break;case"osi12_pl":case"osi12_pr":case"osi12_ul":case"osi12_ur":t.stn_list[e].interchange=[[],n.transfer]}delete t.stn_list[e].transfer,"branch"in n||(t.stn_list[e].branch={left:[],right:[]},2==n.children.length?t.stn_list[e].branch.right=["through",n.children[1]]:t.stn_list[e].branch.right=[],2==n.parents.length?t.stn_list[e].branch.left=["through",n.parents[1]]:t.stn_list[e].branch.left=[])}"psd_num"in t||(t.psd_num=1),"line_num"in t||(t.line_num=1),delete t.style,3==t.theme.length&&t.theme.push("#fff");for(let[e,n]of Object.entries(t.stn_list))["linestart","lineend"].includes(e)||"num"in n||(t.stn_list[e].num="00");for(let[e,n]of Object.entries(t.stn_list))"interchange"in n&&n.interchange.map(t=>{t.map(t=>{5==t.length&&t.splice(3,0,"#fff")})});"info_panel_type"in t||(t.info_panel_type="panasonic");for(let[e,n]of Object.entries(t.stn_list))"osi22_end_p"===n.change_type&&(t.stn_list[e].change_type="osi22_pr"),"osi22_end_u"===n.change_type&&(t.stn_list[e].change_type="osi22_ur");for(let[e,n]of Object.entries(t.stn_list))"interchange"in n||(t.stn_list[e].interchange=[[]]);"gz_1"===t.info_panel_type&&(t.info_panel_type="gz28"),"panasonic"===t.info_panel_type&&(t.info_panel_type="gz28"),"gz_2"===t.info_panel_type&&(t.info_panel_type="gzgf"),"gz_3"===t.info_panel_type&&(t.info_panel_type="gz3"),"direction_gz_x"in t||(t.direction_gz_x=50),"direction_gz_y"in t||(t.direction_gz_y=70),i(t)}n.r(e);const g=(t,e)=>t[(t=>{switch(t){case"en":return["en"];case"zh-Hans":return["zh-Hans","zh","en"];case"zh-HK":return["zh-HK","zh-Hant","zh","en"];default:return[t,"en"]}})(e).find(e=>t[e])];var m;!function(t){t[t.city=0]="city",t[t.line=1]="line",t[t.colour=2]="colour",t[t.fg=3]="fg",t[t.nameZH=4]="nameZH",t[t.nameEN=5]="nameEN"}(m||(m={}));class u{constructor(t,e){this.STN_NAME_Y=-10.5,this.STN_NAME_BASE_HEIGHT=30.390625,this.STN_NAME_LINE_GAP=14,this.STN_NAME_BG_ADJUST=.5,this.id=t,this.parents=e.parents,this.children=e.children,this.name=e.name,this.branch=e.branch}get inDegree(){return this.parents.length}get outDegree(){return this.children.length}get nameClass(){switch(this.state){case-1:return"Pass";case 0:return"Current";default:return"Future"}}get _nameTxtAnchor(){return"middle"}get _nameDX(){return 0}get _nameDY(){return 0}get nameHTML(){var t=this.name[1].split("\\");if(1==this.namePos)var e=this.STN_NAME_LINE_GAP-this.STN_NAME_Y-this.STN_NAME_BG_ADJUST;else e=-this.STN_NAME_LINE_GAP-this.STN_NAME_Y-this.STN_NAME_BASE_HEIGHT-10*(t.length-1);0===this.state&&$("#current_bg").attr({y:this.y+e+this.STN_NAME_Y-1.5+this._nameDY,height:this.STN_NAME_BASE_HEIGHT+10*(t.length-1)+2+1.5});for(var n=t.shift(),i=$("<text>",{dy:15,class:"rmg-name__en rmg-name__mtr--station"}).text(n);n=t.shift();)i.append($("<tspan>",{x:0,dy:10,"alignment-baseline":"middle"}).text(n));return $("<g>",{transform:`translate(${this.x+this._nameDX},${this.y+e+this._nameDY})`,"text-anchor":this._nameTxtAnchor,class:`Name ${this.nameClass}`}).append($("<text>").addClass("rmg-name__zh rmg-name__mtr--station").text(this.name[0])).append(i)}get iconClass(){return-1==this.state?"rmg-stn__mtr--pass":"rmg-stn__mtr--future"}get iconHTML(){return $("<use>",{"xlink:href":"#stn_hk",x:this.x,y:this.y,class:this.iconClass})}get ungrpHTML(){return[this.iconHTML,this.nameHTML]}get html(){return $("<g>",{id:this.id}).append(...this.ungrpHTML)}}class p extends u{constructor(t,e){super(t,e),this._intInfo=e.interchange[0][0]}get _dy(){return 0}get intTickHTML(){var t=1==this.namePos?180:0,e=this._intInfo[m.colour],n=$("<use>",{"xlink:href":"#inttick_hk",stroke:e,transform:`translate(${this.x},${this.y+this._dy})rotate(${t})`,class:"rmg-line rmg-line__mtr rmg-line__change"});return-1==this.state&&n.addClass("rmg-line__pass"),n}get _nameClass(){return-1==this.state?"Pass":"Future"}get intNameHTML(){var[t,e,n]=h([this._intInfo[m.nameZH],this._intInfo[m.nameEN]],15,7),i=0==this.namePos?30.953125:-37.703125-13*(e-1)-7*(n-1);return i+=this._dy,$("<g>",{"text-anchor":"middle",transform:`translate(${this.x},${this.y+i})`,class:`Name ${this._nameClass}`}).html(t[0])}get ungrpHTML(){return[this.intTickHTML,this.iconHTML,this.nameHTML,this.intNameHTML]}}class f extends u{constructor(t,e){super(t,e),this._intCity=[],this._intLine=[],this._intColour=[],this._intNameZH=[],this._intNameEN=[],this._intInfos=e.interchange[0],e.interchange[0].forEach(t=>{this._intCity.push(t[0]),this._intLine.push(t[1]),this._intColour.push(t[2]),this._intNameZH.push(t[4]),this._intNameEN.push(t[5])})}get iconHTML(){let t=1!=this.namePos?0:180;return $("<use>",{"xlink:href":"#int3_hk",transform:`translate(${this.x},${this.y})rotate(${t})`,class:this.iconClass})}get _tickRotation(){return 0}get _dy(){return 0}get _dx(){return 0}get _tickFlip(){return 1}get intTickHTML(){let t=[];return this._intInfos.map(t=>t[m.colour]).forEach((e,n)=>{if(n>=2)return;let i=-1===this.state?"#aaa":e,s=1!==this.namePos?18*(n+1):-18*(2-n);s+=this._dy,s*=this._tickFlip,t.push($("<use>",{"xlink:href":"#inttick_hk",stroke:i,transform:`translate(${this.x+this._dx},${this.y+s})rotate(${this._tickRotation})`,class:"rmg-line rmg-line__mtr rmg-line__change"}))}),t}get _txtAnchor(){return"middle"}get _intNameDX(){return 0}get _nameClass(){return-1==this.state?"Pass":"Future"}get intNameHTML(){let t=[],e=this._nameClass;return this._intInfos.map(t=>[t[m.nameZH],t[m.nameEN]]).forEach((n,i)=>{if(i>=2)return;let[s,a,r]=h(n,15,7);var l=0===this.namePos?18*(i+1):-18*(2-i);l+=this._dy,l*=this._tickFlip,l+=5.953125-(19.65625+13*(a-1)+7*(r-1))/2,t.push($("<g>",{"text-anchor":this._txtAnchor,transform:`translate(${this.x+this._intNameDX},${this.y+l})`,class:"Name "+e}).html(s[0]))}),t}get ungrpHTML(){return[...this.intTickHTML,this.iconHTML,this.nameHTML,...this.intNameHTML]}}class x extends f{get _tickRotation(){return 90}get _txtAnchor(){return"end"}get _intNameDX(){return-24}}class w extends f{get _tickRotation(){return-90}get _txtAnchor(){return"start"}get _intNameDX(){return 24}}class v extends p{constructor(t,e){e.interchange[0].push(e.interchange[1][1]),super(t,e),this._osiNames=e.interchange[1][0],this._osiType=e.change_type.substring(6,7)}get osiClass(){return"u"==this._osiType?"rmg-stn__mtr--unpaid-osi":"rmg-stn__mtr--paid-osi"}get iconHTML(){var t=1!=this.namePos?0:180;return $("<use>",{"xlink:href":"#osi11_hk",transform:`translate(${this.x},${this.y})rotate(${t})`,class:[this.iconClass,this.osiClass].join(" ")})}get _dy(){return 0==this.namePos?26:-26}get _txtAnchor(){return"middle"}get _osiNameDX(){return 0}get osiNameHTML(){var t=this._dy+8.34375-12.515625;return $("<g>",{"text-anchor":this._txtAnchor,transform:`translate(${this.x+this._osiNameDX},${this.y+t})`,class:"Name "+this._nameClass}).append($("<text>").addClass("rmg-name__zh rmg-name__mtr--osi").text(this._osiNames[0])).append($("<text>",{x:0,dy:12,class:"rmg-name__en rmg-name__mtr--osi"}).text(this._osiNames[1]))}get ungrpHTML(){return[this.intTickHTML,this.iconHTML,this.nameHTML,this.intNameHTML,this.osiNameHTML]}}class y extends v{get _txtAnchor(){return"end"}get _osiNameDX(){return-13}}class b extends v{get _txtAnchor(){return"start"}get _osiNameDX(){return 13}}class S extends f{constructor(t,e){e.interchange[0].unshift(...e.interchange[1].slice(1,3)),super(t,e),this._osiNames=e.interchange[1][0],this._osiType=e.change_type.split("_").reverse()[0][0]}get osiClass(){return"u"==this._osiType?"rmg-stn__mtr--unpaid-osi":"rmg-stn__mtr--paid-osi"}get iconHTML(){var t=1!=this.namePos?0:180;return $("<use>",{"xlink:href":"#osi12_hk",transform:`translate(${this.x},${this.y})rotate(${t})`,class:[this.iconClass,this.osiClass].join(" ")})}get _dy(){return 0==this.namePos?8:-8}get _osiDY(){return 0==this.namePos?62.34375:-70.6875}get _osiTxtAnchor(){return"middle"}get _osiDX(){return 0}get osiNameHTML(){var t=-1==this.state?"Pass":"Future";return $("<g>",{"text-anchor":this._osiTxtAnchor,transform:`translate(${this.x+this._dx+this._osiDX},${this.y+this._osiDY})`,class:`Name ${t}`}).append($("<text>").addClass("rmg-name__zh rmg-name__mtr--osi").text(this._osiNames[0])).append($("<text>",{x:0,dy:12,class:"rmg-name__en rmg-name__mtr--osi"}).text(this._osiNames[1].split("\\")[0]).append($("<tspan>",{x:0,dy:10}).text(this._osiNames[1].split("\\")[1]||"")))}get ungrpHTML(){return[...this.intTickHTML,this.iconHTML,this.nameHTML,...this.intNameHTML,this.osiNameHTML]}}class N extends S{get _tickRotation(){return 90}get _txtAnchor(){return"end"}get _intNameDX(){return-24}}class D extends S{get _tickRotation(){return-90}get _txtAnchor(){return"start"}get _intNameDX(){return 24}}class T extends S{constructor(t,e){super(t,e),this._origIntInfo=e.interchange[0][2]}get _nameTxtAnchor(){return this._osiTxtAnchor}get _nameDY(){return 1===this.namePos?11.515625:-11.515625}get origIntTickHTML(){var t=1==this.namePos?0:180,e=this._origIntInfo[m.colour],n=$("<use>",{"xlink:href":"#inttick_hk",stroke:e,transform:`translate(${this.x},${this.y})rotate(${t})`,class:"rmg-line rmg-line__mtr rmg-line__change"});return-1==this.state&&n.addClass("rmg-line__pass"),n}get origIntNameHTML(){var[t,e,n]=h([this._origIntInfo[m.nameZH],this._origIntInfo[m.nameEN]],15,7),i=1==this.namePos?30.953125:-37.703125-13*(e-1)-7*(n-1);return $("<g>",{"text-anchor":this._txtAnchor,transform:`translate(${this.x-this._nameDX},${this.y+i})`,class:`Name ${this._nameClass}`}).html(t[0])}get _osiNameDX(){return 0}get osiNameHTML(){var t=this._dy-(1===this.namePos?27:-27)+8.34375-12.515625;return $("<g>",{"text-anchor":this._osiTxtAnchor,transform:`translate(${this.x+this._osiNameDX},${this.y+t})`,class:"Name "+this._nameClass}).append($("<text>").addClass("rmg-name__zh rmg-name__mtr--osi").text(this._osiNames[0])).append($("<text>",{x:0,dy:12,class:"rmg-name__en rmg-name__mtr--osi"}).text(this._osiNames[1]))}get ungrpHTML(){return[...this.intTickHTML,this.origIntTickHTML,this.iconHTML,this.nameHTML,...this.intNameHTML,this.origIntNameHTML,this.osiNameHTML]}}class C extends T{get _nameDX(){return 3}get _tickRotation(){return 90}get _txtAnchor(){return"end"}get _intNameDX(){return-24}get _osiNameDX(){return 13}get _osiTxtAnchor(){return"start"}}class z extends T{get _nameDX(){return-3}get _tickRotation(){return-90}get _txtAnchor(){return"start"}get _intNameDX(){return 24}get _osiNameDX(){return-13}get _osiTxtAnchor(){return"end"}}class M extends S{constructor(t,e){super(t,e),[this._origIntCity,this._origIntLine,this._origIntColour,this._origIntFg,this._origIntNameZH,this._origIntNameEN]=e.interchange[0][2]}get origIntTickHTML(){var t=1==this.namePos?180:0,e=this._origIntColour,n=$("<use>",{"xlink:href":"#inttick_hk",stroke:e,transform:`translate(${this.x},${this.y})rotate(${t})`,class:"rmg-line rmg-line__mtr rmg-line__change"});return-1==this.state&&n.addClass("rmg-line__pass"),n}get origIntNameHTML(){var[t,e,n]=h([this._origIntNameZH,this._origIntNameEN],15,7),i=0==this.namePos?30.953125:-37.703125-13*(e-1)-7*(n-1);return $("<g>",{"text-anchor":"middle",transform:`translate(${this.x},${this.y+i})`,class:`Name ${this._nameClass}`}).html(t[0])}get iconHTML(){var t=1==this.namePos?1:-1,e="lineend"==this.children[0]?1:-1;this.children[0];return $("<use>",{"xlink:href":"#osi22end_hk",transform:`translate(${this.x},${this.y})scale(${e},${t})`,class:[this.iconClass,this.osiClass].join(" ")})}get _tickRotation(){return"lineend"==this.children[0]?-90:90}get _tickFlip(){return-1}get _dx(){return"lineend"==this.children[0]?41:-41}get _dy(){return 0==this.namePos?-18:18}get _intNameDX(){return"lineend"==this.children[0]?65:-65}get _txtAnchor(){return"lineend"==this.children[0]?"start":"end"}get _osiDY(){return 0==this.namePos?18.34375:-26.6875}get _osiTxtAnchor(){return"lineend"==this.children[0]?"start":"end"}get _osiDX(){return"lineend"==this.children[0]?-9:9}get ungrpHTML(){return[...this.intTickHTML,this.origIntTickHTML,this.iconHTML,this.nameHTML,...this.intNameHTML,this.origIntNameHTML,this.osiNameHTML]}}class L{constructor(t){this._longInterval=1,this.stations={},this._svgHeight=t.svg_height,this._svgWidth=t.svg_width,this._svgDestWidth=t.svg_dest_width,this._showOuter=t.show_outer,[this.themeCity,this.themeLine,this._themeColour,this._fgColour]=t.theme,this.yPc=t.y_pc,this._padding=t.padding,this._stripPc=t.strip_pc,this._branchSpacing=t.branch_spacing,this._txtFlip=t.txt_flip,this._lineNames=t.line_name;for(let[e,n]of Object.entries(t.stn_list))this.stations[e]=this._initStnInstance(e,n);this._currentStnId=t.current_stn_idx,this._direction=t.direction,this._platformNum=t.platform_num,this._destLegacy=t.dest_legacy,this._charForm=t.char_form;for(let[t,e]of Object.entries(this.stations))["linestart","lineend"].includes(t)||(e.x=this._stnRealX(t),e.y=this._stnRealY(t),e.state=this._stnState(t),e.namePos=this._txtFlip?Number(!this._stnNamePos(t)):this._stnNamePos(t))}_initStnInstance(t,e){switch(e.change_type){case"int2":return new p(t,e);case"int3_l":return new x(t,e);case"int3_r":return new w(t,e);case"osi11_ul":case"osi11_pl":return new y(t,e);case"osi11_ur":case"osi11_pr":return new b(t,e);case"osi12_ul":case"osi12_pl":return new N(t,e);case"osi12_ur":case"osi12_pr":return new D(t,e);case"osi22_pl":case"osi22_ul":return"linestart"==e.parents[0]||"lineend"==e.children[0]?new M(t,e):new C(t,e);case"osi22_pr":case"osi22_ur":return"linestart"==e.parents[0]||"lineend"==e.children[0]?new M(t,e):new z(t,e);default:return new u(t,e)}}set svgDestWidth(t){isNaN(t)||t<=0||(this._svgDestWidth=t,a("svg_dest_width",t),this.drawSVGFrame(),this.drawStrip(),this.drawDestInfo(),this.loadFonts())}set svgWidth(t){if(!(isNaN(t)||t<=0)){this._svgWidth=t,a("svg_width",t),this.drawSVGFrame();for(let[t,e]of Object.entries(this.stations))["linestart","lineend"].includes(t)||(e.x=this._stnRealX(t),e.y=this._stnRealY(t));L.clearSVG(),this.drawStns(),this.drawLine(),this.drawStrip(),this.loadFonts(),this.updateStnNameBg()}}set yPc(t){t=Number(t),this._yPc=t,a("y_pc",t);let e=t*this._svgHeight/100;$("g#main").attr("transform",`translate(0,${e})`)}set padding(t){t=Number(t),this._padding=t,a("padding",t);for(let[t,e]of Object.entries(this.stations))["linestart","lineend"].includes(t)||(e.x=this._stnRealX(t));L.clearSVG(),this.drawStns(),this.drawLine(),this.loadFonts(),this.updateStnNameBg()}set branchSpacing(t){t=Number(t),this._branchSpacing=t,a("branch_spacing",t);for(let[t,e]of Object.entries(this.stations))["linestart","lineend"].includes(t)||(e.x=this._stnRealX(t),e.y=this._stnRealY(t));L.clearSVG(),this.drawStns(),this.drawLine(),this.loadFonts(),this.updateStnNameBg()}set txtFlip(t){this._txtFlip=t,a("txt_flip",t);for(let[t,e]of Object.entries(this.stations))["linestart","lineend"].includes(t)||(e.namePos=this._txtFlip?Number(!this._stnNamePos(t)):this._stnNamePos(t));$("#stn_icons").empty(),this.drawStns(),this.loadFonts(),this.updateStnNameBg()}set themeColour(t){this._themeColour=t[0],this._fgColour=t[1];var e=s();e.theme[2]=t[0],e.theme[3]=t[1],i(e),this.fillThemeColour()}set direction(t){this._direction=t,a("direction",t);for(let[t,e]of Object.entries(this.stations))["linestart","lineend"].includes(t)||(e.state=this._stnState(t));L.clearSVG(),this.drawStns(),this.drawLine(),this.drawDestInfo(),this.loadFonts()}set platformNum(t){this._platformNum=t,a("platform_num",t),$(".rmg-name__platformnum").text(t)}set charForm(t){this._charForm=t,a("char_form",t);var e=$(".rmg-name__zh").eq(0).attr("class").match(/rmg-name__char-\w{2,4}/g)[0];$(".rmg-name__zh").removeClass(e),$(".rmg-name__zh").addClass(`rmg-name__char-${t}`)}set lineNames(t){this._lineNames=t,a("line_name",t),this.drawDestInfo(),this.loadFonts()}set destLegacy(t){this._destLegacy=t,a("dest_legacy",t),this.drawDestInfo(),this.loadFonts()}set currentStnId(t){this._currentStnId=t,a("current_stn_idx",t);for(let[t,e]of Object.entries(this.stations))["linestart","lineend"].includes(t)||(e.state=this._stnState(t));L.clearSVG(),this.drawStns(),this.drawLine(),this.drawDestInfo(),this.loadFonts(),this.updateStnNameBg()}_rightWideFactor(t){var e=0;return["Int3RStation","OSI11RStation","OSI12RStation","OSI22LStation","OSI22RStation"].includes(this.stations[t].constructor.name)&&(e+=this._longInterval),2==this._stnOutdegree(t)&&(e+=this._longInterval/2),2==this._stnIndegree(this.stations[t].children[0])&&(e+=this._longInterval/2),e}_leftWideFactor(t){var e=0;return["Int3LStation","OSI11LStation","OSI12LStation","OSI22LStation","OSI22RStation"].includes(this.stations[t].constructor.name)&&(e+=this._longInterval),2==this._stnIndegree(t)&&(e+=this._longInterval/2),2==this._stnOutdegree(this.stations[t].parents[0])&&(e+=this._longInterval/2),e}_pathWeight(t,e){return this.stations[t].children.includes(e)?1+this._rightWideFactor(t)+this._leftWideFactor(e):-1/0}_cpm(t,e){var n=this;if(t==e)return 0;var i=this.stations[t].children.map(t=>i.push(1+n._cpm(t,e)));return Math.max(...i)}_cp(t,e){var n=this;if(t==e)return{len:0,nodes:[t]};let i=[],s=[];this.stations[t].children.forEach(a=>{let r=n._cp(a,e);r.len<0||(i.push(this._pathWeight(t,a)+r.len),r.nodes.unshift(t),s.push(r.nodes))});let a=Math.max(...i);return{len:a,nodes:s[i.indexOf(a)]}}get criticalPath(){let t=[],e=[];this.leftDests.forEach(n=>{this.rightDests.forEach(i=>{let s=this._cp(n,i);t.push(s.len),e.push(s.nodes)})});let n=Math.max(...t);return{len:n,nodes:e[t.indexOf(n)]}}_topoOrder(t,e=[]){var n=this;return e.push(t),this.stations[t].children.forEach(i=>{2==this._stnIndegree(i)&&0==this.stations[i].parents.indexOf(t)||e.concat(n._topoOrder(i,e))}),e}get tpo(){let t=this._topoOrder("linestart");return t.slice(1,t.length-1)}get y(){return 0}get stripY(){return this._stripPc*this._svgHeight/100}get turningRadius(){return this._branchSpacing/2*(Math.sqrt(2)/(Math.sqrt(2)-1))}get lineXs(){return[this._svgWidth*this._padding/100,this._svgWidth*(1-this._padding/100)]}get leftDests(){return this.stations.linestart.children}get rightDests(){return this.stations.lineend.parents}get lValidDests(){return Array.from(new Set(this.routes.filter(t=>-1!==t.indexOf(this._currentStnId)).map(t=>t.filter(t=>"lineend"!==t&&"linestart"!==t)[0])))}get rValidDests(){return Array.from(new Set(this.routes.filter(t=>-1!==t.indexOf(this._currentStnId)).map(t=>t.filter(t=>"lineend"!==t&&"linestart"!==t).reverse()[0])))}_stnIndegree(t){return this.stations[t].inDegree}_stnOutdegree(t){return this.stations[t].outDegree}_stnXShare(t){var e=this.criticalPath;if(e.nodes.includes(t))return this._cp(e.nodes[0],t).len;for(var n=t,i=t,s=!1,a=!1;;){var r=this.stations[n].parents[0];if("linestart"==r){s=!0;break}if(n=r,this._stnOutdegree(n)>1)break}for(;;){var l=this.stations[i].children;if("lineend"==l[0]){a=!0;break}if(i=l[0],this._stnIndegree(i)>1)break}var h=this._cp(n,t).len,o=this._cp(t,i).len;if(s){var c=this._cp(e.nodes[0],i).len;return this._stnXShare(i)-o/(h+o)*c}if(a)c=this._cp(n,e.nodes.slice(-1)[0]).len;else c=this._cp(n,i).len;return this._stnXShare(n)+h/(h+o)*c}_stnRealX(t){let[e,n]=this.lineXs;return e+this._stnXShare(t)/this.criticalPath.len*(n-e)}_stnYShare(t){if(["linestart","lineend"].includes(t)||this._stnIndegree(t)>1||this._stnOutdegree(t)>1)return 0;var e=this.stations[t].parents[0];return e?1==this._stnOutdegree(e)?this._stnYShare(e):0==this.stations[e].children.indexOf(t)?1:-1:0}_stnRealY(t){return this.y-this._stnYShare(t)*this._branchSpacing}_isSuccessor_old(t,e){var n=this.stations[t].children;if(!n.length)return!1;if(n.includes(e))return!0;for(let t of n)if(this._isSuccessor_old(t,e))return!0;return!1}_isSuccessor(t,e){for(let n of this.routes){let i=n.indexOf(t),s=n.indexOf(e);if(-1!==i&&-1!==s&&i<s)return!0}return!1}_isPredecessor_old(t,e){var n=this.stations[t].parents;if(!n.length)return!1;if(n.includes(e))return!0;for(let t of n)if(this._isPredecessor_old(t,e))return!0;return!1}_isPredecessor(t,e){for(let n of this.routes){let i=n.indexOf(t),s=n.indexOf(e);if(-1!==i&&-1!==s&&s<i)return!0}return!1}_stnState(t){return t==this._currentStnId?0:"r"==this._direction?this._isSuccessor(this._currentStnId,t)?1:-1:this._isPredecessor(this._currentStnId,t)?1:-1}_stnNamePos(t){var e=this.criticalPath.nodes;if("linestart"==t)return 1;var n=e.indexOf(t)%2;if(-1==n){var i=this.stations[t].parents[0];return 2==this._stnOutdegree(i)?this._stnNamePos(i):Number(!this._stnNamePos(i))}return n}drawSVGFrame(){$("#railmap, #outer").attr({width:this._svgWidth,height:this._svgHeight}),$("#destination, #dest_outer").attr({width:this._svgDestWidth,height:this._svgHeight}),$("#dest_strip_gz").attr("width",this._svgDestWidth),$("#strip_gz").attr("width",this._svgWidth)}showFrameOuter(){this._showOuter?$("#outer, #dest_outer").show():$("#outer, #dest_outer").hide()}drawStns(){for(let[t,e]of Object.entries(this.stations))["linestart","lineend"].includes(t)||$("#stn_icons").append(e.html);$("#stn_icons").html($("#stn_icons").html())}updateStnNameBg(){var t=l($(`#stn_icons > #${this._currentStnId} > .Name`)[0],"railmap");console.log(t),$("#current_bg").attr({x:t.x-3,width:t.width+6}).show()}get stnDX(){return this.turningRadius-this._branchSpacing/2}get stnDY(){return this._branchSpacing/2}get stnExtraH(){var[t,e]=this.lineXs;return(e-t)/this.criticalPath.len*this._longInterval}get stnSpareH(){var[t,e]=this.lineXs,n=((e-t)/this.criticalPath.len-2*this.stnDX)/2;return n<0&&console.warn(`SVG width too small! ${n}`),n}get pathTurnENE(){return`a ${this.turningRadius},${this.turningRadius} 0 0,0 ${this.stnDX},${-this.stnDY}`}get pathTurnNEE(){return`a ${this.turningRadius},${this.turningRadius} 0 0,1 ${this.stnDX},${-this.stnDY}`}get pathTurnESE(){return`a ${this.turningRadius},${this.turningRadius} 0 0,1 ${this.stnDX},${this.stnDY}`}get pathTurnSEE(){return`a ${this.turningRadius},${this.turningRadius} 0 0,0 ${this.stnDX},${this.stnDY}`}_linePath(t){var[e,n,i]=[],s=[],{stnExtraH:a,stnSpareH:r,pathTurnESE:l,pathTurnSEE:h,pathTurnENE:o,pathTurnNEE:c,stnDX:d}=this;return t.forEach(t=>{var[_,g]=["_stnRealX","_stnRealY"].map(e=>this[e](t));if(!n&&0!==n)return[e,i,n]=[t,_,g],void s.push(`M ${_},${g}`);g>n?(s.push(g==this.y?`h ${_-i-a*this._leftWideFactor(t)-r-2*d}`:`h ${a*this._rightWideFactor(e)+r}`),s.push(l,h)):g<n&&(s.push(g==this.y?`h ${_-i-a*this._leftWideFactor(t)-r-2*d}`:`h ${a*this._rightWideFactor(e)+r}`),s.push(o,c)),s.push(`H ${_}`),[e,i,n]=[t,_,g]}),s.join(" ").replace(/( H ([\d.]+))+/g," H $2")}drawLine(){this.branches.map(t=>{var e=t.filter(t=>this.stations[t].state>=0),n=t.filter(t=>this.stations[t].state<=0);1===e.length&&(n=t),0==e.filter(t=>-1!==n.indexOf(t)).length&&e.length&&(n[0]===t[0]?n.push(e[0]):e[0]===t[0]&&e[e.length-1]===t[t.length-1]&&n.length?(n=t,e=[]):n.unshift(e[e.length-1])),$("#line_main").append($("<path>",{d:this._linePath(e)})),$("#line_pass").append($("<path>",{d:this._linePath(n)}))}),$("#line_main").html($("#line_main").html()),$("#line_pass").html($("#line_pass").html())}drawStrip(){$("#strip").attr("d",`M 0,${this.stripY} H ${this._svgWidth}`),$("#dest_strip").attr("d",`M 0,${this.stripY} H ${this._svgDestWidth}`)}fillThemeColour(){$("#line_main, #strip, #dest_strip").attr("stroke",this._themeColour),$("#dest_name > #platform > circle").attr("fill",this._themeColour)}drawDestInfo(){$("#dest_name > #platform > text").text(this._platformNum);let t=this[this._direction+"ValidDests"],e="l"===this._direction?"start":"end";var[n,i]=[0,1].map(e=>t.map(t=>this.stations[t].name[e].replace(/\\/g," ")).join("/"));if(this._destLegacy){var[s,a]=this._lineNames;a+=" "}else var s=a="";$("#dest_name > g:last-child text").eq(0).text(`${s}å¾€${n}`),$("#dest_name > g:last-child text").eq(1).text(`${a}to ${i}`);var r=310+$("#dest_name > g:last-child")[0].getBoundingClientRect().width+45+50,l="l"==this._direction?1:-1,h=(this._svgDestWidth-l*r)/2,o=90*(1-l),c=h+285*l,d=c+120*l;$("#dest_name > use").attr("transform",`translate(${h},130)rotate(${o})`),$("#dest_name > #platform").attr("transform",`translate(${c},130)`),$("#dest_name > g:last-child").attr({transform:`translate(${d},105)`,"text-anchor":e})}loadFonts(){$(".rmg-name__zh, .rmg-name__en").addClass(`rmg-name__char-${this._charForm}`)}updateStnName(t,e,n){let a=s();a.stn_list[t].name=e,a.stn_list[t].num=n,i(a),this.stations[t].name=e,this.stations[t].stnNum=n,$(`#stn_icons #${t}`).remove(),$("#stn_icons").append(this.stations[t].html),$("#stn_icons").html($("#stn_icons").html()),this.leftDests.includes(t)&&"l"==this._direction?this.drawDestInfo():this.rightDests.includes(t)&&"r"==this._direction&&this.drawDestInfo(),this.loadFonts(),t==this._currentStnId&&this.updateStnNameBg()}updateStnTransfer(t,e,n=null){var a=this.stations[t].constructor.name,r=s();if(r.stn_list[t].change_type=e,"none"==e?(delete r.stn_list[t].transfer,r.stn_list[t].interchange=[[]]):r.stn_list[t].interchange=n,i(r),this.stations[t]=this._initStnInstance(t,r.stn_list[t]),a!=this.stations[t].constructor.name){for(let[t,e]of Object.entries(this.stations))["linestart","lineend"].includes(t)||(e.x=this._stnRealX(t),e.y=this._stnRealY(t),e.namePos=this._txtFlip?Number(!this._stnNamePos(t)):this._stnNamePos(t),e.state=this._stnState(t));L.clearSVG(),this.drawStns(),this.drawLine(),this.drawStrip()}else this.stations[t].x=this._stnRealX(t),this.stations[t].y=this._stnRealY(t),this.stations[t].namePos=this._txtFlip?Number(!this._stnNamePos(t)):this._stnNamePos(t),this.stations[t].state=this._stnState(t),$(`#stn_icons #${t}`).remove(),$("#stn_icons").append(this.stations[t].html),$("#stn_icons").html($("#stn_icons").html());this.loadFonts(),this.updateStnNameBg()}removeStn(t){var e=s(),n=this.stations[t].parents,a=this.stations[t].children,r=!0;for(let e in this.stations)if(![t,"linestart","lineend"].includes(e)&&0==this._stnYShare(e)){r=!1;break}if(2==n.length&&2==a.length)return!1;if(r)return!1;if(4==Object.keys(e.stn_list).length)return!1;if(2==n.length||2==a.length)n.forEach(t=>{e.stn_list[t].children=a,this.stations[t].children=a}),a.forEach(t=>{e.stn_list[t].parents=n,this.stations[t].parents=n}),1==n.length&&(e.stn_list[n[0]].branch.right=this.stations[t].branch.right,this.stations[n[0]].branch.right=this.stations[t].branch.right),1==a.length&&(e.stn_list[a[0]].branch.left=this.stations[t].branch.left,this.stations[a[0]].branch.left=this.stations[t].branch.left);else if(2==this._stnOutdegree(n[0])&&2==this._stnIndegree(a[0])){var l=this.stations[n[0]].children.indexOf(t),h=this.stations[a[0]].parents.indexOf(t);e.stn_list[n[0]].children.splice(l,1),this.stations[n[0]].children.splice(l,1),e.stn_list[a[0]].parents.splice(h,1),this.stations[a[0]].parents.splice(h,1),e.stn_list[n[0]].branch.right=[],this.stations[n[0]].branch.right=[],e.stn_list[a[0]].branch.left=[],this.stations[a[0]].branch.left=[]}else n.forEach(n=>{var i=e.stn_list[n].children.indexOf(t);a.length?(e.stn_list[n].children[i]=a[0],this.stations[n].children[i]=a[0]):(e.stn_list[n].children.splice(i,1),this.stations[n].children.splice(i,1)),this.stations[n].branch.right[1]===t&&(this.stations[n].branch.right[1]=a[0],e.stn_list[n].branch.right[1]=a[0])}),a.forEach(i=>{var s=e.stn_list[i].parents.indexOf(t);n.length?(e.stn_list[i].parents[s]=n[0],this.stations[i].parents[s]=n[0]):(e.stn_list[i].parents.splice(s,1),this.stations[i].parents.splice(s,1)),this.stations[i].branch.left[1]===t&&(this.stations[i].branch.left[1]=n[0],e.stn_list[i].branch.left[1]=n[0])});delete e.stn_list[t],delete this.stations[t];if(this._currentStnId==t){var o=Object.keys(this.stations)[1];this._currentStnId=o,e.current_stn_idx=o,!0}i(e),n.concat(a).forEach(t=>{["linestart","lineend"].includes(t)||(this.stations[t]=this._initStnInstance(t,e.stn_list[t]))});for(let[t,e]of Object.entries(this.stations))["linestart","lineend"].includes(t)||(e.x=this._stnRealX(t),e.y=this._stnRealY(t),e.namePos=this._txtFlip?Number(!this._stnNamePos(t)):this._stnNamePos(t),e.state=this._stnState(t));return L.clearSVG(),this.drawStns(),this.drawLine(),this.drawStrip(),this.drawDestInfo(),this.loadFonts(),this.updateStnNameBg(),!0}newStnPossibleLoc(t,e){switch("before"==t?this._stnIndegree(e):this._stnOutdegree(e)){case 2:return[1,1,1,[],[]];case 1:if(0==this._stnYShare(e)){let n=this.newBranchPossibleEnd(t,e);return n=n.length?n:[],[1,0,0,n,n]}return this.stations[e].y>this.y?"before"==t?[this._stnOutdegree(this.stations[e].parents[0])-1,0,1,[],[]]:[this._stnIndegree(this.stations[e].children[0])-1,0,1,[],[]]:"before"==t?[this._stnOutdegree(this.stations[e].parents[0])-1,1,0,[],[]]:[this._stnIndegree(this.stations[e].children[0])-1,1,0,[],[]]}return[0,0,0,[],[]]}newBranchPossibleEnd(t,e){let n=[];if("before"==t){for(;1==this._stnIndegree(e);)e=this.stations[e].parents[0],n.unshift(e);n.pop()}else{for(;1==this._stnOutdegree(e);)e=this.stations[e].children[0],n.push(e);n.shift()}return n}addStn(t,e,n,a){let r=o();for(;Object.keys(this.stations).includes(r);)r=o();let l=s(),h={};"before"==t?"centre"==n?(h.parents=this.stations[e].parents,0==this._stnIndegree(e)&&this.stations[e].y!=this.y?h.children=this.leftDests:this.stations[e].y!=this.y?(h.children=this.stations[this.stations[e].parents[0]].children,h.branch={left:[],right:this.stations[h.parents[0]].branch.right},this.stations[h.parents[0]].branch.right=[],l.stn_list[h.parents[0]].branch.right=[]):(h.children=[e],h.branch={left:this.stations[e].branch.left,right:[]},this.stations[e].branch.left=[],l.stn_list[e].branch.left=[]),h.parents.forEach(t=>{this.stations[t].children=[r],l.stn_list[t].children=[r]}),h.children.forEach(t=>{this.stations[t].parents=[r],l.stn_list[t].parents=[r]})):"upper"==n?(h.branch={left:[],right:[]},2==this._stnIndegree(e)?(this.stations[e].branch.left[1]==this.stations[e].parents[0]&&(this.stations[e].branch.left[1]=r,l.stn_list[e].branch.left[1]=r),h.parents=this.stations[e].parents.slice(0,1),h.children=[e],h.parents.forEach(t=>{this.stations[t].children=[r],l.stn_list[t].children=[r]}),this.stations[e].parents[0]=r,l.stn_list[e].parents[0]=r):(h.parents=this.stations[e].parents,h.children=[e],h.parents.forEach(t=>{this.stations[t].children[0]=r,l.stn_list[t].children[0]=r,this.stations[t].branch.right[1]===e&&(this.stations[t].branch.right[1]=r,l.stn_list[t].branch.right[1]=r)}),h.children.forEach(t=>{this.stations[t].parents=[r],l.stn_list[t].parents=[r]}))):"lower"==n?(h.branch={left:[],right:[]},2==this._stnIndegree(e)?(this.stations[e].branch.left[1]==this.stations[e].parents[1]&&(this.stations[e].branch.left[1]=r,l.stn_list[e].branch.left[1]=r),h.parents=this.stations[e].parents.slice(1),h.children=[e],h.parents.forEach(t=>{this.stations[t].children=[r],l.stn_list[t].children=[r]}),this.stations[e].parents[1]=r,l.stn_list[e].parents[1]=r):(h.parents=this.stations[e].parents,h.children=[e],h.parents.forEach(t=>{this.stations[t].children[1]=r,l.stn_list[t].children[1]=r,this.stations[t].branch.right[1]===e&&(this.stations[t].branch.right[1]=r,l.stn_list[t].branch.right[1]=r)}),h.children.forEach(t=>{this.stations[t].parents=[r],l.stn_list[t].parents=[r]}))):"newupper"==n?(h.branch={left:[],right:[]},this.stations[e].branch.left[1]=r,l.stn_list[e].branch.left[1]=r,this.stations[a].branch.right[1]=r,l.stn_list[a].branch.right[1]=r,h.parents=[a],h.children=[e],this.stations[a].children.unshift(r),l.stn_list[a].children.unshift(r),this.stations[e].parents.unshift(r),l.stn_list[e].parents.unshift(r)):"newlower"==n&&(h.branch={left:[],right:[]},this.stations[e].branch.left[1]=r,l.stn_list[e].branch.left[1]=r,this.stations[a].branch.right[1]=r,l.stn_list[a].branch.right[1]=r,h.parents=[a],h.children=[e],this.stations[a].children.push(r),l.stn_list[a].children.push(r),this.stations[e].parents.push(r),l.stn_list[e].parents.push(r)):"centre"==n?(h.children=this.stations[e].children,0==this._stnOutdegree(e)&&this.stations[e].y!=this.y?h.parents=this.rightDests:this.stations[e].y!=this.y?(h.parents=this.stations[this.stations[e].children[0]].parents,h.branch={left:this.stations[h.children[0]].branch.left,right:[]},this.stations[h.children[0]].branch.left=[],l.stn_list[h.children[0]].branch.left=[]):(h.parents=[e],h.branch={left:[],right:this.stations[e].branch.right},this.stations[e].branch.right=[],l.stn_list[e].branch.right=[]),h.children.forEach(t=>{this.stations[t].parents=[r],l.stn_list[t].parents=[r]}),h.parents.forEach(t=>{this.stations[t].children=[r],l.stn_list[t].children=[r]})):"upper"==n?(h.branch={left:[],right:[]},2==this._stnOutdegree(e)?(this.stations[e].branch.right[1]==this.stations[e].children[0]&&(this.stations[e].branch.right[1]=r,l.stn_list[e].branch.right[1]=r),h.children=this.stations[e].children.slice(0,1),h.parents=[e],h.children.forEach(t=>{this.stations[t].parents=[r],l.stn_list[t].parents=[r]}),this.stations[e].children[0]=r,l.stn_list[e].children[0]=r):(h.children=this.stations[e].children,h.parents=[e],h.children.forEach(t=>{this.stations[t].parents[0]=r,l.stn_list[t].parents[0]=r,this.stations[t].branch.left[1]===e&&(this.stations[t].branch.left[1]=r,l.stn_list[t].branch.left[1]=r)}),h.parents.forEach(t=>{this.stations[t].children=[r],l.stn_list[t].children=[r]}))):"lower"==n?(h.branch={left:[],right:[]},2==this._stnOutdegree(e)?(this.stations[e].branch.right[1]==this.stations[e].children[1]&&(this.stations[e].branch.right[1]=r,l.stn_list[e].branch.right[1]=r),h.children=this.stations[e].children.slice(1),h.parents=[e],h.children.forEach(t=>{this.stations[t].parents=[r],l.stn_list[t].parents=[r]}),this.stations[e].children[1]=r,l.stn_list[e].children[1]=r):(h.children=this.stations[e].children,h.parents=[e],h.children.forEach(t=>{1===this._stnIndegree(t)?(this.stations[t].parents[0]=r,l.stn_list[t].parents[0]=r):(this.stations[t].parents[1]=r,l.stn_list[t].parents[1]=r),this.stations[t].branch.left[1]===e&&(this.stations[t].branch.left[1]=r,l.stn_list[t].branch.left[1]=r)}),h.parents.forEach(t=>{this.stations[t].children=[r],l.stn_list[t].children=[r]}))):"newupper"==n?(h.branch={left:[],right:[]},this.stations[e].branch.right=["through",r],l.stn_list[e].branch.right=["through",r],this.stations[a].branch.left=["through",r],l.stn_list[a].branch.left=["through",r],h.children=[a],h.parents=[e],this.stations[a].parents.unshift(r),l.stn_list[a].parents.unshift(r),this.stations[e].children.unshift(r),l.stn_list[e].children.unshift(r)):"newlower"==n&&(h.branch={left:[],right:[]},this.stations[e].branch.right=["through",r],l.stn_list[e].branch.right=["through",r],this.stations[a].branch.left=["through",r],l.stn_list[a].branch.left=["through",r],h.children=[a],h.parents=[e],this.stations[a].parents.push(r),l.stn_list[a].parents.push(r),this.stations[e].children.push(r),l.stn_list[e].children.push(r)),h.name=[`è»Šç«™${r.toUpperCase()}`,`Station ${r.toUpperCase()}`],h.change_type="none",h.num="00",h.interchange=[[]],l.stn_list[r]=h,i(l),this.stations[r]=this._initStnInstance(r,h),this.stations[e]=this._initStnInstance(e,s().stn_list[e]);for(let[t,e]of Object.entries(this.stations))["linestart","lineend"].includes(t)||(e.x=this._stnRealX(t),e.y=this._stnRealY(t),e.state=this._stnState(t),e.namePos=this._txtFlip?Number(!this._stnNamePos(t)):this._stnNamePos(t));return L.clearSVG(),this.drawStns(),this.drawLine(),this.drawStrip(),this.drawDestInfo(),this.loadFonts(),this.updateStnNameBg(),[r,h]}reverseStns(){var t=s();for(let[n,i]of Object.entries(this.stations))if("linestart"===n)t.stn_list.lineend.parents=i.children.reverse(),t.stn_list.lineend.branch={left:i.branch.right,right:[]};else if("lineend"===n)t.stn_list.linestart.children=i.parents.reverse(),t.stn_list.linestart.branch={left:[],right:i.branch.left};else{var e=i.children.reverse().map(t=>{switch(t){case"linestart":return"lineend";case"lineend":return"linestart";default:return t}});t.stn_list[n].children=i.parents.reverse().map(t=>{switch(t){case"linestart":return"lineend";case"lineend":return"linestart";default:return t}}),t.stn_list[n].parents=e,t.stn_list[n].branch.left=i.branch.right,t.stn_list[n].branch.right=i.branch.left}i(t),location.reload(!0)}updateBranchType(t,e,n){if(this.stations[t].branch[e][0]===n)return;this.stations[t].branch[e][0]=n;let a=s();a.stn_list[t].branch[e][0]=n,i(a);for(let[t,e]of Object.entries(this.stations))["linestart","lineend"].includes(t)||(e.state=this._stnState(t));L.clearSVG(),this.drawStns(),this.drawLine(),this.drawDestInfo(),this.loadFonts()}updateBranchFirst(t,e,n){if(this.stations[t].branch[e][1]===n)return!1;let a=n,r=s();if("right"===e){for(;1===this.stations[a].inDegree;)a=this.stations[a].children[0];let e=this.stations[t].children.indexOf(n);this.stations[t].branch.right[1]=r.stn_list[t].branch.right[1]=n,this.stations[a].branch.left[1]=r.stn_list[a].branch.left[1]=this.stations[a].parents[e]}else{for(;1===this.stations[a].outDegree;)a=this.stations[a].parents[0];let e=this.stations[t].parents.indexOf(n);this.stations[t].branch.left[1]=r.stn_list[t].branch.left[1]=n,this.stations[a].branch.right[1]=r.stn_list[a].branch.right[1]=this.stations[a].children[e]}i(r);for(let[t,e]of Object.entries(this.stations))["linestart","lineend"].includes(t)||(e.x=this._stnRealX(t),e.y=this._stnRealY(t),e.state=this._stnState(t));return L.clearSVG(),this.drawStns(),this.drawLine(),this.drawDestInfo(),this.loadFonts(),!0}updateBranchPos(t,e,n){if("right"===e){if(this.stations[t].children.indexOf(this.stations[t].branch.right[1])===n)return}else if(this.stations[t].parents.indexOf(this.stations[t].branch.left[1])===n)return;let a=this.stations[t].branch[e][1],r=s();if("right"===e){for(;1===this.stations[a].inDegree;)a=this.stations[a].children[0];this.stations[t].children.reverse(),r.stn_list[t].children.reverse(),this.stations[a].parents.reverse(),r.stn_list[a].parents.reverse()}else{for(;1===this.stations[a].outDegree;)a=this.stations[a].parents[0];this.stations[t].parents.reverse(),r.stn_list[t].parents.reverse(),this.stations[a].children.reverse(),r.stn_list[a].children.reverse()}i(r);for(let[t,e]of Object.entries(this.stations))["linestart","lineend"].includes(t)||(e.y=this._stnRealY(t));L.clearSVG(),this.drawStns(),this.drawLine(),this.drawDestInfo(),this.loadFonts()}static clearSVG(){$("#stn_icons, #line_main, #line_pass").empty()}static initSVG(t){t.drawSVGFrame(),t.showFrameOuter(),t.drawStns(),t.fillThemeColour(),t.drawLine(),t.drawStrip(),t.drawDestInfo(),t.loadFonts(),t.updateStnNameBg()}get branches(){for(var t=["linestart"],e=[[]],n=0;t.length;){var i=t.shift(),s=e[n][0]||null,a=[i];for(s&&a.unshift(s);"lineend"!=i&&("linestart"==i||s!=this.stations[i].branch.left[1]);){s=i;var r=this.stations[s].children;switch(r.length){case 1:i=r[0];break;case 2:if(e.push([s]),"linestart"==s)var l=this.stations[s].branch.right[1];else l=this.stations[s].branch.right[1];t.push(l),i=r.filter(t=>t!=l)[0]}a.push(i)}e[n]=a,n++}return e.map(t=>t.filter(t=>!["linestart","lineend"].includes(t)))}get routes(){for(var t=["linestart"],e=[["linestart"]],n=0;t.length;){var i=t.shift(),s=e[n].slice().reverse()[0]||null;for(s&&"linestart"!==i?e[n].push(i):e[n]=[i];"lineend"!==i;){s=i;var a=this.stations[s].children;switch(a.length){case 1:i=a[0];break;case 2:var r=this.stations[s].branch.right[1];"through"===this.stations[s].branch.right[0]?(e.push(e[n].slice()),t.push(r)):0===n&&(e.push([s]),t.push(r)),i=a.filter(t=>t!=r)[0]}if(e[n].push(i),s===this.stations[i].branch.left[1]&&"nonthrough"===this.stations[i].branch.left[0])break}n++}return e}}var I=n(12),k=n(2),P=n(6),E=n(11);var H=n(3);class O extends u{constructor(t,e){super(t,e),this.stnNum=e.num}get nameClass(){switch(this.state){case-1:return"Pass";case 0:return"CurrentGZ";default:return"Future"}}get _nameShift(){return!1}get _tickRotation(){return this.y>0?180:0}get iconHTML(){var[t,e]=-1==this.state?["stn_gz_pass","Pass"]:["stn_gz","Future"];return $("<g>",{transform:`translate(${this.x},${this.y})`}).append($("<use>",{"xlink:href":"#"+t,class:"rmg-stn"})).append($("<g>",{class:"Name "+e}).append($("<text>",{class:"rmg-name__zh rmg-name__gzmtr--line-num"})).append($("<text>",{class:"rmg-name__zh rmg-name__gzmtr--station-num",x:0}).text(this.stnNum)))}get nameHTML(){var t=this.name[1].split("\\").length;let e;e=this._nameShift?0===this._tickRotation?-9:16+12*(t-1)*Math.cos(-45):0===this._tickRotation?(24+12*(t-1))*Math.cos(-45):-6;let n=0===this._tickRotation?-25.921875-12*(t-1)*Math.cos(-45):17.5;return $("<g>",{transform:`translate(${this.x-e},${this.y+n})rotate(-45)`,"text-anchor":0===this._tickRotation?"start":"end",class:`Name ${this.nameClass}`}).append($("<text>").addClass("rmg-name__zh rmg-name__gzmtr--station").text(this.name[0])).append($("<text>",{dy:15,class:"rmg-name__en rmg-name__gzmtr--station"}).text(this.name[1].split("\\")[0]).append($("<tspan>",{x:0,dy:12}).text(this.name[1].split("\\")[1])))}}class F extends O{constructor(t,e){super(t,e),this._intInfos=e.interchange[0]}get intTickHTML(){var t=this._intInfos.map(t=>t[m.colour]).map((t,e)=>{let n=this.x-2*(this._intInfos.length-1)+4*e;return $("<use>",{"xlink:href":"#inttick_gz",stroke:-1==this.state?"#aaa":t,transform:`translate(${n},${this.y})rotate(${this._tickRotation})`})});return $("<g>",{class:"rmg-line rmg-line__gzmtr rmg-line__change"}).append(...t)}get intNameHTML(){var t=this._intInfos.map(t=>t[m.nameZH]).map(t=>t.match(/[\d]+|[\D]+/g)||[""]).map((t,e)=>{var n=!1;return 2==t.length&&!isNaN(Number(t[0]))&&isNaN(Number(t[1]))&&(n=!0),$("<text>",{y:8.5+28*e*(0===this._tickRotation?1:-1),class:"rmg-name__zh rmg-name__gzmtr--int"}).append($("<tspan>",{"font-size":"16px","alignment-baseline":"central"}).text(n?t[0]:"")).append($("<tspan>",{dy:-.5,"alignment-baseline":"central"}).text(n?t[1]:t.join("")))}),e=this._intInfos.map(t=>t[m.nameEN]).map((t,e)=>{let n=$("<text>",{y:19.5+28*e*(0===this._tickRotation?1:-1),class:"rmg-name__en"}).text(t);return n.addClass(t.length>10?"rmg-name__gzmtr--int-small":"rmg-name__gzmtr--int"),n});this._intInfos.map(t=>t[m.fg]).map((n,i)=>{"#fff"!=n&&-1!=this.state||([t[i],e[i]]=[t[i],e[i]].map(t=>t.addClass("rmg-name__gzmtr--white-fg")))});var n=this._intInfos.map(t=>t[m.colour]).map((t,e)=>$("<use>",{"xlink:href":"#intbox_gz",fill:-1==this.state?"#aaa":t,y:28*e*(0===this._tickRotation?1:-1)}));return $("<g>",{"text-anchor":"middle",transform:`translate(${this.x},${this.y+(0===this._tickRotation?23:-47)})`}).append(...n,...t,...e)}get ungrpHTML(){return[this.intTickHTML,this.iconHTML,this.nameHTML,this.intNameHTML]}}class R extends F{constructor(t,e,n){e.interchange[0].unshift(n),e.interchange[1]&&e.interchange[0].push(...e.interchange[1].slice(1)),super(t,e)}get _nameShift(){return!0}get _tickRotation(){return 0===this.parents.indexOf(this.branch.left[1])||0===this.children.indexOf(this.branch.right[1])?0:180}}class j extends F{constructor(t,e){e.interchange[0].push(...e.interchange[1].slice(1)),super(t,e)}}class X extends L{constructor(t){super(t),this._psdNum=t.psd_num,this._lineNum=t.line_num,this._infoPanelType=t.info_panel_type,this._directionGZX=t.direction_gz_x,this._directionGZY=t.direction_gz_y}_initStnInstance(t,e){if(2===e.children.length||2===e.parents.length)return new R(t,e,[this.themeCity,this.themeLine,this._themeColour,this._fgColour,...this._lineNames]);switch(e.change_type){case"int2":case"int3_l":case"int3_r":return new F(t,e);case"osi11_ul":case"osi11_pl":case"osi11_ur":case"osi11_pr":case"osi12_ul":case"osi12_pl":case"osi12_ur":case"osi12_pr":case"osi22_ul":case"osi22_pl":case"osi22_ur":case"osi22_pr":return new j(t,e);case"osi22_end_p":case"osi22_end_u":if("linestart"==e.parents[0]||"lineend"==e.children[0])return new j(t,e);default:return new O(t,e)}}get lineXs(){return"r"==this._direction?[this._svgWidth*this._padding/100+65,this._svgWidth*(1-this._padding/100)]:[this._svgWidth*this._padding/100,this._svgWidth*(1-this._padding/100)-65]}set svgWidth(t){super.svgWidth=t,this.loadLineNum(),this.loadLineName(),this.loadDirection()}set padding(t){super.padding=t,this.loadLineNum(),this.loadLineName()}set branchSpacing(t){super.branchSpacing=t,this.loadLineNum()}set direction(t){this._direction=t,a("direction",t);for(let[t,e]of Object.entries(this.stations))["linestart","lineend"].includes(t)||(e.x=this._stnRealX(t),e.y=this._stnRealY(t),e.state=this._stnState(t));X.clearSVG(),this.drawStns(),this.drawLine(),this.drawDestInfo(),this.loadLineNum(),this.loadLineName(),this.loadDirection(),this.loadFonts()}set txtFlip(t){super.txtFlip=t,this.loadLineNum()}set currentStnId(t){super.currentStnId=t,this.loadLineNum(),this.loadDirection()}set lineNum(t){this._lineNum=t,a("line_num",t),this.loadLineNum(),this.loadFonts()}set lineNames(t){this._lineNames=t,a("line_name",t),this.loadLineName(),this.loadFonts()}set psdNum(t){this._psdNum=t,a("psd_num",t),$(".rmg-psd-num").text(t)}set infoPanelType(t){this._infoPanelType=t,a("info_panel_type",t),$("#station_info_gzmtr #indicator_light").attr("xlink:href","#indicator_"+t),this.drawStrip(),this.fillThemeColour(),this.drawPSD()}set directionGZX(t){this._directionGZX=t,a("direction_gz_x",t);let e=this._svgWidth*this._directionGZX/100,n=this._svgHeight*this._directionGZY/100;$("#direction_gz").attr("transform",`translate(${e},${n})`)}set directionGZY(t){this._directionGZY=t,a("direction_gz_y",t);let e=this._svgWidth*this._directionGZX/100,n=this._svgHeight*this._directionGZY/100;$("#direction_gz").attr("transform",`translate(${e},${n})`)}_stnXShare(t){let{criticalPath:e,branches:n}=this,i=this;if(e.nodes.includes(t))return super._stnXShare(t);if(this.criticalPath.nodes.join(",")!==n[0].join(","))return super._stnXShare(t);{let e=n.slice(1).filter(e=>e.includes(t))[0],s=this._cp(e[0],t).len,a=this._cp(t,e[e.length-1]).len;return n[0].includes(e[0])&&n[0].includes(e[e.length-1])?(i._stnXShare(e[0])*a+i._stnXShare(e[e.length-1])*s)/(s+a):n[0].includes(e[0])?i._stnXShare(e[0])+s:i._stnXShare(e[e.length-1])-a}}_stnYShare(t){if(["linestart","lineend"].includes(t))return 0;var e=this.branches;if(e[0].includes(t))return 0;{let s=1;for(;!e[s].includes(t);)s++;if(e[0].includes(e[s][0])){var n=e[s][0],i="children";return 0==this.stations[n][i].indexOf(e[s][1])?2:-2}n=e[s].slice().reverse()[0],i="parents";return 0==this.stations[n][i].indexOf(e[s].slice().reverse()[1])?2:-2}}drawStrip(){let t=(t=>{switch(this._infoPanelType){case"gz28":case"gzgf":return 60;case"gz3":return 40;case"gz1421":return 20}})();$("#dest_strip_gz, #strip_gz").attr({y:this._svgHeight-t,height:t})}_rightWideFactor(t){return"BranchStationGZ"===this.stations[t].constructor.name&&0===this.stations[t]._tickRotation?.25:0}_leftWideFactor(t){return"BranchStationGZ"===this.stations[t].constructor.name&&0!==this.stations[t]._tickRotation?.5:0}_pathWeight(t,e){return this.stations[t].children.includes(e)?1+this._rightWideFactor(t)+this._leftWideFactor(e):-1/0}_linePath(t){var[e,n,i]=[],s=[],{stnExtraH:a,stnSpareH:r,pathTurnESE:l,pathTurnSEE:h,pathTurnENE:o,pathTurnNEE:c,stnDX:d}=this;return t.forEach(t=>{var[a,r]=["_stnRealX","_stnRealY"].map(e=>this[e](t));if(!n&&0!==n)return[e,i,n]=[t,a,r],void s.push(`M ${a},${r}`);r===this.y?(r<n&&s.push(`H ${a-30}`,"a 30,30 0 0,0 30,-30",`V ${r}`),r>n&&s.push(`H ${a-30}`,"a 30,30 0 0,1 30,30",`V ${r}`)):(r<n&&s.push(`V ${r+30}`,"a 30,30 0 0,1 30,-30",`H ${a}`),r>n&&s.push(`V ${r-30}`,"a 30,30 0 0,0 30,30",`H ${a}`)),s.push(`H ${a}`),[e,i,n]=[t,a,r]}),s.join(" ").replace(/( H ([\d.]+))+/g," H $2")}drawLine(){$(".rmg-line").removeClass("rmg-line__mtr").addClass("rmg-line__gzmtr"),super.drawLine()}loadFonts(){$(".rmg-name__zh, .rmg-name__en").addClass("rmg-name__gzmtr")}fillThemeColour(){super.fillThemeColour(),$("#dest_strip_gz, #strip_gz").attr("fill",this._themeColour),["gz3","gz1421"].includes(this._infoPanelType)?($("#big_psd use").attr("fill",this._themeColour),"#fff"===this._fgColour?$("#big_psd text").addClass("rmg-name__gzmtr--white-fg"):$("#big_psd text").removeClass("rmg-name__gzmtr--white-fg")):($("#big_psd use").attr("fill","white"),$("#big_psd text").removeClass("rmg-name__gzmtr--white-fg")),$("path#stn_gz").attr("stroke",this._themeColour),$("#station_info_gzmtr > #platform > circle").attr("fill",this._themeColour),$("#line_name use").attr("fill",this._themeColour),"#fff"===this._fgColour?($("#station_info_gzmtr > #platform text").addClass("rmg-name__gzmtr--white-fg"),$("#line_name text").addClass("rmg-name__gzmtr--white-fg")):($("#station_info_gzmtr > #platform text").removeClass("rmg-name__gzmtr--white-fg"),$("#line_name text").removeClass("rmg-name__gzmtr--white-fg"))}updateStnNameBg(){$("#current_bg").hide()}loadLineNum(){$(".rmg-name__gzmtr--line-num").text(this._lineNum).attr("transform","translate(-9.25,0)");var t=l($(".rmg-name__gzmtr--line-num")[1],"railmap");if(2===this._lineNum.length){var e=t.width>15.59375?15.59375/t.width:1;$(".rmg-name__gzmtr--line-num").attr("transform",`translate(-9.25,0)scale(${e})`),$(".rmg-name__gzmtr--station-num").attr("transform",`translate(9.25,0)scale(${e})`)}else{e=t.width>15.59375?15.59375/t.width:1;$(".rmg-name__gzmtr--line-num").attr("transform",`translate(-9.25,0)scale(${e})`),$(".rmg-name__gzmtr--station-num").attr("transform","translate(9.25,0)")}}loadLineName(){var t=this._lineNames[0].match(/[\d]+|[\D]+/g)||"",e=!1;2==t.length&&!isNaN(Number(t[0]))&&isNaN(Number(t[1]))&&(e=!0),e?($("#line_name tspan").eq(0).text(t[0]),$("#line_name tspan").eq(1).text(t[1]),$("#line_name tspan").eq(1).attr("dy","-0.5")):($("#line_name tspan").eq(0).text(""),$("#line_name tspan").eq(1).text(this._lineNames[0]),$("#line_name tspan").eq(1).attr("dy","-0.5")),$("#line_name text:last-child").text(this._lineNames[1]),this._lineNames[1].length>10?$("#line_name text:last-child").text(this._lineNames[1]).addClass("rmg-name__gzmtr--int-small").removeClass("rmg-name__gzmtr--int"):$("#line_name text:last-child").text(this._lineNames[1]).removeClass("rmg-name__gzmtr--int-small").addClass("rmg-name__gzmtr--int"),"#fff"==this._fgColour&&$("#line_name text").addClass("rmg-name__gzmtr--white-fg");var n="r"==this._direction?this.lineXs[0]-65:this.lineXs[1]+65;$("#line_name").attr({transform:`translate(${n},${this.y-18})scale(1.5)`})}loadDirection(){let t,e=this._svgWidth*this._directionGZX/100,n=this._svgHeight*this._directionGZY/100;$("#direction_gz").attr("transform",`translate(${e},${n})`),"l"==this._direction?($("#direction_gz use").attr("transform","scale(0.35)"),$("#direction_gz g").attr({"text-anchor":"start",transform:"translate(65,-5)"}),t=this.lValidDests):($("#direction_gz use").attr("transform","scale(0.35)rotate(180)"),$("#direction_gz g").attr({"text-anchor":"end",transform:"translate(-65,-5)"}),t=this.rValidDests);var[i,s]=[0,1].map(e=>t.map(t=>this.stations[t].name[e].replace(/\\/g," ")).join("/"));$("#direction_gz text").eq(0).text(i+"æ–¹å‘"),$("#direction_gz text").eq(1).text("Towards "+s)}updateStnName(t,e,n){super.updateStnName(t,e,n),this.loadLineNum(),(this.stations[this._currentStnId].parents.includes(t)||this.stations[this._currentStnId].children.includes(t))&&(this.drawDestInfo(),this.loadFonts()),this._currentStnId===t&&(this.drawDestInfo(),this.loadFonts()),(this.leftDests.includes(t)||this.rightDests.includes(t))&&this.loadDirection()}drawDestInfo(){$("#station_info_gzmtr #big_stn_num text").eq(1).text(this.stations[this._currentStnId].stnNum),$("#station_info_gzmtr > #platform > text").eq(0).text(this._platformNum),$("#station_info_gzmtr > #big_psd text").eq(0).text(this._psdNum),$("#station_info_gzmtr #big_name").empty().attr("transform",`translate(${this._svgDestWidth/2},${100-20*(this.stations[this._currentStnId].name[1].split("\\").length-1)})`).append($("<text>",{class:"rmg-name__zh rmg-name__gzmtr--dest"}).text(this.stations[this._currentStnId].name[0])).append($("<text>",{dy:70,class:"rmg-name__en rmg-name__gzmtr--dest"}).text(this.stations[this._currentStnId].name[1].split("\\")[0]).append($("<tspan>",{x:0,dy:40,"alignment-baseline":"middle"}).text(this.stations[this._currentStnId].name[1].split("\\")[1]||""))),$("#terminus_gz").attr("transform",`translate(${this._svgWidth/2},100)`);let t=this.stations[this._currentStnId]["l"===this._direction?"parents":"children"].filter(t=>(this.stations[this._currentStnId].branch["l"===this._direction?"left":"right"].length,!0));["linestart","lineend"].includes(t[0])?($("#station_info_gzmtr").find("#big_next, #big_next_2").hide(),$("#station_info_gzmtr > use").eq(0).hide(),$("#line_main, #line_pass, #line_name, #stn_icons, #direction_gz").hide(),$("#terminus_gz").show()):(1===t.length?($("#station_info_gzmtr #big_next").show(),$("#station_info_gzmtr #big_next_2").hide()):($("#station_info_gzmtr #big_next").hide(),$("#station_info_gzmtr #big_next_2").show()),$("#station_info_gzmtr > use").eq(0).show(),$("#line_main, #line_pass, #line_name, #stn_icons, #direction_gz").show(),$("#terminus_gz").hide());let[e,n]=["",""],i=0;if(1===t.length){var s=this.stations[t[0]];[e,n]=s.name,i=e.length,$("#station_info_gzmtr #big_next g:nth-child(2) text").eq(0).text(e),$("#station_info_gzmtr #big_next g:nth-child(2) text").eq(1).text(n.split("\\")[0]).append($("<tspan>",{x:0,dy:17,"alignment-baseline":"middle"}).text(n.split("\\")[1]||""))}else t.forEach((t,s)=>{let a=this.stations[t];[e,n]=a.name,e.length>i&&(i=e.length),$(`#station_info_gzmtr #big_next_2 g:nth-child(${2*(s+1)}) text`).eq(2).text(e),$(`#station_info_gzmtr #big_next_2 g:nth-child(${2*(s+1)}) text`).eq(3).text(n.split("\\")[0]).append($("<tspan>",{x:0,dy:13,"alignment-baseline":"middle"}).text(n.split("\\")[1]||""));let r,l=this.routes.filter(e=>-1!==e.indexOf(t)).map(t=>t.filter(t=>"linestart"!==t&&"lineend"!==t));r="l"===this._direction?Array.from(new Set(l.map(t=>t[0]))).reverse():Array.from(new Set(l.map(t=>t.reverse()[0]))),$(`#station_info_gzmtr #big_next_2 g:nth-child(${2*(s+1)}) text`).eq(0).text(r.map(t=>this.stations[t].name[0]).join("/")+"æ–¹å‘"),$(`#station_info_gzmtr #big_next_2 g:nth-child(${2*(s+1)}) text`).eq(1).text("Towards "+r.map(t=>this.stations[t].name[1]).join("/"))});$("#station_info_gzmtr").html($("#station_info_gzmtr").html());var a=l($("#station_info_gzmtr #big_name text")[0],"destination");$("#station_info_gzmtr #big_stn_num").attr("transform",`translate(${(this._svgDestWidth+a.width)/2+55},${120-20*(this.stations[this._currentStnId].name[1].split("\\").length-1)})scale(1.4)`);let r={x:0,y:0,width:0,height:0};if(1===t.length)r=l($("#station_info_gzmtr #big_next g:nth-child(2)")[0],"destination");else{let t=[l($("#station_info_gzmtr #big_next_2 g:nth-child(2)")[0],"destination"),l($("#station_info_gzmtr #big_next_2 g:nth-child(4)")[0],"destination")];r=t[0].width>t[1].width?t[0]:t[1]}"l"==this._direction?($("#station_info_gzmtr #platform").attr("transform",`translate(${this._svgDestWidth-100},120)`),1===t.length?i<=2?($("#station_info_gzmtr #big_next g:nth-child(2)").attr("transform","translate(150,110)"),$("#station_info_gzmtr > use").eq(0).attr("transform",`translate(${(115+35*(1+i)+a.x)/2-20},120)scale(0.25)`)):($("#station_info_gzmtr #big_next g:nth-child(2)").attr("transform","translate(132.5,110)"),$("#station_info_gzmtr > use").eq(0).attr("transform",`translate(${(115+35*(.5+i)+a.x)/2-20},120)scale(0.25)`)):($("#station_info_gzmtr #big_next_2 g:nth-child(2)").attr("transform","translate(113,80)"),$("#station_info_gzmtr #big_next_2 g:nth-child(4)").attr("transform","translate(113,190)"),$("#station_info_gzmtr > use").eq(0).attr("transform",`translate(${(99+27*(1+i)+a.x)/2-20},120)scale(0.25)`)),$("#station_info_gzmtr #big_next g:first-child").attr("transform","translate(80,110)"),$("#station_info_gzmtr #big_next_2 g:first-child").attr("transform","translate(72,80)"),$("#station_info_gzmtr #big_next_2 g:nth-child(3)").attr("transform","translate(72,190)")):($("#station_info_gzmtr #platform").attr("transform","translate(100,120)"),1===t.length?($("#station_info_gzmtr #big_next g:nth-child(2)").attr("transform",`translate(${this._svgDestWidth-45-r.width},110)`),i<=2?($("#station_info_gzmtr #big_next g:first-child").attr("transform",`translate(${this._svgDestWidth-45-r.width-70},110)`),$("#station_info_gzmtr > use").eq(0).attr("transform",`translate(${(this._svgDestWidth-45-r.width-70-35+a.x+a.width+55+25.9)/2+20},120)scale(0.25)rotate(180)`)):($("#station_info_gzmtr #big_next g:first-child").attr("transform",`translate(${this._svgDestWidth-45-r.width-52.5},110)`),$("#station_info_gzmtr > use").eq(0).attr("transform",`translate(${(this._svgDestWidth-45-r.width-87.5+a.x+a.width+55+25.9)/2+20},120)scale(0.25)rotate(180)`))):($("#station_info_gzmtr #big_next_2 g:nth-child(2)").attr("transform",`translate(${this._svgDestWidth-45-r.width},80)`),$("#station_info_gzmtr #big_next_2 g:nth-child(4)").attr("transform",`translate(${this._svgDestWidth-45-r.width},190)`),$("#station_info_gzmtr #big_next_2 g:first-child").attr("transform",`translate(${this._svgDestWidth-45-r.width-41},80)`),$("#station_info_gzmtr #big_next_2 g:nth-child(3)").attr("transform",`translate(${this._svgDestWidth-45-r.width-41},190)`),$("#station_info_gzmtr > use").eq(0).attr("transform",`translate(${(this._svgDestWidth-45-r.width-41-27+a.x+a.width+55+25.9)/2+20},120)scale(0.25)rotate(180)`))),$("#station_info_gzmtr #indicator_light").attr({x:this._svgDestWidth/2,y:270,"xlink:href":"#indicator_"+this._infoPanelType}),this.drawPSD()}drawPSD(){$("#station_info_gzmtr #big_psd").attr("transform",`translate(${this._svgDestWidth/2+80},${(t=>{switch(this._infoPanelType){case"gz3":return 218;case"gz1421":return 238;default:return 242}})()})`)}addStn(t,e,n,i){var s=super.addStn(t,e,n,i);return this.loadLineNum(),this.loadDirection(),s}removeStn(t){return!!super.removeStn(t)&&(this.loadLineNum(),this.loadDirection(),!0)}updateStnTransfer(t,e,n=null){super.updateStnTransfer(t,e,n),this.loadLineNum()}updateBranchType(t,e,n){super.updateBranchType(t,e,n),this.loadLineNum(),this.loadDirection()}updateBranchFirst(t,e,n){return!!super.updateBranchFirst(t,e,n)&&(this.loadLineNum(),this.loadDirection(),!0)}updateBranchPos(t,e,n){super.updateBranchPos(t,e,n),this.loadLineNum(),this.loadDirection()}static initSVG(t){super.initSVG(t),t.loadLineNum(),t.loadLineName(),t.loadDirection()}}var A=n(1),W=n(9);var G=n(4),Y=n(10);var q=n(8),B=n(17);const V=(t,e,n)=>$("<div>",{id:t,class:"mdc-card mdc-layout-grid__cell--span-2-desktop mdc-layout-grid__cell--span-4-tablet mdc-layout-grid__cell--span-2-phone station-card"}).append($("<div>",{class:"mdc-card__primary-action"}).append($("<div>",{class:"mdc-card__media mdc-card__media--16-9"})).append($("<div>",{class:"mdc-card__media-content station-card__content"}).html(e.join("<br>")).prepend($("<span>").css("display","gzmtr"===window.urlParams.get("style")?"inline":"none").text(n+"Â ")))).append($("<div>",{class:"mdc-card__actions"}).append($("<div>",{class:"mdc-card__action-icons"}).append($("<button>",{title:"Set As Current",class:"material-icons mdc-icon-button mdc-card__action mdc-card__action--icon"}).text("my_location")).append($("<button>",{title:"Interchange",class:"material-icons mdc-icon-button mdc-card__action mdc-card__action--icon"}).text("edit")).append($("<button>",{title:"Remove",class:"material-icons mdc-icon-button mdc-card__action mdc-card__action--icon"}).text("delete_forever"))));function Z(){var t=$("#stn_transfer_diag .mdc-layout-grid__inner #int_name_zh,#int_name_en").slice(0,2).clone();t.find(".mdc-text-field").removeAttr("data-mdc-auto-init-state"),$("div#int_line").slice(1,3).after(t);const[e,n,i,a,r]=["#stn_add_diag","#stn_modify_diag","#stn_transfer_diag","#stn_delete_diag","#stn_delete_err"].map(t=>new k.MDCDialog($(t)[0])),[l,h,o,d]=["#prep","#pivot","#loc","#end"].map(t=>new G.MDCSelect($("#stn_add_diag").find(t)[0])),[_,m,u]=["#name_zh","#name_en","#stn_num"].map(t=>new A.MDCTextField($("#stn_modify_diag").find(t)[0])),p=new q.MDCTabBar($("#stn_transfer_diag .mdc-tab-bar")[0]),f=new G.MDCSelect($("#change_type")[0]),x=$("#int_city .mdc-select").map((t,e)=>new G.MDCSelect(e)).get(),w=$("#int_line .mdc-select").map((t,e)=>new G.MDCSelect(e)).get(),v=$("#int_name_zh .mdc-text-field").map((t,e)=>new A.MDCTextField(e)).get(),y=$("#int_name_en .mdc-text-field").map((t,e)=>new A.MDCTextField(e)).get(),b=new A.MDCTextField($("#stn_transfer_diag #osi_name_zh")[0]),S=new A.MDCTextField($("#stn_transfer_diag #osi_name_en")[0]),[N,D]=["#tick_direc","#paid_area"].map(t=>new B.a($("#stn_transfer_diag").find(t)[0])),[T,C,z,M,L,I]=["#left_through","#right_through","#left_first","#right_first","#left_pos","#right_pos"].map(t=>new G.MDCSelect($(t)[0]));var P=s().stn_list;window.myLine.tpo.forEach(t=>{$("#panel_stations .mdc-layout-grid__inner:first").append(V(t,P[t].name,P[t].num)),$("#pivot__selection").append($("<li>",{"data-value":t}).addClass("mdc-list-item").text(P[t].name.join()))}),$("#panel_stations .mdc-card__primary-action").on("click",t=>{var e=t.target.closest(".mdc-card").id;"add_stn"!=e&&($("#stn_modify_diag").attr("for",e),n.open())}),$('#panel_stations .mdc-card__action-icons > [title="Add"]').on("click",t=>{e.open()}),$('#panel_stations .mdc-card__action-icons > [title="Set As Current"]').on("click",t=>{var e=t.target.closest(".mdc-card").id;window.myLine.currentStnId=e}),$('#panel_stations .mdc-card__action-icons > [title="Interchange"]').on("click",t=>{$("#stn_transfer_diag").attr("for",t.target.closest(".mdc-card").id),i.open()}),$('#panel_stations .mdc-card__action-icons > [title="Remove"]').on("click",t=>{var e=t.target.closest(".mdc-card").id;$("#stn_delete_diag").attr("for",e),a.open()}),e.listen("MDCDialog:opening",t=>{h.selectedIndex=0}),e.listen("MDCDialog:opened",t=>{[l,h,o].forEach(t=>t.layout())}),e.listen("MDCDialog:closed",t=>{if("close"!=t.detail.action){var e=l.value,s=h.value,r=o.value,c=d.value,[_,g]=window.myLine.addStn(e,s,r,c);console.log(e,s,r,c);var m=window.myLine.tpo[window.myLine.tpo.indexOf(_)-1]||"add_stn";$(`#panel_stations .mdc-layout-grid__inner:first #${m}`).after(V(_,g.name,g.num)),$(`#panel_stations #${_} .mdc-card__primary-action`).on("click",t=>{var e=t.target.closest(".mdc-card").id;"add_stn"!=e&&($("#stn_modify_diag").attr("for",e),n.open())}),$(`#panel_stations #${_} .mdc-card__action-icons > [title="Set As Current"]`).on("click",t=>{var e=t.target.closest(".mdc-card").id;window.myLine.currentStnId=e}),$(`#panel_stations #${_} .mdc-card__action-icons > [title="Interchange"]`).on("click",t=>{var e=t.target.closest(".mdc-card").id;$("#stn_transfer_diag").attr("for",e),i.open()}),$(`#panel_stations #${_} .mdc-card__action-icons > [title="Remove"]`).on("click",t=>{var e=t.target.closest(".mdc-card").id;$("#stn_delete_diag").attr("for",e),a.open()});var u=$("<li>",{"data-value":_,class:"mdc-list-item"}).text(g.name.join(" - "));"add_stn"==m?$("#pivot__selection").prepend(u):$(`#pivot__selection [data-value="${m}"`).after(u),$("#stn_modify_diag").attr("for",_),n.open()}}),l.listen("MDCSelect:change",t=>{$("#stn_add_diag #pivot")[0].dispatchEvent(new Event("MDCSelect:change"))}),h.listen("MDCSelect:change",t=>{var e=l.value,n=h.value,i=s().stn_list;for(let[t,s]of window.myLine.newStnPossibleLoc(e,n).entries())1===s||s.length?($("#loc__selection li").eq(t).show(),t>=3&&($("#end__selection").empty(),s.forEach(t=>{$("#end__selection").append($("<li>",{class:"mdc-list-item","data-value":t}).text(i[t].name.join(" - ")))}))):$("#loc__selection li").eq(t).hide();o.value=Array.from(document.querySelectorAll("#loc__selection li")).filter(t=>"none"!==t.style.display)[0].dataset.value}),o.listen("MDCSelect:change",t=>{["newupper","newlower"].includes(t.detail.value)?($("#stn_add_diag [new-branch]").show(),d.selectedIndex=0):$("#stn_add_diag [new-branch]").hide()}),n.listen("MDCDialog:opening",t=>{var e=$(t.target).attr("for");[_.value,m.value]=s().stn_list[e].name,u.value=s().stn_list[e].num}),n.listen("MDCDialog:opened",()=>{_.layout(),m.layout(),u.layout()}),$("#stn_modify_diag #name_zh, #stn_modify_diag #name_en, #stn_num").on("input",()=>{var t=_.value,e=m.value,n=u.value,i=$("#stn_modify_diag").attr("for");window.myLine.updateStnName(i,[t,e],n),$(`#panel_stations .mdc-layout-grid__inner:first #${i} .mdc-card__media-content`).html([t,e].join("<br>")).prepend($("<span>",{style:"gzmtr"==window.urlParams.get("style")?"":"display:none;"}).text(n+" ")),$(`#pivot__selection [data-value="${i}`).html(`${t} - ${e}`)});const E=()=>{f.layout(),x.forEach(t=>t.layout()),w.forEach(t=>t.layout()),v.forEach(t=>t.layout()),y.forEach(t=>t.layout()),S.layout(),b.layout()},H=()=>{T.layout(),C.layout(),z.layout(),M.layout(),L.layout(),I.layout()};function O(t,e){e?($("#int_city, #int_line, #int_name_zh, #int_name_en").slice(4*t,4*(t+1)).show(),x[t].layout(),w[t].layout(),v[t].layout(),y[t].layout()):$("#int_city, #int_line, #int_name_zh, #int_name_en").slice(4*t,4*(t+1)).hide()}p.listen("MDCTabBar:activated",t=>{switch(t.detail.index){case 0:$("#panel_interchange").show(),$("#panel_branch").hide(),E();break;case 1:$("#panel_interchange").hide(),$("#panel_branch").show(),H()}}),$.getJSON("data/city_list.json",t=>{var e=window.urlParams.get("lang");t.forEach(t=>{$("#int_city__selection.mdc-list").each((n,i)=>{$(i).append($("<li>",{class:"mdc-list-item","data-value":t.id}).html(c(t.country)+g(t.name,e)))})})}),i.listen("MDCDialog:opening",t=>{var e=$(t.target).attr("for"),n=s().stn_list[e];let i=s().theme[0];if(f.value=n.change_type.split("_")[0],"none"!==n.change_type){var a=n.interchange[0].concat(n.interchange[1]?n.interchange[1].slice(1,n.interchange[1].length):[]);a.length<3&&a.unshift([,,,,,,]),a.length<3&&a.push([,,,,,,]),console.log(a),a.forEach((t,e)=>{let n=$("#int_city__selection.mdc-list").eq(0).find(`[data-value="${t[0]||i}"]`).index();x[e].selectedIndex=n,v[e].value=t[4]||"",y[e].value=t[5]||""})}else{let t=$("#int_city__selection.mdc-list").eq(0).find(`[data-value="${i}"]`).index();x.forEach(e=>e.selectedIndex=t),v.forEach(t=>t.value=""),y.forEach(t=>t.value="")}["none","int2"].includes(n.change_type.split("_")[0])?N.on=!0:N.on="r"==n.change_type.slice(-1),"osi"==n.change_type.substring(0,3)?([b.value,S.value]=n.interchange[1][0],D.on="p"==n.change_type.split("_").reverse()[0][0]):(b.value="",S.value="",D.on=!0),(t=>{["left","right"].forEach(e=>{let n=t.branch[e][0];n?("left"===e?T.value=n:C.value=n,$(`#${e}_through__selection [data-value="na"]`).hide(),$(`#${e}_through__selection [data-value="through"]`).show(),$(`#${e}_through__selection [data-value="nonthrough"]`).show(),$(`[${e}-first-group], [${e}-pos-group]`).show()):("left"===e?T.value="na":C.value="na",$(`#${e}_through__selection [data-value="na"]`).show(),$(`#${e}_through__selection [data-value="through"]`).hide(),$(`#${e}_through__selection [data-value="nonthrough"]`).hide(),$(`[${e}-first-group], [${e}-pos-group]`).hide())}),$("#left_first__selection, #right_first__selection").empty(),Promise.resolve(s().stn_list).then(e=>{t.parents.forEach(t=>{$("#left_first__selection").append($("<li>",{class:"mdc-list-item","data-value":t}).text(e[t].name.join(" - ")))}),t.children.forEach(t=>{$("#right_first__selection").append($("<li>",{class:"mdc-list-item","data-value":t}).text(e[t].name.join(" - ")))})}).then(()=>{["left","right"].forEach(e=>{"left"===e?"na"!==T.value?z.selectedIndex=t.parents.indexOf(t.branch[e][1]):z.selectedIndex=0:"na"!==C.value?M.selectedIndex=t.children.indexOf(t.branch[e][1]):M.selectedIndex=0})}),L.selectedIndex=t.parents.indexOf(t.branch.left[1]),I.selectedIndex=t.children.indexOf(t.branch.right[1])})(n)}),i.listen("MDCDialog:opened",t=>{E(),H()}),i.listen("MDCDialog:closed",t=>{if("close"!=t.detail.action){var e=t.target.getAttribute("for"),n=f.value,i=N.on?"r":"l",s=[b.value,S.value],a=D.on?"p":"u",[r,l,h]=[0,1,2].map(t=>[x[t].value,w[t].value].concat($("ul#int_line__selection").eq(t).find("li span").eq(w[t].selectedIndex).attr("style").match(/#[\w\d]+/g),v[t].value,y[t].value));if("none"==n)window.myLine.updateStnTransfer(e,n);else if("osi22"==n)window.myLine.updateStnTransfer(e,`${n}_${a}${i}`,[[r],[s,l,h]]);else switch(n){case"int2":window.myLine.updateStnTransfer(e,n,[[l]]);break;case"osi11":window.myLine.updateStnTransfer(e,`${n}_${a}${i}`,[[],[s,l]]);break;default:switch(n){case"int3":window.myLine.updateStnTransfer(e,`${n}_${i}`,[[l,h]]);break;case"osi12":window.myLine.updateStnTransfer(e,`${n}_${a}${i}`,[[],[s,l,h]])}}}}),f.listen("MDCSelect:change",t=>{if("int2"==t.detail.value)O(0,!1),O(1,!0),O(2,!1),$("#stn_transfer_diag #tick_direc").hide(),$("#osi_name_zh, #osi_name_en, #paid_area").hide();else if("int3"==t.detail.value)O(0,!1),O(1,!0),O(2,!0),$("#stn_transfer_diag #tick_direc").show(),$("#osi_name_zh, #osi_name_en, #paid_area").hide();else if("osi11"==t.detail.value)O(0,!1),O(1,!0),O(2,!1),$("#stn_transfer_diag #tick_direc").show(),$("#osi_name_zh, #osi_name_en, #paid_area").show();else if("osi12"==t.detail.value)O(0,!1),O(1,!0),O(2,!0),$("#stn_transfer_diag #tick_direc").show(),$("#osi_name_zh, #osi_name_en, #paid_area").show();else if("osi22"==t.detail.value){O(0,!0),O(1,!0),O(2,!0);let t=s().stn_list[$("#stn_transfer_diag").attr("for")];"linestart"==t.parents[0]||"lineend"==t.children[0]?$("#tick_direc").hide():$("#tick_direc").show()}else $("#stn_transfer_diag #panel_interchange [id]div").slice(1).hide(),$("#tick_direc, #paid_area").hide()}),x.forEach((t,e)=>{t.listen("MDCSelect:change",t=>{-1!==t.detail.index&&$.getJSON(`data/${t.detail.value}.json`,t=>{var n=window.urlParams.get("lang");$("#int_line__selection.mdc-list").eq(e).empty(),t.forEach(t=>{$("#int_line__selection.mdc-list").eq(e).append(`<li class="mdc-list-item" data-value="${t.id}">\n                        <span style="background:${t.colour};color:${t.fg||"#fff"};">&nbsp;${g(t.name,n)}&nbsp;</span>\n                        </li>`)});var i=$("#stn_transfer_diag").attr("for"),a=s().stn_list[i];if("none"!==a.change_type){var r=a.interchange[0].concat(a.interchange[1]?a.interchange[1].slice(1,a.interchange[1].length):[]);r.length<3&&r.unshift([,,,,,,]),r.length<3&&r.push([,,,,,,]);var l=$("#int_line__selection.mdc-list").eq(e).find(`[data-value="${r[e][1]}"]`).index();w[e].selectedIndex=-1==l?0:l}else w[e].selectedIndex=0})})});const F=(...t)=>[...t[0]].map((e,n)=>t.map(t=>t[n]));F([T,C],["left","right"]).forEach(t=>{t[0].listen("MDCSelect:change",e=>{if("na"===e.detail.value)return;let n=$("#stn_transfer_diag").attr("for");window.myLine.updateBranchType(n,t[1],e.detail.value)})}),F([z,M],["left","right"],[L,I]).forEach(t=>{t[0].listen("MDCSelect:change",e=>{if(1===$(`#${t[1]}_first__selection`).children().length)return;let n=$("#stn_transfer_diag").attr("for");window.myLine.updateBranchFirst(n,t[1],e.detail.value)&&(0===t[2].selectedIndex?t[2].selectedIndex=1:t[2].selectedIndex=0)})}),F([L,I],["left","right"],[T,C]).forEach(t=>{t[0].listen("MDCSelect:change",e=>{if("na"===t[2].value)return;let n=$("#stn_transfer_diag").attr("for");window.myLine.updateBranchPos(n,t[1],e.detail.index)})}),a.listen("MDCDialog:opening",t=>{var e=$(t.target).attr("for");$("#stn_delete_diag #err_stn").text(s().stn_list[e].name.join(" - "))}),a.listen("MDCDialog:closed",t=>{if("close"!=t.detail.action){var e=$(t.target).attr("for");window.myLine.removeStn(e)?($(`#panel_stations .mdc-layout-grid__inner #${e}`).remove(),$(`#pivot__selection [data-value="${e}"]`).remove()):r.open()}})}window.myLine=null,H(`[${window.urlParams.get("style")}-specific]`).show(),function(){const[t,e,n,i,a,l]=["#template_diag","#import_diag","#export_diag","#preview_diag","#style_diag","#lang_diag"].map(t=>k.MDCDialog.attachTo($(t)[0])),[h,o]=$("#panel_save .mdc-list").map((t,e)=>P.MDCList.attachTo(e)).get();h.listen("MDCList:action",e=>{switch(e.detail.index){case 0:t.open();break;case 1:$("#upload_file").click();break;case 2:$("<a>",{href:"data:application/json;base64,"+btoa(unescape(encodeURIComponent(localStorage.rmgParam))),download:"rmg_param.json"})[0].click();break;case 3:n.open()}}),$("#panel_save .mdc-list:nth-child(2) li:first-child span:nth-child(2) span:last-child").attr("trans-tag",$(`#style_diag [data-mdc-dialog-action="${window.urlParams.get("style")}"] span`).attr("trans-tag")).text($(`#style_diag [data-mdc-dialog-action="${window.urlParams.get("style")}"] span`).text()),$("#panel_save .mdc-list:nth-child(2) li:nth-child(2) span:nth-child(2) span:last-child").text($(`#lang_diag [data-mdc-dialog-action="${window.urlParams.get("lang")}"] span`).text()),o.listen("MDCList:action",t=>{switch(t.detail.index){case 0:a.open();break;case 1:l.open()}}),$.getJSON("templates/template_list.json",t=>{var e=window.urlParams.get("lang");t.forEach(t=>{$("#template_diag ul").append($("<li>",{class:"mdc-list-item","data-mdc-dialog-action":t.filename,"data-mdc-auto-init":"MDCRipple"}).append($("<span>",{class:"mdc-list-item__text"}).text(g(t.desc,e))))}),$("#template_diag li:first-child").attr("tabindex",0),I.a.register("MDCRipple",E.a)}),t.listen("MDCDialog:closed",t=>{"close"!=t.detail.action&&$.getJSON(`templates/${t.detail.action}.json`,t=>{localStorage.rmgParam=JSON.stringify(t),location.reload(!0)})}),n.listen("MDCDialog:closed",t=>{switch(t.detail.action){case"close":break;case"svg1":$("#preview_diag").attr("for","destination"),i.open();break;case"svg2":$("#preview_diag").attr("for","railmap"),i.open()}}),$(window).on("resize",t=>{c()});const c=()=>{var t=$("preview_diag").attr("for"),[e,n]=["destination"==t?s().svg_dest_width:s().svg_width,s().svg_height],i=$(window).width()-32-50,a=$(window).height()-60-53-60,r=Math.min(i/e,a/n);$("#preview_diag").find("svg").attr({width:e*r,height:n*r}),$("#preview_diag").find(".mdc-dialog__surface").attr("style",`max-width:${i+50}px;`)};let d;i.listen("MDCDialog:opened",t=>{var e=$(t.target).attr("for"),[n,i]=["destination"==e?s().svg_dest_width:s().svg_width,s().svg_height];$("#preview_diag .mdc-dialog__surface").attr("style",`max-width:${$(window).width()-32}px;`);var a=$(window).width()-32-50,r=$(window).height()-60-53-60,l=Math.min(a/n,r/i);$(t.target).find(".mdc-dialog__content").append($("#"+$(t.target).attr("for")).clone().attr({style:"all:initial;",viewBox:`0 0 ${n} ${i}`,width:n*l,height:i*l})),$(t.target).find('svg [style="display: none;"]').remove()}),i.listen("MDCDialog:closed",t=>{if("close"!==t.detail.action){if("png"===t.detail.action)return r($(t.target).removeAttr("for").find("svg")),void $(t.target).find(".mdc-dialog__content").empty();if("svg"===t.detail.action){var e=document.createElement("a"),n=$(t.target).find(".mdc-dialog__content svg").prepend($("style#svg_share").clone());e.href="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(n[0].outerHTML))),e.download="rmg_export.svg",e.click(),$(t.target).removeAttr("for").find(".mdc-dialog__content").empty()}}else $(t.target).removeAttr("for").find(".mdc-dialog__content").empty()}),$("#upload_file").on("change",t=>{console.log(t.target.files[0]);let n=new FileReader;n.onload=function(t){var n;console.log(t.target),d=JSON.parse(t.target.result),$("#import_diag").find(".mdc-dialog__content").html((n=d,`Number of stations: ${Object.keys(n.stn_list).length-2}\n            ${Object.entries(n.stn_list).map(t=>["linestart","lineend"].includes(t[0])?"":t[1].name.join(" - ")).join("<br>").trim().replace(/\\/," ")}`)),e.open()},n.readAsText(t.target.files[0])}),e.listen("MDCDialog:closed",t=>{"close"!=t.detail.action?(L.clearSVG(),localStorage.rmgParam=JSON.stringify(d),location.reload(!0)):$("#upload_file")[0].value=""}),a.listen("MDCDialog:closed",t=>{switch(t.detail.action){case"close":case window.urlParams.get("style"):return;default:window.urlParams.set("style",t.detail.action),window.location.href="?"+window.urlParams.toString()}}),l.listen("MDCDialog:closed",t=>{if("close"!=t.detail.action){var e=t.detail.action;localStorage.rmgLang=e,e!=window.urlParams.get("lang")&&(window.urlParams.set("lang",e),window.location.href="?"+window.urlParams.toString())}})}(),function(){const t=t=>{let e=(t=>{switch(window.urlParams.get("style")){case"mtr":return L;case"gzmtr":return X}})();window.myLine=new e(t),e.initSVG(window.myLine)};if(null!=localStorage.rmgParam)try{_(),t(s())}catch(t){let e=k.MDCDialog.attachTo($("#init_err_diag")[0]);$("#init_err_diag").find("#err_stack").html(t+"<br>"+t.stack.replace(/\n/g,"<br>")),e.open(),console.error(t)}else $.getJSON("templates/blank.json",e=>{localStorage.rmgParam=JSON.stringify(e),_(),t(s())})}(),function(){let t=[!1,!0,!0,!0,!0];window.sliders=[],q.MDCTabBar.attachTo($("#panels .mdc-tab-bar")[0]).listen("MDCTabBar:activated",e=>{if($(".panel--active").removeClass("panel--active"),$(".panel").eq(e.detail.index).addClass("panel--active"),1==e.detail.index&&t[1]&&(!function(){const[t,e]=["#svg_dest_width","#svg_width"].map(t=>A.MDCTextField.attachTo($(t)[0])),[n,i,a]=["#branch_spacing","#y_pc","#padding"].map(t=>W.MDCSlider.attachTo($(t)[0]));window.sliders.push(n,i,a),Promise.resolve(s()).then(s=>{t.value=s.svg_dest_width,e.value=s.svg_width,i.value=s.y_pc,n.value=s.branch_spacing,a.value=s.padding}),$(t.root_).find("input").on("input",t=>window.myLine.svgDestWidth=Number(t.target.value)),$(e.root_).find("input").on("input",t=>window.myLine.svgWidth=Number(t.target.value)),n.listen("MDCSlider:input",t=>{window.myLine.branchSpacing=n.value}),i.listen("MDCSlider:input",t=>{window.myLine.yPc=Number(i.value)}),a.listen("MDCSlider:input",t=>{window.myLine.padding=a.value})}(),"gzmtr"===window.urlParams.get("style")&&function(){const[t,e]=["#direction_gz_x","#direction_gz_y"].map(t=>W.MDCSlider.attachTo($(t)[0]));Promise.resolve(s()).then(n=>{t.value=n.direction_gz_x,e.value=n.direction_gz_y}),t.listen("MDCSlider:input",e=>{window.myLine.directionGZX=Number(t.value)}),e.listen("MDCSlider:input",t=>{window.myLine.directionGZY=Number(e.value)})}(),t[1]=!1),1===e.detail.index&&window.sliders.forEach(t=>t.layout()),2==e.detail.index&&t[2]){switch(function(){const t=P.MDCList.attachTo($("#design_list")[0]),[e,n]=["#design_theme_diag","#line_name_diag"].map(t=>k.MDCDialog.attachTo($(t)[0])),[a,r]=["#theme_city","#theme_line"].map(t=>new G.MDCSelect($(t)[0])),[l,h]=["#name_zh","#name_en"].map(t=>A.MDCTextField.attachTo($("#line_name_diag").find(t)[0])),o=A.MDCTextField.attachTo($("#platform_num")[0]),_=t=>$("#design_list").find(`li#direc p#${t}`).text();Promise.resolve(s()).then(t=>{$("#design_list").find("li#name .mdc-list-item__secondary-text").text(t.line_name.join()),l.value=t.line_name[0],h.value=t.line_name[1],$("#design_list").find("li#direc .mdc-list-item__secondary-text").text(_(t.direction)),o.value=t.platform_num}),$.getJSON("data/city_list.json",t=>{let e=window.urlParams.get("lang");t.forEach(t=>{$("#theme_city__selection").append($("<li>",{class:"mdc-list-item","data-value":t.id}).text(c(t.country)+g(t.name,e)))});var[n]=s().theme,i=$(`#theme_city__selection > [data-value="${n}"]`).index();a.selectedIndex=i}),t.listen("MDCList:action",t=>{switch(t.detail.index){case 0:e.open();break;case 1:n.open();break;case 2:"r"==s().direction?(console.log("right to left"),window.myLine.direction="l",$("#design_list").find("li#direc .mdc-list-item__secondary-text").text(_("l"))):(console.log("left to right"),window.myLine.direction="r",$("#design_list").find("li#direc .mdc-list-item__secondary-text").text(_("r")));break;case 4:window.myLine.reverseStns()}}),e.listen("MDCDialog:opened",()=>{[a,r].map(t=>t.layout())}),a.listen("MDCSelect:change",t=>{let e=t.detail.value;$("#theme_line__selection").empty(),$.getJSON(`data/${e}.json`,t=>{var n=window.urlParams.get("lang");t.forEach(t=>{$("#theme_line__selection").append($("<li>",{class:"mdc-list-item","data-value":t.id}).append($("<span>").css({background:t.colour,color:t.fg||"#fff"}).text("Â "+g(t.name,n)+"Â ")))});var a=s();a.theme[0]=e,i(a);var l=$(`#theme_line__selection > [data-value="${a.theme[1]}"]`).index();r.selectedIndex=-1==l?0:l})}),r.listen("MDCSelect:change",t=>{let e=t.detail.index;var n=s();n.theme[1]=t.detail.value,i(n),window.myLine.themeLine=t.detail.value,window.myLine.themeColour=["background-color","color"].map(t=>$("#theme_line__selection span").eq(e).css(t)).map(d),$("#design_list").find("li#theme .mdc-list-item__secondary-text").html($("#theme_city__selection li").eq(a.selectedIndex).text()+" "+$("#theme_line__selection li").eq(e).html().trim())}),n.listen("MDCDialog:opened",t=>{[l,h].map(t=>t.layout())}),$("#line_name_diag").find(".mdc-text-field").on("input",()=>{let t=[l,h].map(t=>t.value);window.myLine.lineNames=t,$("#design_list").find("li#name .mdc-list-item__secondary-text").text(t.join())}),$(o.root_).find("input").on("input",t=>window.myLine.platformNum=t.target.value)}(),window.urlParams.get("style")){case"mtr":!function(){const t=P.MDCList.attachTo($("#design_list_mtr")[0]),e=k.MDCDialog.attachTo($("#design_char_diag")[0]),n=new Y.MDCSwitch($("#legacy")[0]),i=t=>$("#design_char_diag").find("li").filter((e,n)=>n.dataset.mdcDialogAction===t).find("span").text();Promise.resolve(s()).then(t=>{$("#design_list_mtr").find("li#char .mdc-list-item__secondary-text").text(i(t.char_form)),n.checked=t.dest_legacy}),t.listen("MDCList:action",t=>{switch(t.detail.index){case 0:window.myLine.txtFlip=!s().txt_flip;break;case 1:e.open()}}),e.listen("MDCDialog:closed",t=>{let e=t.detail.action;"close"!=e&&(window.myLine.charForm=e,$("#design_list_mtr").find("li#char .mdc-list-item__secondary-text").text(i(e)))}),$(n.root_).find("input").on("change",t=>window.myLine.destLegacy=t.target.checked)}();break;case"gzmtr":!function(){const t=P.MDCList.attachTo($("#design_list_gzmtr")[0]),e=k.MDCDialog.attachTo($("#panel_type_diag")[0]),[n,i]=["#psd_num","#line_num"].map(t=>A.MDCTextField.attachTo($(t)[0]));Promise.resolve(s()).then(t=>{n.value=t.psd_num,i.value=t.line_num}),t.listen("MDCList:action",t=>{switch(t.detail.index){case 1:e.open()}}),$(i.root_).find("input").on("input",t=>window.myLine.lineNum=t.target.value),$(n.root_).find("input").on("input",t=>window.myLine.psdNum=t.target.value),e.listen("MDCDialog:closed",t=>{"close"!==t.detail.action&&(window.myLine.infoPanelType=t.detail.action)})}()}t[2]=!1}3==e.detail.index&&t[3]&&(console.log("init again"),Z(),t[3]=!1),4==e.detail.index&&t[4]&&($("#panel_info .mdc-card__actions #report").on("click",()=>{window.open("https://github.com/wongchito/RailMapGenerator/issues","_blank")}),$('#panel_info .mdc-card__action-icons [title="Star"]').on("click",()=>{window.open("https://github.com/wongchito/RailMapGenerator","_blank")}),$('#panel_info .mdc-card__action-icons [title="Fork"]').on("click",()=>{window.open("https://github.com/wongchito/RailMapGenerator/fork","_blank")}),t[4]=!1)})}()}]);